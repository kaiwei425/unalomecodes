# 下一步行动计划

## 🎯 立即行动（今天就可以做）

### 步骤 1: 评估当前状态（10分钟）

1. **检查你的部署环境**
   ```bash
   # 确认你的部署平台（Cloudflare Pages/Workers）
   # 确认是否有测试环境
   ```

2. **决定部署策略**
   - [ ] 选择 A：立即部署（高风险，不推荐）
   - [ ] 选择 B：快速修复后部署（推荐，1-2天）
   - [ ] 选择 C：完整修复后部署（理想，2-4周）

---

### 步骤 2: 快速修复关键问题（如果选择 B）

#### 修复 1: CORS 配置（30分钟）

**文件**: `functions/[[path]].handler.js`

**修改位置**: 第 4 行

**修改前**:
```javascript
'Access-Control-Allow-Origin': '*',
```

**修改后**:
```javascript
// 在 jsonHeadersFor 函数中动态设置
function jsonHeadersFor(request, env){
  const h = Object.assign({}, jsonHeaders);
  const origin = resolveCorsOrigin(request, env);
  if (origin) {
    h['Access-Control-Allow-Origin'] = origin;
    h['Vary'] = 'Origin';
  } else {
    delete h['Access-Control-Allow-Origin'];
  }
  return h;
}
```

**需要添加的环境变量**:
```
CORS_ORIGINS=https://shop.unalomecodes.com,https://unalomecodes.pages.dev
```

---

#### 修复 2: 关键错误提示（1小时）

**文件**: `js/checkout.js`

**找到这些位置并修改**:

1. **订单提交错误处理**（约第 956 行）
```javascript
// 修改前
} catch(err){
  console.error(err);
  alert('已送出訂單'); // 即使失败也显示成功
}

// 修改后
} catch(err){
  console.error('[Checkout] Order submission failed:', err);
  if (pendingOverlay) pendingOverlay.style.display = 'none';
  if (submitBtn) submitBtn.disabled = false;
  
  // 用户友好的错误提示
  const errorMsg = err.message || '訂單提交失敗，請稍後再試';
  alert(`❌ ${errorMsg}\n\n如果問題持續，請聯繫客服。`);
  return; // 不要继续执行
}
```

2. **支付错误处理**（约第 1904 行）
```javascript
// 修改前
} catch(err){
  console.error(err);
  alert('刷卡請求失敗，請稍後再試。');
}

// 修改后
} catch(err){
  console.error('[Payment] Credit card error:', err);
  const errorMsg = err.message || '付款處理失敗';
  alert(`❌ ${errorMsg}\n\n請檢查網路連線或稍後再試。\n如問題持續，請聯繫客服。`);
}
```

---

#### 修复 3: XSS 防护（30分钟）

**文件**: `js/cart.js` 第 42 行

**修改前**:
```javascript
div.innerHTML = `\
  <img src="${imgSafe||''}" alt="">\
  <div>\
    <div class="cartTitle">${name}</div>\
    ...
  </div>`;
```

**修改后**:
```javascript
// 确保所有用户输入都经过 escapeHtml
// 检查 escapeHtml 函数是否存在且正确
// 如果不存在，添加：
function escapeHtml(s=''){
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// 然后确保所有变量都转义
const name = escapeHtml(it.name||'商品');
const deity = escapeHtml(it.deity||'');
const variantName = escapeHtml(it.variantName||"");
```

---

### 步骤 3: 测试修复（30分钟）

1. **本地测试**
   ```bash
   # 在本地运行测试
   # 检查：
   # - CORS 是否正常工作
   # - 错误提示是否显示
   # - 购物车功能是否正常
   ```

2. **测试场景**
   - [ ] 正常下单流程
   - [ ] 模拟网络错误（断网测试）
   - [ ] 测试错误提示显示
   - [ ] 测试 CORS（从不同域名访问）

---

## 📅 本周计划（如果选择完整修复）

### Day 1: 安全修复
- [x] 修复 CORS
- [ ] 修复 XSS 风险点
- [ ] 添加输入验证
- [ ] 测试安全修复

### Day 2: 错误处理改进
- [ ] 创建统一错误处理系统
- [ ] 替换所有 `catch(_){}`
- [ ] 添加用户友好提示
- [ ] 测试错误场景

### Day 3: 性能优化
- [ ] 实现图片懒加载
- [ ] 优化 localStorage 操作
- [ ] 添加 API 缓存
- [ ] 性能测试

### Day 4-5: 代码重构
- [ ] 拆分巨型文件
- [ ] 提取常量
- [ ] 代码整理
- [ ] 全面测试

---

## 🛠️ 具体操作步骤

### 立即开始（选择 B 方案）

#### 1. 备份当前代码
```bash
# 创建备份分支
git checkout -b backup-before-fixes
git add .
git commit -m "Backup before security fixes"
git checkout main
```

#### 2. 创建修复分支
```bash
git checkout -b hotfix/security-fixes
```

#### 3. 开始修复

**修复 CORS**:
1. 打开 `functions/[[path]].handler.js`
2. 找到 `jsonHeaders` 定义（第 2-8 行）
3. 修改为动态 CORS（使用已有的 `jsonHeadersFor` 函数）
4. 确保所有 API 响应都使用 `jsonHeadersFor(request, env)`

**修复错误处理**:
1. 打开 `js/checkout.js`
2. 搜索所有 `catch(err)` 或 `catch(_)`
3. 添加用户友好的错误提示
4. 确保错误被正确记录

**修复 XSS**:
1. 检查所有使用 `innerHTML` 的地方
2. 确保所有用户输入都经过 `escapeHtml`
3. 测试恶意输入（如 `<script>alert(1)</script>`）

#### 4. 测试
```bash
# 本地测试
npm run dev  # 或你的本地开发命令

# 测试场景：
# 1. 正常流程
# 2. 网络错误
# 3. 恶意输入
```

#### 5. 提交和部署
```bash
git add .
git commit -m "Fix: Security and error handling improvements"
git push origin hotfix/security-fixes

# 合并到主分支
git checkout main
git merge hotfix/security-fixes
git push origin main
```

---

## 📋 检查清单

### 修复前检查
- [ ] 代码已备份
- [ ] 有测试环境
- [ ] 了解部署流程
- [ ] 有回滚方案

### 修复中检查
- [ ] CORS 配置已修改
- [ ] 关键错误已处理
- [ ] XSS 风险点已修复
- [ ] 代码可以正常运行

### 修复后检查
- [ ] 本地测试通过
- [ ] 错误提示正常显示
- [ ] 安全扫描通过
- [ ] 准备部署

### 部署后检查
- [ ] 功能正常
- [ ] 错误日志正常
- [ ] 用户反馈正常
- [ ] 性能指标正常

---

## 🚀 快速开始命令

### 如果你想立即开始修复：

1. **创建修复文件**
   ```bash
   # 我已经创建了工具函数，你可以直接使用
   # js/utils/security.js
   # js/utils/error-handler.js
   # js/utils/constants.js
   ```

2. **引入工具函数**
   在需要使用的文件中：
   ```javascript
   // 在 checkout.js 顶部添加
   import { escapeHtml } from './utils/security.js';
   import { handleError, showError } from './utils/error-handler.js';
   ```

3. **替换现有代码**
   ```javascript
   // 替换所有 catch(_){} 为
   } catch(err) {
     handleError(err, { context: 'checkout' });
   }
   ```

---

## 💡 建议的执行顺序

### 如果时间紧急（今天必须部署）：
1. ✅ 修复 CORS（30分钟）
2. ✅ 修复订单提交错误提示（30分钟）
3. ✅ 测试（30分钟）
4. ✅ 部署

**总时间**: 约 1.5 小时

### 如果有 1-2 天时间：
1. ✅ 完成快速修复（2小时）
2. ✅ 修复所有关键错误处理（4小时）
3. ✅ 修复 XSS 风险点（2小时）
4. ✅ 全面测试（2小时）
5. ✅ 部署

**总时间**: 约 1-2 天

### 如果有 1-2 周时间：
1. ✅ 完成所有高优先级修复
2. ✅ 性能优化
3. ✅ 代码重构
4. ✅ 添加测试
5. ✅ 部署

**总时间**: 约 1-2 周

---

## ❓ 需要帮助？

如果你需要：
- **具体代码修复**：告诉我你想修复哪个文件，我可以提供完整代码
- **测试指导**：我可以帮你写测试用例
- **部署协助**：我可以检查你的部署配置

**下一步建议**：
1. 先决定你的时间安排（紧急/1-2天/1-2周）
2. 根据时间选择对应的修复方案
3. 开始执行第一个修复（CORS）
4. 测试后再继续下一个

---

**准备好了吗？** 告诉我你想从哪个修复开始，我可以提供详细的代码！

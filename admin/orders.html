
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>訂單管理（批次）｜unalomecodes</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--brand:#eab308;}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1022,#0f172a);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;}
  .backLink{margin-bottom:10px;}
  .backBtn{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 12px;border-radius:999px;
    background:#111827;border:1px solid #263046;color:#e5e7eb;
    text-decoration:none;font-weight:700;font-size:13px;
    transition:all .18s ease;
  }
  .backBtn:hover{border-color:#3b82f6;color:#3b82f6;}
  h1{font-size:22px;margin:12px 0 16px 0;letter-spacing:.5px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px}
  .bar input,.bar select{background:#0f172a;border:1px solid #263046;color:#e5e7eb;border-radius:10px;padding:8px 10px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:14px 14px 8px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.06);vertical-align:top}
  th{color:#94a3b8;font-weight:700;text-align:left;background:#0f172a;position:sticky;top:0}
  tbody tr:hover{background:#0f172a}
  .badge{display:inline-block;background:#0f172a;border:1px solid #263046;color:#eab308;border-radius:9999px;padding:2px 8px;font-size:12px}
  .btn{display:inline-flex;align-items:center;gap:6px;background:#111827;border:1px solid #263046;color:#e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer}
  .btn:hover{border-color:#3b475f}
  .btn.gold{background:#eab308;color:#111827;border-color:#eab308}
  .btn.danger{border-color:#d33;color:#ffb0b0}
  .muted{color:#94a3b8}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr} }
  .toast{position:fixed;right:16px;bottom:16px;background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:10px;z-index:9999}
  .selbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 12px}
  .selbar .count{color:#eab308}
  .checkbox{transform:scale(1.2)}

  /* status badge colors */
  .badge.status-paid{ border-color:#f59e0b; color:#f59e0b; background:rgba(245,158,11,.08) }
  .badge.status-shipped{ border-color:#60a5fa; color:#60a5fa; background:rgba(96,165,250,.08) }
  .badge.status-done{ border-color:#34d399; color:#34d399; background:rgba(52,211,153,.08) }

  /* login overlay */
  #loginGate{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:100000}
  #loginCard{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:24px;min-width:280px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  #loginCard h2{margin:0 0 10px 0;font-size:18px}
  #loginCard input{width:100%;background:#0f172a;border:1px solid #263046;color:#e5e7eb;border-radius:10px;padding:8px 10px;margin-top:8px}
  #loginCard .hint{color:#94a3b8;font-size:12px;margin-top:6px}
  #loginCard .row{display:flex;gap:8px;margin-top:12px}
  #loginCard .row .btn{flex:1}
  tr.mail-ok td:nth-child(7)::after{
    content:'（已寄信）';
    margin-left:6px;
    font-size:12px;
    color:#60a5fa;
    font-weight:600;
  }
  tr.mail-fail td:nth-child(7)::after{
    content:'（尚未寄信）';
    margin-left:6px;
    font-size:12px;
    color:#fbbf24;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="backLink"><a class="backBtn" href="./index.html">← 返回主選單</a></div>
    <h1>訂單管理（批次）</h1>
<div class="bar">
      <input id="q" placeholder="搜尋 訂單編號 / 商品 / email / 門市 ...">
      <select id="statusSel"><option value="">全部狀態</option><option value="已付款待出貨">已付款待出貨</option><option value="已寄件">已寄件</option><option value="已完成訂單">已完成訂單</option></select> <select id="sortSel"><option value="time_desc">時間：新 → 舊</option><option value="time_asc">時間：舊 → 新</option><option value="amt_desc">金額：高 → 低</option><option value="amt_asc">金額：低 → 高</option><option value="status">狀態</option></select>
      <button class="btn" id="reload">重新整理</button>
      <span class="muted" id="count"></span>
    </div>

    <div class="selbar">
      <button class="btn gold" id="markPaid">批次標記已付款</button>
      <button class="btn gold" id="markShipped">批次標記已出貨</button>
      <button class="btn gold" id="markDone">批次標記已完成訂單</button>
      <button class="btn danger" id="batchDelete">批次刪除</button>
      <button class="btn" id="exportCsv">匯出選取訂單（CSV）</button>
      <span class="muted">已選取 <span class="count" id="selCount">0</span> 筆</span>
    </div>

    <div class="card">
      <div class="grid">
        <div style="overflow:auto; max-height:70vh;">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:36px"><input class="checkbox" type="checkbox" id="checkAll"></th>
                <th style="min-width:220px">訂單編號 / 建立時間</th>
                <th style="min-width:260px">商品</th>
                <th style="min-width:120px">金額</th>
                <th style="min-width:200px">付款</th>
                <th style="min-width:240px">訂購人資訊</th>
                <th style="min-width:140px">狀態</th>
                <th style="min-width:160px">單筆操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  
<script>
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const ADMIN_KEY_STORAGE = 'ADMIN_KEY';
function promptAdminKey(){
  var key = prompt('請輸入管理員金鑰');
  if (key){
    key = key.trim();
    if (key) sessionStorage.setItem(ADMIN_KEY_STORAGE, key);
  }
  return key ? key.trim() : '';
}
function getAdminKey(){
  var key = sessionStorage.getItem(ADMIN_KEY_STORAGE) || '';
  if (!key){
    key = promptAdminKey();
  }
  return key ? key.trim() : '';
}
function clearAdminKey(){
  try{ sessionStorage.removeItem(ADMIN_KEY_STORAGE); }catch(_){}
}
function authHeaders(extra){
  const headers = Object.assign({}, extra || {});
  const key = getAdminKey();
  if (!key) throw new Error('尚未輸入管理員金鑰');
  headers['x-admin-key'] = key;
  return headers;
}
async function authedFetch(url, options, retried){
  const opts = Object.assign({}, options || {});
  opts.headers = authHeaders(opts.headers || {});
  const res = await fetch(url, opts);
  if (res.status === 401 && retried !== true){
    clearAdminKey();
    alert('管理員金鑰錯誤或已過期，請重新輸入');
    const key = getAdminKey();
    if (!key) throw new Error('沒有管理員金鑰');
    return authedFetch(url, options, true);
  }
  return res;
}
const fmt = ts => ts ? new Date(ts).toLocaleString() : '';

let ORDERS = [];
let current = [];
let selected = new Set();

function toast(msg){
  const t = document.createElement('div');
  t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 1600);
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}


function normalizeProof(u){
  if (!u) return "";
  u = String(u).trim();
  if (/^https?:\/\//i.test(u) || /^\/api\/proof(?:\.inline|\.view)?\//.test(u)) return u;
  return '/api/proof/' + encodeURIComponent(u);
}


async function loadOrders(){
  try{
    const res = await authedFetch('/api/orders?limit=500', { cache:'no-store' });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    ORDERS = Array.isArray(data.orders) ? data.orders : [];
  }catch(e){
    ORDERS = [];
    console.error(e);
  }
  render();
}

function applyFilter(){
  const q  = $('#q').value.trim().toLowerCase();
  const st = $('#statusSel').value;
  let items = [...ORDERS];
  if (st) items = items.filter(o=> String(o.status||'') === st);
  if (q){
    items = items.filter(o=> JSON.stringify(o).toLowerCase().includes(q));
  }
  current = items;
  $('#count').textContent = `共 ${items.length} 筆`;
  const sort = $('#sortSel') ? $('#sortSel').value : 'time_desc';
  if (sort === 'time_desc') items.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  else if (sort === 'time_asc') items.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
  else if (sort === 'amt_desc') items.sort((a,b)=> amountNumber(b) - amountNumber(a));
  else if (sort === 'amt_asc') items.sort((a,b)=> amountNumber(a) - amountNumber(b));
  else if (sort === 'status') items.sort((a,b)=> String(a.status||'').localeCompare(String(b.status||'')));

}

function render(){
  applyFilter();
  const rows = current.map(o=> {
    const buyer = o.buyer || {};
    const shipment = o.shipment || {};
    const remarkVal = String(
      o.note || o.notes || o.remark || o.memo || o.comment ||
      (o.payment && (o.payment.note || o.payment.remark || o.payment.memo)) ||
      (buyer && (buyer.note || buyer.notes || buyer.remark || buyer.memo)) ||
      (o.transfer && (o.transfer.note || o.transfer.remark)) ||
      ''
    ).trim();
    const checked = selected.has(o.id) ? 'checked' : '';


const items = Array.isArray(o.items) ? o.items : [{
      productName:o.productName, productId:o.productId, price:o.price, qty:o.qty, deity:o.deity
    }];

    const itemsHtml = items.map(it => {
      const title = escapeHtml(it.productName || it.name || o.productName || it.title || '商品');
      const spec  = String(it.variantName || it.variant || it.spec || '').trim();
      const specLine = spec ? `｜規格：${escapeHtml(spec)}` : '';
      const qty   = Math.max(1, Number(it.qty || it.quantity || 1));
      const rawPrice = (it.price != null ? it.price : (it.unitPrice != null ? it.unitPrice : 0));
      const priceNum = Number(String(rawPrice).replace(/[^\d.]/g,'')) || 0;
      const sub   = priceNum * qty;
      return `<div style="margin:2px 0">
        <div><span class="mono">${title}</span></div>
        <div class="muted">單價：NT$ ${priceNum.toLocaleString('en-US')}${specLine}｜數量：${qty}｜小計：NT$ ${sub.toLocaleString('en-US')}</div>
      </div>`;
    }).join('');

    const amount = (function(){
      if (o.amount != null) {
        const n = Number(String(o.amount).replace(/[^\d.]/g,'')) || 0;
        return n.toLocaleString('en-US');
      }
      const sum = items.reduce((s,it)=>{
        const rawPrice = (it.price != null ? it.price : (it.unitPrice != null ? it.unitPrice : 0));
        const priceNum = Number(String(rawPrice).replace(/[^\d.]/g,'')) || 0;
        const qty   = Math.max(1, Number(it.qty || it.quantity || 1));
        return s + priceNum * qty;
      }, 0);
      return sum.toLocaleString('en-US');
    })();

    const payHtml = ((()=>{
      const m = String(o.method||'').trim();
      const ml = m.toLowerCase();
      const isBank = (ml === 'bank-transfer') || (ml === 'bank_transfer') || (ml === 'bank transfer') || /bank|轉帳|匯款/.test(ml);
      if (!isBank) return `<div>${escapeHtml(m)}</div>`;
      // --- bank-transfer 區塊（憑證 + 祈福照片） ---
      const last5 = String(o.transferLast5 || (o.transfer && (o.transfer.last5 || o.transfer.lastFive)) || '').trim() || '（未填）';
      let proof = o.receiptUrl || (o.transfer && o.transfer.proofUrl);
      proof = normalizeProof(proof);
      const parts = [
        `<div><span class="badge">轉帳匯款</span></div>`,
        `<div class="muted">後五碼：${escapeHtml(last5)}</div>`
      ];
      // 憑證連結
      try{
        let proofKey = '';
        if (proof){
          try {
            const u2 = new URL(proof, location.origin);
            proofKey = u2.pathname.replace(/^\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
          } catch {
            proofKey = (proof||'').replace(/^.*\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
          }
        }
        if (proofKey){
          const inlineUrl = `/api/proof.inline/${encodeURIComponent(proofKey)}`;
          const debugUrl  = `/api/proof/${encodeURIComponent(proofKey)}?debug=1`;
          parts.push(`<div class="muted"><a class="proofLink" data-src="${inlineUrl}" href="${inlineUrl}" target="_blank" rel="noopener noreferrer">查看憑證</a>　<a href="${debugUrl}" target="_blank" rel="noopener noreferrer" class="muted">（debug）</a></div>`);
        }
      }catch{}
      // ritual photo candidates (broadened, deep)
      function pickRitual(o){
        // direct fields
        let v = o.ritualPhotoUrl || o.ritual_photo_url || o.ritual_photo ||
                (o.ritual && (o.ritual.photoUrl || o.ritual.photo || o.ritual.url)) ||
                (o.transfer && (o.transfer.ritualPhotoUrl || o.transfer.ritual_photo || o.transfer.ritual)) ||
                (o.payment && (o.payment.ritualPhotoUrl || o.payment.ritual_photo));
        // explicit support for legacy path
        if (!v){
          v = o.extra && o.extra.candle && o.extra.candle.photoUrl;
        }
        // files/attachments array {url|path|key|id, role|type|kind|category|field|name}
        if (!v){
          const arr = Array.isArray(o.files) ? o.files : (Array.isArray(o.attachments) ? o.attachments : []);
          for (const f of arr){
            const role = (f.role || f.type || f.kind || f.category || f.field || f.name || '').toString();
            if (/ritual.*photo|photo.*ritual|ritual_photo|祈福/i.test(role) || /ritual|祈福/i.test((f.filename||'').toString())){
              v = f.url || f.path || f.key || f.id || '';
              if (v) break;
            }
          }
        }
        // meta/form style
        if (!v){
          const meta = o.meta || o.form || o.payload || {};
          v = meta.ritual_photo || meta.ritualPhoto || meta.ritualPhotoUrl || meta.ritual || '';
        }
        // deep search (depth <= 3) for any key that looks like ritual photo
        if (!v){
          const seen = new WeakSet();
          const keyRe = /(ritual.*photo|photo.*ritual|ritual_photo|ritualphoto|祈福)/i;
          const badRe = /(receipt|proof|invoice)/i;
          function dfs(node, depth){
            if (!node || typeof node !== 'object' || depth>3 || seen.has(node)) return '';
            seen.add(node);
            if (Array.isArray(node)){
              for (const el of node){
                const r = dfs(el, depth+1);
                if (r) return r;
              }
              return '';
            }
            for (const k of Object.keys(node)){
              const val = node[k];
              if (typeof val === 'string' && keyRe.test(k) && !badRe.test(k)){
                return val;
              }
            }
            for (const k of Object.keys(node)){
              const val = node[k];
              const r = dfs(val, depth+1);
              if (r) return r;
            }
            return '';
          }
          v = dfs(o, 0);
        }
        // normalize: keep http(s) or any absolute-path as-is; if it's a plain key, map to /api/proof/
        if (!v) return '';
        v = String(v).trim();
        if (/^https?:\/\//i.test(v) || /^\//.test(v)) return v;
        return '/api/proof/' + encodeURIComponent(v);
      }
      let ritual = pickRitual(o);
      // 祈福照片連結
      try{
        let ritualKey = '';
        if (ritual){
          try {
            const u3 = new URL(ritual, location.origin);
            const path = u3.pathname.replace(/\?.*$/,'');
            if (/^\/api\/proof(?:\.(?:view|inline))?\//.test(path)){
              ritualKey = path.replace(/^\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
            } else if (!/^https?:\/\//i.test(ritual) && !/^\//.test(ritual)) {
              // looks like a bare key (no scheme, no leading slash)
              ritualKey = ritual;
            } else {
              ritualKey = '';
            }
          } catch {
            ritualKey = ritual.replace(/^.*\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
          }
        }
        if (ritualKey){
          const rInline = `/api/proof.inline/${encodeURIComponent(ritualKey)}`;
          const rDebug  = `/api/proof/${encodeURIComponent(ritualKey)}?debug=1`;
          parts.push(`<div class="muted"><a class="proofLink" data-src="${rInline}" href="${rInline}" target="_blank" rel="noopener noreferrer">祈福照片</a>　<a href="${rDebug}" target="_blank" rel="noopener noreferrer" class="muted">（debug）</a></div>`);
        } else if (ritual){
          // 無法抽出 key 時，至少給原始連結
          parts.push(`<div class="muted"><a href="${escapeHtml(ritual)}" target="_blank" rel="noopener noreferrer">祈福照片</a></div>`);
        }
      }catch{}
      return parts.join('');
    }))();

    return `<tr data-id="${o.id}">
      <td><input class="checkbox rowcheck" type="checkbox" ${checked} data-id="${o.id}"></td>
      <td>
        <div><span class="badge">${o.id||''}</span></div>
        <div class="muted">${fmt(o.createdAt)}</div>
      </td>
      <td>${itemsHtml}</td>
      <td><strong>NT$ ${amount}</strong></td>
      <td>${payHtml}</td>
      <td>
  <div>${escapeHtml(buyer.name||"")}</div>
  ${ (buyer.phone||o.phone||buyer.tel||buyer.mobile) ? `<div class="muted">電話：${escapeHtml(buyer.phone||o.phone||buyer.tel||buyer.mobile)}</div>` : "" }
  ${ (buyer.email||o.email) ? `<div class="muted">Email：${escapeHtml(buyer.email||o.email)}</div>` : "" }
  ${ buyer.line ? `<div class="muted">LINE：${escapeHtml(buyer.line)}</div>` : "" }
  ${ (buyer.store||o.store) ? `<div class="muted">7-11 門市：${escapeHtml(buyer.store||o.store)}</div>` : "" }
  <div class="muted">備註：${escapeHtml(remarkVal) || '（無）'}</div>
</td>
      <td><span class="badge ${statusClass(o.status)}">${escapeHtml(o.status||"pending")}</span></td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <select class="opStatus" style="padding:6px 10px;border:1px solid #334155;border-radius:8px;background:#0b1022;color:#e5e7eb" data-id="${o.id}">
          <option value="">選擇狀態</option>
          <option value="已付款待出貨" ${String(o.status||"")=== "已付款待出貨" ? "selected":""}>已付款待出貨</option>
          <option value="已寄件" ${String(o.status||"")=== "已寄件" ? "selected":""}>已寄件</option>
          <option value="已完成訂單" ${String(o.status||"")=== "已完成訂單" ? "selected":""}>已完成訂單</option>
        </select>
        <button class="btn" data-act="applyStatus" data-id="${o.id}">套用</button>
        <button class="btn danger" data-act="singleDel" data-id="${o.id}">刪除</button>
        <button class="btn gold" data-act="addRitual" data-id="${o.id}">新增祈福成果</button>
        <button class="btn" data-act="copyResultLink" data-id="${o.id}">複製成果頁連結</button>
      </td>
    </tr>`;
  }).join('');
  $('#tbody').innerHTML = rows || '<tr><td colspan="8" class="muted">目前沒有訂單</td></tr>';
  hydrateProofThumbs();
function hydrateProofThumbs(){
  const thumbs = document.querySelectorAll('img.proofThumb[data-src]');
  thumbs.forEach(async (img)=>{
    const src = img.getAttribute('data-src');
    if (!src) return;
    // derive key from /api/proof or /api/proof.view or /api/proof.inline or raw
    let key = '';
    try {
      const u = new URL(src, location.origin);
      key = u.pathname.replace(/^\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
    } catch { key = src.replace(/^.*\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, ''); }
    try {
      const r = await fetch(`/api/proof.data/${key}`);
      const dataUrl = await r.text();
      if (/^data:image\//i.test(dataUrl)){
        img.src = dataUrl;    // 直接用 data URL 顯示
        img.alt = '憑證';
      } else {
        img.style.display = 'none';
        const link = img.nextElementSibling && img.nextElementSibling.matches('a.proofLink') ? img.nextElementSibling : null;
        if (link) link.style.display = 'inline';
      }
    } catch(e){
      img.style.display = 'none';
      const link = img.nextElementSibling && img.nextElementSibling.matches('a.proofLink') ? img.nextElementSibling : null;
      if (link) link.style.display = 'inline';
    }
  });
}
  updateSelCount();
  syncHeaderCheckbox();
}

function updateSelCount(){ $('#selCount').textContent = selected.size; }

function syncHeaderCheckbox(){
  const allVisibleIds = new Set(current.map(o=> o.id));
  const allChecked = current.length > 0 && current.every(o=> selected.has(o.id));
  $('#checkAll').checked = allChecked;
  for (const id of Array.from(selected)){
    if (!allVisibleIds.has(id)) selected.delete(id);
  }
  updateSelCount();
}

// --- Events ---
$('#reload').addEventListener('click', loadOrders);
$('#q').addEventListener('input', render);
$('#statusSel').addEventListener('change', render);

// Row checkbox toggle
document.addEventListener('change', e=>{
  const cb = e.target.closest && e.target.closest('.rowcheck');
  if (!cb) return;
  const id = cb.getAttribute('data-id');
  if (cb.checked) selected.add(id); else selected.delete(id);
  updateSelCount();
  syncHeaderCheckbox();
});

// Header check-all
$('#checkAll').addEventListener('change', e=>{
  if (e.target.checked){
    current.forEach(o=> selected.add(o.id));
  } else {
    current.forEach(o=> selected.delete(o.id));
  }
  render();
});

// --- PATCH 2/2: resilient admin call + remember ADMIN_KEY ---
function ensureAdminKey(){
  let k = getAdminKey();
  if (!k){
    k = getAdminKey();
  }
  return k;
}
async function postRitualResults(id, items){
  const key0 = ensureAdminKey();
  if (!key0) throw new Error('未提供 ADMIN_KEY');
  const payload = { orderId: id, items: items };
  const endpoints = [
    `/api/ritual_result?admin_key=${encodeURIComponent(key0)}`,
    `/api/order.results/${encodeURIComponent(id)}?admin_key=${encodeURIComponent(key0)}`,
    `/api/orders/${encodeURIComponent(id)}/results?admin_key=${encodeURIComponent(key0)}`
  ];
  async function tryOnce(url){
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // simple request, 避免 OPTIONS
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>({}));
    if (!res.ok || !j.ok){
      const msg = j && (j.error || j.message);
      const err = new Error(msg || ('HTTP '+res.status));
      err.status = res.status;
      throw err;
    }
    return j;
  }
  // attempt endpoints; on 401, clear key & prompt once to retry
  let lastErr = null;
  for (const url of endpoints){
    try{
      return await tryOnce(url);
    }catch(e){
      if (e && e.status === 401){
        clearAdminKey();
        const key1 = ensureAdminKey();
        if (!key1) throw new Error('未提供 ADMIN_KEY');
        const url2 = url.replace(/admin_key=[^&]*/,'admin_key='+encodeURIComponent(key1));
        try{ return await tryOnce(url2); }catch(e2){ lastErr = e2; }
      }else{
        lastErr = e;
      }
    }
  }
  throw lastErr || new Error('上傳失敗');
}

// Single row actions
document.addEventListener('click', async e=>{
  const btn = e.target.closest && e.target.closest('button[data-act]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-act');

  if (act === 'applyStatus'){
    const row = btn.closest('tr');
    const sel = row && row.querySelector('select.opStatus');
    if (!sel){ toast('找不到狀態選單'); return; }
    const status = sel.value;
    if (!status){ toast('請先選擇狀態'); return; }
    try{
      const res = await authedFetch('/api/order/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'set', id, status })
      });
      const j = await res.json().catch(()=>({}));
      if (!res.ok || !j.ok) throw new Error(j.error || ('HTTP '+res.status));
      const badge = row && row.querySelector('td:nth-child(7) .badge');
      if (badge) badge.textContent = status;
      if (row){
        row.classList.remove('mail-ok','mail-fail');
        if (j.notified) row.classList.add('mail-ok');
        else row.classList.add('mail-fail');
        const infoCell = row.querySelector('td:nth-child(2) .muted');
        if (infoCell){
          const stamp = new Date().toLocaleString('zh-TW',{hour12:false});
          infoCell.textContent = j.notified ? `通知信已寄出：${stamp}` : `未寄信：${stamp}`;
        }
      }
      const target = ORDERS.find(x=> x.id === id);
      if (target) target.status = status;
      toast(j.notified ? '狀態已更新，已寄出通知信' : '狀態已更新');
    }catch(err){
      toast('更新狀態失敗：' + (err && err.message || err));
    }
    return;
  }

  if (act === 'singleDel'){
    const row = btn.closest('tr');
    const titleCell = row ? row.querySelector('td:nth-child(3)') : null;
    const orderHint = titleCell ? titleCell.textContent.trim().slice(0, 60) : '';
    const ok = confirm(`確定要刪除訂單「${id}」嗎？\n${orderHint ? '商品：' + orderHint + '\n' : ''}此動作無法復原。`);
    if (!ok) return;
    try{
      const res = await authedFetch('/api/order/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, action:'delete' })
      });
      const j = await res.json().catch(()=>({}));
      if (!res.ok || !j.ok) throw new Error(j.error || ('HTTP '+res.status));
      toast('已刪除 1 筆');
      await loadOrders();
    }catch(err){
      toast('刪除失敗：' + (err && err.message || err));
    }
    return;
  }

  if (act === 'addRitual'){
    const url = prompt('請輸入成果圖片或影片網址（可多個以逗號分隔）');
    if (!url) return;
      const urls = url.split(',').map(s=>s.trim()).filter(Boolean).map(u=>({type:/\.mp4|\.mov|\.m4v|\.avi|\.webm/i.test(u)?'video':'image',url:u}));
    try{
      const j = await postRitualResults(id, urls);
      toast('已新增祈福成果');
      await loadOrders();
    }catch(err){
      toast('上傳失敗：' + (err && err.message || err));
    }
    return;
  }

  if (act === 'copyResultLink'){
    try{
      const token = (o=>o.resultToken||o.token||'')(ORDERS.find(x=>x.id===id)||{});
      if (!token){ toast('此訂單尚無成果頁 token'); return; }
      const full = `${location.origin}/o/${encodeURIComponent(id)}?token=${encodeURIComponent(token)}`;
      await navigator.clipboard.writeText(full);
      toast('已複製成果頁連結');
    }catch(e){ toast('複製失敗'); }
    return;
  }
});

// Batch: mark paid
$('#markPaid').addEventListener('click', async ()=>{
  if (selected.size === 0){ toast('請先選取訂單'); return; }
  let ok = 0;
  let notified = 0;
  for (const id of selected){
    try{
      const res = await authedFetch('/api/order/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, action:'set', status:'已付款待出貨' })
      });
      const j = await res.json().catch(()=>({}));
      if (res.ok && j && j.ok){
        ok++;
        if (j.notified) notified++;
      }
    }catch(_){}
  }
  toast('已標記已付款待出貨：' + ok + ' 筆' + (notified ? `（已寄出 ${notified} 封通知）` : ''));
  await loadOrders();
});

// Batch: mark shipped
$('#markShipped').addEventListener('click', async ()=>{
  if (selected.size === 0){ toast('請先選取訂單'); return; }
  let ok = 0;
  let notified = 0;
  for (const id of selected){
    try{
      const res = await authedFetch('/api/order/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, action:'set', status:'已寄件' })
      });
      const j = await res.json().catch(()=>({}));
      if (res.ok && j && j.ok){
        ok++;
        if (j.notified) notified++;
      }
    }catch(_){}
  }
  toast('已標記已出貨：' + ok + ' 筆' + (notified ? `（已寄出 ${notified} 封通知）` : ''));
  await loadOrders();
});

// Batch: mark done
$('#markDone').addEventListener('click', async ()=>{
  if (selected.size === 0){ toast('請先選取訂單'); return; }
  let ok = 0;
  let notified = 0;
  for (const id of selected){
    try{
      const res = await authedFetch('/api/order/status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, action:'set', status:'已完成訂單' })
      });
      const j = await res.json().catch(()=>({}));
      if (res.ok && j && j.ok){
        ok++;
        if (j.notified) notified++;
      }
    }catch(_){}
  }
  toast('已標記已完成訂單：' + ok + ' 筆' + (notified ? `（已寄出 ${notified} 封通知）` : ''));
  await loadOrders();
});

// Batch: delete
$('#batchDelete').addEventListener('click', async ()=>{
  if (selected.size === 0){ toast('請先選取訂單'); return; }
  let ok = 0;
  for (const id of selected){
    const res = await authedFetch('/api/order/status', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id, action:'delete' })
    });
    if (res.ok) ok++;
  }
  toast('已刪除：' + ok + ' 筆');
  selected.clear();
  await loadOrders();
});

// Export selected to CSV (use backend API so金額/備註/憑證網址都正確)
$('#exportCsv').addEventListener('click', ()=>{
  if (selected.size === 0){ toast('請先選取訂單'); return; }
  const ids = Array.from(selected).join(',');
  const key = getAdminKey();
  if (!key){ toast('尚未輸入管理員金鑰'); return; }
  const url = `/api/orders/export?ids=${encodeURIComponent(ids)}&admin_key=${encodeURIComponent(key)}`;
  // 直接開啟下載
  window.open(url, '_blank');
});

// Proof lightbox
document.addEventListener('click', async function(e){
  const a = e.target.closest && e.target.closest('a.proofLink');
  if (!a) return;
  e.preventDefault();
  const src = a.getAttribute('data-src') || '';
  if (!src) return;
  const m = document.getElementById('imgLightbox');
  const img = document.getElementById('imgLightboxImg');
  if (!m || !img) return;
  // derive key
  let key = '';
  try {
    const u = new URL(src, location.origin);
    key = u.pathname.replace(/^\/api\/proof(?:\.(?:view|inline))?\//,'').replace(/\?.*$/, '');
  } catch { key = src; }
  try {
    const r = await fetch(`/api/proof.data/${key}`);
    const dataUrl = await r.text();
    if (!/^data:image\//i.test(dataUrl)) throw new Error('not image data');
    img.src = dataUrl;
    m.style.display = 'flex';
  } catch(err){
    toast('憑證載入失敗，請點（debug）檢查');
  }
});
document.addEventListener('click', function(e){
  const m = e.target.closest && e.target.closest('#imgLightbox');
  if (!m) return;
  m.style.display = 'none';
  const img = document.getElementById('imgLightboxImg');
  if (img) img.src = '';
});


// helpers for badge color + amount sorting
function statusClass(s){
  const v = String(s||'').trim();
  if (v === '已付款待出貨') return 'status-paid';
  if (v === '已寄件') return 'status-shipped';
  if (v === '已完成訂單') return 'status-done';
  return '';
}
function amountNumber(o){

const items = Array.isArray(o.items) ? o.items : [{
    productName:o.productName, productId:o.productId, price:o.price, qty:o.qty, deity:o.deity
  }];
  if (o.amount != null){
    return Number(String(o.amount).replace(/[^\d.]/g,'')) || 0;
  }
  return items.reduce((s,it)=>{
    const rawPrice = (it.price != null ? it.price : (it.unitPrice != null ? it.unitPrice : 0));
    const priceNum = Number(String(rawPrice).replace(/[^\d.]/g,'')) || 0;
    const qty   = Math.max(1, Number(it.qty || it.quantity || 1));
    return s + priceNum * qty;
  }, 0);
}

// init
loadOrders();

// sort change
const sortSel = document.getElementById('sortSel');
if (sortSel) sortSel.addEventListener('change', render);

// auto refresh every 60s (pause if login gate showing)
let __autoTimer = setInterval(()=>{
  const gate = document.getElementById('loginGate');
  if (gate && gate.style.display === 'flex') return;
  loadOrders();
}, 60000);

// simple login gate using sessionStorage
(function(){
  const gate = document.getElementById('loginGate');
  if (!gate) return;
  const key = 'adminAuth';
  if (sessionStorage.getItem(key) === '1'){ gate.style.display='none'; return; }
  gate.style.display = 'flex';
  document.getElementById('loginOk').addEventListener('click', ()=>{
    const v = (document.getElementById('loginPwd').value||'').trim();
    if (v === '123'){ sessionStorage.setItem(key,'1'); gate.style.display='none'; loadOrders(); }
    else { alert('密碼錯誤'); }
  });
  document.getElementById('loginCancel').addEventListener('click', ()=>{
    gate.style.display='none'; // 允許查看但不載入資料
  });
})();

</script>

<!-- LINE客服橫幅樣式 -->
<style>
  .line-support-btn:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,185,0,.28); filter:saturate(1.05); }
  .line-support-btn:active{ transform:translateY(0); box-shadow:0 2px 6px rgba(0,185,0,.25); filter:saturate(1); }
  .line-support-btn:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(0,185,0,.15), 0 6px 14px rgba(0,185,0,.28); }
</style>

<div id="imgLightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:99999;align-items:center;justify-content:center;padding:20px">
  <img id="imgLightboxImg" src="" style="max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)">
</div>


<div id="loginGate">
  <div id="loginCard">
    <h2>後台登入</h2>
    <div class="muted">請輸入密碼以查看訂單</div>
    <input id="loginPwd" type="password" placeholder="輸入密碼">
    <div class="hint">預設密碼：123（之後可改為你的自訂密碼）</div>
    <div class="row">
      <button class="btn gold" id="loginOk">登入</button>
      <button class="btn" id="loginCancel">取消</button>
    </div>
  </div>
</div>
</body>
</html>	

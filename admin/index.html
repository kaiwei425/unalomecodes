<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="後台管理入口（僅限管理員）。">
<meta name="robots" content="noindex,nofollow">
<link rel="canonical" href="https://shop.unalomecodes.com/admin">
<title>unalomecodes | 懂玩泰國 - 後台 index</title>
<link rel="stylesheet" href="/css/admin-index.inline-1.css">
<script src="/js/admin-index.inline-1.js"></script>
<script src="/js/admin-guard.js" defer></script>
<link rel="stylesheet" href="/admin/admin-ui.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="/js/admin-shell.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="backLink">
    <a class="backBtn" href="/">← 返回入口首頁</a>
  </div>
  <header class="entry-hero">
    <div class="entry-hero-text">
      <div class="entry-eyebrow">控制中心</div>
      <h1>後台控制中心</h1>
      <div class="entry-chips">
        <span class="pill">訂單流程</span>
        <span class="pill alt">商品上架</span>
        <span class="pill">服務訂單</span>
      </div>
    </div>
    <div class="entry-actions">
      <a class="entry-action primary" href="/admin/orders">
        <span class="action-title">處理訂單</span>
        <span class="action-sub">付款 / 出貨</span>
      </a>
      <a class="entry-action" href="/admin/products">
        <span class="action-title">新增商品</span>
        <span class="action-sub">上架與庫存</span>
      </a>
      <a class="entry-action" href="/admin/service-orders">
        <span class="action-title">服務訂單</span>
        <span class="action-sub">祈福進度</span>
      </a>
      <a class="entry-action ghost" href="/admin/code-viewer">
        <span class="action-title">查看留言</span>
        <span class="action-sub">顧客回饋</span>
      </a>
    </div>
  </header>

  <section class="entry-section">
    <div class="section-head">
      <div>
        <h2>營運快覽</h2>
        <p class="muted">即時總覽重點數據</p>
      </div>
      <div class="section-note">
        <span>統計以台灣時間計算</span>
        <button class="btn ghost" id="refreshDashboardStats" type="button">重新整理</button>
      </div>
    </div>
    <div class="admin-stats" id="adminStats">
      <div class="admin-stat-card">
        <div class="admin-stat-title">商品總數</div>
        <div class="admin-stat-value" data-stat="products-total">—</div>
        <div class="admin-stat-sub" data-stat-sub="products-sub">載入中…</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-title">訂單總數</div>
        <div class="admin-stat-value" data-stat="orders-total">—</div>
        <div class="admin-stat-sub" data-stat-sub="orders-sub">載入中…</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-title">服務訂單總數</div>
        <div class="admin-stat-value" data-stat="service-orders-total">—</div>
        <div class="admin-stat-sub" data-stat-sub="service-orders-sub">載入中…</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-title">會員數</div>
        <div class="admin-stat-value" data-stat="members-total">—</div>
        <div class="admin-stat-sub" data-stat-sub="members-sub">載入中…</div>
      </div>
      <div class="admin-stat-card">
      <div class="admin-stat-title">優惠券使用（近 7 日）</div>
        <div class="admin-stat-value" data-stat="coupons-used">—</div>
        <div class="admin-stat-sub" data-stat-sub="coupons-sub">載入中…</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-title">今日入口瀏覽</div>
        <div class="admin-stat-value" data-stat="home-views-today">—</div>
        <div class="admin-stat-sub" data-stat-sub="home-views-sub">載入中…</div>
      </div>
    </div>
  </section>

  <section class="entry-section">
    <div class="section-head">
      <div>
        <h2>核心工作區</h2>
        <p class="muted">高頻任務集中處理</p>
      </div>
    </div>
    <div class="entry-grid">
      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">🧾</span>
            <h3>訂單 / 出貨</h3>
          </div>
          <span class="tag alt">訂單查詢 / 狀態更新</span>
        </div>
        <p class="muted">查看訂單、更新付款與出貨狀態，對齊客服與物流資訊。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/orders">進入訂單</a>
          <a class="btn ghost" href="/admin/orders" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">📦</span>
            <h3>商品管理</h3>
          </div>
          <span class="tag">新增 / 編輯 / 上架</span>
        </div>
        <p class="muted">維持原商品上架頁功能，可調整名稱、神祇代碼、分類、售價與規格。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/products">進入商品</a>
          <a class="btn ghost" href="/admin/products" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">🧿</span>
            <h3>服務訂單</h3>
          </div>
          <span class="tag">祈福進度 / 狀態更新</span>
        </div>
        <p class="muted">查看顧客的祈福訂單、更新進度並寄出通知，與實體訂單分開管理。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/service-orders">進入服務訂單</a>
          <a class="btn ghost" href="/admin/service-orders" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">💬</span>
            <h3>留言管理</h3>
          </div>
          <span class="tag alt">顧客分享 / 批次整理</span>
        </div>
        <p class="muted">依神祇代碼載入留言，支援圖片預覽與批次刪除，與前台故事同步。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/code-viewer">進入留言</a>
          <a class="btn ghost" href="/admin/code-viewer" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">📈</span>
            <h3>入口網流量</h3>
          </div>
          <span class="tag alt">入口首頁 / 來源</span>
        </div>
        <p class="muted">查看入口首頁每日瀏覽與來源概況。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/traffic">查看儀表板</a>
          <a class="btn ghost" href="/admin/traffic" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>
    </div>
  </section>

  <section class="entry-section">
    <div class="section-head">
      <div>
        <h2>數據監控</h2>
        <p class="muted">流量趨勢與營運報表</p>
      </div>
    </div>
    <div class="data-grid">
      <div class="data-stack">
        <div class="data-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <h3>入口首頁流量統計</h3>
            <div class="muted">
              總累積不重複訪客：<span id="homeTotal" class="stat-accent">—</span>
            </div>
          </div>
          <div style="position:relative;height:300px;width:100%;">
            <canvas id="homeChart"></canvas>
          </div>
        </div>

        <div class="data-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <h3>美食地圖流量統計</h3>
            <div class="muted">
              總累積不重複訪客：<span id="foodMapTotal" class="stat-accent">—</span>
            </div>
          </div>
          <div style="position:relative;height:300px;width:100%;">
            <canvas id="foodMapChart"></canvas>
          </div>
        </div>

        <div class="data-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <h3>寺廟地圖流量統計</h3>
            <div class="muted">
              總累積不重複訪客：<span id="templeMapTotal" class="stat-accent">—</span>
            </div>
          </div>
          <div style="position:relative;height:300px;width:100%;">
            <canvas id="templeMapChart"></canvas>
          </div>
        </div>

        <div class="data-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <h3>UTM 轉換統計</h3>
            <div class="muted">近 14 天</div>
          </div>
          <div class="report-kpis">
            <div class="report-kpi">
              <div class="label">實體商品轉換</div>
              <div class="value" data-report="utm-physical-total">—</div>
            </div>
            <div class="report-kpi">
              <div class="label">服務商品轉換</div>
              <div class="value" data-report="utm-service-total">—</div>
            </div>
          </div>
          <div class="report-lists">
            <div>
              <div class="tag">實體商品入口</div>
              <ul class="report-list" data-report-list="utm-physical-source"></ul>
            </div>
            <div>
              <div class="tag alt">服務商品入口</div>
              <ul class="report-list" data-report-list="utm-service-source"></ul>
            </div>
          </div>
          <div class="report-note">依 UTM source 統計，未帶參數視為 direct。</div>
        </div>
      </div>

      <section class="report-section data-card" id="reportSection">
        <div class="report-head">
          <h2>營運報表</h2>
          <div class="report-note">統計以台灣時間計算</div>
        </div>
        <div class="report-grid">
          <div class="report-card">
            <h3>實體商品</h3>
            <div class="report-kpis">
              <div class="report-kpi">
                <div class="label">今日營收</div>
                <div class="value" data-report="physical-rev-today">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">7 天營收</div>
                <div class="value" data-report="physical-rev-7">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">30 天營收</div>
                <div class="value" data-report="physical-rev-30">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">今日訂單</div>
                <div class="value" data-report="physical-ord-today">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">7 天訂單</div>
                <div class="value" data-report="physical-ord-7">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">30 天訂單</div>
                <div class="value" data-report="physical-ord-30">—</div>
              </div>
            </div>
            <div class="report-row"><span>訂單狀態</span><span data-report="physical-status">—</span></div>
            <div class="report-row"><span>掃描範圍</span><span data-report="physical-scan">—</span></div>
            <div class="report-lists">
              <div>
                <div class="tag">熱賣 TOP10</div>
                <ul class="report-list" data-report-list="physical-top"></ul>
              </div>
              <div>
                <div class="tag alt">低庫存</div>
                <ul class="report-list" data-report-list="physical-low"></ul>
              </div>
            </div>
          </div>
          <div class="report-card">
            <h3>服務商品</h3>
            <div class="report-kpis">
              <div class="report-kpi">
                <div class="label">今日營收</div>
                <div class="value" data-report="service-rev-today">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">7 天營收</div>
                <div class="value" data-report="service-rev-7">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">30 天營收</div>
                <div class="value" data-report="service-rev-30">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">今日訂單</div>
                <div class="value" data-report="service-ord-today">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">7 天訂單</div>
                <div class="value" data-report="service-ord-7">—</div>
              </div>
              <div class="report-kpi">
                <div class="label">30 天訂單</div>
                <div class="value" data-report="service-ord-30">—</div>
              </div>
            </div>
            <div class="report-row"><span>訂單狀態</span><span data-report="service-status">—</span></div>
            <div class="report-row"><span>掃描範圍</span><span data-report="service-scan">—</span></div>
            <div class="report-lists">
              <div>
                <div class="tag">熱賣 TOP10</div>
                <ul class="report-list" data-report-list="service-top"></ul>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </section>

  <section class="entry-section">
    <div class="section-head">
      <div>
        <h2>其他工具</h2>
        <p class="muted">維持營運的支援功能</p>
      </div>
    </div>
    <div class="entry-grid">
      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">🕯️</span>
            <h3>服務型商品</h3>
          </div>
          <span class="tag">蠟燭祈福 / 儀式服務</span>
        </div>
        <p class="muted">管理服務專區的上架內容，包含價格、介紹、包含項目與示意圖。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/service-products">管理服務</a>
          <a class="btn ghost" href="/admin/service-products" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">👤</span>
            <h3>會員管理</h3>
          </div>
          <span class="tag alt">登入紀錄 / 聯絡資料</span>
        </div>
        <p class="muted">查看使用者基本資料、預設聯絡方式、登入時間與門市偏好。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/members">進入會員</a>
          <a class="btn ghost" href="/admin/members" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">📊</span>
            <h3>日籤領取統計</h3>
          </div>
          <span class="tag">每日唯一領取人數</span>
        </div>
        <p class="muted">查看每天「領取日籤」的使用人數，支援自訂天數。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/fortune-stats">查看統計</a>
          <a class="btn ghost" href="/admin/fortune-stats" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>

      <article class="entry-card">
        <div class="entry-card-head">
          <div class="entry-card-title">
            <span class="entry-icon">🎟️</span>
            <h3>優惠券產生器</h3>
          </div>
          <span class="tag alt">建立 / 管理優惠券</span>
        </div>
        <p class="muted">在本域直接產生、管理優惠券，避免被瀏覽器阻擋外站。</p>
        <div class="entry-card-actions">
          <a class="btn primary" href="/admin/coupons">開啟優惠券工具</a>
          <a class="btn ghost" href="/admin/coupons" target="_blank" rel="noopener">新分頁 ↗</a>
        </div>
      </article>
    </div>
  </section>

  <div class="footer">需要新增模組？保留此入口並加入新卡片連結即可。</div>
</div>

<script src="/js/admin-index.inline-2.js"></script>
<script>
  // 補丁：獨立抓取入口首頁 (home_view) 的數據並渲染圖表
  (function() {
    const API_BASE = 'https://coupon-service.kaiwei425.workers.dev';
    
    async function fetchHomeStats() {
      try {
        const token = localStorage.getItem('admin_token');
        if (!token) return;

        // 抓取 home_view 趨勢數據 (14天)
        const res = await fetch(`${API_BASE}/admin/stats/trend?event=home_view&days=14`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) return;
        const data = await res.json();
        // 預期 data 結構: { today: number, total: number, history: [{date: string, count: number}] }

        // 1. 更新今日數據卡片
        const todayEl = document.querySelector('[data-stat="home-views-today"]');
        const subEl = document.querySelector('[data-stat-sub="home-views-sub"]');
        if (todayEl) todayEl.textContent = (data.today || 0).toLocaleString();
        if (subEl) subEl.textContent = '已更新';

        // 2. 更新圖表區總數
        const totalEl = document.getElementById('homeTotal');
        if (totalEl) totalEl.textContent = (data.total || 0).toLocaleString();

        // 3. 繪製圖表
        const ctx = document.getElementById('homeChart');
        if (ctx && data.history && window.Chart) {
          // 如果已經有實例則銷毀 (避免重複渲染)
          const existingChart = Chart.getChart(ctx);
          if (existingChart) existingChart.destroy();

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.history.map(h => h.date),
              datasets: [{
                label: '瀏覽人次',
                data: data.history.map(h => h.count),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                x: { grid: { display: false } }
              },
              interaction: { intersect: false, mode: 'index' }
            }
          });
        }
      } catch (err) {
        console.error('Home stats fetch error:', err);
        const subEl = document.querySelector('[data-stat-sub="home-views-sub"]');
        if (subEl) subEl.textContent = '載入失敗';
      }
    }

    // 頁面載入後執行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fetchHomeStats);
    } else {
      fetchHomeStats();
    }
  })();
</script>
</body>
</html>

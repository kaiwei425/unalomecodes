<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="å¾Œå°ç®¡ç†å…¥å£ï¼ˆåƒ…é™ç®¡ç†å“¡ï¼‰ã€‚">
<meta name="robots" content="noindex,nofollow">
<link rel="canonical" href="https://shop.unalomecodes.com/admin">
<title>å¾Œå°å…¥å£ï½œunalomecodes</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap');
:root{
  --bg:#f7f8fb;
  --fg:#0f172a;
  --muted:#6b7280;
  --panel:#ffffff;
  --line:#e5e7eb;
  --accent:#2563eb;
  --accent-2:#10b981;
  --card-shadow:0 16px 40px rgba(15,23,42,.08);
}
*{box-sizing:border-box;}
html,body{
  margin:0;padding:0;min-height:100%;
  font-family:"Space Grotesk","Segoe UI",system-ui,-apple-system,sans-serif;
  background:radial-gradient(circle at 15% 20%, rgba(37,99,235,.08), transparent 30%), radial-gradient(circle at 85% 10%, rgba(16,185,129,.08), transparent 26%), var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
}
.wrap{max-width:1200px;margin:0 auto;padding:28px 18px 36px;}
.backLink{margin-bottom:14px;}
.backBtn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:999px;
  background:#fff;border:1px solid var(--line);color:var(--fg);
  text-decoration:none;font-weight:700;font-size:13px;
  box-shadow:0 6px 16px rgba(15,23,42,.08);
  transition:all .18s ease;
}
.backBtn:hover{border-color:#93c5fd;color:#2563eb;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:var(--panel);border:1px solid var(--line);border-radius:16px;
  padding:14px 16px;box-shadow:var(--card-shadow);
}
.brand{display:flex;align-items:center;gap:10px;}
.brand-badge{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#2563eb,#10b981);display:grid;place-items:center;color:#fff;font-weight:800;font-size:16px;}
.brand h1{margin:0;font-size:20px;letter-spacing:.3px;}
.brand .muted{margin:0;font-size:13px;}
.nav{display:flex;gap:10px;flex-wrap:wrap;}
.nav a{
  text-decoration:none;
  color:var(--fg);
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:999px;
  padding:8px 12px;
  font-weight:700;
  display:inline-flex;align-items:center;gap:8px;
  box-shadow:0 6px 16px rgba(15,23,42,.08);
  transition:all .18s ease;
}
.nav a:hover{transform:translateY(-1px);border-color:#c7d2fe;}
.grid{
  margin-top:18px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:14px;
}
.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  box-shadow:var(--card-shadow);
  transition:all .2s ease;
}
.card:hover{transform:translateY(-3px);border-color:#bfdbfe;box-shadow:0 20px 40px rgba(15,23,42,.12);}
.card h3{margin:0;font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px;}
.tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);}
.tag::before{content:"â—";color:var(--accent);font-size:10px;}
.muted{color:var(--muted);font-size:14px;}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto;}
.btn{
  appearance:none;border:1px solid var(--line);background:#eff6ff;color:#0f172a;
  border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:800;font-size:14px;
  text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:6px;
  transition:all .18s ease;
}
.btn:hover{transform:translateY(-1px);border-color:#c7d2fe;box-shadow:0 10px 20px rgba(15,23,42,.08);}
.btn.primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);border-color:#1d4ed8;color:#fff;}
.footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center;}
.report-section{margin-top:18px;}
.report-head{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.report-head h2{margin:0;font-size:20px;font-weight:800;}
.report-grid{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;}
.report-card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--card-shadow);display:grid;gap:12px;}
.report-card h3{margin:0;font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px;}
.report-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.report-kpi{border:1px solid var(--line);border-radius:12px;padding:10px;background:#f8fafc;}
.report-kpi .label{font-size:12px;color:var(--muted);}
.report-kpi .value{font-size:16px;font-weight:800;margin-top:4px;}
.report-row{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:var(--muted);}
.report-lists{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
.report-list{list-style:none;margin:0;padding:0;display:grid;gap:6px;}
.report-list li{display:flex;justify-content:space-between;gap:8px;font-size:13px;color:#0f172a;}
.report-list li.empty{color:var(--muted);}
.report-list .name{font-weight:700;}
.report-note{font-size:12px;color:var(--muted);}
  html.admin-guard-hide{visibility:hidden;}
</style>
<script>document.documentElement.classList.add('admin-guard-hide');</script>
<script src="/js/admin-guard.js" defer></script>
<link rel="stylesheet" href="/admin/admin-ui.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/js/admin-shell.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="backLink">
    <a class="backBtn" href="https://shop.unalomecodes.com/shop">â† è¿”å›å•†å“é¦–é </a>
  </div>
  <div class="topbar">
    <div class="brand">
      <div class="brand-badge">UA</div>
      <div>
        <h1>unalomecodes å¾Œå°</h1>
      </div>
    </div>
    <div class="nav">
      <a href="/admin/products">ğŸ“¦ å•†å“</a>
      <a href="/admin/code-viewer">ğŸ’¬ ç•™è¨€</a>
      <a href="/admin/orders">ğŸ“‘ è¨‚å–®</a>
      <a href="/admin/members">ğŸ‘¤ æœƒå“¡</a>
      <a href="/admin/fortune-stats">ğŸ“Š æ—¥ç±¤çµ±è¨ˆ</a>
      <a href="/admin/service-products">ğŸ•¯ æœå‹™å•†å“</a>
      <a href="/admin/service-orders">ğŸ§¾ æœå‹™è¨‚å–®</a>
    </div>
  </div>

  <div class="admin-stats" id="adminStats">
    <div class="admin-stat-card">
      <div class="admin-stat-title">å•†å“ç¸½æ•¸</div>
      <div class="admin-stat-value" data-stat="products-total">â€”</div>
      <div class="admin-stat-sub" data-stat-sub="products-sub">è¼‰å…¥ä¸­â€¦</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-title">è¨‚å–®ç¸½æ•¸</div>
      <div class="admin-stat-value" data-stat="orders-total">â€”</div>
      <div class="admin-stat-sub" data-stat-sub="orders-sub">è¼‰å…¥ä¸­â€¦</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-title">æœƒå“¡æ•¸</div>
      <div class="admin-stat-value" data-stat="members-total">â€”</div>
      <div class="admin-stat-sub" data-stat-sub="members-sub">è¼‰å…¥ä¸­â€¦</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-title">å„ªæƒ åˆ¸ä½¿ç”¨</div>
      <div class="admin-stat-value" data-stat="coupons-used">â€”</div>
      <div class="admin-stat-sub" data-stat-sub="coupons-sub">è¼‰å…¥ä¸­â€¦</div>
    </div>
  </div>

  <div class="card" style="margin-top:18px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="margin:0;">ç¾é£Ÿåœ°åœ–æµé‡çµ±è¨ˆ</h3>
      <div class="muted">
        ç¸½ç´¯ç©ä¸é‡è¤‡è¨ªå®¢ï¼š<strong id="foodMapTotal" style="color:var(--accent);font-size:18px;">â€”</strong>
      </div>
    </div>
    <div style="position:relative;height:300px;width:100%;">
      <canvas id="foodMapChart"></canvas>
    </div>
  </div>

  <section class="report-section" id="reportSection">
    <div class="report-head">
      <h2>ç‡Ÿé‹å ±è¡¨</h2>
      <div class="report-note">çµ±è¨ˆä»¥å°ç£æ™‚é–“è¨ˆç®—</div>
    </div>
    <div class="report-grid">
      <div class="report-card">
        <h3>å¯¦é«”å•†å“</h3>
        <div class="report-kpis">
          <div class="report-kpi">
            <div class="label">ä»Šæ—¥ç‡Ÿæ”¶</div>
            <div class="value" data-report="physical-rev-today">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">7 å¤©ç‡Ÿæ”¶</div>
            <div class="value" data-report="physical-rev-7">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">30 å¤©ç‡Ÿæ”¶</div>
            <div class="value" data-report="physical-rev-30">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">ä»Šæ—¥è¨‚å–®</div>
            <div class="value" data-report="physical-ord-today">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">7 å¤©è¨‚å–®</div>
            <div class="value" data-report="physical-ord-7">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">30 å¤©è¨‚å–®</div>
            <div class="value" data-report="physical-ord-30">â€”</div>
          </div>
        </div>
        <div class="report-row"><span>è¨‚å–®ç‹€æ…‹</span><span data-report="physical-status">â€”</span></div>
        <div class="report-row"><span>æƒæç¯„åœ</span><span data-report="physical-scan">â€”</span></div>
        <div class="report-lists">
          <div>
            <div class="tag">ç†±è³£ TOP10</div>
            <ul class="report-list" data-report-list="physical-top"></ul>
          </div>
          <div>
            <div class="tag">ä½åº«å­˜</div>
            <ul class="report-list" data-report-list="physical-low"></ul>
          </div>
        </div>
      </div>
      <div class="report-card">
        <h3>æœå‹™å•†å“</h3>
        <div class="report-kpis">
          <div class="report-kpi">
            <div class="label">ä»Šæ—¥ç‡Ÿæ”¶</div>
            <div class="value" data-report="service-rev-today">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">7 å¤©ç‡Ÿæ”¶</div>
            <div class="value" data-report="service-rev-7">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">30 å¤©ç‡Ÿæ”¶</div>
            <div class="value" data-report="service-rev-30">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">ä»Šæ—¥è¨‚å–®</div>
            <div class="value" data-report="service-ord-today">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">7 å¤©è¨‚å–®</div>
            <div class="value" data-report="service-ord-7">â€”</div>
          </div>
          <div class="report-kpi">
            <div class="label">30 å¤©è¨‚å–®</div>
            <div class="value" data-report="service-ord-30">â€”</div>
          </div>
        </div>
        <div class="report-row"><span>è¨‚å–®ç‹€æ…‹</span><span data-report="service-status">â€”</span></div>
        <div class="report-row"><span>æƒæç¯„åœ</span><span data-report="service-scan">â€”</span></div>
        <div class="report-lists">
          <div>
            <div class="tag">ç†±è³£ TOP10</div>
            <ul class="report-list" data-report-list="service-top"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <div class="card">
      <h3>å•†å“ç®¡ç†</h3>
      <div class="tag">æ–°å¢ / ç·¨è¼¯ / ä¸Šæ¶ä¸‹æ¶</div>
      <p class="muted">ç¶­æŒåŸå•†å“ä¸Šæ¶é åŠŸèƒ½ï¼Œå¯èª¿æ•´åç¨±ã€ç¥ç¥‡ä»£ç¢¼ã€åˆ†é¡ã€å”®åƒ¹èˆ‡è¦æ ¼ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/products">é€²å…¥å•†å“</a>
        <a class="btn" href="/admin/products" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>ç•™è¨€ç®¡ç†</h3>
      <div class="tag">é¡§å®¢åˆ†äº« / å–®ç­†åˆªé™¤ / å…¨åˆª</div>
      <p class="muted">ä¾ç¥ç¥‡ä»£ç¢¼è¼‰å…¥ç•™è¨€ï¼Œæ”¯æ´åœ–ç‰‡é è¦½èˆ‡æ‰¹æ¬¡åˆªé™¤ï¼Œèˆ‡å‰å°æ•…äº‹åŒæ­¥ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/code-viewer">é€²å…¥ç•™è¨€</a>
        <a class="btn" href="/admin/code-viewer" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>è¨‚å–® / å‡ºè²¨</h3>
      <div class="tag">è¨‚å–®æŸ¥è©¢ / ç‹€æ…‹æ›´æ–°</div>
      <p class="muted">æŸ¥çœ‹è¨‚å–®ã€æ›´æ–°ä»˜æ¬¾èˆ‡å‡ºè²¨ç‹€æ…‹ï¼Œå°é½Šå®¢æœèˆ‡ç‰©æµè³‡è¨Šã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/orders">é€²å…¥è¨‚å–®</a>
        <a class="btn" href="/admin/orders" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>æœå‹™å‹å•†å“</h3>
      <div class="tag">è Ÿç‡­ç¥ˆç¦ / å„€å¼æœå‹™</div>
      <p class="muted">ç®¡ç†æœå‹™å°ˆå€çš„ä¸Šæ¶å…§å®¹ï¼ŒåŒ…å«åƒ¹æ ¼ã€ä»‹ç´¹ã€åŒ…å«é …ç›®èˆ‡ç¤ºæ„åœ–ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/service-products">ç®¡ç†æœå‹™</a>
        <a class="btn" href="/admin/service-products" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>æœå‹™è¨‚å–®</h3>
      <div class="tag">ç¥ˆç¦é€²åº¦ / ç‹€æ…‹æ›´æ–°</div>
      <p class="muted">æŸ¥çœ‹é¡§å®¢çš„ç¥ˆç¦è¨‚å–®ã€æ›´æ–°é€²åº¦ä¸¦å¯„å‡ºé€šçŸ¥ï¼Œèˆ‡å¯¦é«”è¨‚å–®åˆ†é–‹ç®¡ç†ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/service-orders">é€²å…¥æœå‹™è¨‚å–®</a>
        <a class="btn" href="/admin/service-orders" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>æœƒå“¡ç®¡ç†</h3>
      <div class="tag">ç™»å…¥ç´€éŒ„ / è¯çµ¡è³‡æ–™</div>
      <p class="muted">æŸ¥çœ‹ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™ã€é è¨­è¯çµ¡æ–¹å¼ã€ç™»å…¥æ™‚é–“èˆ‡é–€å¸‚åå¥½ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/members">é€²å…¥æœƒå“¡</a>
        <a class="btn" href="/admin/members" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>æ—¥ç±¤é ˜å–çµ±è¨ˆ</h3>
      <div class="tag">æ¯æ—¥å”¯ä¸€é ˜å–äººæ•¸</div>
      <p class="muted">æŸ¥çœ‹æ¯å¤©ã€Œé ˜å–æ—¥ç±¤ã€çš„ä½¿ç”¨äººæ•¸ï¼Œæ”¯æ´è‡ªè¨‚å¤©æ•¸ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/fortune-stats">æŸ¥çœ‹çµ±è¨ˆ</a>
        <a class="btn" href="/admin/fortune-stats" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>

    <div class="card">
      <h3>å„ªæƒ åˆ¸ç”¢ç”Ÿå™¨</h3>
      <div class="tag">å»ºç«‹ / ç®¡ç†å„ªæƒ åˆ¸</div>
      <p class="muted">åœ¨æœ¬åŸŸç›´æ¥ç”¢ç”Ÿã€ç®¡ç†å„ªæƒ åˆ¸ï¼Œé¿å…è¢«ç€è¦½å™¨é˜»æ“‹å¤–ç«™ã€‚</p>
      <div class="actions">
        <a class="btn primary" href="/admin/coupons">é–‹å•Ÿå„ªæƒ åˆ¸å·¥å…·</a>
        <a class="btn" href="/admin/coupons" target="_blank" rel="noopener">æ–°åˆ†é </a>
      </div>
    </div>
  </div>

  <div class="footer">éœ€è¦æ–°å¢æ¨¡çµ„ï¼Ÿä¿ç•™æ­¤å…¥å£ä¸¦åŠ å…¥æ–°å¡ç‰‡é€£çµå³å¯ã€‚</div>
</div>

<script>
(function(){
  const box = document.getElementById('adminStats');
  if (!box) return;
  const maxDashboardAttempts = 3;
  const retryDelay = (attempt) => 1400 * (attempt + 1);
  const set = (key, value) => {
    const el = box.querySelector(`[data-stat="${key}"]`);
    if (el) el.textContent = value;
  };
  const setSub = (key, value) => {
    const el = box.querySelector(`[data-stat-sub="${key}"]`);
    if (el) el.textContent = value;
  };
  const fmtNum = (n)=> Number(n || 0).toLocaleString('zh-TW');
  const fmtMoney = (n)=> `NT$ ${fmtNum(Math.round(Number(n || 0) || 0))}`;
  const esc = (val)=>{
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
    return String(val || '').replace(/[&<>"']/g, m => map[m] || m);
  };
  const setReport = (key, value)=>{
    const el = document.querySelector(`[data-report="${key}"]`);
    if (el) el.textContent = value;
  };
  const renderList = (key, items, formatter)=>{
    const el = document.querySelector(`[data-report-list="${key}"]`);
    if (!el) return;
    if (!items || !items.length){
      el.innerHTML = '<li class="empty">å°šç„¡è³‡æ–™</li>';
      return;
    }
    el.innerHTML = items.map(formatter).join('');
  };
  const markReportLoading = ()=>{
    setSub('products-sub', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setSub('orders-sub', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setSub('members-sub', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setSub('coupons-sub', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setReport('physical-status', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setReport('service-status', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setReport('physical-scan', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
    setReport('service-scan', 'çµ±è¨ˆæ›´æ–°ä¸­â€¦');
  };
  const applyDashboard = (data)=>{
    const s = data.stats || {};
    set('products-total', s.products ? s.products.total : 'â€”');
    setSub('products-sub', s.products ? `ä¸Šæ¶ ${s.products.active || 0}ï½œä½åº«å­˜ ${s.products.lowStock || 0}` : 'â€”');
    set('orders-total', s.orders ? s.orders.total : 'â€”');
    setSub('orders-sub', s.orders ? `æ–°è¨‚å–® ${s.orders.pending || 0}ï½œå·²ç¢ºèªä»˜æ¬¾ ${s.orders.paid || 0}ï½œå·²å®Œæˆè¨‚å–® ${s.orders.done || 0}` : 'â€”');
    set('members-total', s.members ? s.members.total : 'â€”');
    setSub('members-sub', s.members && s.members.approx ? 'è³‡æ–™é‡è¼ƒå¤§ï¼Œé¡¯ç¤ºä¼°ç®—' : 'åŒæ­¥å®Œæˆ');
    if (s.coupons){
      set('coupons-used', `${s.coupons.used || 0}/${s.coupons.total || 0}`);
      setSub('coupons-sub', s.coupons.approx ? 'è³‡æ–™é‡è¼ƒå¤§ï¼Œé¡¯ç¤ºä¼°ç®—' : 'ä½¿ç”¨ç‡çµ±è¨ˆ');
    }

    const r = data.reports || {};
    const limits = data.limits || {};
    const physical = r.physical || {};
    const service = r.service || {};
    setReport('physical-rev-today', fmtMoney(physical.revenue?.today));
    setReport('physical-rev-7', fmtMoney(physical.revenue?.last7));
    setReport('physical-rev-30', fmtMoney(physical.revenue?.last30));
    setReport('physical-ord-today', fmtNum(physical.orders?.today));
    setReport('physical-ord-7', fmtNum(physical.orders?.last7));
    setReport('physical-ord-30', fmtNum(physical.orders?.last30));
    setReport('physical-status', `æ–°è¨‚å–® ${fmtNum(physical.status?.pending)}ï½œå·²ç¢ºèªä»˜æ¬¾ ${fmtNum(physical.status?.paid)}ï½œå·²å®Œæˆè¨‚å–® ${fmtNum(physical.status?.done)}`);
    setReport('physical-scan', physical.approx ? `è³‡æ–™é‡è¼ƒå¤§ï¼Œçµ±è¨ˆå‰ ${fmtNum(limits.scanLimit || 0)} ç­†` : 'å®Œæ•´çµ±è¨ˆ');

    setReport('service-rev-today', fmtMoney(service.revenue?.today));
    setReport('service-rev-7', fmtMoney(service.revenue?.last7));
    setReport('service-rev-30', fmtMoney(service.revenue?.last30));
    setReport('service-ord-today', fmtNum(service.orders?.today));
    setReport('service-ord-7', fmtNum(service.orders?.last7));
    setReport('service-ord-30', fmtNum(service.orders?.last30));
    setReport('service-status', `æ–°è¨‚å–® ${fmtNum(service.status?.pending)}ï½œå·²ç¢ºèªä»˜æ¬¾ ${fmtNum(service.status?.paid)}ï½œå·²å®Œæˆè¨‚å–® ${fmtNum(service.status?.done)}`);
    setReport('service-scan', service.approx ? `è³‡æ–™é‡è¼ƒå¤§ï¼Œçµ±è¨ˆå‰ ${fmtNum(limits.scanLimit || 0)} ç­†` : 'å®Œæ•´çµ±è¨ˆ');

    renderList('physical-top', physical.topItems, (item)=>{
      const name = esc(item.name || 'å•†å“');
      const qty = fmtNum(item.qty || 0);
      return `<li><span class="name">${name}</span><span>Ã— ${qty}</span></li>`;
    });
    renderList('physical-low', physical.lowStock, (item)=>{
      const name = esc(item.name || 'å•†å“');
      const stock = fmtNum(item.stock || 0);
      return `<li><span class="name">${name}</span><span>åº«å­˜ ${stock}</span></li>`;
    });
    renderList('service-top', service.topItems, (item)=>{
      const name = esc(item.name || 'æœå‹™å•†å“');
      const qty = fmtNum(item.qty || 0);
      return `<li><span class="name">${name}</span><span>Ã— ${qty}</span></li>`;
    });
  };
  const loadDashboard = (attempt = 0)=>{
    fetch('/api/admin/dashboard', { credentials:'include', cache:'no-store' })
      .then(res => res.json().catch(()=>({})).then(data => ({ ok: res.ok, data })))
      .then(({ ok, data })=>{
        if (!ok || !data || data.ok === false) throw new Error((data && data.error) || 'load_failed');
        const hasStats = data && data.stats && Object.keys(data.stats).length > 0;
        if (data && data.fromCache === false && !hasStats){
          markReportLoading();
          if (attempt < maxDashboardAttempts){
            setTimeout(()=> loadDashboard(attempt + 1), retryDelay(attempt));
          }
          return;
        }
        applyDashboard(data);
      })
      .catch(()=>{
        const subs = box.querySelectorAll('[data-stat-sub]');
        subs.forEach(el => { el.textContent = 'æš«æ™‚ç„¡æ³•è¼‰å…¥'; });
      });
  };
  loadDashboard();

  // Load Food Map Stats
  const ctx = document.getElementById('foodMapChart');
  const totalEl = document.getElementById('foodMapTotal');
  if (ctx) {
    fetch('/api/admin/food-stats?days=14', { credentials:'include', cache:'no-store' })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) return;
        if (totalEl) totalEl.textContent = (data.total || 0).toLocaleString() + ' äºº';
        
        const labels = (data.stats || []).map(s => s.date.slice(5)); // MM-DD
        const counts = (data.stats || []).map(s => s.count);
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'æ¯æ—¥ä¸é‡è¤‡è¨ªå®¢',
              data: counts,
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37,99,235,0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#ffffff',
              pointBorderColor: '#2563eb',
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(15,23,42,0.9)',
                titleColor: '#e2e8f0',
                bodyColor: '#e2e8f0',
                borderColor: 'rgba(255,255,255,0.1)',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' },
                ticks: { stepSize: 1, font: { size: 11 } }
              },
              x: {
                grid: { display: false },
                ticks: { font: { size: 11 } }
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
      })
      .catch(console.error);
  }
})();
</script>
</body>
</html>

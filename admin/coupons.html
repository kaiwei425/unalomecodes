<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>å„ªæƒ åˆ¸å·¥å…·ï½œunalomecodes</title>
<style>
  :root{
    --bg:#f7f8fb;--fg:#0f172a;--muted:#6b7280;--panel:#ffffff;--line:#e5e7eb;--accent:#2563eb;--accent2:#10b981;
    --shadow:0 18px 40px rgba(15,23,42,.12);
  }
  *{box-sizing:border-box;}body{margin:0;font-family:"Space Grotesk","Segoe UI",system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--fg);}
  .wrap{max-width:960px;margin:0 auto;padding:20px 16px 36px;}
  .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
  .top h1{margin:0;font-size:22px;font-weight:800;}
  .top .muted{margin:0;font-size:13px;color:var(--muted);}
  .top-actions{display:flex;gap:8px;flex-wrap:wrap;}
  .pill-link{
    text-decoration:none;
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 12px;border-radius:999px;
    background:#fff;border:1px solid var(--line);color:var(--fg);
    font-weight:700;font-size:13px;
    box-shadow:0 10px 24px rgba(15,23,42,.08);
    transition:all .18s ease;
  }
  .pill-link:hover{border-color:#bfdbfe;color:#2563eb;transform:translateY(-1px);}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:14px;}
  label{display:block;font-weight:700;font-size:13px;margin-bottom:6px;color:#0f172a;}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff;}
  select:disabled{background:#f8fafc;color:#94a3b8;}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}
  button{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:800;font-size:15px;cursor:pointer;}
  .btn-primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;box-shadow:0 10px 24px rgba(37,99,235,.25);}
  .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--fg);}
  .result{margin-top:12px;padding:12px;border-radius:12px;border:1px solid #bbf7d0;background:#f0fdf4;color:#166534;font-weight:700;word-break:break-all;}
  .error{margin-top:12px;padding:12px;border-radius:12px;border:1px solid #fecdd3;background:#fff1f2;color:#b91c1c;font-weight:700;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;}
  table{width:100%;border-collapse:collapse;margin-top:14px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;}
  th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left;}
  th{background:#f8fafc;color:#475569;font-weight:800;}
  tbody tr:hover{background:#f1f5f9;}
  .status-used{color:#b91c1c;font-weight:700;}
  .status-new{color:#166534;font-weight:700;}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 6px;}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;}
  html.admin-guard-hide{visibility:hidden;}
</style>
<script>document.documentElement.classList.add('admin-guard-hide');</script>
<script src="/js/admin-guard.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>å„ªæƒ åˆ¸å·¥å…·</h1>
      <p class="muted">æ”¯æ´ç¥ç¥‡åˆ¸ã€å…¨é¤¨åˆ¸ã€å…é‹åˆ¸èˆ‡æ‰¹æ¬¡ç™¼æ”¾ã€‚</p>
    </div>
    <div class="top-actions">
      <a class="pill-link" href="./index.html">â† è¿”å›å¾Œå°é¦–é </a>
      <a class="pill-link" href="/shop.html">ğŸ  å•†å“é¦–é </a>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label for="cpnType">åˆ¸ç¨®</label>
        <select id="cpnType">
          <option value="DEITY">å–®ä¸€ç¥ç¥‡åˆ¸</option>
          <option value="ALL">å…¨é¤¨æŠ˜æ‰£åˆ¸</option>
          <option value="SHIP">å…é‹åˆ¸</option>
        </select>
      </div>
      <div>
        <label for="cpnDeity">å®ˆè­·ç¥ä»£ç¢¼</label>
        <select id="cpnDeity">
          <option value="">è¼‰å…¥å®ˆè­·ç¥æ¸…å–®ä¸­...</option>
        </select>
      </div>
      <div>
        <label for="cpnAmount">æŠ˜æŠµé‡‘é¡ï¼ˆNT$ï¼‰</label>
        <input id="cpnAmount" type="number" min="1" value="200">
      </div>
      <div>
        <label for="cpnStart">ç”Ÿæ•ˆæ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
        <input id="cpnStart" type="datetime-local">
      </div>
      <div>
        <label for="cpnExpire">åˆ°æœŸæ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
        <input id="cpnExpire" type="datetime-local">
      </div>
    </div>
    <div class="actions" style="margin-top:14px;">
      <button class="btn-primary" id="btnIssue">ç”¢ç”Ÿå„ªæƒ åˆ¸</button>
      <button class="btn-ghost" id="btnClear">æ¸…ç©ºçµæœ</button>
    </div>
    <div id="cpnResult" class="result" style="display:none;"></div>
    <div id="cpnError" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;font-size:16px;font-weight:800;">æ‰¹æ¬¡ç™¼æ”¾ï¼ˆå…¨é¤¨ / å…é‹åˆ¸ï¼‰</h3>
    <div class="grid">
      <div>
        <label for="batchType">åˆ¸ç¨®</label>
        <select id="batchType">
          <option value="ALL">å…¨é¤¨æŠ˜æ‰£åˆ¸ï¼ˆALLï¼‰</option>
          <option value="SHIP">å…é‹åˆ¸ï¼ˆSHIPï¼‰</option>
        </select>
      </div>
      <div>
        <label for="batchAmount">æŠ˜æŠµé‡‘é¡ï¼ˆNT$ï¼‰</label>
        <input id="batchAmount" type="number" min="1" value="200">
      </div>
      <div>
        <label for="batchStart">ç”Ÿæ•ˆæ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
        <input id="batchStart" type="datetime-local">
      </div>
      <div>
        <label for="batchExpire">åˆ°æœŸæ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
        <input id="batchExpire" type="datetime-local">
      </div>
      <div>
        <label for="batchTarget">ç™¼æ”¾å°è±¡</label>
        <select id="batchTarget">
          <option value="all">å…¨éƒ¨æœƒå“¡</option>
          <option value="buyers">æ›¾ä¸‹å–®æœƒå“¡</option>
        </select>
      </div>
    </div>
    <div class="actions" style="margin-top:14px;">
      <button class="btn-primary" id="btnBatch">æ‰¹æ¬¡ç™¼æ”¾</button>
      <div id="batchMsg" class="result" style="display:none;"></div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <input id="q" placeholder="æœå°‹åˆ¸ç¢¼ / å®ˆè­·ç¥" style="padding:10px 12px;border-radius:12px;border:1px solid var(--line);min-width:200px;">
      <select id="filterUsed" style="padding:10px 12px;border-radius:12px;border:1px solid var(--line);">
        <option value="">å…¨éƒ¨</option>
        <option value="false">æœªä½¿ç”¨</option>
        <option value="true">å·²ä½¿ç”¨</option>
      </select>
      <button class="btn-ghost" id="btnReload" type="button">é‡æ–°æ•´ç†</button>
      <button class="btn-primary" id="btnShowGlobal" type="button" style="background:#111827;">å…¨é¤¨/å…é‹æ¸…å–®</button>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:180px">åˆ¸ç¢¼</th>
          <th style="width:90px">é¡å‹</th>
          <th style="width:120px">å®ˆè­·ç¥</th>
          <th style="width:90px">é‡‘é¡</th>
          <th style="width:120px">ç”Ÿæ•ˆ</th>
          <th style="width:120px">åˆ°æœŸ</th>
          <th>ç™¼æ”¾æ™‚é–“</th>
          <th style="width:120px">ç‹€æ…‹</th>
          <th style="width:180px">ä½¿ç”¨æ–¼è¨‚å–®</th>
          <th style="width:150px">ä½¿ç”¨æ™‚é–“</th>
        </tr>
      </thead>
      <tbody id="cpnList"><tr><td colspan="10" class="muted">å°šæœªè¼‰å…¥</td></tr></tbody>
    </table>
  </div>

  <div id="globalPanel" class="card" style="display:none;">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
      <div>
        <h3 style="margin:0;font-size:16px;font-weight:800;">å…¨é¤¨/å…é‹åˆ¸ç™¼æ”¾åˆ—è¡¨</h3>
        <p class="muted" style="margin:4px 0 0;">åƒ…é¡¯ç¤ºé¡å‹ç‚º ALL / SHIP çš„åˆ¸ï¼Œæ–¹ä¾¿æŸ¥çœ‹ç™¼æ”¾èˆ‡ä½¿ç”¨æƒ…å½¢ã€‚</p>
      </div>
      <button id="btnCloseGlobal" class="btn-ghost" type="button">é—œé–‰</button>
    </div>
    <table style="margin-top:10px;">
      <thead>
        <tr>
          <th style="width:200px">åˆ¸ç¢¼</th>
          <th style="width:80px">é¡å‹</th>
          <th style="width:80px">é‡‘é¡</th>
          <th style="width:140px">ç™¼æ”¾</th>
          <th style="width:140px">ç”Ÿæ•ˆ</th>
          <th style="width:140px">åˆ°æœŸ</th>
          <th style="width:120px">ç‹€æ…‹</th>
          <th style="width:180px">ä½¿ç”¨è¨‚å–®</th>
          <th style="width:160px">ä½¿ç”¨æ™‚é–“</th>
        </tr>
      </thead>
      <tbody id="globalList"><tr><td colspan="9" class="muted">è¼‰å…¥ä¸­â€¦</td></tr></tbody>
    </table>
  </div>
</div>
<script>
  const DEITY_LABELS = {
    FM:'å››é¢ç¥ï¼ˆFMï¼‰',
    GA:'è±¡ç¥ï¼ˆGAï¼‰',
    CD:'å´‡è¿ªï¼ˆCDï¼‰',
    KP:'å¤å¹³ï¼ˆKPï¼‰',
    HM:'å“ˆé­¯æ›¼ï¼ˆHMï¼‰',
    RH:'æ‹‰èƒ¡ï¼ˆRHï¼‰',
    JL:'è¿¦æ¨“ç¾…ï¼ˆJLï¼‰',
    ZD:'æ¾¤åº¦é‡‘ï¼ˆZDï¼‰',
    ZF:'æ‹›è²¡å¥³ç¥ï¼ˆZFï¼‰',
    WE:'äº”çœ¼å››è€³ï¼ˆWEï¼‰',
    XZ:'å¾ç¥è€äººï¼ˆXZï¼‰',
    HP:'é­‚é­„å‹‡ï¼ˆHPï¼‰'
  };
  const NAME_TO_CODE = {};
  Object.entries(DEITY_LABELS).forEach(([code,label])=>{
    const plain = label.replace(/ï¼ˆ.*?ï¼‰/g,'').trim().replace(/\s+/g,'');
    NAME_TO_CODE[plain] = code;
  });
  const TYPE_LABELS = { DEITY:'ç¥ç¥‡åˆ¸', ALL:'å…¨é¤¨åˆ¸', SHIP:'å…é‹åˆ¸' };
  function toISO(val){
    if (!val) return undefined;
    const dt = new Date(val);
    if (isNaN(dt.getTime())) return undefined;
    return dt.toISOString();
  }
  const FALLBACK_DEITIES = Object.keys(DEITY_LABELS);
  function fmtDate(val){
    if (!val) return '';
    try{ return new Date(val).toLocaleString('zh-TW'); }catch(_){ return ''; }
  }
  async function loadDeities(){
    const sel = document.getElementById('cpnDeity');
    sel.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
    const set = new Set(FALLBACK_DEITIES);
    try{
      const res = await fetch('/api/products?active=true',{cache:'no-store'});
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      items.forEach(p=>{
        const candidates = [];
        if (p && p.deity) candidates.push(String(p.deity));
        if (p && p.deityCode) candidates.push(String(p.deityCode));
        candidates.forEach(raw=>{
          let code = '';
          const up = raw.trim().toUpperCase();
          if (/^[A-Z]{2}$/.test(up)) code = up;
          else if (DEITY_LABELS[up]) code = up;
          else {
            const flat = raw.replace(/\s+/g,'');
            if (NAME_TO_CODE[flat]) code = NAME_TO_CODE[flat];
          }
          if (code) set.add(code);
        });
      });
      const list = Array.from(set).filter(v=>/^[A-Z]{2}$/.test(v)).sort(); // åƒ…ä¿ç•™å…©ç¢¼ä»£ç¢¼ï¼Œé¿å…é‡è¤‡ä¸­æ–‡åç¨±
      if (!list.length){
        sel.innerHTML = '<option value="">å°šæœªæ‰¾åˆ°å®ˆè­·ç¥ä»£ç¢¼</option>';
      }else{
        sel.innerHTML = '<option value="">è«‹é¸æ“‡å®ˆè­·ç¥</option>';
        list.forEach(code=>{
          const opt = document.createElement('option');
          opt.value = code;
          opt.textContent = DEITY_LABELS[code] || code;
          sel.appendChild(opt);
        });
      }
    }catch(_){
      sel.innerHTML = '<option value="">ç„¡æ³•è¼‰å…¥å®ˆè­·ç¥</option>';
    }
  }
  const typeSelect = document.getElementById('cpnType');
  const deitySelect = document.getElementById('cpnDeity');
  function syncDeityDisabled(){
    const t = (typeSelect.value||'DEITY').toUpperCase();
    const disable = t !== 'DEITY';
    deitySelect.disabled = disable;
    if (disable){
      deitySelect.value = '';
    }
  }
  typeSelect.addEventListener('change', syncDeityDisabled);
  async function issue(){
    const type = (typeSelect.value||'DEITY').toUpperCase();
    const deityRaw = (document.getElementById('cpnDeity').value||'').trim().toUpperCase();
    const deity = type === 'DEITY' ? deityRaw : type;
    const amount = Number(document.getElementById('cpnAmount').value||200)||200;
    const startAtVal = document.getElementById('cpnStart').value;
    const expireVal = document.getElementById('cpnExpire').value;
    const resBox = document.getElementById('cpnResult');
    const errBox = document.getElementById('cpnError');
    resBox.style.display='none'; errBox.style.display='none';
    if (!deity){
      errBox.textContent = 'è«‹è¼¸å…¥å®ˆè­·ç¥ä»£ç¢¼ï¼ˆå¦‚ FM / GA / XZï¼‰';
      errBox.style.display='block';
      return;
    }
    try{
      const resp = await fetch('/api/coupons/issue', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          deity,
          type,
          amount,
          startAt: toISO(startAtVal),
          expireAt: toISO(expireVal)
        }),
        credentials:'include'
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok || !data || !data.code){
        const msg = (data && (data.error || data.reason)) || ('HTTP '+resp.status);
        throw new Error(msg);
      }
      resBox.innerHTML = `å„ªæƒ ç¢¼ï¼š${data.code} <br>é¡å‹ï¼š${TYPE_LABELS[type]||type}ï½œå®ˆè­·ç¥ï¼š${data.deity || deity}ï½œæŠ˜æŠµï¼šNT$ ${Number(data.amount||amount)}`;
      resBox.style.display='block';
      try{ navigator.clipboard.writeText(data.code); }catch(_){}
    }catch(err){
      errBox.textContent = err.message || 'ç™¼åˆ¸å¤±æ•—';
      errBox.style.display='block';
    }
  }
  document.getElementById('btnIssue').addEventListener('click', issue);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('cpnResult').style.display='none';
    document.getElementById('cpnError').style.display='none';
  });
  async function issueBatch(){
    const type = (document.getElementById('batchType').value||'ALL').toUpperCase();
    const amount = Number(document.getElementById('batchAmount').value||0)||0;
    const startAt = document.getElementById('batchStart').value;
    const expireAt = document.getElementById('batchExpire').value;
    const target = (document.getElementById('batchTarget').value||'all').toLowerCase();
    const box = document.getElementById('batchMsg');
    box.style.display='none';
    if (amount<=0){
      alert('è«‹è¼¸å…¥æŠ˜æŠµé‡‘é¡');
      return;
    }
    try{
      const resp = await fetch('/api/coupons/issue-batch', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({
          type,
          amount,
          target,
          startAt: toISO(startAt),
          expireAt: toISO(expireAt)
        })
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok || !data.ok){
        throw new Error(data.error || ('HTTP '+resp.status));
      }
      box.textContent = `å·²ç™¼æ”¾ ${data.issued || 0} / ${data.total || 0} ä½æœƒå“¡ã€‚`;
      box.style.display='block';
      await loadList();
    }catch(err){
      alert('æ‰¹æ¬¡ç™¼æ”¾å¤±æ•—ï¼š'+(err.message||err));
    }
  }
  document.getElementById('btnBatch').addEventListener('click', issueBatch);
  // åˆ—è¡¨
  const qInput = document.getElementById('q');
  const usedSel = document.getElementById('filterUsed');
  const listBody = document.getElementById('cpnList');
  const globalPanel = document.getElementById('globalPanel');
  const globalList = document.getElementById('globalList');
  let lastFetched = [];
  async function loadList(){
    if (listBody) listBody.innerHTML = '<tr><td colspan="10" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
    const q = (qInput.value||'').trim();
    const used = usedSel.value;
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (used) params.set('used', used);
    params.set('limit','300');
    try{
      const res = await fetch('/api/coupons/list?'+params.toString(), { credentials:'include' });
      const data = await res.json().catch(()=>({}));
      if (res.status === 401){
        listBody.innerHTML = `<tr><td colspan="10" class="error">è«‹é‡æ–°ä»¥ç®¡ç†å“¡ç™»å…¥å¾Œå°ï¼Œå†è©¦ä¸€æ¬¡ã€‚ï¼ˆéœ€ç™½åå–® Google å¸³è™Ÿï¼‰</td></tr>`;
        return;
      }
      if (!res.ok || !data.ok){
        throw new Error(data && data.error ? data.error : ('HTTP '+res.status));
      }
      const items = Array.isArray(data.items) ? data.items : [];
      lastFetched = items;
      const deityOnly = items.filter(c=> {
        const t = (c.type||'').toUpperCase();
        return !(t === 'ALL' || t === 'SHIP');
      });
      if (!deityOnly.length){
        listBody.innerHTML = '<tr><td colspan="10" class="muted">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¥ç¥‡åˆ¸ï¼ˆæ­¤è™•åƒ…é¡¯ç¤ºç¥ç¥‡åˆ¸ï¼ŒALL/SHIP è«‹é»ä¸‹æ–¹æŒ‰éˆ•ï¼‰</td></tr>';
        return;
      }
      listBody.innerHTML = deityOnly.map(c=>{
        const usedText = c.used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨';
        const usedCls = c.used ? 'status-used' : 'status-new';
        const issued = fmtDate(c.issuedAt);
        const usedAt = fmtDate(c.usedAt);
        return `<tr>
          <td style="font-weight:800;">${c.code||''}</td>
          <td>${TYPE_LABELS[(c.type||'DEITY').toUpperCase()] || (c.type||'DEITY')}</td>
          <td>${c.deity||''}</td>
          <td>NT$ ${Number(c.amount||0)}</td>
          <td>${fmtDate(c.startAt)||''}</td>
          <td>${fmtDate(c.expireAt)||''}</td>
          <td>${issued}</td>
          <td class="${usedCls}">${usedText}</td>
          <td>${c.orderId||''}</td>
          <td>${usedAt||''}</td>
        </tr>`;
      }).join('');
    }catch(err){
      if (listBody) listBody.innerHTML = `<tr><td colspan="10" class="error">è®€å–å¤±æ•—ï¼š${err.message||err}</td></tr>`;
    }
  }
  function renderGlobal(){
    if (!globalList) return;
    const src = Array.isArray(lastFetched) ? lastFetched : [];
    const filtered = src.filter(c=> (c.type||'').toUpperCase()==='ALL' || (c.type||'').toUpperCase()==='SHIP');
    if (!filtered.length){
      globalList.innerHTML = '<tr><td colspan="9" class="muted">ç›®å‰æ²’æœ‰å…¨é¤¨æˆ–å…é‹åˆ¸</td></tr>';
      return;
    }
    globalList.innerHTML = filtered.map(c=>{
      const usedText = c.used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨';
      const usedCls = c.used ? 'status-used' : 'status-new';
      return `<tr>
        <td style="font-weight:800;">${c.code||''}</td>
        <td>${TYPE_LABELS[(c.type||'').toUpperCase()]||c.type||''}</td>
        <td>NT$ ${Number(c.amount||0)}</td>
        <td>${fmtDate(c.issuedAt)||''}</td>
        <td>${fmtDate(c.startAt)||''}</td>
        <td>${fmtDate(c.expireAt)||''}</td>
        <td class="${usedCls}">${usedText}</td>
        <td>${c.orderId||''}</td>
        <td>${fmtDate(c.usedAt)||''}</td>
      </tr>`;
    }).join('');
  }
  function toggleGlobal(open){
    if (!globalPanel) return;
    globalPanel.style.display = open ? '' : 'none';
    if (open) renderGlobal();
  }
  document.getElementById('btnShowGlobal').addEventListener('click', ()=> toggleGlobal(true));
  document.getElementById('btnCloseGlobal').addEventListener('click', ()=> toggleGlobal(false));
  document.getElementById('btnReload').addEventListener('click', loadList);
  qInput.addEventListener('input', ()=>{ clearTimeout(qInput._t); qInput._t=setTimeout(loadList,300); });
  usedSel.addEventListener('change', loadList);
  loadDeities();
  syncDeityDisabled();
  loadList();
</script>
</body>
</html>

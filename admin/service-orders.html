<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>服務訂單管理</title>
<style>
  :root{
    --bg:#0b1022;--card:#111827;--line:#20283c;--text:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;
  }
  *{box-sizing:border-box;}
  body{margin:0;background:linear-gradient(180deg,#050815,#0f172a);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px;}
  .backLink{margin-bottom:14px;}
  .backBtn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;color:#e5e7eb;text-decoration:none;font-weight:700;}
  h1{margin:0 0 16px;font-size:26px;font-weight:800;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 16px 40px rgba(0,0,0,.45);}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top;}
  th{color:var(--muted);font-weight:700;}
  tbody tr:hover{background:rgba(255,255,255,.02);}
  .btn{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#fff;padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer;}
  .btn.primary{background:linear-gradient(135deg,#34d399,#38bdf8);border:none;color:#0b1120;}
  select{background:#0f172a;border:1px solid var(--line);color:#e5e7eb;border-radius:10px;padding:6px 10px;}
  .muted{color:var(--muted);font-size:13px;}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#1e293b;}
  .lookup{margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  dialog{border:none;border-radius:16px;padding:0;background:#0f172a;color:#e5e7eb;border:1px solid #1f2937;max-width:520px;width:95%;}
  dialog .dlgHead{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;}
  dialog .dlgBody{padding:18px;display:grid;gap:12px;font-size:14px;}
  dialog .dlgBody div{line-height:1.5;}
  .closeBtn{border:none;background:rgba(255,255,255,.1);color:#fff;border-radius:999px;width:28px;height:28px;font-size:16px;cursor:pointer;}
  .proof-img{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.12);object-fit:cover;max-height:220px;margin-top:8px;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="backLink"><a class="backBtn" href="./index.html">← 返回主選單</a></div>
    <h1>服務訂單管理</h1>
    <div class="lookup">
      <input id="filter" placeholder="搜尋訂單編號 / 服務 / 電話" style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0f172a;color:#e5e7eb;">
      <button class="btn" id="btnReload">重新整理</button>
    </div>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>訂單</th>
            <th>服務</th>
            <th>聯絡資料</th>
            <th>狀態</th>
            <th style="width:180px">操作</th>
          </tr>
        </thead>
        <tbody id="ordersBody"><tr><td colspan="5" class="muted">載入中…</td></tr></tbody>
      </table>
    </div>
  </div>
  <dialog id="svcOrderDetail">
    <div class="dlgHead">
      <strong id="svcOrderDetailTitle">訂單明細</strong>
      <button type="button" class="closeBtn" id="svcOrderDetailClose">✕</button>
    </div>
    <div class="dlgBody" id="svcOrderDetailBody">
      <div>載入中…</div>
    </div>
  </dialog>
  <input type="file" id="resultPhotoInput" accept="image/*" style="display:none;">
<script>
(function(){
  const API_BASE = window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com';
  async function authedFetch(url, init){
    const opts = Object.assign({}, init||{});
    opts.credentials = 'include';
    if (!opts.method) opts.method = 'GET';
    const target = /^https?:/i.test(url) ? url : API_BASE + url;
    const res = await fetch(target, opts);
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data || data.ok === false){
      throw new Error((data && data.error) || ('HTTP '+res.status));
    }
    return data;
  }
  const bodyEl = document.getElementById('ordersBody');
  const filterInput = document.getElementById('filter');
  const btnReload = document.getElementById('btnReload');
  let orders = [];
  const STATUSES = ['待處理','已確認付款，祈福進行中','祈福完成','祈福成果已通知'];

  function fmtCurrency(val){
    return 'NT$ ' + Number(val||0).toLocaleString('zh-TW');
  }
  function formatItems(order){
    const list = Array.isArray(order.items) ? order.items : [];
    if (list.length){
      return list.map(it => `${it.name || order.serviceName || ''}｜${fmtCurrency(it.total || 0)}`).join('<br>');
    }
    return `${order.serviceName || ''}｜${fmtCurrency(order.amount || 0)}`;
  }
  function formatSelections(order){
    const options = Array.isArray(order.selectedOptions) ? order.selectedOptions : (order.selectedOption ? [order.selectedOption] : []);
    if (options.length){
      return options.map(opt => `${opt.name || ''}${opt.price ? `（+${fmtCurrency(opt.price)}）` : ''}`).join('、');
    }
    return '標準服務';
  }
  function getProofUrl(order){
    return order?.transfer?.receiptUrl || order?.transfer?.proofUrl || order?.transferReceiptUrl || '';
  }
  function getRitualPhotoUrl(order){
    return order?.ritualPhotoUrl || order?.transfer?.ritualPhotoUrl || order?.ritual_photo || order?.ritualPhoto || '';
  }
  function getResultPhoto(order){
    if (!order) return '';
    if (order.resultPhotoUrl) return order.resultPhotoUrl;
    const list = Array.isArray(order.results) ? order.results : [];
    for (const item of list){
      if (!item) continue;
      const url = item.url || item.image || item.imageUrl;
      if (url) return url;
    }
    return '';
  }
  function getTransferLast5(order){
    return (order && (order.transfer && order.transfer.last5 || order.transferLast5 || '')) || '';
  }
  function render(){
    const q = (filterInput.value||'').toLowerCase();
    const view = orders.filter(o=>{
      if (!q) return true;
      return [o.id, o.serviceName, o.buyer && o.buyer.phone].join(' ').toLowerCase().includes(q);
    });
    if (!view.length){
      bodyEl.innerHTML = '<tr><td colspan="5" class="muted">沒有符合的訂單。</td></tr>';
      return;
    }
    bodyEl.innerHTML = view.map(o=>{
      const transferLast5 = getTransferLast5(o);
      const transferDisplay = transferLast5 ? `<strong style="letter-spacing:1px;">${transferLast5}</strong>` : '—';
      return `
        <tr data-id="${o.id}">
          <td>
            <div style="font-weight:700;">${o.id}</div>
            <div class="muted">${(o.createdAt||'').replace('T',' ').replace('Z','')}</div>
          </td>
          <td>
            <div style="font-weight:600;">${o.serviceName||''}</div>
            <div class="muted">選項：${formatSelections(o)}</div>
            <div class="muted">內容：${formatItems(o)}</div>
            <div class="muted">備註：${o.note || '—'}</div>
          </td>
          <td>
            <div>${o.buyer && o.buyer.name ? o.buyer.name : ''}</div>
            <div class="muted">${o.buyer && o.buyer.phone ? o.buyer.phone : ''}</div>
            <div class="muted">${o.buyer && o.buyer.email ? o.buyer.email : ''}</div>
            <div class="muted">生日：${o.buyer && o.buyer.birth ? o.buyer.birth : '—'}</div>
            <div class="muted">指定日期：${o.requestDate || '—'}</div>
            <div class="muted">匯款末五碼：${transferDisplay}</div>
          </td>
          <td><span class="badge">${o.status || '待處理'}</span></td>
          <td>
            <select data-id="${o.id}" class="statusSel">
              ${STATUSES.map(st => `<option value="${st}" ${st === o.status ? 'selected':''}>${st}</option>`).join('')}
            </select>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
              <button class="btn primary" data-act="apply" data-id="${o.id}">套用</button>
              <button class="btn" data-act="view" data-id="${o.id}">查看明細</button>
              <button class="btn" data-act="photo" data-id="${o.id}">顧客照片</button>
              <button class="btn" data-act="result-view" data-id="${o.id}">查看成果</button>
              <button class="btn" data-act="result-upload" data-id="${o.id}">上傳成果</button>
              <button class="btn" data-act="proof" data-id="${o.id}">查看憑證</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }
  async function loadOrders(){
    bodyEl.innerHTML = '<tr><td colspan="5" class="muted">載入中…</td></tr>';
    try{
      const data = await authedFetch('/api/service/orders');
      orders = Array.isArray(data.items) ? data.items : [];
      render();
    }catch(err){
      bodyEl.innerHTML = `<tr><td colspan="5" class="muted">載入失敗：${err.message}</td></tr>`;
    }
  }
  bodyEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.getAttribute('data-act');
    const id = btn.getAttribute('data-id');
    if (act === 'apply'){
      const row = btn.closest('tr');
      const sel = row ? row.querySelector('select.statusSel') : null;
      if (!sel) return;
      const status = sel.value;
      btn.disabled = true;
      btn.textContent = '更新中…';
      try{
        await authedFetch('/api/service/order/status', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, status })
        });
        const target = orders.find(o=> o.id === id);
        if (target) target.status = status;
        render();
      }catch(err){
        alert('更新失敗：' + err.message);
      }finally{
        btn.disabled = false;
        btn.textContent = '套用';
      }
      return;
    }
    if (act === 'view'){
      const order = orders.find(o=> o.id === id);
      if (order) openDetail(order);
      return;
    }
    if (act === 'photo'){
      const order = orders.find(o=> o.id === id);
      if (!order){
        alert('找不到訂單資訊');
        return;
      }
      const url = getRitualPhotoUrl(order);
      if (!url){
        alert('此訂單沒有提供祈福照片');
        return;
      }
      window.open(url, '_blank', 'noopener');
      return;
    }
    if (act === 'result-view'){
      const order = orders.find(o=> o.id === id);
      if (!order){
        alert('找不到訂單資訊');
        return;
      }
      const url = getResultPhoto(order);
      if (!url){
        alert('尚未上傳祈福成果');
        return;
      }
      window.open(url, '_blank', 'noopener');
      return;
    }
    if (act === 'result-upload'){
      const input = document.getElementById('resultPhotoInput');
      if (!input) return;
      input.dataset.targetId = id;
      input.value = '';
      input.click();
      return;
    }
    if (act === 'proof'){
      const order = orders.find(o=> o.id === id);
      if (!order){
        alert('找不到訂單資訊');
        return;
      }
      const url = getProofUrl(order);
      if (!url){
        alert('此訂單尚未上傳匯款憑證');
        return;
      }
      window.open(url, '_blank', 'noopener');
    }
  });
  const detailDialog = document.getElementById('svcOrderDetail');
  const detailBody = document.getElementById('svcOrderDetailBody');
  const detailClose = document.getElementById('svcOrderDetailClose');
  function escapeHtml(str){
    return String(str||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function openDetail(order){
    if (!detailDialog || !detailBody) return;
    const transfer = order.transfer || {};
    const receipt = transfer.receiptUrl || transfer.proofUrl || order.transferReceiptUrl || '';
    const ritualPhoto = getRitualPhotoUrl(order);
    const resultPhoto = getResultPhoto(order);
    const items = Array.isArray(order.items) ? order.items : [];
    const itemHtml = items.length ? items.map(it=> `<div>${escapeHtml(it.name||'')}｜${fmtCurrency(it.total||0)}</div>`).join('') : `<div>${escapeHtml(order.serviceName||'')}</div>`;
    const birth = (order.buyer && (order.buyer.birth || order.buyer.birthday)) || '—';
    const reqDate = order.requestDate || '—';
    detailBody.innerHTML = `
      <div><span class="muted">訂單編號</span><br><strong>${escapeHtml(order.id||'')}</strong></div>
      <div><span class="muted">服務內容</span>${itemHtml}</div>
      <div><span class="muted">聯絡人</span><br>${escapeHtml(order.buyer && order.buyer.name || '')}｜${escapeHtml(order.buyer && order.buyer.phone || '')}<br>${escapeHtml(order.buyer && order.buyer.email || '')}<br>生日：${escapeHtml(birth)}｜指定日期：${escapeHtml(reqDate)}</div>
      <div><span class="muted">匯款金額</span><br>${fmtCurrency(transfer.amount || order.amount || 0)}</div>
      <div><span class="muted">匯款資訊</span><br>銀行：${escapeHtml(transfer.bank || '—')}<br>帳號：${escapeHtml(transfer.account || '—')}<br>末五碼：${escapeHtml(transfer.last5 || order.transferLast5 || '—')}</div>
      <div><span class="muted">備註 / 匯款說明</span><br>${escapeHtml(transfer.memo || order.transferMemo || order.note || '—')}</div>
      ${receipt ? `<div><span class="muted">匯款憑證</span><br><a href="${escapeHtml(receipt)}" target="_blank" rel="noopener" style="color:#38bdf8;">開新視窗查看</a><img src="${escapeHtml(receipt)}" alt="匯款憑證" class="proof-img"></div>` : '<div><span class="muted">匯款憑證</span><br>尚未提供</div>'}
      ${ritualPhoto ? `<div><span class="muted">顧客照片</span><br><a href="${escapeHtml(ritualPhoto)}" target="_blank" rel="noopener" style="color:#38bdf8;">開新視窗查看</a><img src="${escapeHtml(ritualPhoto)}" alt="顧客照片" class="proof-img"></div>` : '<div><span class="muted">顧客照片</span><br>未提供</div>'}
      ${resultPhoto ? `<div><span class="muted">祈福成果</span><br><a href="${escapeHtml(resultPhoto)}" target="_blank" rel="noopener" style="color:#38bdf8;">開新視窗查看</a><img src="${escapeHtml(resultPhoto)}" alt="祈福成果" class="proof-img"></div>` : '<div><span class="muted">祈福成果</span><br>未上傳</div>'}
    `;
    detailDialog.showModal();
  }
  if (detailClose){
    detailClose.addEventListener('click', ()=> detailDialog.close());
  }
  const resultInput = document.getElementById('resultPhotoInput');
  if (resultInput){
    resultInput.addEventListener('change', async ()=>{
      const id = resultInput.dataset.targetId;
      if (!id || !resultInput.files || !resultInput.files[0]) return;
      const file = resultInput.files[0];
      if (file.size > 20 * 1024 * 1024){
        alert('檔案過大（限 20MB）');
        resultInput.value = '';
        return;
      }
      try{
        const form = new FormData();
        form.append('files[]', file);
        const upload = await authedFetch('/api/upload', { method:'POST', body: form });
        const url = upload.files && upload.files[0] && upload.files[0].url;
        if (!url) throw new Error('上傳失敗');
        await authedFetch('/api/service/order/result-photo', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, photo: url })
        });
        const target = orders.find(o=> o.id === id);
        if (target) target.resultPhotoUrl = url;
        render();
        alert('祈福成果已更新');
      }catch(err){
        alert('上傳失敗：' + err.message);
      }finally{
        resultInput.value = '';
      }
    });
  }
  filterInput.addEventListener('input', render);
  btnReload.addEventListener('click', loadOrders);
  loadOrders();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>服務商品管理｜unalomecodes</title>
<style>
  :root{
    --bg:#f5f7fb;--card:#fff;--fg:#0f172a;--line:#e5e7eb;--accent:#2563eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}
  .wrap{max-width:1200px;margin:0 auto;padding:24px;}
  .backLink{margin-bottom:14px;}
  .backBtn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;text-decoration:none;color:var(--fg);font-weight:700;}
  h1{margin:0 0 12px;font-size:30px;font-weight:800;}
  .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
  .toolbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);font-size:14px;}
  .grid{display:grid;grid-template-columns:460px 1fr;gap:20px;}
  @media(max-width:1100px){.grid{grid-template-columns:1fr;}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:20px;padding:20px;box-shadow:0 20px 40px rgba(15,23,42,.08);}
  label{display:block;font-size:12px;color:#6b7280;margin-top:12px;margin-bottom:4px;font-weight:700;}
  input,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:14px;transition:border-color .2s;}
  input:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15);}
  textarea{min-height:110px;line-height:1.6;resize:vertical;}
  .row{display:flex;gap:10px;flex-wrap:wrap;}
  .btn{border:1px solid var(--line);background:#fff;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;}
  .btn.danger{background:#fee2e2;border:none;color:#b91c1c;}
  table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:16px;overflow:hidden;font-size:14px;}
  th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;}
  th{background:#f1f5f9;color:#64748b;font-weight:700;}
  tbody tr:hover{background:#f8fafc;}
  .muted{color:#94a3b8;font-size:12px;}
  .imgPreview{width:100%;height:220px;border:1px dashed var(--line);border-radius:16px;display:flex;align-items:center;justify-content:center;background:#f8fafc;overflow:hidden;}
  .imgPreview img{width:100%;height:100%;object-fit:cover;}
  .imgList{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
  .imgList .thumb{position:relative;width:86px;height:86px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff;}
  .imgList .thumb img{width:100%;height:100%;object-fit:cover;}
  .imgList .thumb button{position:absolute;top:4px;right:4px;border:none;background:rgba(15,23,42,.7);color:#fff;border-radius:999px;width:20px;height:20px;cursor:pointer;}
  .optionsGrid{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
  .svc-option-row{display:grid;grid-template-columns:1fr 120px auto;gap:8px;align-items:center;}
  @media(max-width:520px){.svc-option-row{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="backLink"><a class="backBtn" href="./index.html">← 返回主選單</a></div>
    <h1>服務型商品管理</h1>
    <div class="toolbar">
      <input id="filter" placeholder="搜尋服務名稱…">
      <button class="btn" id="btnReload">重新整理</button>
    </div>
    <div class="grid">
      <div class="card form-card">
        <h3 style="margin:0 0 6px;">新增 / 編輯服務</h3>
        <p class="muted">輸入資料後按「儲存服務」。若選取表格中的項目會帶入資料供編輯。</p>
        <input type="hidden" id="svc_id">
        <input type="hidden" id="svc_duration">
        <label>服務名稱</label>
        <input id="svc_name" placeholder="例：蠟燭祈福｜基本祈請">
        <label>費用（NT$）</label>
        <input id="svc_price" type="number" min="0" value="0">
        <label>已售出（顯示用）</label>
        <input id="svc_sold" type="number" min="0" value="0">
        <label>詳細說明</label>
        <textarea id="svc_description" placeholder="完整介紹、祈福流程、注意事項…"></textarea>
        <label>IG 影片連結（可選）</label>
        <input id="svc_instagram" placeholder="https://www.instagram.com/p/XXXX/">
        <label>包含內容（每行一項）</label>
        <textarea id="svc_includes" placeholder="蠟燭祈請一次&#10;祈福祝禱錄音節錄"></textarea>
        <input type="hidden" id="svc_active" value="1">
        <div class="row" style="justify-content:space-between;align-items:center;margin-top:12px;">
          <label style="margin:0">服務圖片（可多張，首張為封面）</label>
          <button class="btn" type="button" id="btnImagesUpload">上傳圖片</button>
        </div>
        <div class="imgList" id="svcImagePreview"><span class="muted">尚未上傳</span></div>
        <textarea id="svc_images" style="display:none;"></textarea>
        <input type="file" id="fileImages" accept="image/*" multiple style="display:none;">
        <label style="display:flex;justify-content:space-between;align-items:center;">
          <span>服務項目（可供顧客選擇）</span>
          <button class="btn" type="button" id="btnAddOption">＋新增項目</button>
        </label>
        <div class="muted">例如不同蠟燭或供品組合，輸入名稱與加價（0 代表不加價）。</div>
        <div id="svc_options" class="optionsGrid"></div>
        <div class="row" style="margin-top:14px;gap:8px;">
          <button class="btn primary" id="btnSave">儲存服務</button>
          <button class="btn" id="btnReset">清空</button>
          <button class="btn danger" id="btnDelete" style="margin-left:auto;display:none;">刪除此服務</button>
        </div>
        <div class="muted" id="formMsg" style="margin-top:10px;"></div>
      </div>
      <div class="card list-card" style="overflow:auto;">
        <h3 style="margin:0 0 10px;">服務清單</h3>
        <table>
          <thead>
            <tr><th style="width:60px">封面</th><th>服務資訊</th><th style="width:120px">費用</th><th style="width:80px">操作</th></tr>
          </thead>
          <tbody id="svcListBody"><tr><td colspan="4" class="muted">尚無資料</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
<script>
(function(){
  const STORAGE_KEY = 'ADMIN_KEY';
  function getAdminKey(){
    let key = sessionStorage.getItem(STORAGE_KEY) || '';
    if (!key){
      key = prompt('請輸入管理員金鑰') || '';
      if (key) sessionStorage.setItem(STORAGE_KEY, key.trim());
    }
    return key.trim();
  }
  async function authedFetch(url, init){
    const key = getAdminKey();
    if (!key) throw new Error('未提供管理員金鑰');
    const headers = Object.assign({}, init && init.headers ? init.headers : {}, { 'X-Admin-Key': key });
    const opts = Object.assign({}, init||{}, { headers });
    const res = await fetch(url, opts);
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data || data.ok === false){
      throw new Error((data && data.error) || ('HTTP '+res.status));
    }
    return data;
  }

  const listBody = document.getElementById('svcListBody');
  const filterInput = document.getElementById('filter');
  const formMsg = document.getElementById('formMsg');
  const btnSave = document.getElementById('btnSave');
  const btnReset = document.getElementById('btnReset');
  const btnDelete = document.getElementById('btnDelete');
  const btnReload = document.getElementById('btnReload');
  const imagesInput = document.getElementById('svc_images');
  const soldInput = document.getElementById('svc_sold');
  const activeInput = document.getElementById('svc_active');
  const imagePreview = document.getElementById('svcImagePreview');
  const optionsWrap = document.getElementById('svc_options');
  let items = [];
  let currentId = '';

  function resolveServiceId(item){
    if (!item) return '';
    return item.id || item._id || item.key || item._key || '';
  }
  function ensureItemIds(list){
    const stamp = Date.now();
    list.forEach((item, idx)=>{
      if (!item) return;
      const resolved = resolveServiceId(item);
      item.__virtualId = resolved || `svc-temp-${stamp}-${idx}`;
    });
  }
  function getRowId(item){
    return resolveServiceId(item) || item.__virtualId || '';
  }
  function findItemByRowId(rowId){
    if (!rowId) return null;
    return items.find(it => getRowId(it) === rowId) || null;
  }

  function getImages(){
    const raw = (imagesInput.value || '').trim();
    if (!raw) return [];
    return raw.split('\n').map(s=>s.trim()).filter(Boolean);
  }
  function setImages(list){
    const urls = Array.from(new Set((list||[]).filter(Boolean)));
    imagesInput.value = urls.join('\n');
    if (!urls.length){
      imagePreview.innerHTML = '<span class="muted">尚未上傳</span>';
      return;
    }
    imagePreview.innerHTML = urls.map((url, idx) => `
      <div class="thumb">
        <img src="${url}" alt="">
        <button type="button" class="x" data-url="${url}">×</button>
        ${idx === 0 ? '<div style="position:absolute;left:6px;bottom:6px;font-size:11px;background:rgba(15,23,42,.7);color:#fff;padding:2px 6px;border-radius:999px;">封面</div>' : ''}
      </div>
    `).join('');
  }
  function addOptionRow(name='', price=0){
    const row = document.createElement('div');
    row.className = 'svc-option-row';
    const nameInput = document.createElement('input');
    nameInput.name = 'opt_name';
    nameInput.placeholder = '項目名稱';
    nameInput.value = name || '';
    const priceInput = document.createElement('input');
    priceInput.name = 'opt_price';
    priceInput.type = 'number';
    priceInput.placeholder = '加價';
    priceInput.value = Number(price||0);
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn danger';
    btn.textContent = '刪除';
    btn.addEventListener('click', ()=>{
      row.remove();
      if (!optionsWrap.querySelector('.svc-option-row')){
        addOptionRow();
      }
    });
    row.append(nameInput, priceInput, btn);
    optionsWrap.appendChild(row);
  }
  function readForm(){
    const images = getImages();
    const idInput = document.getElementById('svc_id').value.trim();
    const data = {
      name: document.getElementById('svc_name').value.trim(),
      price: Number(document.getElementById('svc_price').value || 0),
      sold: Number(soldInput.value || 0),
      active: activeInput.value !== '0',
      duration: document.getElementById('svc_duration').value.trim(),
      description: document.getElementById('svc_description').value,
      instagram: document.getElementById('svc_instagram').value.trim(),
      includes: document.getElementById('svc_includes').value.split('\n').map(s=>s.trim()).filter(Boolean),
      cover: images[0] || '',
      gallery: images.slice(1),
      options: Array.from(optionsWrap.querySelectorAll('.svc-option-row')).map(row=>{
        const name = row.querySelector('input[name="opt_name"]').value.trim();
        const price = Number(row.querySelector('input[name="opt_price"]').value||0);
        return { name, price };
      }).filter(opt => opt.name)
    };
    const resolvedId = idInput || currentId || '';
    if (resolvedId) data.id = resolvedId;
    return data;
  }
  function fillForm(data){
    currentId = resolveServiceId(data) || '';
    document.getElementById('svc_id').value = currentId;
    document.getElementById('svc_name').value = data.name || '';
    document.getElementById('svc_price').value = Number(data.price||0);
    soldInput.value = Number(data.sold||0);
    activeInput.value = data.active === false ? '0' : '1';
    document.getElementById('svc_duration').value = data.duration || '';
    document.getElementById('svc_description').value = data.description || '';
    document.getElementById('svc_instagram').value = data.instagram || '';
    document.getElementById('svc_includes').value = Array.isArray(data.includes) ? data.includes.join('\n') : '';
    const gallery = Array.isArray(data.gallery) ? data.gallery : [];
    const imgs = [];
    if (data.cover) imgs.push(data.cover);
    gallery.forEach(url=>{
      if (url && !imgs.includes(url)) imgs.push(url);
    });
    setImages(imgs);
    optionsWrap.innerHTML = '';
    const opts = Array.isArray(data.options) && data.options.length ? data.options : [{name:'',price:0}];
    opts.forEach(opt => addOptionRow(opt.name, opt.price));
    btnDelete.style.display = data.id ? 'inline-flex' : 'none';
  }
  function resetForm(){
    currentId = '';
    fillForm({ id:'', price:0, gallery:[], options:[{name:'',price:0}], active:true, instagram:'' });
    formMsg.textContent = '';
  }
  async function uploadFiles(fileList){
    if (!fileList || !fileList.length) return [];
    const form = new FormData();
    Array.from(fileList).forEach(f => form.append('files[]', f));
    const res = await fetch('/api/upload', { method:'POST', body: form });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data || data.ok === false){
      throw new Error((data && data.error) || '上傳失敗');
    }
    return Array.isArray(data.files) ? data.files : [];
  }
  async function toggleActive(id, active){
    try{
      await authedFetch('/api/service/products', {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, active })
      });
      if (formMsg) formMsg.textContent = active ? '已上架' : '已下架';
      if (currentId === id){
        activeInput.value = active ? '1' : '0';
      }
      await loadServices();
    }catch(err){
      alert('更新狀態失敗：' + err.message);
    }
  }
  function renderList(){
    const q = (filterInput.value||'').trim().toLowerCase();
    const view = items.filter(it => !q || String(it.name||'').toLowerCase().includes(q));
    if (!view.length){
      listBody.innerHTML = '<tr><td colspan="4" class="muted">沒有符合條件的服務。</td></tr>';
      return;
    }
    listBody.innerHTML = view.map(it => {
      const rowId = getRowId(it);
      return `
      <tr data-id="${rowId}">
        <td>${it.cover ? `<img src="${it.cover}" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:10px;">` : ''}</td>
        <td>
          <div style="font-weight:700;">${it.name||''}</div>
          <div class="muted">${it.includes && it.includes.length ? it.includes[0] : '—'}</div>
          <div class="muted">已售出：${Number(it.sold||0)}</div>
        </td>
        <td>
          <div>${Number(it.price||0).toLocaleString('zh-TW')}</div>
          <div class="muted">${it.active === false ? '（已下架）' : ''}</div>
        </td>
        <td style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn" data-act="edit" data-id="${rowId}">編輯</button>
          <button class="btn" data-act="${it.active === false ? 'publish' : 'unpublish'}" data-id="${rowId}">
            ${it.active === false ? '上架' : '下架'}
          </button>
        </td>
      </tr>`;
    }).join('');
  }
  async function loadServices(){
    listBody.innerHTML = '<tr><td colspan="4" class="muted">載入中…</td></tr>';
    try{
      const data = await authedFetch('/api/service/products');
      items = Array.isArray(data.items) ? data.items : [];
      ensureItemIds(items);
      renderList();
    }catch(err){
      listBody.innerHTML = `<tr><td colspan="4" class="muted">載入失敗：${err.message}</td></tr>`;
    }
  }

  btnReload.addEventListener('click', loadServices);
  filterInput.addEventListener('input', renderList);
  btnReset.addEventListener('click', resetForm);
  listBody.addEventListener('click', e=>{
    const target = e.target instanceof Element ? e.target : (e.target && e.target.parentElement) || null;
    const btn = target ? target.closest('button[data-act]') : null;
    if (!btn) return;
    const act = btn.getAttribute('data-act');
    const id = (btn.getAttribute('data-id') || '').trim();
    if (!id) return;
    if (act === 'edit'){
      const item = findItemByRowId(id);
      if (item) fillForm(item);
      return;
    }
    if (act === 'publish' || act === 'unpublish'){
      const item = findItemByRowId(id);
      const realId = item ? resolveServiceId(item) : '';
      if (!realId){
        alert('此服務尚未產生 ID，請先編輯並儲存一次。');
        return;
      }
      const next = act === 'publish';
      toggleActive(realId, next);
    }
  });
  btnSave.addEventListener('click', async ()=>{
    const data = readForm();
    if (!data.name || !data.price){
      formMsg.textContent = '請填寫名稱與價格';
      return;
    }
    formMsg.textContent = '儲存中…';
    try{
      if (data.id){
        await authedFetch('/api/service/products', {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
      }else{
        const res = await authedFetch('/api/service/products', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        data.id = res.item && res.item.id;
      }
      formMsg.textContent = '已儲存';
      await loadServices();
      if (data.id){
        const target = items.find(x=> x.id === data.id);
        if (target) fillForm(target);
      }else{
        resetForm();
      }
    }catch(err){
      formMsg.textContent = '儲存失敗：' + err.message;
    }
  });
  btnDelete.addEventListener('click', async ()=>{
    const id = document.getElementById('svc_id').value.trim();
    if (!id) return;
    if (!confirm('確定要刪除服務「'+id+'」嗎？')) return;
    try{
      await authedFetch('/api/service/products?id='+encodeURIComponent(id), { method:'DELETE' });
      resetForm();
      await loadServices();
    }catch(err){
      alert('刪除失敗：' + err.message);
    }
  });
  document.getElementById('btnImagesUpload').addEventListener('click',()=> document.getElementById('fileImages').click());
  document.getElementById('fileImages').addEventListener('change', async e=>{
    const files = e.target.files;
    if (!files || !files.length) return;
    formMsg.textContent = '上傳圖片中…';
    try{
      const uploaded = await uploadFiles(files);
      const urls = getImages();
      uploaded.forEach(f => {
        if (f && f.url) urls.push(f.url);
      });
      setImages(urls);
      formMsg.textContent = '圖片已更新（首張為封面）';
    }catch(err){
      formMsg.textContent = '上傳失敗：' + err.message;
    }finally{
      e.target.value = '';
    }
  });
  imagePreview.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-url]');
    if (!btn) return;
    const url = btn.getAttribute('data-url');
    const urls = getImages().filter(item => item !== url);
    setImages(urls);
  });
  document.getElementById('btnAddOption').addEventListener('click', ()=> addOptionRow());

  resetForm();
  loadServices();
})();
</script>
</body>
</html>

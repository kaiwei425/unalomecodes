<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>å¾Œå°ï½œå•†å“ç•™è¨€ç®¡ç†</title>
<style>
:root {
  --bg: #0d1117;
  --panel: #0b1224;
  --card: #111a2f;
  --line: #1f2a44;
  --muted: #9fb2d3;
  --fg: #e8f1ff;
  --primary: #7c7cff;
  --primary-strong: #5d5de6;
  --danger: #f1607d;
  --danger-strong: #d94b64;
  --accent: #58e1c1;
  --gradient: radial-gradient(circle at 20% 20%, rgba(124,124,255,0.15), transparent 35%), radial-gradient(circle at 80% 0%, rgba(88,225,193,0.16), transparent 30%), linear-gradient(145deg, #0b1020 0%, #0f162b 60%, #0c1626 100%);
}
*{box-sizing:border-box;}
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
html,body{
  margin:0;padding:0;
  min-height:100%;
  background:var(--gradient);
  color:var(--fg);
  font-family:"Space Grotesk","Segoe UI",system-ui,-apple-system,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.wrap{max-width:1200px;margin:0 auto;padding:28px;}
.backLink{margin-bottom:14px;}
.backBtn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:999px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:var(--fg);text-decoration:none;font-weight:700;font-size:13px;
  transition:all .18s ease;
}
.backBtn:hover{border-color:var(--primary);background:rgba(124,124,255,0.18);}
.hero{
  display:flex;gap:18px;align-items:flex-start;justify-content:space-between;
  background:linear-gradient(135deg, rgba(124,124,255,0.16), rgba(88,225,193,0.12));
  border:1px solid rgba(124,124,255,0.35);
  box-shadow:0 18px 35px rgba(0,0,0,0.35);
  border-radius:18px;
  padding:22px 24px;
}
.eyebrow{letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--accent);margin:0 0 4px 0;font-weight:700;}
h1{margin:0;font-size:30px;font-weight:800;letter-spacing:.4px;}
.muted{color:var(--muted);font-size:14px;line-height:1.6;}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.chip{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);color:var(--fg);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;}
.hero-actions{display:flex;gap:10px;align-items:flex-start;}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:20px 22px;
  box-shadow:0 12px 26px rgba(0,0,0,0.25);
  margin-top:16px;
}
.card-head{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px;}
.card-title{font-weight:700;font-size:18px;}
.hint{font-size:13px;color:var(--muted);}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
  gap:14px;
}
.item{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
  border:1px solid var(--line);
  border-radius:14px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  transition:all .2s ease;
}
.item:hover{transform:translateY(-3px);border-color:rgba(124,124,255,0.4);box-shadow:0 12px 24px rgba(0,0,0,0.18);}
.item .title{font-weight:700;font-size:18px;color:var(--fg);}
.item .id{font-size:13px;color:var(--muted);font-weight:500;}
.item .deity-info{font-size:14px;color:var(--muted);margin-top:2px;}
.item .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;}

.btn{
  appearance:none;border:1px solid var(--line);background:rgba(255,255,255,0.05);color:var(--fg);
  border-radius:10px;padding:9px 14px;cursor:pointer;font-weight:700;font-size:14px;
  transition:all 0.18s ease;letter-spacing:0.01em;
}
.btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.25);box-shadow:0 8px 16px rgba(0,0,0,0.2);}
.btn.primary{background:var(--primary);border-color:var(--primary-strong);color:#fff;}
.btn.primary:hover{background:var(--primary-strong);}
.btn.warn, .btn.danger{background:var(--danger);border-color:var(--danger-strong);color:#fff;}
.btn.warn:hover, .btn.danger:hover{background:var(--danger-strong);}
.btn.ghost{background:transparent;border-color:rgba(255,255,255,0.25);}

#log{
  margin-top:10px;font-size:13px;color:var(--muted);white-space:pre-wrap;
  background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;border:1px dashed var(--line);
}

.legend{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted);margin-top:8px;}
.legend span{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid var(--line);}

/* Overlay */
.overlay{position:fixed;inset:0;background:rgba(5,8,15,.82);backdrop-filter:blur(6px);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px;}
.panel{position:relative;background:var(--panel);color:var(--fg);border:1px solid var(--line);border-radius:16px;box-shadow:0 28px 70px rgba(0,0,0,.55);display:flex;flex-direction:column;max-width:900px;width:100%;max-height:92vh;}
.panel header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--panel);z-index:10;}
.panel header strong{font-size:18px;font-weight:700;}
.panel header .ov-code{font-size:14px;color:var(--muted);margin-left:10px;}
.panel header .row{margin:0;}
.panel main{padding:14px 20px;overflow-y:auto;flex-grow:1;display:flex;flex-direction:column;gap:14px;}
.panel footer{padding:14px 20px;border-top:1px solid var(--line);background:var(--panel);position:sticky;bottom:0;z-index:10;}

/* Message List */
#ovList{display:flex;flex-direction:column;gap:14px;}
#ovList:empty::before{content:"ç›®å‰æ²’æœ‰ç•™è¨€ã€‚";display:block;text-align:center;color:var(--muted);padding:18px;border:1px dashed var(--line);border-radius:10px;}
.msg{background:rgba(255,255,255,0.02);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start;}
.msg .msg-left{flex-shrink:0;}
.msg .msg-img{width:72px;height:72px;object-fit:cover;border-radius:10px;background:var(--bg);cursor:pointer;transition:opacity 0.2s ease;}
.msg .msg-img:hover{opacity:0.82;}
.msg .msg-body{flex-grow:1;min-width:0;}
.msg .msg-head{display:flex;justify-content:space-between;align-items:baseline;gap:8px;margin-bottom:4px;}
.msg .msg-nick{font-weight:700;color:var(--fg);font-size:15px;}
.msg .msg-date{font-size:12px;color:var(--muted);white-space:nowrap;}
.msg .msg-text{font-size:14px;color:var(--fg);line-height:1.6;white-space:pre-wrap;word-break:break-word;}
.msg .msg-actions{margin-top:8px;text-align:right;}
.msg .btn.del-one{padding:6px 10px;font-size:12px;font-weight:600;}

/* Raw JSON Textarea */
textarea.raw{width:100%;min-height:140px;background:#0a1020;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;resize:vertical;}

/* Image Lightbox for Overlay */
#imageLightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:10000;align-items:center;justify-content:center;padding:20px;}
#imageLightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);cursor:pointer;}
</style>
</head>

<body>
<div class="wrap">
  <div class="backLink"><a class="backBtn" href="./index.html">â† è¿”å›ä¸»é¸å–®</a></div>
  <div class="hero">
    <div>
      <p class="eyebrow">ç•™è¨€ç®¡ç†</p>
      <h1>å•†å“ç•™è¨€æ§åˆ¶å°</h1>
      <p class="muted">å¿«é€ŸæŸ¥çœ‹ã€ç®¡ç†ã€åˆªé™¤æ‰€æœ‰å•†å“çš„é¡§å®¢ç•™è¨€ã€‚ä»»ä½•äººç™»å…¥éƒ½èƒ½ç›´è¦ºæ“ä½œã€‚</p>
      <div class="chips">
        <span class="chip">å³æ™‚è®€å– /api/products</span>
        <span class="chip">ç•™è¨€æ¸…å–® /api/stories</span>
        <span class="chip">æ”¯æ´é€ç­†åˆªé™¤èˆ‡å…¨åˆª</span>
      </div>
    </div>
    <div class="hero-actions">
      <button class="btn ghost" onclick="loadProducts()">é‡æ–°è¼‰å…¥</button>
      <button class="btn primary" onclick="document.getElementById('overlay').style.display='block'; setTimeout(()=>document.getElementById('ovList').innerHTML='<div class=&quot;msg&quot;><div class=&quot;msg-body&quot;><div class=&quot;msg-text&quot;>é¸æ“‡å•†å“å¾Œæ‰èƒ½è¼‰å…¥ç•™è¨€</div></div></div>',0);">é–‹å•Ÿç•™è¨€é¢æ¿</button>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <div class="card-title">å•†å“æ¸…å–®</div>
      <div class="hint">é»ã€ŒæŸ¥çœ‹ã€é–‹å•Ÿ JSONï¼›ã€Œç®¡ç†ç•™è¨€ã€é€²å…¥ç•™è¨€é¢æ¿ï¼›ã€Œæ•´å“é …å…¨åˆªã€å¿«é€Ÿæ¸…ç©ºã€‚</div>
    </div>
    <div id="productList" class="grid">è®€å–ä¸­...</div>
    <div class="legend">
      <span>ğŸ—‚ï¸ ç¥ç¥‡ä»£ç¢¼è‡ªå‹•å¸¶å…¥</span>
      <span>ğŸ‘€ ç®¡ç†ç•™è¨€æ”¯æ´åœ–ç‰‡é è¦½</span>
      <span>âš ï¸ å…¨åˆªæœƒä¸€æ¬¡æ¸…é™¤è©²å“é …å…¨éƒ¨ç•™è¨€</span>
    </div>
    <div id="log" class="muted"></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="panel">
    <header>
      <div style="display:flex;align-items:baseline;">
        <strong>ç•™è¨€ç®¡ç†ï¼š</strong>
        <span class="ov-code" id="ovCode"></span>
      </div>
      <div class="row">
        <button class="btn danger" id="ovDelAll">åˆªé™¤å…¨éƒ¨</button>
        <button class="btn primary" id="ovClose">é—œé–‰</button>
      </div>
    </header>
    <main id="ovList">è¼‰å…¥ä¸­â€¦</main>
    <footer>
      <div class="muted" style="margin-bottom:6px">åŸå§‹å›æ‡‰ï¼ˆé™¤éŒ¯ç”¨ï¼‰ï¼š</div>
      <textarea class="raw" id="ovRaw" readonly>ï¼ˆç­‰å¾…è¼‰å…¥ï¼‰</textarea>
    </footer>
  </div>
</div>

<!-- Image Lightbox for Message Images -->
<div id="imageLightbox" class="overlay">
  <img id="imageLightboxImg" src="" alt="ç•™è¨€åœ–ç‰‡">
</div>

<script>
const API_BASE = window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com';
const svcListBtn = document.getElementById('btnLoadServices');
function authHeaders(extra){
  const base = {};
  if (extra) return Object.assign(base, extra);
  return base;
}
const $ = (s)=>document.querySelector(s);
function toast(msg){ $('#log').textContent = msg; }
function esc(s){ return String(s||'').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }

function toDeityCode(name=''){
  const s = String(name||'').trim();
  if (!s) return '';
  const u = s.toUpperCase();
  if (/^[A-Z]{2}$/.test(u)) return u;
  if (/å››é¢ç¥|BRAHMA|PHRA\s*PHROM|PHROM|ERAWAN/.test(s)) return 'FM';
  if (/è±¡ç¥|GANESHA|PHIKANET|PHIKANES|PIKANES/.test(s))   return 'GA';
  if (/å´‡è¿ª|SOMDEJ|SOMDET/.test(s))                      return 'CD';
  if (/å¤å¹³|KHUN\s*PHAEN|KHUN\s*PAEN|K\.?P\.?/.test(s))  return 'KP';
  if (/å“ˆé­¯æ›¼|H(AN|AR)UMAN/.test(s))                     return 'HM';
  if (/æ‹‰èƒ¡|RAHU/.test(s))                                return 'RH';
  if (/è¿¦æ¨“ç¾…|GARUDA|K(AR|AL)UDA/.test(s))               return 'JL';
  if (/æ¾¤åº¦é‡‘|JATUKAM|R(AM|A)MATHEP|ZEDO(G|K)ON|ZEDUKIN/.test(s)) return 'ZD';
  if (/æ‹›è²¡å¥³ç¥|LAKSHMI|LAXSHMI|LAMSI/.test(s))          return 'ZF';
  if (/äº”çœ¼å››è€³|FIVE[\-\s]*EYES|5EYES|FIVEEYES/.test(s)) return 'WE';
  if (/å¾ç¥|XU\s*ZHU|XUZHU/.test(s))                     return 'XZ';
  if (/é­‚é­„å‹‡|HUN\s*PO\s*YONG|HPY/.test(s))              return 'HP';
  return '';
}

function storyCodeFromProduct(p){
  if (p && p.deityCode) {
    const c = String(p.deityCode).trim().toUpperCase();
    if (c) return c;
  }
  const guess = toDeityCode((p && (p.deity || p.name)) || '');
  if (guess) return guess;
  if (p && p.id) return String(p.id).trim().toUpperCase();
  return '';
}

function storyCodeFromService(s){
  if (!s) return '';
  if (s.reviewCode) {
    const rc = String(s.reviewCode).trim().toUpperCase();
    if (rc) return rc;
  }
  if (s.deityCode) {
    const dc = String(s.deityCode).trim().toUpperCase();
    if (dc) return dc;
  }
  const guess = toDeityCode((s && (s.deity || s.name)) || '');
  if (guess) return guess;
  if (s.id) return String(s.id).trim().toUpperCase();
  return '';
}

async function loadProducts(){
  const list = $('#productList');
  list.textContent = 'è¼‰å…¥ä¸­...';
  try{
    const fetchProducts = fetch(API_BASE + '/api/products',{cache:'no-store', headers: authHeaders(), credentials:'include'})
      .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .catch(err=>({ error: err.message, items: [] }));
    const fetchServices = fetch(API_BASE + '/api/service/products',{cache:'no-store', headers: authHeaders(), credentials:'include'})
      .then(r=> r.ok ? r.json() : ({ items: [] }))
      .catch(()=>({ items: [] }));
    const [prodData, svcData] = await Promise.all([fetchProducts, fetchServices]);
    const combined = [];
    (Array.isArray(prodData.items) ? prodData.items : []).forEach(p=>{
      combined.push({ type:'physical', raw:p, code: storyCodeFromProduct(p) });
    });
    (Array.isArray(svcData.items) ? svcData.items : []).forEach(s=>{
      combined.push({ type:'service', raw:s, code: storyCodeFromService(s) });
    });
    if (!combined.length){
      list.textContent = 'ç›®å‰æ²’æœ‰å¯ç”¨çš„å•†å“æˆ–æœå‹™';
      return;
    }
    list.innerHTML = combined.map(item => {
      const p = item.raw || {};
      const typeLabel = item.type === 'service'
        ? '<span class="chip alt">æœå‹™å•†å“</span>'
        : '<span class="chip">å¯¦é«”å•†å“</span>';
      return `
        <div class="item" data-type="${esc(item.type)}" data-id="${esc(p.id||'')}" data-deity-code="${esc(item.code)}">
          <div class="title">${p.name ? esc(p.name) : 'ï¼ˆæœªå‘½åï¼‰'}</div>
          <div class="id">IDï¼š${esc(p.id||'(ç„¡ ID)')}</div>
          <div class="row" style="margin:4px 0 8px;gap:6px;flex-wrap:wrap;">
            ${typeLabel}
            ${p.deity ? `<span class="chip">ç¥ç¥‡ï¼š${esc(p.deity)}</span>` : ''}
          </div>
          <div class="row">
            <button class="btn" data-act="view">æŸ¥çœ‹ç•™è¨€(JSON)</button>
            <button class="btn primary" data-act="manage">ç®¡ç†ç•™è¨€</button>
            <button class="btn warn" data-act="del">æ•´å“é …å…¨åˆª</button>
          </div>
        </div>
      `;
    }).join('');
    list.onclick = handleListAction;
  }catch(e){
    $('#productList').textContent = 'è®€å–å¤±æ•—ï¼š' + e.message;
  }
}

function handleListAction(e){
  const t = e.target;
  if (!(t instanceof Element)) return;
  const act = t.getAttribute('data-act');
  if (!act) return;
  const wrap = t.closest('.item');
  if (!wrap) return;
  const deityCode = (wrap.getAttribute('data-deity-code')||'').trim().toUpperCase();
  console.log('Action:', act, 'Deity Code:', deityCode);
  if (!deityCode) return toast('æ‰¾ä¸åˆ°æ­¤å•†å“çš„ç¥ç¥‡ä»£ç¢¼ (deityCode)');

  if (act === 'view'){
    window.open(API_BASE + '/api/stories?code=' + encodeURIComponent(deityCode), '_blank');
  }
  if (act === 'del'){
    delAllViaPost(deityCode);
  }
  if (act === 'manage'){
    openOverlay(deityCode);
  }
}

async function delAllViaPost(id){
  const code = (id || '').toString().trim().toUpperCase();
  if (!confirm('åˆªé™¤ '+code+' çš„æ‰€æœ‰ç•™è¨€ï¼Ÿ')) return;
  try{
    const r = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(code) + '&_method=DELETE', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ _method: 'DELETE' }),
      credentials:'include'
    });
    if (!r.ok) throw new Error('HTTP '+r.status);
    toast('å·²åˆªé™¤ '+code+' çš„æ‰€æœ‰ç•™è¨€');
  }catch(e){
    toast('åˆªé™¤å¤±æ•—ï¼š' + e.message);
  }
}

async function fetchStories(code){
  const realCode = (code || '').toString().trim().toUpperCase();
  if (!realCode) throw new Error('ç¼ºå°‘ç¥ç¥‡ä»£ç¢¼');
  const r = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(realCode), { cache:'no-store', headers: authHeaders(), credentials:'include' });
  const js = await r.json();
  return js;
}

/* overlay logic */
const overlay = $('#overlay');
const ovCode = $('#ovCode');
const ovList = $('#ovList');
const ovRaw  = $('#ovRaw');

$('#ovClose').onclick = ()=> overlay.style.display = 'none';
$('#ovDelAll').onclick = ()=>{
  const code = ovCode.textContent.trim();
  if (!code) return;
  delAllViaPost(code);
};

async function openOverlay(code){
  ovCode.textContent = code;
  ovList.textContent = 'è¼‰å…¥ä¸­â€¦';
  ovRaw.value = 'ï¼ˆç­‰å¾…è¼‰å…¥ï¼‰';
  overlay.style.display = 'block';
  try{
    const data = await fetchStories(code);
    renderMessages(code, data);
  }catch(e){
    ovList.textContent = 'è®€å–ç•™è¨€å¤±æ•—ï¼š' + e.message;
    ovRaw.value = 'è®€å–å¤±æ•—ï¼š' + e.message;
  }
}

function renderMessages(code, data){
    ovRaw.value = JSON.stringify(data, null, 2);
    const arr = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    if (!arr.length){
      ovList.innerHTML = ''; // Let CSS handle the empty state message
      return;
    }
    ovList.innerHTML = arr.map(m => `
      <div class="msg" data-id="${esc(m.id||'')}">
        ${m.imageUrl ? `<div class="msg-left"><img src="${esc(m.imageUrl)}" class="msg-img" alt="ç•™è¨€åœ–ç‰‡"></div>` : ''}
        <div class="msg-body">
          <div class="msg-head">
            <div class="msg-nick">${esc(m.nick || 'åŒ¿å')}</div>
            <div class="msg-date">${m.ts ? new Date(m.ts).toLocaleString() : '-'}</div>
          </div>
          <div class="msg-text">${esc(m.msg||m.text||'')}</div>
          <div class="msg-actions"><button class="btn danger del-one" data-act="del-one">åˆªé™¤æ­¤å‰‡</button></div>
        </div>
      </div>
    `).join('');

    // Add event listener for image lightbox
    ovList.querySelectorAll('.msg-img').forEach(img => {
      img.addEventListener('click', (e) => {
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImg = document.getElementById('imageLightboxImg');
        lightboxImg.src = e.target.src;
        lightbox.style.display = 'flex';
      });
    });

    ovList.onclick = async (e)=>{
      const t = e.target;
      if (!(t instanceof Element) || !t.classList.contains('del-one')) return;
      const msgEl = t.closest('.msg');
      const mid = msgEl && msgEl.getAttribute('data-id');
      if (!mid) return alert('æ‰¾ä¸åˆ°ç•™è¨€ID');
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‰‡ç•™è¨€ï¼Ÿ')) return;
      t.disabled = true;
      try{
        const rr = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(code) + '&id=' + encodeURIComponent(mid) + '&_method=DELETE', {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ _method: 'DELETE' }),
          credentials:'include'
        });
        if (!rr.ok) throw new Error('HTTP '+rr.status);
        // After deletion, re-fetch and re-render to update the list
        const updatedData = await fetchStories(code);
        renderMessages(code, updatedData);
      }catch(err){
        alert('åˆªé™¤å¤±æ•—ï¼š'+err.message);
      }finally{
        t.disabled = false;
      }
    };
}

document.addEventListener('DOMContentLoaded', loadProducts);

// Close image lightbox when clicking it
document.getElementById('imageLightbox').addEventListener('click', (e) => {
  e.currentTarget.style.display = 'none';
});
</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>商品留言管理（POST 刪除兼容版）｜守護指引</title>
<style>
  :root {
    --bg: #111827;
    --card: #1f2937;
    --muted: #9ca3af;
    --fg: #f9fafb;
    --line: #374151;
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --danger: #ef4444;
    --danger-hover: #dc2626;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;}
  h1{font-size:28px;margin:12px 0 20px 0;letter-spacing:.5px;font-weight:800;color:var(--fg);}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,0.2);}
  .muted{color:var(--muted);font-size:13px;}
  .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px;}
  @media (min-width:860px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }

  /* Product Item Card */
  .item{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px;transition:all 0.2s ease;}
  .item:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.25);}
  .item .title{font-weight:700;font-size:18px;color:var(--fg);}
  .item .id{font-size:13px;color:var(--muted);font-weight:500;}
  .item .deity-info{font-size:14px;color:var(--muted);margin-top:4px;}
  .item .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;}

  /* Buttons */
  .btn{
    appearance:none;border:1px solid var(--line);background:var(--card);color:var(--fg);
    border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:600;
    transition:all 0.2s ease;
  }
  .btn:hover{filter:brightness(1.1);border-color:var(--muted);}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff;}
  .btn.primary:hover{background:var(--primary-hover);border-color:var(--primary-hover);}
  .btn.warn, .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff;}
  .btn.warn:hover, .btn.danger:hover{background:var(--danger-hover);border-color:var(--danger-hover);}

  /* Log */
  #log{margin-top:16px;font-size:13px;color:var(--muted);white-space:pre-wrap;background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--line);}

  /* Overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px;}
  .panel{position:relative;background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:flex;flex-direction:column;max-width:800px;width:100%;max-height:90vh;}
  .panel header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10;}
  .panel header strong{font-size:18px;font-weight:700;}
  .panel header .ov-code{font-size:14px;color:var(--muted);margin-left:10px;}
  .panel header .row{margin:0;}
  .panel main{padding:10px 20px;overflow-y:auto;flex-grow:1;}
  .panel footer{padding:14px 20px;border-top:1px solid var(--line);background:var(--bg);position:sticky;bottom:0;z-index:10;}

  /* Message List */
  #ovList{display:flex;flex-direction:column;gap:16px;}
  #ovList:empty::before{content:"目前沒有留言。";display:block;text-align:center;color:var(--muted);padding:20px;border:1px dashed var(--line);border-radius:8px;}
  .msg{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start;}
  .msg .msg-left{flex-shrink:0;}
  .msg .msg-img{width:64px;height:64px;object-fit:cover;border-radius:8px;background:var(--bg);cursor:pointer;transition:opacity 0.2s ease;}
  .msg .msg-img:hover{opacity:0.8;}
  .msg .msg-body{flex-grow:1;min-width:0;}
  .msg .msg-head{display:flex;justify-content:space-between;align-items:baseline;gap:8px;margin-bottom:4px;}
  .msg .msg-nick{font-weight:700;color:var(--fg);font-size:15px;}
  .msg .msg-date{font-size:12px;color:var(--muted);white-space:nowrap;}
  .msg .msg-text{font-size:14px;color:var(--fg);line-height:1.6;white-space:pre-wrap;word-break:break-word;}
  .msg .msg-actions{margin-top:8px;text-align:right;}
  .msg .btn.del-one{padding:6px 10px;font-size:12px;font-weight:500;}

  /* Raw JSON Textarea */
  textarea.raw{width:100%;min-height:120px;background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;resize:vertical;}

  /* Image Lightbox for Overlay */
  #imageLightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:10000;align-items:center;justify-content:center;padding:20px;}
  #imageLightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);cursor:pointer;}
</style>
</head>
<body>
<div class="wrap">
  <h1>商品留言管理</h1>
  <div class="card">
    <p class="muted">本頁從 <code>/api/products</code> 讀取商品清單；「管理留言」可載入該商品的所有留言，逐筆刪除或一鍵全刪。</p>
    <div id="productList" class="grid">讀取中...</div>
    <div id="log" class="muted"></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="panel">
    <header>
      <div style="display:flex;align-items:baseline;">
        <strong>留言管理：</strong>
        <span class="ov-code" id="ovCode"></span>
      </div>
      <div class="row">
        <button class="btn danger" id="ovDelAll">刪除全部</button>
        <button class="btn primary" id="ovClose">關閉</button>
      </div>
    </header>
    <main id="ovList">載入中…</main>
    <footer>
      <div class="muted" style="margin-bottom:6px">原始回應（除錯用）：</div>
      <textarea class="raw" id="ovRaw" readonly>（等待載入）</textarea>
    </footer>
  </div>
</div>

<!-- Image Lightbox for Message Images -->
<div id="imageLightbox" class="overlay">
  <img id="imageLightboxImg" src="" alt="留言圖片">
</div>

<script>
const API_BASE = location.origin;
const $ = (s)=>document.querySelector(s);
function toast(msg){ $('#log').textContent = msg; }
function esc(s){ return String(s||'').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }

async function loadProducts(){
  const list = $('#productList');
  list.textContent = '載入中...';
  try{
    const res = await fetch(API_BASE + '/api/products',{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const items = data.items || [];
    if(!items.length){ list.textContent = '目前沒有上架商品'; return; }
    list.innerHTML = items.map(p => `
      <div class="item" data-id="${esc(p.id||'')}">
        <div class="title">${p.name ? esc(p.name) : '（未命名）'}</div>
        <div class="id">ID：${esc(p.id||'(無 ID)')}</div>
        ${p.deity?`<div class="deity-info">神祇：${esc(p.deity)}</div>`:''}
        <div class="row">
          <button class="btn" data-act="view">查看留言(JSON)</button>
          <button class="btn primary" data-act="manage">管理留言</button>
          <button class="btn warn" data-act="del">整品項全刪</button>
        </div>
      </div>
    `).join('');
    list.onclick = handleListAction;
  }catch(e){
    $('#productList').textContent = '讀取失敗：' + e.message;
  }
}

function handleListAction(e){
  const t = e.target;
  if (!(t instanceof Element)) return;
  const act = t.getAttribute('data-act');
  if (!act) return;
  const wrap = t.closest('.item');
  if (!wrap) return;
  const id = (wrap.getAttribute('data-id')||'');
  if (!id) return toast('找不到此商品 ID');
  if (act === 'view'){
    window.open(API_BASE + '/api/stories?code=' + encodeURIComponent(id), '_blank');
  }
  if (act === 'del'){
    delAllViaPost(id);
  }
  if (act === 'manage'){
    openOverlay(id);
  }
}

async function delAllViaPost(id){
  const code = id;
  if (!confirm('刪除 '+code+' 的所有留言？')) return;
  try{
    const r = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(code) + '&_method=DELETE', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ _method: 'DELETE' })
    });
    if (!r.ok) throw new Error('HTTP '+r.status);
    toast('已刪除 '+code+' 的所有留言');
  }catch(e){
    toast('刪除失敗：' + e.message);
  }
}

async function fetchStories(code){
  const r = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(code), { cache:'no-store' });
  const js = await r.json();
  return js;
}

/* overlay logic */
const overlay = $('#overlay');
const ovCode = $('#ovCode');
const ovList = $('#ovList');
const ovRaw  = $('#ovRaw');

$('#ovClose').onclick = ()=> overlay.style.display = 'none';
$('#ovDelAll').onclick = ()=>{
  const code = ovCode.textContent.trim();
  if (!code) return;
  delAllViaPost(code);
};

async function openOverlay(code){
  ovCode.textContent = code;
  ovList.textContent = '載入中…';
  ovRaw.value = '（等待載入）';
  overlay.style.display = 'block';
  try{
    const data = await fetchStories(code);
    renderMessages(code, data);
  }catch(e){
    ovList.textContent = '讀取失敗：' + e.message;
    ovRaw.value = '讀取失敗：' + e.message;
  }
}

function renderMessages(code, data){
    ovRaw.value = JSON.stringify(data, null, 2);
    const arr = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    if (!arr.length){
      ovList.innerHTML = ''; // Let CSS handle the empty state message
      return;
    }
    ovList.innerHTML = arr.map(m => `
      <div class="msg" data-id="${esc(m.id||'')}">
        ${m.imageUrl ? `<div class="msg-left"><img src="${esc(m.imageUrl)}" class="msg-img" data-caption="${esc((m.nick || '匿名') + ' 的分享')}" alt="留言圖片"></div>` : ''}
        <div class="msg-body">
          <div class="msg-head">
            <div class="msg-nick">${esc(m.nick || '匿名')}</div>
            <div class="msg-date">${m.ts ? new Date(m.ts).toLocaleString() : '-'}</div>
          </div>
          <div class="msg-text">${esc(m.msg||m.text||'')}</div>
          <div class="msg-actions"><button class="btn danger del-one" data-act="del-one">刪除此則</button></div>
        </div>
      </div>
    `).join('');

    // Add event listener for image lightbox
    ovList.querySelectorAll('.msg-img').forEach(img => {
      img.addEventListener('click', (e) => {
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImg = document.getElementById('imageLightboxImg');
        lightboxImg.src = e.target.src;
        lightbox.style.display = 'flex';
      });
    });

    ovList.onclick = async (e)=>{
      const t = e.target;
      if (!(t instanceof Element) || !t.classList.contains('del-one')) return;
      const msgEl = t.closest('.msg');
      const mid = msgEl && msgEl.getAttribute('data-id');
      if (!mid) return alert('找不到留言ID');
      if (!confirm('確定要刪除此則留言？')) return;
      t.disabled = true;
      try{
        const rr = await fetch(API_BASE + '/api/stories?code=' + encodeURIComponent(code) + '&id=' + encodeURIComponent(mid) + '&_method=DELETE', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ _method: 'DELETE' })
        });
        if (!rr.ok) throw new Error('HTTP '+rr.status);
        // After deletion, re-fetch and re-render to update the list
        const updatedData = await fetchStories(code);
        renderMessages(code, updatedData);
      }catch(err){
        alert('刪除失敗：'+err.message);
      }finally{
        t.disabled = false;
      }
    };
}

document.addEventListener('DOMContentLoaded', loadProducts);

// Close image lightbox when clicking it
document.getElementById('imageLightbox').addEventListener('click', (e) => {
  e.currentTarget.style.display = 'none';
});
</script>
</body>
</html>

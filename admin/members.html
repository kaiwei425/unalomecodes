<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="後台會員管理頁（僅限管理員）。">
<meta name="robots" content="noindex,nofollow">
<link rel="canonical" href="https://shop.unalomecodes.com/admin/members">
<title>會員管理｜unalomecodes</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--line:#1f2937;--brand:#3b82f6;}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1022,#0f172a);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;}
  .backLink{margin-bottom:10px;}
  .backBtn{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 12px;border-radius:999px;
    background:#111827;border:1px solid #263046;color:#e5e7eb;
    text-decoration:none;font-weight:700;font-size:13px;
    transition:all .18s ease;
  }
  .backBtn:hover{border-color:#3b82f6;color:#3b82f6;}
  h1{font-size:22px;margin:12px 0 16px 0;letter-spacing:.5px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px}
  .bar input,.bar select{background:#0f172a;border:1px solid #263046;color:#e5e7eb;border-radius:10px;padding:8px 10px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.06);vertical-align:top}
  th{color:#94a3b8;font-weight:700;text-align:left;background:#0f172a;position:sticky;top:0}
  tbody tr:hover{background:#0f172a}
  .muted{color:#94a3b8}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #334155;font-size:12px;color:#e5e7eb}
  .badge.green{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,.08)}
  .badge.blue{border-color:#3b82f6;color:#3b82f6;background:rgba(59,130,246,.08)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;}
  .action-btn{border:none;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700;cursor:pointer;background:#1f2937;color:#e2e8f0;border:1px solid #334155;}
  .action-btn:hover{border-color:#f97316;color:#f97316;}
  .action-btn.danger{border-color:#7f1d1d;color:#fecaca;background:rgba(127,29,29,.15);}
  .action-btn.danger:hover{border-color:#fca5a5;color:#fca5a5;}
  html.admin-guard-hide{visibility:hidden;}
</style>
<script>document.documentElement.classList.add('admin-guard-hide');</script>
<script src="/js/admin-guard.js" defer></script>
<link rel="stylesheet" href="/admin/admin-ui.css">
<script src="/js/admin-shell.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="backLink"><a class="backBtn" href="./index.html">← 返回主選單</a></div>
    <h1>會員管理</h1>
    <div class="bar">
      <input id="q" placeholder="搜尋 姓名 / Email / 手機">
      <select id="sortSel">
        <option value="lastLogin">最近登入</option>
        <option value="created">註冊時間</option>
        <option value="name">姓名</option>
      </select>
      <button id="reload" class="backBtn" style="border-radius:10px;">重新整理</button>
      <span class="muted" id="count"></span>
    </div>
    <div class="card">
      <div style="overflow:auto; max-height:70vh;">
        <table>
          <thead>
            <tr>
          <th style="min-width:160px">姓名 / Email</th>
          <th style="min-width:120px">手機</th>
          <th style="min-width:180px">預設門市</th>
          <th style="min-width:140px">守護神</th>
          <th style="min-width:160px">登入 / 建立</th>
          <th style="min-width:140px">操作</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="6" class="muted">載入中…</td></tr></tbody>
    </table>
  </div>
</div>
  </div>
<script>
  const API = (window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com') + '/api/admin/users';
  const API_RESET = (window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com') + '/api/admin/users/reset-guardian';
  const API_DELETE = (window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com') + '/api/admin/users/delete';
  const q = document.getElementById('q');
  const tbody = document.getElementById('tbody');
  const sortSel = document.getElementById('sortSel');
  const countEl = document.getElementById('count');
  let items = [];

  function render(){
    let list = items.slice();
    const key = (q.value||'').trim().toLowerCase();
    if (key){
      list = list.filter(u=> JSON.stringify(u).toLowerCase().includes(key));
    }
    const sort = sortSel.value;
    list.sort((a,b)=>{
      if (sort === 'name') return String(a.name||'').localeCompare(String(b.name||''));
      if (sort === 'created'){
        return new Date(b.createdAt||0) - new Date(a.createdAt||0);
      }
      return new Date(b.lastLoginAt||b.updatedAt||b.createdAt||0) - new Date(a.lastLoginAt||a.updatedAt||a.createdAt||0);
    });
    if (countEl) countEl.textContent = `共 ${list.length} 位`;
    tbody.innerHTML = list.map(u=>{
      const store = u.defaultStore || {};
      const storeText = store.name ? `${store.name}${store.id ? '（'+store.id+'）' : ''}` : '';
      const guardianName = (u.guardian && (u.guardian.name || u.guardian.code)) ? (u.guardian.name || u.guardian.code) : '';
      return `<tr>
        <td>
          <div style="font-weight:700">${escapeHtml(u.name||'（未填寫）')}</div>
          <div class="muted">${escapeHtml(u.email||'')}</div>
        </td>
        <td>${escapeHtml((u.defaultContact && u.defaultContact.phone) || '')}</td>
        <td>${escapeHtml(storeText)}</td>
        <td>${guardianName ? `<span class="badge blue">${escapeHtml(guardianName)}</span>` : '<span class="muted">未設定</span>'}</td>
        <td>
          <div class="muted">登入：${fmt(u.lastLoginAt)}</div>
          <div class="muted">建立：${fmt(u.createdAt)}</div>
        </td>
        <td>
          <button class="action-btn" data-reset-id="${escapeHtml(u.id||'')}" data-reset-name="${escapeHtml(u.name||u.email||'')}">重置守護神</button>
          <button class="action-btn danger" data-del-id="${escapeHtml(u.id||'')}" data-del-name="${escapeHtml(u.name||u.email||'')}">刪除會員</button>
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="6" class="muted">目前沒有資料</td></tr>';
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]||c));
  }
  function fmt(ts){
    if (!ts) return '';
    try{ return new Date(ts).toLocaleString(); }catch(_){ return ts; }
  }

  async function load(){
    tbody.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
    try{
      const res = await fetch(API, { credentials:'include', cache:'no-store' });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || !data.ok){
        throw new Error(data.error || ('HTTP '+res.status));
      }
      items = Array.isArray(data.items) ? data.items : [];
      render();
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="6" style="color:#f87171;">讀取失敗：${escapeHtml(err.message||err)}</td></tr>`;
    }
  }

  document.getElementById('reload').addEventListener('click', load);
  q.addEventListener('input', ()=>{ clearTimeout(q._t); q._t=setTimeout(render,200); });
  sortSel.addEventListener('change', render);
  tbody.addEventListener('click', async e=>{
    const resetBtn = e.target.closest('[data-reset-id]');
    if (resetBtn){
      const id = resetBtn.getAttribute('data-reset-id');
      const name = resetBtn.getAttribute('data-reset-name') || '';
      if (!id) return;
      if (!confirm(`確定要重置 ${name ? name + ' 的' : ''}守護神？`)) return;
      try{
        const res = await fetch(API_RESET, {
          method:'POST',
          credentials:'include',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ id })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        await load();
        alert('已重置守護神');
      }catch(err){
        alert('重置失敗：' + (err.message || err));
      }
      return;
    }
    const delBtn = e.target.closest('[data-del-id]');
    if (!delBtn) return;
    const id = delBtn.getAttribute('data-del-id');
    const name = delBtn.getAttribute('data-del-name') || '';
    if (!id) return;
    const confirmText = prompt(`確定要刪除會員「${name || id}」嗎？\n此動作不可復原。\n請輸入「刪除」確認`);
    if (confirmText !== '刪除') return;
    try{
      const res = await fetch(API_DELETE, {
        method:'POST',
        credentials:'include',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ id, confirm:'刪除' })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
      await load();
      alert('已刪除會員');
    }catch(err){
      alert('刪除失敗：' + (err.message || err));
    }
  });
  load();
</script>
</body>
</html>

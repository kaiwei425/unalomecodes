<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
<title>後台｜商品管理</title>
<meta name="theme-color" content="#f8fafc" />
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --fg:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --primary:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 16px 40px rgba(15,23,42,.12);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:'Space Grotesk', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .backLink{margin-bottom:12px;}
  .backBtn{
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 12px;border-radius:999px;
    background:#fff;border:1px solid var(--line);color:var(--fg);
    text-decoration:none;font-weight:700;font-size:13px;
    box-shadow:0 6px 14px rgba(15,23,42,.08);
    transition:all .18s ease;
  }
  .backBtn:hover{border-color:var(--primary);color:var(--primary);}
  h1{margin:0 0 12px;font-size:26px;font-weight:800;letter-spacing:.3px;}
  h3{margin:0 0 10px;font-size:18px;font-weight:700;}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:18px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr;}}
  .card{
    background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:20px;
    box-shadow:var(--shadow);
  }
  .row{display:flex;gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;font-weight:700;letter-spacing:.02em;}
  input,textarea,select{
    width:100%;background:#fff;border:1px solid var(--line);color:var(--fg);
    padding:11px 12px;border-radius:12px;font-size:14px; transition: border-color .2s ease, box-shadow .2s ease;
  }
  input:focus,textarea:focus,select:focus{
    outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,0.2);
  }
  textarea{min-height:120px;line-height:1.6}
  .btn{
    appearance:none;border:1px solid var(--line);background:#f8fafc;color:var(--fg);
    padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;
    transition: all .18s ease;letter-spacing:.02em;
  }
  .btn:hover{filter: brightness(1.04); transform: translateY(-1px); box-shadow:0 8px 18px rgba(15,23,42,.08);}
  .btn:active{transform: translateY(0);}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);border-color:#1d4ed8; color: #fff;}
  .btn.ok{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:#16a34a;color:#fff}
  .btn.warn{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#f59e0b;color:#0f172a}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);border-color:#dc2626; color: #fff;}
  .btn.ghost{background:#fff; border-color: var(--line);}
  .muted{color:var(--muted);font-size:12px}
  .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .thumb{position:relative}
  .thumb img{width:84px;height:84px;object-fit:cover;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:0 6px 14px rgba(15,23,42,.08);}
  .thumb .x{
    position:absolute;top:-8px;right:-8px;background:var(--danger);color:#fff;border:2px solid var(--panel);border-radius:50%;
    width:24px;height:24px;cursor:pointer;font-weight:700; display:flex; align-items:center; justify-content:center;
    transition: transform .2s ease;
  }
  .thumb .x:hover{ transform: scale(1.1); }
  .hr{height:1px;background:var(--line);margin:12px 0}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden;}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px;vertical-align:top}
  th{color:var(--muted);font-weight:700; padding-top: 8px; padding-bottom: 12px;background:#f9fafb;}
  tbody tr:hover{ background: #f3f4f6; }
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{font-size:12px;background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:4px 10px; font-weight: 600;border:1px solid #c7d2fe;}
  .chip.alt{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
  .tools{display:flex;gap:6px;flex-wrap:wrap}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0 12px}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#f8fafc;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .badge.green{background:#dcfce7;color:#166534}
  .badge.gray{background:#e5e7eb;color:#374151}
  .hint{font-size:12px;color:var(--muted)}
  .footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,0.55); backdrop-filter: blur(6px); display:none;align-items:center;justify-content:center;padding:16px;overflow:auto}
  .modal .box{max-width:680px;width:100%;max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px; box-shadow: var(--shadow);}
  .modal .head{position:sticky;top:0;z-index:2;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;background:#fff;border-bottom:1px solid var(--line)}
  .modal .close{background:#fff;border:1px solid var(--line);color:var(--fg);border-radius:8px;padding:6px 10px;cursor:pointer}
  .variants{display:grid;gap:8px}
  .varRow{display:grid;grid-template-columns:1fr 110px 110px 34px;gap:8px}
  .varHead{display:grid;grid-template-columns:1fr 110px 110px 34px;gap:8px;font-size:12px;color:#6b7280;margin:6px 0}
  .varHead > div{padding:0 2px}
  @media(max-width:560px){
    .varRow{grid-template-columns:1fr 1fr; row-gap:10px}
    .varHead{display:none}
  }
  html.admin-guard-hide{visibility:hidden;}
</style>
<script>document.documentElement.classList.add('admin-guard-hide');</script>
<script src="/js/admin-guard.js" defer></script>
<link rel="stylesheet" href="/admin/admin-ui.css">
<script src="/js/admin-shell.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="backLink"><a class="backBtn" href="./index.html">← 返回主選單</a></div>
  <h1>商品管理後台</h1>
  <div class="grid">
    <!-- 左：新增商品 -->
    <div class="card">
      <h3 style="margin:0 0 6px">新增商品</h3>
      <div class="muted">上傳多張圖片 → 設定基本資料與規格 → 建立</div>
      <label>商品名稱</label>
      <input id="new_name" placeholder="例：四面神 · 開運加持牌" />

      <label>神祇（方便前台篩選，可留空）</label>
      <input id="new_deity" placeholder="例：四面神 / 象神 / 招財女神…" />
      <label>神祇代碼（用於優惠券比對，兩碼大寫）</label>
      <select id="new_deityCode">
        <option value="">（不設定）</option>
        <option value="WE">WE｜五眼四耳</option>
        <option value="XZ">XZ｜徐祝老人</option>
        <option value="KP">KP｜坤平</option>
        <option value="CD">CD｜崇迪</option>
        <option value="RH">RH｜拉胡</option>
        <option value="HM">HM｜哈魯曼</option>
        <option value="FM">FM｜四面神</option>
        <option value="GA">GA｜象神</option>
        <option value="JL">JL｜迦樓羅</option>
        <option value="ZD">ZD｜澤度金</option>
        <option value="ZF">ZF｜招財女神</option>
        <option value="HP">HP｜魂魄勇</option>
      </select>
      <div class="hint">建議同時填「神祇名稱」與「神祇代碼」。前台折扣比對會以代碼為準。</div>

      <label>分類（決定前台流程）</label>
      <select id="new_category">
        <option value="佛牌/聖物">佛牌/聖物</option>
        <option value="蠟燭加持祈福">蠟燭加持祈福</option>
        <option value="跑廟行程">跑廟行程</option>
        <option value="其他">其他</option>
      </select>

      <div class="row">
        <div style="flex:1">
          <label>基礎價格（NT$）</label>
          <input id="new_price" type="number" min="0" step="1" value="0" />
        </div>
        <div style="flex:1">
          <label>已售出（顯示用，會隨訂單自動累加）</label>
          <input id="new_sold" type="number" min="0" step="1" value="0" />
        </div>
      </div>

      <label>商品描述</label>
      <textarea id="new_desc" placeholder="材質、尺寸、加持資訊、注意事項…"></textarea>
      <label>Instagram 影片連結（選填）</label>
      <input id="new_instagram" placeholder="https://www.instagram.com/p/XXXX/">
      <div class="hint">貼上 IG 貼文或 Reels 的網址，前台商品頁會自動嵌入影片。</div>

      <div class="hr"></div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <label style="margin:0">圖片上傳（可多選）</label>
        <button class="btn ghost" id="btnUpload">選擇圖片</button>
        <input id="filePicker" type="file" accept="image/*" multiple style="display:none" />
      </div>
      <div class="thumbs" id="new_imgs"></div>
      <div class="hint">上傳成功後會出現縮圖；點右上角 × 可刪除並移除檔案（會刪 R2）。</div>

      <div class="hr"></div>

      <label>規格（外殼）</label>
      <div class="varHead"><div>名稱</div><div>加價（NT$）</div><div>庫存</div><div></div></div>
      <div class="variants" id="new_vars"></div>
      <button class="btn" id="btnAddVar" style="margin-top:8px">＋新增規格</button>

      <div class="hr"></div>
      <div class="row" style="gap:8px">
        <button class="btn primary" id="btnCreate">建立商品</button>
        <div class="muted" id="createMsg"></div>
      </div>
    </div>

    <!-- 右：商品列表 -->
    <div class="card">
      <div class="toolbar">
        <div class="row" style="gap:8px;align-items:center">
          <input id="q" placeholder="搜尋名稱/神祇關鍵字…" style="width:260px" />
          <span class="pill">
            <label style="margin:0;display:flex;gap:6px;align-items:center">
              <input id="onlyActive" type="checkbox" />
              只看上架
            </label>
          </span>
        </div>
        <button class="btn" id="btnReload">重新整理</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:60px">圖</th>
            <th>商品</th>
            <th style="width:120px">分類</th>
            <th style="width:110px">價格</th>
            <th style="width:100px">已售出</th>
            <th style="width:210px">操作</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">© 2025 unalomecodes</div>
</div>

<!-- 編輯 Modal -->
<div class="modal" id="editModal">
  <div class="box">
    <div class="head">
      <h3 style="margin:0">編輯商品</h3>
      <button class="close" id="closeEdit">關閉</button>
    </div>
    <div id="editBody"></div>
  </div>
</div>

<script>
(function(){
  const apiBase = window.__SHOP_ORIGIN || 'https://shop.unalomecodes.com';
  async function authedFetch(url, options){
    const opts = Object.assign({}, options || {});
    opts.credentials = 'include';
    const res = await fetch(url, opts);
    if (res.status === 401){
      throw new Error('未登入或無權限，請使用管理員帳號重新登入。');
    }
    return res;
  }
  // ==== 神祇代碼驗證 ====
  const VALID_DEITY_CODES = ["WE","XZ","KP","CD","RH","HM","FM","GA","JL","ZD","ZF","HP"];
  // 名稱對應代碼對照表
  const DEITY_NAME_TO_CODE = {
    "四面神": "FM",
    "象神": "GA",
    "招財女神": "ZF",
    "五眼四耳": "WE",
    "徐祝老人": "XZ",
    "坤平": "KP",
    "崇迪": "CD",
    "拉胡": "RH",
    "哈魯曼": "HM",
    "迦樓羅": "JL",
    "澤度金": "ZD",
    "魂魄勇": "HP"
  };

  // --- 與 shop.html 同步的分類正規化函式 ---
  const ALL_CATEGORIES = ["佛牌/聖物", "蠟燭加持祈福", "跑廟行程", "其他"];
  function normalizeCategory(p) {
    const cat = p && p.category;
    if (cat && ALL_CATEGORIES.includes(cat)) return cat;
    const name = (p && p.name || "").toLowerCase();
    if (name.includes("蠟燭")) return "蠟燭加持祈福";
    if (name.includes("跑廟")) return "跑廟行程";
    return "佛牌/聖物";
  }

  // ==== 工具 ====
  const $ = (id)=>document.getElementById(id);
  const el = (tag, attrs={}, html="")=>{
    const e = document.createElement(tag);
    for (const k in attrs) {
      if (k === "class") e.className = attrs[k];
      else if (k === "style") e.setAttribute("style", attrs[k]);
      else e[k] = attrs[k];
    }
    if (html) e.innerHTML = html;
    return e;
  };

  // ==== 新增商品：規格 UI ====
  const newVars = $("new_vars");
  const addVarRow = (parent, data={name:"", priceDiff:0, stock:0})=>{
    const row = el("div", { class:"varRow" });
    const inName = el("input", { placeholder:"外殼名稱（例：銀色）", value: data.name||"", title:"規格名稱" });
    const inDiff = el("input", { type:"number", step:"1", min:"0", value: Number(data.priceDiff||0), placeholder:"加價（NT$）", title:"此規格相對於基礎價格的加價金額（NT$）" });
    const inStock= el("input", { type:"number", step:"1", min:"0", value: Number(data.stock||0), placeholder:"庫存數量", title:"此規格可販售的庫存數量" });
    const btnDel = el("button", { class:"btn danger", title:"刪除規格" }, "×");
    btnDel.addEventListener("click", ()=> row.remove());
    row.append(inName, inDiff, inStock, btnDel);
    parent.append(row);
  };
  $("btnAddVar").addEventListener("click", ()=> addVarRow(newVars));

  // ==== 上傳 ====
  const newImgsBox = $("new_imgs");
  $("btnUpload").addEventListener("click", ()=> $("filePicker").click());
  $("filePicker").addEventListener("change", async (ev)=>{
    const files = Array.from(ev.target.files || []);
    if (!files.length) return;
    const fd = new FormData();
    files.forEach(f=> fd.append("files[]", f));
    setBusy(true);
    try{
      const res = await authedFetch(apiBase + "/api/upload", { method:"POST", body:fd });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||"上傳失敗");
      for (const it of data.files) addThumb(newImgsBox, it.url);
    }catch(e){ alert(e.message||e); }
    setBusy(false);
    ev.target.value = "";
  });

  function addThumb(container, url, onRemoveR2=true){
    const box = el("div", { class:"thumb" });
    const img = el("img", { src:url, loading:"lazy", crossOrigin:"anonymous" });
    const x = el("button", { class:"x" }, "×");
    x.addEventListener("click", async ()=>{
      if (!confirm("確定刪除此圖片？（會刪除儲存檔案）")) return;
      try{
        await authedFetch(apiBase + "/api/deleteFile", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ url })
        });
      }catch(e){}
      box.remove();
    });
    box.append(img, x);
    container.append(box);
  }

  // ==== 建立商品 ====
  $("btnCreate").addEventListener("click", async ()=>{
    const name = $("new_name").value.trim();
    const deity = $("new_deity").value.trim();
    const deityCode = $("new_deityCode") ? $("new_deityCode").value.trim().toUpperCase() : "";
    const category = ($("new_category") && $("new_category").value) || "佛牌/聖物";
    const basePrice = Number($("new_price").value || 0);
    const sold = Number($("new_sold").value || 0);
    const description = $("new_desc").value.trim();
    const instagram = $("new_instagram") ? $("new_instagram").value.trim() : "";

    const images = Array.from(newImgsBox.querySelectorAll("img")).map(i=>i.src);
    const variants = Array.from(newVars.querySelectorAll(".varRow")).map(row=>{
      const [n, d, s] = row.querySelectorAll("input");
      return { name:n.value.trim(), priceDiff:Number(d.value||0), stock:Number(s.value||0) };
    });

    if (!name || !images.length) {
      $("createMsg").textContent = "請至少輸入名稱並上傳一張圖片。";
      return;
    }
    // 神祇代碼驗證
    if (deityCode) {
      if (!/^[A-Z]{2}$/.test(deityCode) || !VALID_DEITY_CODES.includes(deityCode)) {
        $("createMsg").textContent = "神祇代碼格式不正確，請重新選擇。";
        return;
      }
    }

    setBusy(true);
    $("createMsg").textContent = "建立中…";
    try{
      const res = await authedFetch(apiBase + "/api/products", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name, deity, deityCode, category, basePrice, sold, description, images, variants, instagram, active:true })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||"建立失敗");
      $("createMsg").textContent = "✅ 已建立";
      clearNewForm();
      await reloadList();
    }catch(e){
      $("createMsg").textContent = "❌ " + (e.message||e);
    }
    setBusy(false);
  });

  function clearNewForm(){
    $("new_name").value = "";
    $("new_deity").value = "";
    if ($("new_deityCode")) $("new_deityCode").value = "";
    $("new_price").value = "0";
    $("new_sold").value  = "0";
    $("new_desc").value  = "";
    if ($("new_instagram")) $("new_instagram").value = "";
    newImgsBox.innerHTML = "";
    newVars.innerHTML = "";
  }

  // ==== 列表 ====
  $("btnReload").addEventListener("click", reloadList);
  $("q").addEventListener("input", renderList);
  $("onlyActive").addEventListener("change", renderList);

  let allItems = [];
  async function reloadList(){
    setBusy(true);
    try{
      const onlyActive = $("onlyActive").checked ? "?active=true" : "";
      const res = await authedFetch(apiBase + "/api/products" + onlyActive);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||"讀取失敗");
      allItems = data.items || [];
      renderList();
    }catch(e){ alert(e.message||e); }
    setBusy(false);
  }

  function renderList(){
    const q = $("q").value.trim().toLowerCase();
    const tbody = $("list");
    tbody.innerHTML = "";
    const items = allItems.filter(p=>{
      if (!q) return true;
      return (p.name||"").toLowerCase().includes(q) || (p.deity||"").toLowerCase().includes(q);
    });
    for (const p of items){
      const tr = el("tr");
      const firstImg = (p.images && p.images[0]) ? p.images[0] : "";
      tr.append(
        tdImg(firstImg),
        tdInfo(p),
        tdCategory(p),
        tdPrice(p),
        tdSold(p),
        tdTools(p)
      );
      tbody.append(tr);
    }
  }

  function tdImg(url){
    const td = el("td");
    if (url) {
      const img = el("img", { src:url, style:"width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #262730;background:#0e0e12" });
      td.append(img);
    } else {
      td.textContent = "—";
    }
    return td;
  }
  function tdInfo(p){
    const td = el("td");
    const t = el("div", { style:"font-weight:700" }, escapeHtml(p.name||"未命名"));
    const chips = el("div", { class:"chips", style:"margin-top:6px" });
    if (p.category) chips.append(el("div",{ class:"chip alt" },"分類："+escapeHtml(p.category)));
    if (p.deity)    chips.append(el("div",{ class:"chip" },"神祇："+escapeHtml(p.deity)));
    if (p.deityCode) chips.append(el("div",{ class:"chip" },"代碼："+escapeHtml(p.deityCode)));
    chips.append(el("div",{ class:"chip "+(p.active? "alt": "") }, p.active ? "上架中" : "已下架"));
    td.append(t, chips);
    return td;
  }
  function tdCategory(p){
    const td = el("td");
    const cat = normalizeCategory(p);
    td.textContent = cat;
    return td;
  }
  function tdPrice(p){
    const td = el("td");
    td.innerHTML = `NT$ ${Number(p.basePrice||0).toLocaleString()}`;
    return td;
  }
  function tdSold(p){
    const td = el("td");
    td.innerHTML = `<span class="badge ${p.sold>0?'green':'gray'}">${Number(p.sold||0)}</span>`;
    return td;
  }
  function tdTools(p){
    const td = el("td");
    const box = el("div",{ class:"tools" });
    const b1 = el("button",{ class:"btn" },"編輯");
    const b2 = el("button",{ class:"btn "+(p.active? "warn":"ok") }, p.active ? "下架" : "上架");
    const b3 = el("button",{ class:"btn danger" },"刪除");
    b1.addEventListener("click", ()=> openEdit(p.id));
    b2.addEventListener("click", ()=> toggleActive(p));
    b3.addEventListener("click", ()=> removeProduct(p.id));
    box.append(b1,b2,b3);
    td.append(box);
    return td;
  }

  async function toggleActive(p){
    if (!confirm(`確定要${p.active? "下架":"上架"}「${p.name}」？`)) return;
    setBusy(true);
    try{
      await authedFetch(`${apiBase}/api/products/${encodeURIComponent(p.id)}`, {
        method:"PATCH",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ active: !p.active })
      });
      await reloadList();
    }catch(e){ alert(e.message||e); }
    setBusy(false);
  }

  async function removeProduct(id){
    if (!confirm("刪除後無法復原，確定刪除？")) return;
    setBusy(true);
    try{
      await authedFetch(`${apiBase}/api/products/${encodeURIComponent(id)}`, { method:"DELETE" });
      await reloadList();
    }catch(e){ alert(e.message||e); }
    setBusy(false);
  }

  // ==== 編輯 Modal ====
  const modal = $("editModal");
  $("closeEdit").addEventListener("click", ()=> modal.style.display="none");

  async function openEdit(id){
    setBusy(true);
    try{
      const res = await authedFetch(`${apiBase}/api/products/${encodeURIComponent(id)}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||"讀取失敗");
      const p = data.product;
      renderEdit(p);
      modal.style.display = "flex";
    }catch(e){ alert(e.message||e); }
    setBusy(false);
  }

  function renderEdit(p){
    const box = $("editBody");
    box.innerHTML = "";

    const name = inputRow("商品名稱", p.name||"");
    const deity= inputRow("神祇", p.deity||"");

    // 神祇代碼（兩碼）
    const deityCodeWrap = el("div");
    const deityCodeLab  = el("label",{}, "神祇代碼（兩碼大寫）");
    const deityCodeSel  = el("select");
    [
      ["","（不設定）"],
      ["WE","WE｜五眼四耳"],["XZ","XZ｜徐祝老人"],["KP","KP｜坤平"],
      ["CD","CD｜崇迪"],["RH","RH｜拉胡"],["HM","HM｜哈魯曼"],
      ["FM","FM｜四面神"],["GA","GA｜象神"],["JL","JL｜迦樓羅"],
      ["ZD","ZD｜澤度金"],["ZF","ZF｜招財女神"],["HP","HP｜魂魄勇"]
    ].forEach(([v,t])=>{
      const o = el("option",{ value:v }, t);
      if ((p.deityCode||"") === v) o.selected = true;
      deityCodeSel.append(o);
    });
    deityCodeWrap.append(deityCodeLab, deityCodeSel);

    // 分類選擇
    const catWrap = el("div");
    const catLab  = el("label",{}, "分類");
    const catSel  = el("select");
    ["佛牌/聖物","蠟燭加持祈福","跑廟行程","其他"].forEach(v=>{
      const opt = el("option",{ value:v }, v);
      // 使用新的正規化函式來確保正確選中
      if (normalizeCategory(p) === v) opt.selected = true;
      catSel.append(opt);
    });
    catWrap.append(catLab, catSel);

    const price= inputRow("基礎價格（NT$）", String(Number(p.basePrice||0)), "number");
    const sold = inputRow("已售出", String(Number(p.sold||0)), "number");
    const desc = areaRow("商品描述", p.description||"");
    const ig = inputRow("Instagram 影片連結（選填）", p.instagram || "");

    const imgTitle = el("label",{}, "圖片");
    const addBtn = el("button",{ class:"btn", style:"margin-left:8px" },"＋新增圖片");
    const picker  = el("input",{ type:"file", accept:"image/*", multiple:true, style:"display:none" });
    const thumbs  = el("div",{ class:"thumbs" });

    (p.images||[]).forEach(u=> addThumbEdit(thumbs, u, p));

    addBtn.addEventListener("click", ()=> picker.click());
    picker.addEventListener("change", async (ev)=>{
      const files = Array.from(ev.target.files||[]);
      if (!files.length) return;
      const fd = new FormData();
      files.forEach(f=> fd.append("files[]", f));
      setBusy(true);
      try{
        const r = await authedFetch(apiBase + "/api/upload", { method:"POST", body:fd });
        const d = await r.json();
        if (!d.ok) throw new Error(d.error||"上傳失敗");
        for (const it of d.files){
          p.images = p.images || [];
          p.images.push(it.url);
          addThumbEdit(thumbs, it.url, p);
        }
        await savePatch(p.id, { images: p.images });
      }catch(e){ alert(e.message||e); }
      setBusy(false);
      ev.target.value = "";
    });

    const varsTitle = el("label",{},"規格（外殼）");
    const varsHead  = el("div",{ class:"varHead" });
    varsHead.innerHTML = '<div>名稱</div><div>加價（NT$）</div><div>庫存</div><div></div>';
    const varsBox   = el("div",{ class:"variants" });
    (p.variants||[]).forEach(v=> addVarEdit(varsBox, v, p));
    const btnAddV   = el("button",{ class:"btn", style:"margin-top:8px" },"＋新增規格");
    btnAddV.addEventListener("click", ()=>{
      const v = { name:"", priceDiff:0, stock:0 };
      p.variants = p.variants || [];
      p.variants.push(v);
      addVarEdit(varsBox, v, p);
      queueSave(p.id, { variants: p.variants });
    });

    const btnRow = el("div",{ class:"row", style:"gap:8px;margin-top:12px" });
    const btnSave= el("button",{ class:"btn primary" },"儲存變更");
    const tip    = el("div",{ class:"muted" },"你也可以邊改邊存：欄位失焦、刪圖/加圖、增減規格時會自動 PATCH。");
    btnSave.addEventListener("click", async ()=>{
      const payload = {
        name: name.input.value.trim(),
        deity: deity.input.value.trim(),
        deityCode: deityCodeSel.value.trim().toUpperCase(),
        category: catSel.value,
        basePrice: Number(price.input.value||0),
        sold: Number(sold.input.value||0),
        description: desc.input.value.trim(),
        instagram: ig.input.value.trim(),
        images: p.images||[],
        variants: p.variants||[]
      };
      await savePatch(p.id, payload, true);
      await reloadList();
      alert("已儲存");
    });
    btnRow.append(btnSave, tip);

    box.append(
      name.row, deity.row, deityCodeWrap, catWrap,
      twoCols(price.row, sold.row),
      desc.row,
      ig.row,
      hr(),
      rowBetween(imgTitle, addBtn),
      thumbs, picker,
      hr(),
      varsTitle, varsHead, varsBox, btnAddV,
      hr(),
      btnRow
    );

    // 欄位失焦即存
    [name.input, deity.input, price.input, sold.input, desc.input, ig.input].forEach(inp=>{
      inp.addEventListener("change", ()=> {
        queueSave(p.id, {
          name: name.input.value.trim(),
          deity: deity.input.value.trim(),
          basePrice: Number(price.input.value||0),
          sold: Number(sold.input.value||0),
          description: desc.input.value.trim(),
          instagram: ig.input.value.trim()
        });
      });
    });

    // deityCode 欄位變更即存 + 驗證
    deityCodeSel.addEventListener("change", ()=> {
      const val = deityCodeSel.value.trim().toUpperCase();
      if (val && (!/^[A-Z]{2}$/.test(val) || !VALID_DEITY_CODES.includes(val))) {
        alert("神祇代碼格式不正確，請重新選擇。");
        deityCodeSel.value = "";
        return;
      }
      queueSave(p.id, { deityCode: val });
    });
    // 分類變動即存
    catSel.addEventListener("change", ()=> {
      queueSave(p.id, { category: catSel.value });
    });
  }

  function addThumbEdit(container, url, p){
    const box = el("div",{ class:"thumb" });
    const img = el("img",{ src:url, loading:"lazy", crossOrigin:"anonymous" });
    const x   = el("button",{ class:"x" },"×");
    x.addEventListener("click", async ()=>{
      if (!confirm("刪除此圖片？（會刪除檔案並自商品移除）")) return;
      try{
        await authedFetch(apiBase + "/api/deleteFile", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ url })
        });
      }catch(e){}
      p.images = (p.images||[]).filter(u=>u!==url);
      box.remove();
      queueSave(p.id, { images: p.images });
    });
    box.append(img,x);
    container.append(box);
  }

  function addVarEdit(container, v, p){
    const row = el("div",{ class:"varRow" });
    const n = el("input",{ value:v.name||"", placeholder:"外殼名稱", title:"規格名稱" });
    const d = el("input",{ type:"number", step:"1", min:"0", value:Number(v.priceDiff||0), placeholder:"加價（NT$）", title:"此規格相對於基礎價格的加價金額（NT$）" });
    const s = el("input",{ type:"number", step:"1", min:"0", value:Number(v.stock||0), placeholder:"庫存數量", title:"此規格可販售的庫存數量" });
    const del= el("button",{ class:"btn danger" },"×");
    const sync = ()=> {
      v.name = n.value.trim();
      v.priceDiff = Number(d.value||0);
      v.stock = Number(s.value||0);
      queueSave(p.id, { variants: p.variants });
    };
    [n,d,s].forEach(inp=> inp.addEventListener("change", sync));
    del.addEventListener("click", ()=>{
      if (!confirm("刪除此規格？")) return;
      p.variants = (p.variants||[]).filter(x=> x!==v);
      row.remove();
      queueSave(p.id, { variants: p.variants });
    });
    row.append(n,d,s,del);
    container.append(row);
  }

  // === 小工具區 ===
  function inputRow(labelText, val="", type="text"){
    const row = el("div");
    const lab = el("label",{}, labelText);
    const inp = el("input",{ value:val, type });
    row.append(lab, inp);
    return { row, input:inp };
  }
  function areaRow(labelText, val=""){
    const row = el("div");
    const lab = el("label",{}, labelText);
    const inp = el("textarea"); inp.value = val;
    row.append(lab, inp);
    return { row, input:inp };
  }
  function rowBetween(a,b){
    const r = el("div",{ class:"row", style:"align-items:center;justify-content:space-between" });
    r.append(a,b); return r;
  }
  function twoCols(a,b){
    const r = el("div",{ class:"row" });
    a.style="flex:1"; b.style="flex:1";
    r.append(a,b); return r;
  }
  function hr(){ return el("div",{ class:"hr" }); }
  function setBusy(on){
    document.body.style.cursor = on? "progress":"default";
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  let saveTimer = null, savePayload = null, saveId = null;
  function queueSave(id, payload){
    saveId = id;
    savePayload = Object.assign({}, savePayload || {}, payload);
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      await savePatch(saveId, savePayload);
      saveTimer = null;
      savePayload = null;
      saveId = null;
    }, 500);
  }
  async function savePatch(id, payload, force=false){
    try{
      const res = await authedFetch(`${apiBase}/api/products/${encodeURIComponent(id)}`, {
        method:"PATCH",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||"儲存失敗");
      if (force) await reloadList();
      return true;
    }catch(e){ alert(e.message||e); return false; }
  }

  // 初次載入
  reloadList();

  // ==== 新增商品表單：神祇名稱 input 自動對應神祇代碼 ====
  if ($("new_deity")) {
    $("new_deity").addEventListener("input", function(ev){
      const val = this.value.trim();
      let matched = "";
      // 直接比對全名
      for (const k in DEITY_NAME_TO_CODE) {
        if (val === k) { matched = DEITY_NAME_TO_CODE[k]; break; }
      }
      // 若沒完全符合，嘗試模糊包含
      if (!matched) {
        for (const k in DEITY_NAME_TO_CODE) {
          if (val.includes(k)) { matched = DEITY_NAME_TO_CODE[k]; break; }
        }
      }
      if ($("new_deityCode")) {
        $("new_deityCode").value = matched;
      }
    });
  }
})();
</script>
</body>
</html>

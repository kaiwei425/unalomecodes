<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ¸¬é©—èˆ‡æ‚¨æœ‰ç·£çš„å®ˆè­·ç¥</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Inter:wght@500;600;700&display=swap');
    :root{
      --bg:#0b1223;
      --card:rgba(255,255,255,0.86);
      --muted:#6b7280;
      --brand:#f59e0b;
      --ok:#10b981;
      --accent:#2563eb;
      --text:#0f172a;
      --text-strong:#0b0c10;
      --border:rgba(255,255,255,0.35);
      --chip:rgba(255,255,255,0.72);
      --shadow:0 18px 48px rgba(6,15,40,.24);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Space Grotesk','Inter',-apple-system,'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
      background:
        radial-gradient(circle at 12% 20%, rgba(56,189,248,.16), transparent 28%),
        radial-gradient(circle at 82% 10%, rgba(37,99,235,.22), transparent 28%),
        radial-gradient(circle at 40% 70%, rgba(16,185,129,.16), transparent 38%),
        #0b1223;
      color:var(--text);
      line-height:1.7;
      -webkit-font-smoothing:antialiased;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(11,18,35,0.75);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,0.08);
      box-shadow:0 12px 26px rgba(0,0,0,.32);
    }
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 32px}
    .brand{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .brand img{width:46px;height:46px;border-radius:14px;box-shadow:0 0 0 4px rgba(245,158,11,.35)}
    .brand h1{font-size:22px;margin:0;color:#fff;letter-spacing:.35px;font-weight:800;}
    .tagline{margin:2px 0 0;color:rgba(255,255,255,0.78);font-size:13px;}
    .brand-actions{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .brand-actions .btn{font-size:13px;padding:10px 14px;min-height:40px}
    @media(max-width:720px){
      .brand-actions{width:100%;justify-content:flex-end}
      .brand-actions .btn{flex:1 1 48%}
    }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,0.55);
      border-radius:20px;
      padding:20px;
      margin:18px 0;
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
    }
    h2{font-size:22px;margin:0 0 12px 0;color:var(--text-strong);letter-spacing:.2px;}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .btn{
      display:flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 16px;border-radius:14px;border:1px solid rgba(0,0,0,0.05);
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      color:var(--text);text-decoration:none;cursor:pointer;font-weight:800;letter-spacing:.02em;
      box-shadow:0 10px 30px rgba(15,23,42,.16);transition:.16s ease;
      font-size:16px;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.03);}
    .btn:active{transform:translateY(0) scale(.99);}
    .btn.primary{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#0b0c10;border-color:rgba(245,158,11,.6);}
    .btn.ok{background:linear-gradient(135deg,#10b981,#22c55e);color:#0b0c10;border-color:#16a34a;}
    .btn.ghost{background:#fff;color:var(--text);border-color:rgba(0,0,0,0.06);}
    .chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
    .chip{
      padding:12px 14px;border-radius:14px;
      background:var(--chip);border:1px solid rgba(255,255,255,0.8);cursor:pointer;
      color:var(--text);font-weight:700;box-shadow:0 8px 22px rgba(15,23,42,.16);
      transition:.16s ease;font-size:15px;
    }
    .chip:hover{transform:translateY(-1px);border-color:rgba(37,99,235,.4);}
    .chip.active{outline:2px solid var(--accent);background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.55);}
    .step{margin:10px 0 2px;font-size:12px;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;}
    .q{font-size:20px;font-weight:800;margin:6px 0 16px}
    .footer{display:grid;gap:10px;margin-top:14px;grid-template-columns:1fr 1fr;}
    #resultBox .footer{grid-template-columns:repeat(2,minmax(0,1fr));align-items:stretch}
    #resultBox .footer .btn{min-height:54px;font-size:14px;padding:12px 10px;text-align:center;white-space:normal}
    .result{padding:16px;border-radius:14px;background:#f9fafb;border:1px dashed rgba(0,0,0,0.08);white-space:pre-wrap;line-height:1.8;box-shadow:inset 0 1px 0 rgba(255,255,255,.8);}
    code.k{background:#111827;padding:2px 6px;border-radius:6px;border:1px solid #1f2937;color:#facc15;}
    .note{font-size:12px;color:var(--muted)}
    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#f59e0b,#2563eb);width:0%}
    #resultBox{border:1px solid rgba(0,0,0,0.05);}
    #resultBox img{border-radius:16px;box-shadow:0 14px 28px rgba(0,0,0,.16);}
    .fortune-dialog{border:none;border-radius:18px;padding:0;max-width:560px;width:92%;background:#0b1022;color:#e5e7eb;box-shadow:0 24px 60px rgba(0,0,0,.45);}
    .fortune-shell{padding:20px;display:grid;gap:16px;background:
      radial-gradient(circle at 20% 10%, rgba(253,224,71,.08), transparent 38%),
      radial-gradient(circle at 80% 0%, rgba(56,189,248,.12), transparent 40%),
      #0b1022;border-radius:18px;border:1px solid rgba(148,163,184,0.2);}
    .fortune-head{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .fortune-title{font-size:18px;font-weight:800;letter-spacing:.5px;}
    .fortune-date{font-size:12px;color:#94a3b8;}
    .fortune-close{border:none;background:rgba(255,255,255,.1);color:#e2e8f0;border-radius:999px;width:28px;height:28px;cursor:pointer;}
    .fortune-loading{padding:16px;border-radius:14px;border:1px dashed rgba(148,163,184,.3);background:rgba(15,23,42,.55);color:#cbd5f5;font-size:13px;text-align:center;}
    .fortune-error{padding:12px;border-radius:12px;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.4);color:#fecaca;font-size:13px;}
    .fortune-card{padding:16px;border-radius:16px;background:linear-gradient(135deg,#111827,#0f172a);border:1px solid rgba(94,234,212,.25);box-shadow:0 16px 36px rgba(0,0,0,.35);}
    .fortune-stars{font-size:16px;letter-spacing:2px;color:#fbbf24;margin-bottom:6px;}
    .fortune-summary{font-size:16px;font-weight:800;color:#f8fafc;margin-bottom:10px;}
    .fortune-section{margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.18);}
    .fortune-label{font-size:12px;letter-spacing:1px;color:#94a3b8;margin-bottom:6px;}
    .fortune-text{font-size:14px;line-height:1.7;color:#e2e8f0;}
    .fortune-meta{margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:#cbd5f5;}
    .fortune-meta span{padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.3);background:rgba(15,23,42,.6);}
    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.55);backdrop-filter:blur(4px);z-index:9999;}
    .loading-card{background:#fff;border-radius:16px;padding:18px 22px;min-width:220px;text-align:center;box-shadow:0 18px 40px rgba(15,23,42,.25);}
    .loading-spinner{width:34px;height:34px;border-radius:50%;border:3px solid rgba(37,99,235,.2);border-top-color:#f59e0b;animation:quizSpin .8s linear infinite;margin:0 auto 10px;}
    .loading-title{font-weight:800;font-size:16px;margin-bottom:4px;color:#0f172a;}
    .loading-sub{font-size:12px;color:#64748b;}
    @keyframes quizSpin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    /* ç­”é¡ŒæŒ‰éˆ•çµ±ä¸€å°ºå¯¸ï¼Œæ‰‹æ©Ÿæ˜“é» */
    #opts .btn{width:100%; min-height:72px; border-radius:16px;}
  </style>
  <meta name="quiz-token" content="quiz_5A9kU3tZmE4hW2xP7qL8vN0r">
</head>
<body>
  <header>
    <div class="wrap brand">
      <img id="brandLogo" src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="logo" />
      <div>
        <h1>æ¸¬é©—èˆ‡æ‚¨æœ‰ç·£çš„å®ˆè­·ç¥</h1>
        <p class="tagline">7 é¡Œ 1 åˆ†é˜ï¼Œæ‰¾å‡ºå®ˆè­·ç¥ï¼Œè§£é–å°ˆå±¬å„ªæƒ èˆ‡é…æˆ´å»ºè­°</p>
      </div>
      <div class="brand-actions">
        <button type="button" class="btn primary" data-fortune-btn>é ˜å–æ—¥ç±¤</button>
        <a class="btn primary" href="/shop">å›åˆ°é¦–é </a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card step-card" id="stepDow">
      <h2>ä½ æ˜¯æ˜ŸæœŸå¹¾å‡ºç”Ÿï¼Ÿ</h2>
      <div id="dowBox" class="chips" role="group" aria-label="weekday"></div>
    </div>

    <div class="card step-card" id="stepZod">
      <h2>ä½ çš„æ˜Ÿåº§ï¼Ÿ</h2>
      <div id="zodiacBox" class="chips" role="group" aria-label="zodiac"></div>
    </div>

    <div class="card step-card" id="quizBox">
      <div id="qTitle" class="q"></div>
      <div id="opts" class="grid"></div>
      <div class="footer">
        <button id="prevBtn" class="btn">â† ä¸Šä¸€é¡Œ</button>
        <button id="nextBtn" class="btn primary">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>

    <div class="card" id="lineFortuneEntry" style="display:none">
      <h2>å·²å®Œæˆå®ˆè­·ç¥æ¸¬é©—</h2>
      <div class="result" id="lineFortuneDesc">ä½ å¯ä»¥ç›´æ¥é ˜å–æ—¥ç±¤ã€‚</div>
      <div class="footer">
        <button type="button" class="btn primary" data-fortune-btn>é ˜å–æ—¥ç±¤</button>
        <button type="button" class="btn" id="lineRetakeBtn">é‡æ–°æ¸¬é©—å®ˆè­·ç¥</button>
      </div>
    </div>

    <div class="card" id="resultBox" style="display:none">
      <h2>ä½ çš„å®ˆè­·è€…</h2>
      <img id="deityImg" alt="å®ˆè­·ç¥" crossorigin="anonymous" referrerpolicy="no-referrer" style="display:none;width:100%;max-height:300px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:12px;" />
      <div class="result" id="resultText">å°šæœªå®Œæˆä½œç­”</div>
      <div style="margin:12px 0">
        <div class="step">ç·£åˆ†å€¼</div>
        <div class="bar"><div id="affBar" class="fill"></div></div>
        <div id="affText" class="note" style="margin-top:6px"></div>
      </div>
      <div style="margin:18px 0 8px">
        <h2 style="margin-bottom:8px">ä½›ç‰Œé…æˆ´å»ºè­°</h2>
        <div id="amuletAdvice" class="result" style="display:none">è¼‰å…¥ä¸­â€¦</div>
        <div class="footer" id="adviceActions" style="margin-top:8px">
          <button id="getCouponBtn" class="btn ok">é»æˆ‘é ˜å–å°ˆå±¬å„ªæƒ </button>
        </div>
        <div id="couponWrap" class="result" style="display:none"></div>
        <div style="margin-top:8px">
          <button id="copyCouponBtn" class="btn ghost" style="display:none">è¤‡è£½å„ªæƒ ç¢¼</button>
          <button id="saveCouponBtn" class="btn" style="display:none">å­˜åˆ°æˆ‘çš„å„ªæƒ åˆ¸</button>
        </div>
      </div>
      <div class="footer">
        <a id="deityLink" target="_blank" rel="noopener" class="btn">æŸ¥çœ‹å®Œæ•´ä»‹ç´¹</a>
        <a id="shareLink" class="btn ok">é‡æ–°æ¸¬é©—ä¸€æ¬¡</a>
        <a id="menuLink" target="_blank" rel="noopener" class="btn">ç€è¦½å…¶ä»–å®ˆè­·è€…</a>
        <a class="btn" href="/shop">å‰å¾€é¸è³¼å°ˆå±¬è–ç‰©</a>
      </div>
    </div>

    <dialog id="fortuneDialogQuiz" class="fortune-dialog">
      <div class="fortune-shell">
        <div class="fortune-head">
          <div>
            <div class="fortune-title">ä»Šæ—¥å°ˆå±¬æ—¥ç±¤</div>
            <div class="fortune-date" id="fortuneDateQuiz">â€”</div>
          </div>
          <button type="button" class="fortune-close" id="fortuneCloseQuiz">âœ•</button>
        </div>
        <div class="fortune-body">
          <div id="fortuneLoadingQuiz" class="fortune-loading">æ­£åœ¨ç¿»ç‰Œä¸­â€¦</div>
          <div id="fortuneErrorQuiz" class="fortune-error" style="display:none;"></div>
          <div id="fortuneCardQuiz" class="fortune-card" style="display:none;">
            <div class="fortune-stars" id="fortuneStarsQuiz"></div>
            <div class="fortune-summary" id="fortuneSummaryQuiz"></div>
            <div class="fortune-section">
              <div class="fortune-label">ç”Ÿæ´»å°å»ºè­°</div>
              <div class="fortune-text" id="fortuneAdviceQuiz"></div>
            </div>
            <div class="fortune-section">
              <div class="fortune-label" id="fortuneRitualLabelQuiz">å®ˆè­·ç¥æƒ³å°ä½ èªª</div>
              <div class="fortune-text" id="fortuneRitualQuiz"></div>
            </div>
            <div class="fortune-meta" id="fortuneMetaQuiz"></div>
          </div>
        </div>
      </div>
    </dialog>
  </main>
  <script>window.LIFF_ID = '2008307812-RVDkHkD5';</script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/js/auth.js?v=20240922"></script>
  <div id="resultLoading" class="loading-overlay" role="status" aria-live="polite">
    <div class="loading-card">
      <div class="loading-spinner" aria-hidden="true"></div>
      <div class="loading-title">å®ˆè­·ç¥æ„Ÿæ‡‰ä¸­â€¦</div>
      <div class="loading-sub">è«‹ç¨å€™</div>
    </div>
  </div>

<script>
/* =====================
   CONFIGï¼ˆå¯æ”¹ï¼‰
===================== */
// ç¥ˆç¦å»ºè­°ä»ä½¿ç”¨æ—¢æœ‰ Workerï¼ˆåŒ…å«å®ˆè­·ç¥è³‡æ–™èˆ‡å»ºè­°ï¼‰
const ADVICE_BASE = 'https://proud-boat-794c.kaiwei425.workers.dev';
const API_BASE = ADVICE_BASE; // ä¾›èˆŠæœ‰åˆ†äº«/å®ˆè­·ç¥è³‡æ–™ API ä½¿ç”¨
// æœ¬ç«™ APIï¼ˆæ–°å„ªæƒ åˆ¸ç³»çµ±ã€å•†å“çµå¸³ï¼‰
const SITE_BASE   = (function(){ try{ return location.origin; }catch(e){ return 'https://shop.unalomecodes.com'; }})();
// ä½¿ç”¨æ—¢æœ‰å¯ç”¨çš„å¤–éƒ¨ç¶²åŸŸï¼Œä»¥ç¢ºä¿ã€ŒæŸ¥çœ‹å®Œæ•´ä»‹ç´¹ï¼åˆ†äº«çµæœï¼ç€è¦½å…¶ä»–å®ˆè­·è€…ã€å¯æ­£å¸¸é–‹å•Ÿ
const SHARE_PAGE = 'https://unalomecodes.pages.dev/share';
const DEITY_PAGE = 'https://unalomecodes.pages.dev/deity';
const DEITY_IMG_OVERRIDES = { CD:'https://i.ibb.co/rGpp2w1s/image.jpg', RH:'https://i.ibb.co/qMy9RxVx/image.jpg', HM:'https://i.ibb.co/kV0pz49B/image.jpg', WE:'https://i.ibb.co/pv4Jc4sc/image.jpg', XZ:'https://i.ibb.co/V0hNnFHT/image.jpg', JL:'https://i.ibb.co/wrWW3ddN/image.jpg', ZD:'https://i.ibb.co/xtJtDTVy/image.jpg', KP:'https://i.ibb.co/k29dc4Qn/image.jpg', FM:'https://i.ibb.co/SXGB6vKj/image.jpg', GA:'https://i.ibb.co/2RhD1k9/image.jpg', HP:'https://i.ibb.co/ymcrPm1C/image.jpg', ZF:'https://i.ibb.co/CRctyB3/image.jpg' };
const BRAND_NAME = 'å®ˆè­·æŒ‡å¼•';
const BRAND_LOGO = 'https://i.ibb.co/7mtppQQ/logo.jpg';
// Coupon service endpoint + token reader (needed for REAL issuance)
const COUPON_API = (function(){ try{ return SITE_BASE + '/api/coupons'; }catch(e){ return '/api/coupons'; }})();
function readQuizToken(){
  try{
    var el = document.querySelector('meta[name="quiz-token"]');
    return el && el.content ? String(el.content).trim() : '';
  }catch(e){ return ''; }
}

/* =====================
   åŸºç¤è³‡æ–™ï¼ˆå–è‡ª worker.jsï¼‰
===================== */
const GODS = ['FM','GA','CD','KP','HP','XZ','WE','HM','RH','JL','ZD','ZF'];
const DOW = {
  Sun:{label:'æ˜ŸæœŸæ—¥', color:'ç´…è‰²',  tip:'è±¡å¾µåŠ›é‡èˆ‡æ¦®è€€ï¼Œè®“ä½ åœ¨äººç¾¤ä¸­å±•ç¾è‡ªä¿¡èˆ‡å…‰å½©', weight:['JL','GA','WE']},
  Mon:{label:'æ˜ŸæœŸä¸€', color:'é»ƒè‰²',  tip:'è±¡å¾µæ™ºæ…§èˆ‡ç†è§£åŠ›ï¼Œå¹«åŠ©ä½ ä»¥æŸ”å…‹å‰›',                   weight:['CD','XZ','KP']},
  Tue:{label:'æ˜ŸæœŸäºŒ', color:'ç²‰ç´…è‰²',tip:'è±¡å¾µå‹‡æ°£èˆ‡æ„›ï¼Œæ¨å‹•ä½ ä¸»å‹•æ”¹è®Š',                         weight:['HM','HP','WE']},
  Wed:{label:'æ˜ŸæœŸä¸‰', color:'ç¶ è‰²',  tip:'è±¡å¾µæˆé•·èˆ‡å’Œè«§ï¼Œè®“ä½ åœ¨è®Šå‹•ä¸­ç©©å®šå‰è¡Œ',                 weight:['KP','XZ','FM']},
  Thu:{label:'æ˜ŸæœŸå››', color:'æ©˜è‰²',  tip:'è±¡å¾µæ™ºæ…§èˆ‡å­¸ç¿’ï¼Œå¸¶ä¾†è²´äººèˆ‡æ–°çŸ¥',                       weight:['FM','CD','RH']},
  Fri:{label:'æ˜ŸæœŸäº”', color:'è—è‰²',  tip:'è±¡å¾µæ„›èˆ‡è—è¡“ï¼Œè®“ä½ æ›´å…·åŒ…å®¹èˆ‡è¦ªå’ŒåŠ›',                   weight:['ZF','KP','XZ']},
  Sat:{label:'æ˜ŸæœŸå…­', color:'ç´«è‰²',  tip:'è±¡å¾µå®ˆè­·èˆ‡æ´å¯Ÿï¼Œå¹«ä½ è½‰å±ç‚ºå®‰',                         weight:['RH','WE','CD']}
};
const ZODIAC = {
  Aries:{name:'ç‰¡ç¾Šåº§ â™ˆï¸', element:'ç«'},
  Taurus:{name:'é‡‘ç‰›åº§ â™‰ï¸', element:'åœŸ'},
  Gemini:{name:'é›™å­åº§ â™Šï¸', element:'é¢¨'},
  Cancer:{name:'å·¨èŸ¹åº§ â™‹ï¸', element:'æ°´'},
  Leo:{name:'ç…å­åº§ â™Œï¸', element:'ç«'},
  Virgo:{name:'è™•å¥³åº§ â™ï¸', element:'åœŸ'},
  Libra:{name:'å¤©ç§¤åº§ â™ï¸', element:'é¢¨'},
  Scorpio:{name:'å¤©è åº§ â™ï¸', element:'æ°´'},
  Sagittarius:{name:'å°„æ‰‹åº§ â™ï¸', element:'ç«'},
  Capricorn:{name:'é­”ç¾¯åº§ â™‘ï¸', element:'åœŸ'},
  Aquarius:{name:'æ°´ç“¶åº§ â™’ï¸', element:'é¢¨'},
  Pisces:{name:'é›™é­šåº§ â™“ï¸', element:'æ°´'}
};
const QUESTIONS = {
  1:{ text:'ä½ çš„è·æ¥­æœ€æ¥è¿‘å“ªä¸€ç¨®ï¼Ÿ',
      opts:{ A:'å‰µæ¥­ï¼è‡ªé›‡', B:'ç®¡ç†ï¼è¡Œæ”¿ï¼ˆä¸Šç­æ—ï¼‰', C:'è¨­è¨ˆï¼è—è¡“ï¼å…§å®¹å‰µä½œ',
             D:'éŠ·å”®ï¼è¡ŒéŠ·ï¼å…¬é—œ', E:'å·¥ç¨‹ï¼æŠ€è¡“ï¼é‡‘èæ•¸æ“š', F:'æœå‹™ï¼é†«ç™‚ï¼æ•™è‚²ï¼èº«å¿ƒå·¥ä½œ',
             G:'è‡ªç”±è·ï¼å…¼è·ï¼è½‰è·ä¸­', H:'å…¬å‹™å“¡' } },
  2:{ text:'ç•¶ä½ æƒ³æ”¹è®Šç”Ÿæ´»æ™‚ï¼Œä½ æœ€æƒ³å…ˆç²å¾—ä»€éº¼ï¼Ÿ',
      opts:{A:'å¡é—œçš„åœ°æ–¹èƒ½å¤ æœ‰é€²å±•',B:'è²¡å¯Œç©©å®šèˆ‡å¯Œè¶³',C:'æ‰¾åˆ°æ›´æ·±çš„ç›®æ¨™èˆ‡æŒ‡å¼•',D:'å®‰å…¨æ„Ÿèˆ‡å®ˆè­·',E:'å­¸æœƒæ”¾ä¸‹èˆ‡çœ‹æ¸…è‡ªå·±'}},
  3:{ text:'å¦‚æœåªçµ¦ä½ ä¸€é …ç¥ç¦ï¼Œä½ æœ€æœŸå¾…å“ªä¸€ç¨®ï¼Ÿ',
      opts:{A:'é–‹å•Ÿæ›´å¤šé“è·¯èˆ‡é¸æ“‡',B:'å¥½é‹èˆ‡è³‡æºè‡ªå·±ä¾†',C:'äººç·£æ¡ƒèŠ±ç›¸åŠ©',D:'å¼·åŠ›ä¿è­·é é›¢å¹²æ“¾',E:'çœ‹æ¸…æ–¹å‘å°ˆæ³¨ç•¶ä¸‹ä¸å…§è€—'}},
  4:{ text:'ä½ è¦ºå¾—è‡ªå·±æœ€å¸¸åè¦†é‡åˆ°çš„èª²é¡Œæ˜¯ï¼Ÿ',
      opts:{A:'æ©Ÿæœƒèˆ‡é˜»ç¤™äº¤éŒ¯',B:'è²¡é‹å¿½ä¸Šå¿½ä¸‹',C:'æ„Ÿæƒ…æˆ–äººéš›åè¦†',D:'å®¹æ˜“è¢«ä»–äººèƒ½é‡å½±éŸ¿',E:'å…§åœ¨ç³¾çµæ–¼å¾—å¤±'}},
  5:{ text:'æœ‹å‹æœ€å¯èƒ½æ€éº¼å½¢å®¹ä½ ï¼Ÿ',
      opts:{A:'è¡å‹åè¶³æœ‰ä¸»è¦‹',B:'è¦ªåˆ‡æœ‰é­…åŠ›æœƒåšäºº',C:'è°æ˜å†·éœæœ‰åˆ¤æ–·',D:'ç©©é‡å¯é çµ¦äººå®‰å…¨æ„Ÿ',E:'æœ‰é è¦‹å–„è¦åŠƒ'}},
  6:{ text:'ç•¶äº‹æƒ…ä¸é †åˆ©æ™‚ï¼Œä½ é€šå¸¸æ€éº¼å›æ‡‰ï¼Ÿ',
      opts:{A:'èª¿æ•´æ–¹æ³•å†è©¦ä¸€æ¬¡',B:'åœä¸‹ä¾†ä¸¦å¥½å¥½è§€å¯Ÿä¸€åˆ‡',C:'æ‰¾äººå•†é‡æˆ–ä»¥ä¿¡å¿µç©©å¿ƒ',D:'é€€ä¸€æ­¥å…ˆç©©ä½è‡ªå·±',E:'æ­£é¢è¿æˆ°å‹‡æ•¢è¡Œå‹•'}},
  7:{ text:'ä½ ç†æƒ³ä¸­çš„äººç”Ÿç‹€æ…‹æ˜¯ï¼Ÿ',
      opts:{A:'ä¸æ–·æ¥å—æ–°æŒ‘æˆ°è®“è‡ªå·±é€²æ­¥',B:'è²¡å¯Œè‡ªç”±ç”Ÿæ´»å¯Œè¶³',C:'æ“æœ‰ç©©å®šè€Œæ·±åˆ»çš„äººéš›é—œä¿‚',D:'å…§å¿ƒå¹³ç©©è¢«ä¿è­·çš„è¸å¯¦æ„Ÿ',E:'æ–¹å‘æ¸…æ¥šä¸¦ä¸”å°ˆæ³¨å‰è¡Œ'}}
};
// å•é¡Œé¸é …å°æ‡‰åŠ æ¬Šï¼ˆæ¯é¡Œæ¯é¸é …å°æ‡‰ç¥ç¥‡ï¼‰
const MAP = {
  1:{ // è·æ¥­
    A:['FM','GA','JL','RH'], B:['FM','KP','WE','ZD'], C:['CD','WE','XZ','ZF'],
    D:['GA','KP','XZ','ZF'], E:['WE','HM','FM','JL'], F:['HP','XZ','KP','WE'],
    G:['RH','FM','JL','WE'], H:['CD','KP','ZD','FM']
  },
  2:{ A:['FM','WE','KP','JL'], B:['ZD','XZ','ZF','KP'], C:['FM','JL','CD','WE'], D:['HP','RH','WE','FM'], E:['CD','WE','FM','HP'] },
  3:{ A:['JL','FM','KP','WE'], B:['XZ','ZD','RH','FM'], C:['KP','GA','XZ','ZF'], D:['HP','RH','FM','WE'], E:['WE','CD','FM','JL'] },
  4:{ A:['FM','WE','JL','KP'], B:['ZD','XZ','RH','KP'], C:['KP','GA','XZ','ZF'], D:['HP','RH','FM','WE'], E:['WE','CD','FM','JL'] },
  5:{ A:['GA','FM','JL','HM'], B:['KP','XZ','ZF','WE'], C:['WE','CD','FM','JL'], D:['FM','HP','KP','ZD'], E:['WE','JL','FM','CD'] },
  6:{ A:['FM','WE','KP','JL'], B:['WE','CD','FM','JL'], C:['KP','XZ','ZF','WE'], D:['HP','FM','RH','WE'], E:['GA','HM','FM','JL'] },
  7:{ A:['FM','JL','WE','HM'], B:['XZ','ZD','ZF','KP'], C:['KP','GA','XZ','ZF'], D:['HP','FM','RH','WE'], E:['WE','CD','FM','JL'] }
};

/* =====================
   è¨ˆç®—é‚è¼¯ï¼ˆå–è‡ª worker.jsï¼‰
===================== */
const JOB_KEYS   = ['A','B','C','D','E','F','G','H'];
const DOW_KEYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const ZODIAC_KEYS= ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];

function stableHash(str){
  let h = 2166136261>>>0;
  for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h>>>0;
}
function taipeiDateKey(ts){
  const t = typeof ts === 'number' ? ts : Date.now();
  const d = new Date(t + 8 * 3600 * 1000);
  return d.toISOString().slice(0, 10);
}
function encodeState(st){
  return [st.dow||'', st.zod||'', st.job||'', st.p2||'', st.p3||'', st.p4||'', st.p5||'', st.p6||'', st.p7||''].join('|');
}
const BALANCE_TOP_N = 8;
const BALANCE_WEIGHTS = (function(){
  const weights = Object.fromEntries(GODS.map(g=>[g,0]));
  Object.values(DOW).forEach(info=>{
    (info.weight || []).forEach(g=>{ if (g in weights) weights[g] += 1; });
  });
  Object.values(MAP).forEach(opts=>{
    Object.values(opts).forEach(arr=>{
      let w = 4;
      for (const g of arr){
        if (g in weights) weights[g] += w;
        w--;
        if (w <= 0) break;
      }
    });
  });
  return weights;
})();
function pickBalancedDeity(ranked, seedStr){
  const top = ranked.slice(0, BALANCE_TOP_N);
  let total = 0;
  const weights = top.map(([g])=>{
    const base = BALANCE_WEIGHTS[g] || 1;
    const w = 1 / base;
    total += w;
    return w;
  });
  const r = (stableHash(seedStr) % 1000000) / 1000000;
  let acc = 0;
  for (let i=0;i<top.length;i++){
    acc += weights[i] / total;
    if (r <= acc) return top[i][0];
  }
  return top[top.length - 1][0];
}
function compileScore(st){
  const score = Object.fromEntries(GODS.map(g=>[g,0]));
  // æ˜ŸæœŸåŠ æ¬Š
  const dw = DOW[st.dow]?.weight || [];
  for (const g of dw){ score[g] += 1; }
  // é¡Œç›®åŠ æ¬Š
  for (let i=1;i<=7;i++){
    const pick = st['p'+i];
    const arr = MAP[i]?.[pick] || [];
    let w = 4;
    for (const g of arr){ score[g] += w; w--; if (w<=0) break; }
  }
  return score;
}
function decideWinner(st){
  const score = compileScore(st);
  const ranked = Object.entries(score).sort((a,b)=> (b[1]-a[1]) || a[0].localeCompare(b[0]));
  const seed = encodeState(st);
  return pickBalancedDeity(ranked, seed);
}
function calcAffinityPercent(st, winner){
  const score = compileScore(st);
  let max=-Infinity, second=-Infinity;
  for (const v of Object.values(score)){
    if (v>max){ second=max; max=v; } else if (v>second){ second=v; }
  }
  const gap = Math.max(0, max - (second===-Infinity?0:second));
  const base = 86 + Math.min(8, gap*4);
  const tweak = stableHash(winner + ':' + encodeState(st)) % 5;
  const pct = Math.max(83, Math.min(99, base + tweak));
  return pct;
}
function affinityBrief(n){
  const p = Number(n)||0;
  if (p>=95) return 'æ¥µå¼·é€£çµ';
  if (p>=92) return 'é«˜åº¦å…±é³´';
  if (p>=88) return 'ç©©å®šåˆæ‹';
  if (p>=85) return 'æ­£åœ¨é è¿‘';
  return 'æœ‰ç¸å¾…å•Ÿå‹•';
}
// ç¥ç¥‡ä»£ç¢¼â†’ä¸­æ–‡åï¼ˆèˆ‡ deity.html åŒæ­¥ï¼‰
function deityName(code){
  const map = {FM:'å››é¢ç¥',GA:'è±¡ç¥',CD:'å´‡è¿ªä½›',KP:'å¤å¹³',HP:'é­‚é­„å‹‡',XZ:'å¾ç¥è€äºº',WE:'äº”çœ¼å››è€³',HM:'çŒ´ç¥å“ˆé­¯æ›¼',RH:'æ‹‰èƒ¡',JL:'è¿¦æ¨“ç¾…',ZD:'æ¾¤åº¦é‡‘',ZF:'æ‹›è²¡å¥³ç¥'};
  return map[code] || 'å®ˆè­·ç¥';
}

/* =====================
   UI ç‹€æ…‹
===================== */
const state = { dow:'', zod:'', job:'', p2:'', p3:'', p4:'', p5:'', p6:'', p7:'' };
let currentStep = 0; // 0: dow, 1: zod, 2..8: questions 1-7
const TOTAL_STEPS = 2 + 7;
let currentQuestion = 1;
const resultLoading = document.getElementById('resultLoading');
function setResultLoading(on){
  if (!resultLoading) return;
  resultLoading.style.display = on ? 'flex' : 'none';
}
const lineEntry = document.getElementById('lineFortuneEntry');
const lineFortuneDesc = document.getElementById('lineFortuneDesc');
const lineRetakeBtn = document.getElementById('lineRetakeBtn');
let forceQuiz = false;
function isLineClient(){
  return !!(window.liff && window.liff.isInClient && window.liff.isInClient());
}
function setQuizVisible(show){
  const ids = ['stepDow','stepZod','quizBox'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.style.display = show ? '' : 'none';
  });
}
function showLineEntry(profile){
  if (!lineEntry) return;
  if (!profile || !profile.guardian || forceQuiz){
    lineEntry.style.display = 'none';
    setQuizVisible(true);
    renderStep();
    return;
  }
  const name = profile.guardian.name || profile.guardian.code || 'å®ˆè­·ç¥';
  if (lineFortuneDesc){
    lineFortuneDesc.textContent = `å®ˆè­·ç¥ï¼š${name}ã€‚ä½ å¯ä»¥ç›´æ¥é ˜å–æ—¥ç±¤ï¼Œæˆ–é‡æ–°æ¸¬é©—ã€‚`;
  }
  lineEntry.style.display = '';
  setQuizVisible(false);
}
if (lineRetakeBtn){
  lineRetakeBtn.addEventListener('click', ()=>{
    forceQuiz = true;
    if (lineEntry) lineEntry.style.display = 'none';
    setQuizVisible(true);
    renderStep();
  });
}

// render weekday
const dowBox = document.getElementById('dowBox');
Object.entries(DOW).forEach(([k,v])=>{
  const b = document.createElement('div');
  b.className = 'chip'; b.textContent = v.label;
  b.onclick = ()=>{
    state.dow=k;
    [...dowBox.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
    nextStep();
  };
  dowBox.appendChild(b);
});

// render zodiac
const zodiacBox = document.getElementById('zodiacBox');
Object.entries(ZODIAC).forEach(([k,v])=>{
  const b = document.createElement('div');
  b.className='chip'; b.textContent = v.name;
  b.onclick = ()=>{
    state.zod=k;
    [...zodiacBox.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
    nextStep();
  };
  zodiacBox.appendChild(b);
});

// render questions
const qTitle = document.getElementById('qTitle');
const optsEl  = document.getElementById('opts');
function renderQ(qNum){
  currentQuestion = qNum;
  const q = QUESTIONS[qNum];
  qTitle.textContent = `ç¬¬ ${qNum} é¡Œï¼ˆå‰©é¤˜ ${Math.max(7-qNum,0)} é¡Œï¼‰ï½œ${q.text}`;
  optsEl.innerHTML='';
  const isJob = (qNum===1);
  Object.entries(q.opts).forEach(([k,label])=>{
    const btn = document.createElement('button');
    btn.className = 'btn'; btn.textContent = label;
    btn.style.textAlign='left';
    btn.onclick = ()=>{
      state['p'+qNum] = k;
      if (isJob) state.job = k;
      if (currentStep < TOTAL_STEPS-1){ nextStep(); }
      else { showResult(); }
    };
    const wrap = document.createElement('div'); wrap.appendChild(btn);
    optsEl.appendChild(wrap);
  });
  document.getElementById('prevBtn').style.display = currentStep>2 ? 'inline-flex' : 'none';
  document.getElementById('nextBtn').style.display = currentStep<TOTAL_STEPS-1 ? 'inline-flex' : 'none';
}
document.getElementById('prevBtn').onclick = ()=>{
  if (currentStep>0){ currentStep--; renderStep(); }
};
document.getElementById('nextBtn').onclick = ()=>{
  if (currentStep<TOTAL_STEPS-1){ currentStep++; renderStep(); }
};

function renderStep(){
  const cards = document.querySelectorAll('.step-card');
  cards.forEach(c=> c.style.display='none');
  if (currentStep === 0){
    document.getElementById('stepDow').style.display='';
  }else if (currentStep === 1){
    document.getElementById('stepZod').style.display='';
  }else{
    document.getElementById('quizBox').style.display='';
    renderQ(currentStep-1);
  }
}
function nextStep(){
  if (currentStep < TOTAL_STEPS-1){
    currentStep++;
    renderStep();
  }else{
    showResult();
  }
}

renderStep();
if (window.authState && typeof window.authState.onProfile === 'function'){
  window.authState.onProfile(profile=>{
    if (isLineClient() && profile && profile.guardian && profile.quiz){
      showLineEntry(profile);
    }else{
      if (!forceQuiz){
        if (lineEntry) lineEntry.style.display = 'none';
        setQuizVisible(true);
        renderStep();
      }
    }
  });
}

/* =====================
   çµæœ
===================== */
function buildShareUrl({code, job, dow, zod, aff, img}){
  const deity = deityName(code);
  const dayName = (DOW[dow]?.label)||'';
  const zodiacName = (ZODIAC[zod]?.name)||'';
  const color = (DOW[dow]?.color)||'';
  const params = new URLSearchParams({
    t:'quiz', deity, zodiac:zodiacName, color, dow:dayName,
    job:(QUESTIONS[1].opts[job]||''), brand:BRAND_NAME, api:API_BASE, affinity:String(aff||''), img: (img||''),
    logo: BRAND_LOGO,
  });
  return `${SHARE_PAGE}?${params.toString()}`;
}
function generateCoupon(code){
  const alpha = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // å»æ‰æ˜“æ··å­—å…ƒ
  function rand(n){ let s=''; for(let i=0;i<n;i++){ s += alpha[Math.floor(Math.random()*alpha.length)]; } return s; }
  const ts = new Date();
  const y = String(ts.getFullYear()).slice(-2);
  const m = String(ts.getMonth()+1).padStart(2,'0');
  const d = String(ts.getDate()).padStart(2,'0');
  // ä»£ç¢¼æ ¼å¼ï¼šUC-<ç¥ç¥‡>-<YYMMDD>-<4>-<4>
  return `UC-${code}-${y}${m}${d}-${rand(4)}-${rand(4)}`;
}

async function issueCoupon(deityCode, amount){
  const payload = { deity: String(deityCode||'').toUpperCase(), amount: Number(amount||200) };
  const headers = { 'Content-Type':'application/json' };
  // ç›´æ¥å‘¼å«æœ¬ç«™æ–°å„ªæƒ åˆ¸ç³»çµ±ï¼ˆå…¬å…± quiz ç™¼åˆ¸ç«¯é»ï¼‰
  const res = await fetch(`${COUPON_API}/issue-quiz`, {
    method: 'POST',
    headers,
    body: JSON.stringify(payload),
    credentials: 'include',
    cache: 'no-store'
  });
  if (!res.ok) throw new Error(`ISSUE_FAILED_${res.status}`);
  const j = await res.json();
  if (!j || !j.code) throw new Error('NO_CODE');
  return j.code;
}

async function showResult(){
  // guard
  if (!state.dow || !state.zod || !state.job || !state.p2 || !state.p3 || !state.p4 || !state.p5 || !state.p6 || !state.p7){
    alert('è«‹å®Œæ•´ä½œç­”ã€Œæ˜ŸæœŸã€æ˜Ÿåº§èˆ‡ 7 é¡Œã€'); return;
  }
  setResultLoading(true);
  try{
  // logged-in: allow only once per Taiwan day
  try{
    const res = await fetch('/api/me/profile', { credentials:'include', cache:'no-store' });
    if (res.ok){
      const data = await res.json().catch(()=>null);
      const profile = data && data.profile ? data.profile : null;
      const lastTs = profile && profile.quiz && profile.quiz.ts ? Date.parse(profile.quiz.ts) : 0;
      if (lastTs){
        const lastKey = taipeiDateKey(lastTs);
        const todayKey = taipeiDateKey(Date.now());
        if (lastKey === todayKey){
          alert('ä»Šå¤©å·²å®Œæˆæ¸¬é©—ï¼Œè«‹æ–¼å°ç£æ™‚é–“åˆå¤œ 12 é»å¾Œå†é‡æ–°æ¸¬é©—ã€‚');
          return;
        }
      }
    }
  }catch(_){}
  const code = decideWinner(state);
  const aff  = calcAffinityPercent(state, code);
  const name = deityName(code);
  // å–ç¥ç¥‡è³‡æ–™
  let meta = { name: name, img: '', desc: '' };
  try {
    const r = await fetch(`${API_BASE}/getDeity?code=${encodeURIComponent(code)}`);
    if (r.ok) { const j = await r.json(); meta.name = j.name || meta.name; meta.img = j.img || ''; meta.desc = j.desc || ''; }
  } catch {}
  // åœ–ç‰‡è¦†è“‹
  const finalImg = DEITY_IMG_OVERRIDES[code] || meta.img || '';
  // é¡¯ç¤ºåœ–ç‰‡
  const imgEl = document.getElementById('deityImg');
  if (finalImg) { imgEl.src = finalImg; imgEl.crossOrigin='anonymous'; imgEl.referrerPolicy='no-referrer'; imgEl.style.display = 'block'; }
  // textï¼ˆæ¯”ç…§ LINE çµæœæ–‡æ¡ˆçš„å®Œæ•´åº¦ï¼‰
  const jobLabel = QUESTIONS[1].opts[state.job] || 'â€”';
  const dayName  = DOW[state.dow]?.label || 'â€”';
  const color    = DOW[state.dow]?.color || '';
  const tip      = DOW[state.dow]?.tip || '';
  const zName    = ZODIAC[state.zod]?.name || 'â€”';
  const traits = [
    QUESTIONS[2].opts[state.p2],
    QUESTIONS[3].opts[state.p3],
    QUESTIONS[4].opts[state.p4],
    QUESTIONS[5].opts[state.p5],
    QUESTIONS[6].opts[state.p6],
    QUESTIONS[7].opts[state.p7]
  ].filter(Boolean);
  const quizProfile = {
    dow: state.dow,
    dowLabel: dayName,
    zod: state.zod,
    zodLabel: zName,
    job: state.job,
    jobLabel,
    color,
    traits,
    answers: { p2: state.p2, p3: state.p3, p4: state.p4, p5: state.p5, p6: state.p6, p7: state.p7 },
    ts: Date.now()
  };
  try{ localStorage.setItem('__lastQuizGuardian__', JSON.stringify({ code, name, ts: Date.now() })); }catch(_){}
  try{ localStorage.setItem('__lastQuizProfile__', JSON.stringify(quizProfile)); }catch(_){}
  try{ localStorage.setItem('__lastQuizBindPending__', JSON.stringify({ ts: Date.now() })); }catch(_){}
  // è‹¥å·²ç™»å…¥ï¼ŒåŒæ­¥åˆ°æœƒå“¡æª”æ¡ˆ
  try{
    await fetch('/api/me/profile', {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ guardian:{ code, name, ts: Date.now() }, quiz: quizProfile })
    });
  }catch(_){}
  const result = [
    `å®ˆè­·è€…ï¼š${meta.name || name}`,
    meta.desc ? `æŒ‡å¼•ï¼š${meta.desc.trim()}` : '',
    `æ˜Ÿåº§ï¼š${zName}`,
    color ? `ç”Ÿæ—¥æ˜ŸæœŸï¼š${dayName}ï¼ˆå¹¸é‹è‰²ï¼š${color}ï¼‰` : `ç”Ÿæ—¥æ˜ŸæœŸï¼š${dayName}`,
    `è·æ¥­ï¼ç•¶å‰è§’è‰²ï¼š${jobLabel}`,
    tip ? `å®ˆè­·é‡é»ï¼š${tip}` : '',
    `ç·£åˆ†å€¼ï¼š${aff}%ï½œ${affinityBrief(aff)}`
  ].filter(Boolean).join('\n\n');
  document.getElementById('resultText').textContent = result;
  // affinity bar
  const bar = document.getElementById('affBar');
  bar.style.width = aff + '%';
  document.getElementById('affText').textContent = `${aff}% ï½œ ${affinityBrief(aff)}`;
  // links
  document.getElementById('deityLink').href = `${DEITY_PAGE}?code=${encodeURIComponent(code)}&api=${encodeURIComponent(API_BASE)}`;
  document.getElementById('shareLink').href = buildShareUrl({ code, job:state.job, dow:state.dow, zod:state.zod, aff:aff, img: finalImg });
  document.getElementById('menuLink').href = `${SHARE_PAGE}?view=deity-menu&api=${encodeURIComponent(API_BASE)}`;

  // å–å¾—ä½›ç‰Œé…æˆ´å»ºè­°ï¼ˆæ²¿ç”¨ LINE Bot çš„ç”Ÿæˆé‚è¼¯ï¼Œç”±å¾Œç«¯æä¾›ï¼‰
  try {
    const advUrl = `${ADVICE_BASE}/amulet/advice?code=${encodeURIComponent(code)}&job=${encodeURIComponent(state.job)}&dow=${encodeURIComponent(state.dow)}&zod=${encodeURIComponent(state.zod)}`;
    const advEl = document.getElementById('amuletAdvice');
    advEl.style.display = 'block';
    advEl.textContent = 'è¼‰å…¥ä¸­â€¦';
    const r2 = await fetch(advUrl);
    if (r2.ok) {
      const j2 = await r2.json();
      if (j2?.text) {
        const cleaned = (j2.text || '').replace(/^ğŸ‘‰.*$/gm, '').trim();
        advEl.textContent = cleaned || 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
      } else {
        advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
      }
    } else {
      advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
    }
  } catch (e) {
    const advEl = document.getElementById('amuletAdvice');
    advEl.style.display = 'block';
    advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
  }

  // å„ªæƒ ç¢¼ï¼šé»æ“Šç”¢ç”Ÿä¸¦é¡¯ç¤ºï¼ˆå„ªå…ˆå¾Œç«¯ç™¼åˆ¸ï¼Œå¤±æ•—å‰‡æœ¬åœ°è‡¨æ™‚åˆ¸ï¼‰
  (function(){
    const btn = document.getElementById('getCouponBtn');
    const box = document.getElementById('couponWrap');
    const copyBtn = document.getElementById('copyCouponBtn');
    const saveBtn = document.getElementById('saveCouponBtn');
    const shopBtn = Array.from(document.querySelectorAll('#resultBox .footer a')).find(a=>/shopunalomecodes\.pages\.dev\/shop/.test(a.href) || /\/shop$/.test(a.pathname));
    async function saveToAccount(codeStr){
      if (!codeStr) return;
      try{
        const res = await fetch('/api/me/coupons', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ code: codeStr })
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 401){
          alert('è«‹å…ˆç™»å…¥æœƒå“¡ï¼Œå†å„²å­˜åˆ°ã€Œæˆ‘çš„å„ªæƒ åˆ¸ã€ã€‚\nå°‡ç‚ºä½ å°å‘ç™»å…¥é ã€‚');
          window.location.href = '/api/auth/google/login?redirect=/quiz/';
          return;
        }
        if (!res.ok || !data.ok){
          throw new Error(data.error || ('HTTP '+res.status));
        }
        alert('å·²å­˜åˆ°ã€Œæˆ‘çš„å„ªæƒ åˆ¸ã€ï¼Œå¯åœ¨è³¼ç‰©è»Šç›´æ¥å¥—ç”¨ã€‚');
      }catch(err){
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š' + (err.message||err));
      }
    }

    if (btn && !btn._bound){
      btn._bound = true;
      btn.addEventListener('click', async ()=>{
        const key = `coupon_${code}`;
          const box = document.getElementById('couponWrap');
        let stored = null; try{ stored = JSON.parse(localStorage.getItem(key)||'null'); }catch(_){ stored = null; }
        // åƒ…æ²¿ç”¨æ–°ç³»çµ±ï¼ˆv2ï¼‰æ­£å¼åˆ¸ï¼›èˆŠè³‡æ–™ä¸€å¾‹é‡ç™¼
        let coupon = (stored && stored.version === 'v2' && stored.issued) ? stored.code : '';
        try{
          if (!coupon){
            // å–®æ¬¡å‘å¾Œç«¯ç´¢å–ï¼Œè‹¥å®ˆè­·ç¥ä»£ç¢¼ä¸ç¬¦ç›´æ¥æ”¹ç”¨æœ¬åœ°åˆ¸ç¢¼ï¼Œé¿å…éŒ¯ç™¼
            const real = await issueCoupon(code, 200);
            if (!real || typeof real !== 'string') throw new Error('NO_CODE');
            const seg = (real.split('-')[1]||'').toUpperCase();
            if (seg && seg !== code){
              console.warn('quiz coupon deity mismatch, using local coupon', { expected: code, got: seg, real });
              coupon = generateCoupon(code); // ä¿è­‰å®ˆè­·ç¥æ­£ç¢º
            }else{
              coupon = real;
            }
            try{ localStorage.setItem(key, JSON.stringify({ code: coupon, issued: true, deity: code, version:'v2' })); }catch(_){ }
          }
          // é¡¯ç¤ºæ­£å¼åˆ¸ç¢¼ï¼ˆä¸å†é¡¯ç¤ºä»»ä½•è‡¨æ™‚åˆ¸æç¤ºï¼‰
          box.style.display = 'block';
          box.textContent = `æ‚¨çš„å„ªæƒ ç¢¼ï¼š${coupon}\næ­¤å„ªæƒ åƒ…é©ç”¨æ–¼ã€Œ${name}ã€ç›¸é—œå•†å“\nè«‹åœ¨çµå¸³é è¼¸å…¥æ­¤ä»£ç¢¼å³å¯æŠ˜æ‰£`;
          if (shopBtn){
            const u = new URL(shopBtn.href, location.origin);
            u.searchParams.set('coupon', coupon);
            u.searchParams.set('deity', code);
            u.searchParams.set('amount', '200');
            shopBtn.href = u.toString();
          }
          if (copyBtn){
            copyBtn.style.display = 'inline-flex';
            copyBtn.dataset.code = coupon;
            if (!copyBtn._bound){
              copyBtn._bound = true;
              copyBtn.addEventListener('click', async ()=>{
                const c = copyBtn.dataset.code || '';
                try{
                  await navigator.clipboard.writeText(c);
                  const old = copyBtn.textContent;
                  copyBtn.textContent = 'å·²è¤‡è£½';
                  setTimeout(()=> copyBtn.textContent = old, 1200);
                }catch(e){
                  // fallback for older browsers
                  try{
                    const ta = document.createElement('textarea');
                    ta.value = c; document.body.appendChild(ta);
                    ta.select(); document.execCommand('copy');
                    document.body.removeChild(ta);
                  }catch(_){ }
                  const old = copyBtn.textContent;
                  copyBtn.textContent = 'å·²è¤‡è£½';
                  setTimeout(()=> copyBtn.textContent = old, 1200);
                }
              });
            }
          }
          if (saveBtn){
            saveBtn.style.display = 'inline-flex';
            saveBtn.dataset.code = coupon;
            if (!saveBtn._bound){
              saveBtn._bound = true;
              saveBtn.addEventListener('click', ()=> saveToAccount(saveBtn.dataset.code||'')); 
            }
          }
        }catch(err){
          // å¾Œç«¯ç™¼åˆ¸å¤±æ•—æ™‚ï¼Œçµ¦å‡ºå‹å–„è¨Šæ¯ä¸¦æä¾›è‡¨æ™‚ç¢¼ï¼ˆä»ä»¥æ­£å¼åˆ¸å„ªå…ˆï¼‰
          var fallback = generateCoupon(code);
          box.style.display = 'block';
          box.textContent = 'ç›®å‰ç³»çµ±æš«æ™‚ç„¡æ³•ç™¼æ”¾æ­£å¼å„ªæƒ ç¢¼ï¼Œå…ˆæä¾›è‡¨æ™‚ä»£ç¢¼ï¼š'+ fallback +'\nè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœå”åŠ©ã€‚';
          if (copyBtn){
            copyBtn.style.display = 'inline-flex';
            copyBtn.dataset.code = fallback;
          }
          if (saveBtn){
            saveBtn.style.display = 'inline-flex';
            saveBtn.dataset.code = fallback;
          }
          if (shopBtn){
            const u = new URL(shopBtn.href, location.origin);
            u.searchParams.set('coupon', fallback);
            u.searchParams.set('deity', code);
            u.searchParams.set('amount', '200');
            shopBtn.href = u.toString();
          }
        }
      });
    }
  })();


  document.getElementById('resultBox').style.display='block';

  // å°‡çµæœç§»è‡³å…¨æ–°é é¢ï¼ˆç§»é™¤å‰é¢çš„é¡Œç›®å¡ç‰‡ï¼Œåƒ…ä¿ç•™çµæœï¼‰
  try{
    const main = document.querySelector('main');
    const res = document.getElementById('resultBox');
    const newWrap = document.createElement('div');
    newWrap.className = 'wrap';
    newWrap.appendChild(res);
    main.innerHTML = '';
    main.appendChild(newWrap);
    res.style.marginTop = '12px';
  }catch(_){ }

  window.scrollTo({ top: 0, behavior:'smooth' });

  // é‡æ–°æ¸¬é©—ï¼šå›åˆ°åˆå§‹ç‹€æ…‹
  try{
    const reBtn = document.getElementById('shareLink');
    if (reBtn){
      reBtn.onclick = (ev)=>{
        ev.preventDefault();
        // é‡ç½®ç‹€æ…‹
        state.dow=''; state.zod=''; state.job=''; state.p2=''; state.p3=''; state.p4=''; state.p5=''; state.p6=''; state.p7='';
        currentStep = 0; currentQuestion = 1;
        // æ¸…ç©ºå¡ç‰‡ä¸¦é‚„åŸ DOM
        const main = document.querySelector('main');
        if (main){
          main.innerHTML = `
            <div class="card step-card" id="stepDow"><h2>ä½ æ˜¯æ˜ŸæœŸå¹¾å‡ºç”Ÿï¼Ÿ</h2><div id="dowBox" class="chips" role="group" aria-label="weekday"></div></div>
            <div class="card step-card" id="stepZod"><h2>ä½ çš„æ˜Ÿåº§ï¼Ÿ</h2><div id="zodiacBox" class="chips" role="group" aria-label="zodiac"></div></div>
            <div class="card step-card" id="quizBox"><div id="qTitle" class="q"></div><div id="opts" class="grid"></div><div class="footer"><button id="prevBtn" class="btn">â† ä¸Šä¸€é¡Œ</button><button id="nextBtn" class="btn primary">ä¸‹ä¸€é¡Œ â†’</button></div></div>
          `;
          // é‡æ–°ç¹«çµå…ƒä»¶èˆ‡äº‹ä»¶
          setTimeout(()=>{ try{ location.reload(); }catch(_){ location.href = location.href; } }, 50);
        }else{
          try{ location.reload(); }catch(_){ location.href = location.href; }
        }
      };
    }
  }catch(_){}
  } finally {
    setResultLoading(false);
  }
}

(function(){
  const fortuneDialog = document.getElementById('fortuneDialogQuiz');
  const fortuneClose = document.getElementById('fortuneCloseQuiz');
  const fortuneLoading = document.getElementById('fortuneLoadingQuiz');
  const fortuneError = document.getElementById('fortuneErrorQuiz');
  const fortuneCard = document.getElementById('fortuneCardQuiz');
  const fortuneDate = document.getElementById('fortuneDateQuiz');
  const fortuneStars = document.getElementById('fortuneStarsQuiz');
  const fortuneSummary = document.getElementById('fortuneSummaryQuiz');
  const fortuneAdvice = document.getElementById('fortuneAdviceQuiz');
  const fortuneRitual = document.getElementById('fortuneRitualQuiz');
  const fortuneMeta = document.getElementById('fortuneMetaQuiz');
  const fortuneRitualLabel = document.getElementById('fortuneRitualLabelQuiz');

  function showDialog(dlg){
    if (!dlg) return;
    if (typeof dlg.showModal === 'function') dlg.showModal();
    else dlg.setAttribute('open','open');
  }
  function closeDialog(dlg){
    if (!dlg) return;
    if (typeof dlg.close === 'function') dlg.close();
    else dlg.removeAttribute('open');
  }
  function setFortuneLoading(){
    if (fortuneLoading) fortuneLoading.style.display = '';
    if (fortuneError) fortuneError.style.display = 'none';
    if (fortuneCard) fortuneCard.style.display = 'none';
  }
  function setFortuneError(message){
    if (fortuneError){
      fortuneError.textContent = message || 'æš«æ™‚ç„¡æ³•å–å¾—æ—¥ç±¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      fortuneError.style.display = '';
    }
    if (fortuneLoading) fortuneLoading.style.display = 'none';
    if (fortuneCard) fortuneCard.style.display = 'none';
  }
  function renderFortune(fortune){
    if (!fortune) return;
    if (fortuneDate) fortuneDate.textContent = fortune.date || '';
    if (fortuneStars){
      const stars = fortune.stars || '';
      fortuneStars.textContent = stars;
      fortuneStars.style.display = stars ? '' : 'none';
    }
    if (fortuneSummary) fortuneSummary.textContent = fortune.summary || '';
    if (fortuneAdvice) fortuneAdvice.textContent = fortune.advice || '';
    if (fortuneRitual) fortuneRitual.textContent = fortune.ritual || '';
    if (fortuneMeta){
      const meta = fortune.meta || {};
      const tags = [];
      if (meta.userZodiac){
        const zodiacLabel = meta.userZodiacElement ? `${meta.userZodiac}ï¼ˆ${meta.userZodiacElement}è±¡ï¼‰` : meta.userZodiac;
        tags.push(`æ˜Ÿåº§ ${zodiacLabel}`);
      }
      if (meta.moonPhase) tags.push(`æœˆç›¸ ${meta.moonPhase}`);
      if (meta.iching) tags.push(`æ˜“ç¶“ ${meta.iching}`);
      if (meta.todayDow) tags.push(`ä»Šæ—¥æ˜ŸæœŸ${meta.todayDow}`);
      if (meta.thaiDayColor) tags.push(`æ³°åœ‹æ˜ŸæœŸè‰² ${meta.thaiDayColor}`);
      if (meta.buddhistYear) tags.push(`ä½›æ›† ${meta.buddhistYear}`);
      fortuneMeta.innerHTML = tags.map(t=>`<span>${t}</span>`).join('');
    }
    if (fortuneRitualLabel){
      const gName = (fortune.meta && fortune.meta.guardianName) || '';
      fortuneRitualLabel.textContent = gName ? `å®ˆè­·ç¥ ${gName} æƒ³å°ä½ èªª` : 'å®ˆè­·ç¥æƒ³å°ä½ èªª';
    }
    if (fortuneLoading) fortuneLoading.style.display = 'none';
    if (fortuneError) fortuneError.style.display = 'none';
    if (fortuneCard) fortuneCard.style.display = '';
  }
  async function fetchFortune(){
    setFortuneLoading();
    try{
      const res = await fetch('/api/fortune', { cache:'no-store', credentials:'include' });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || !data || data.ok === false){
        if (data && data.needQuiz) throw new Error('è«‹å…ˆå®Œæˆå®ˆè­·ç¥æ¸¬é©—å¾Œå†é ˜å–æ—¥ç±¤ã€‚');
        throw new Error((data && data.error) || 'å–å¾—æ—¥ç±¤å¤±æ•—');
      }
      renderFortune(data.fortune || null);
    }catch(err){
      setFortuneError(err && err.message ? err.message : 'æš«æ™‚ç„¡æ³•å–å¾—æ—¥ç±¤');
    }
  }
  async function openFortuneDialog(){
    const loggedIn = window.authState && typeof window.authState.isLoggedIn==='function' ? window.authState.isLoggedIn() : false;
    if (!loggedIn){
      if (window.authState && typeof window.authState.promptLogin === 'function'){
        window.authState.promptLogin('è«‹å…ˆç™»å…¥å¾Œå†é ˜å–æ—¥ç±¤ã€‚');
      }
      return;
    }
    showDialog(fortuneDialog);
    await fetchFortune();
  }
  document.addEventListener('click', ev=>{
    const btn = ev.target.closest('[data-fortune-btn]');
    if (!btn) return;
    ev.preventDefault();
    openFortuneDialog();
  });
  if (fortuneClose){
    fortuneClose.addEventListener('click', ()=> closeDialog(fortuneDialog));
  }
})();
</script>
</body>
</html>

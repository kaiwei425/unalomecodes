<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ¸¬é©—èˆ‡æ‚¨æœ‰ç·£çš„å®ˆè­·ç¥</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#9aa0a6;
      --brand:#f5c211;
      --ok:#10b981;
      --accent:#eab308;
      --text:#111827;
      --text-strong:#0b0c10;
      --border:#e5e7eb;
      --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif;
      background: var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#ffffff;
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:32px;height:32px;border-radius:9px;box-shadow:0 0 0 2px rgba(234,179,8,.4)}
    .brand h1{font-size:18px;margin:0;color:var(--text-strong);letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:-2px}
    .card{background: var(--card);
      border:1px solid var(--border);border-radius:18px;padding:18px;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.22)}
    h2{font-size:20px;margin:0 0 12px 0;color:#111827}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:640px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:980px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .btn{
      display:flex;align-items:center;justify-content:flex-start;gap:10px;
      padding:14px 16px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(249,250,251,1));
      color:var(--text);text-decoration:none;cursor:pointer;font-weight:700;letter-spacing:.02em;
      box-shadow:0 1px 2px rgba(0,0,0,.06);transition:.15s ease;
      font-size:16px;
    }
    .btn:hover{filter:brightness(1.03);transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn.primary{background:linear-gradient(180deg, rgba(250,204,21,.28), rgba(250,204,21,.08));color:#111827;border-color:#c7a40e;justify-content:center;}
    .btn.ok{background:linear-gradient(180deg, rgba(16,185,129,.25), rgba(16,185,129,.08));color:#0b3b2e;border-color:#0e654d;justify-content:center;}
    .btn.ghost{background:#fff;color:#111827;border-color:#e5e7eb}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{padding:10px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer}
    .chip.active{outline:2px solid var(--accent);background:rgba(234,179,8,.12)}
    .step{margin:10px 0 2px;font-size:12px;letter-spacing:.08em;color:var(--muted)}
    .q{font-size:20px;font-weight:800;margin:4px 0 16px}
    .footer{display:grid;gap:10px;margin-top:12px;grid-template-columns:1fr}
    @media (min-width:560px){.footer{grid-template-columns:1fr 1fr}}
    @media (min-width:960px){.footer{grid-template-columns:1fr 1fr 1fr 1fr}}
    .result{padding:16px;border-radius:14px;background:#f9fafb;border:1px dashed var(--border);white-space:pre-wrap;line-height:1.8}
    code.k{background:#1f2937;padding:2px 6px;border-radius:6px;border:1px solid #2a3240}
    .note{font-size:12px;color:var(--muted)}
    .bar{height:10px;border-radius:999px;background:#1f2937;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#fde047,#a3e635);width:0%}
  </style>
  <meta name="quiz-token" content="quiz_5A9kU3tZmE4hW2xP7qL8vN0r">
</head>
<body>
  <header>
    <div class="wrap brand">
      <img id="brandLogo" src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="logo" />
      <div>
        <h1>æ¸¬é©—èˆ‡æ‚¨æœ‰ç·£çš„å®ˆè­·ç¥</h1>
      </div>
      <a class="btn primary" href="/shop" style="margin-left:auto">å›åˆ°å•†å“é </a>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h2>ä½ æ˜¯æ˜ŸæœŸå¹¾å‡ºç”Ÿï¼Ÿ</h2>
      <div id="dowBox" class="chips" role="group" aria-label="weekday"></div>
    </div>

    <div class="card">
      <h2>ä½ çš„æ˜Ÿåº§ï¼Ÿ</h2>
      <div id="zodiacBox" class="chips" role="group" aria-label="zodiac"></div>
    </div>

    <div class="card" id="quizBox">
      <div id="qTitle" class="q"></div>
      <div id="opts" class="grid"></div>
      <div class="footer">
        <button id="prevBtn" class="btn">â† ä¸Šä¸€é¡Œ</button>
        <button id="nextBtn" class="btn primary">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>

    <div class="card" id="resultBox" style="display:none">
      <h2>ä½ çš„å®ˆè­·è€…</h2>
      <img id="deityImg" alt="å®ˆè­·ç¥" crossorigin="anonymous" referrerpolicy="no-referrer" style="display:none;width:100%;max-height:300px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:12px;" />
      <div class="result" id="resultText">å°šæœªå®Œæˆä½œç­”</div>
      <div style="margin:12px 0">
        <div class="step">ç·£åˆ†å€¼</div>
        <div class="bar"><div id="affBar" class="fill"></div></div>
        <div id="affText" class="note" style="margin-top:6px"></div>
      </div>
      <div style="margin:18px 0 8px">
        <h2 style="margin-bottom:8px">ä½›ç‰Œé…æˆ´å»ºè­°</h2>
        <div id="amuletAdvice" class="result" style="display:none">è¼‰å…¥ä¸­â€¦</div>
        <div class="footer" id="adviceActions" style="margin-top:8px">
          <button id="getCouponBtn" class="btn ok">é»æˆ‘é ˜å–å°ˆå±¬å„ªæƒ </button>
        </div>
        <div id="couponWrap" class="result" style="display:none"></div>
        <div style="margin-top:8px">
          <button id="copyCouponBtn" class="btn ghost" style="display:none">è¤‡è£½å„ªæƒ ç¢¼</button>
        </div>
      </div>
      <div class="footer">
        <a id="deityLink" target="_blank" rel="noopener" class="btn">æŸ¥çœ‹å®Œæ•´ä»‹ç´¹</a>
        <a id="shareLink" target="_blank" rel="noopener" class="btn ok">åˆ†äº«æˆ‘çš„çµæœ</a>
        <a id="menuLink" target="_blank" rel="noopener" class="btn">ç€è¦½å…¶ä»–å®ˆè­·è€…</a>
        <a class="btn" href="/shop">å‰å¾€é¸è³¼å°ˆå±¬è–ç‰©</a>
      </div>
    </div>
  </main>

<script>
/* =====================
   CONFIGï¼ˆå¯æ”¹ï¼‰
===================== */
const API_BASE   = 'https://proud-boat-794c.kaiwei425.workers.dev'; // å–è‡ª worker.js
const SHARE_PAGE = './share.html';
const DEITY_PAGE = './deity.html';
const DEITY_IMG_OVERRIDES = { CD:'https://i.ibb.co/rGpp2w1s/image.jpg', RH:'https://i.ibb.co/qMy9RxVx/image.jpg', HM:'https://i.ibb.co/kV0pz49B/image.jpg', WE:'https://i.ibb.co/pv4Jc4sc/image.jpg', XZ:'https://i.ibb.co/V0hNnFHT/image.jpg', JL:'https://i.ibb.co/wrWW3ddN/image.jpg', ZD:'https://i.ibb.co/xtJtDTVy/image.jpg', KP:'https://i.ibb.co/k29dc4Qn/image.jpg', FM:'https://i.ibb.co/SXGB6vKj/image.jpg', GA:'https://i.ibb.co/2RhD1k9/image.jpg', HP:'https://i.ibb.co/ymcrPm1C/image.jpg', ZF:'https://i.ibb.co/CRctyB3/image.jpg' };
const BRAND_NAME = 'å®ˆè­·æŒ‡å¼•';
const BRAND_LOGO = 'https://i.ibb.co/7mtppQQ/logo.jpg';
// Coupon service endpoint + token reader (needed for REAL issuance)
const COUPON_API = 'https://coupon-service.kaiwei425.workers.dev';
function readQuizToken(){
  try{ return (document.querySelector('meta[name="quiz-token"]')?.content||'').trim(); }catch(e){ return ''; }
}

/* =====================
   åŸºç¤è³‡æ–™ï¼ˆå–è‡ª worker.jsï¼‰
===================== */
const GODS = ['FM','GA','CD','KP','HP','XZ','WE','HM','RH','JL','ZD','ZF'];
const DOW = {
  Sun:{label:'æ˜ŸæœŸæ—¥', color:'ç´…è‰²',  tip:'è±¡å¾µåŠ›é‡èˆ‡æ¦®è€€ï¼Œè®“ä½ åœ¨äººç¾¤ä¸­å±•ç¾è‡ªä¿¡èˆ‡å…‰å½©', weight:['JL','GA','WE']},
  Mon:{label:'æ˜ŸæœŸä¸€', color:'é»ƒè‰²',  tip:'è±¡å¾µæ™ºæ…§èˆ‡ç†è§£åŠ›ï¼Œå¹«åŠ©ä½ ä»¥æŸ”å…‹å‰›',                   weight:['CD','XZ','KP']},
  Tue:{label:'æ˜ŸæœŸäºŒ', color:'ç²‰ç´…è‰²',tip:'è±¡å¾µå‹‡æ°£èˆ‡æ„›ï¼Œæ¨å‹•ä½ ä¸»å‹•æ”¹è®Š',                         weight:['HM','HP','WE']},
  Wed:{label:'æ˜ŸæœŸä¸‰', color:'ç¶ è‰²',  tip:'è±¡å¾µæˆé•·èˆ‡å’Œè«§ï¼Œè®“ä½ åœ¨è®Šå‹•ä¸­ç©©å®šå‰è¡Œ',                 weight:['KP','XZ','FM']},
  Thu:{label:'æ˜ŸæœŸå››', color:'æ©˜è‰²',  tip:'è±¡å¾µæ™ºæ…§èˆ‡å­¸ç¿’ï¼Œå¸¶ä¾†è²´äººèˆ‡æ–°çŸ¥',                       weight:['FM','CD','RH']},
  Fri:{label:'æ˜ŸæœŸäº”', color:'è—è‰²',  tip:'è±¡å¾µæ„›èˆ‡è—è¡“ï¼Œè®“ä½ æ›´å…·åŒ…å®¹èˆ‡è¦ªå’ŒåŠ›',                   weight:['ZF','KP','XZ']},
  Sat:{label:'æ˜ŸæœŸå…­', color:'ç´«è‰²',  tip:'è±¡å¾µå®ˆè­·èˆ‡æ´å¯Ÿï¼Œå¹«ä½ è½‰å±ç‚ºå®‰',                         weight:['RH','WE','CD']}
};
const ZODIAC = {
  Aries:{name:'ç‰¡ç¾Šåº§ â™ˆï¸', element:'ç«'},
  Taurus:{name:'é‡‘ç‰›åº§ â™‰ï¸', element:'åœŸ'},
  Gemini:{name:'é›™å­åº§ â™Šï¸', element:'é¢¨'},
  Cancer:{name:'å·¨èŸ¹åº§ â™‹ï¸', element:'æ°´'},
  Leo:{name:'ç…å­åº§ â™Œï¸', element:'ç«'},
  Virgo:{name:'è™•å¥³åº§ â™ï¸', element:'åœŸ'},
  Libra:{name:'å¤©ç§¤åº§ â™ï¸', element:'é¢¨'},
  Scorpio:{name:'å¤©è åº§ â™ï¸', element:'æ°´'},
  Sagittarius:{name:'å°„æ‰‹åº§ â™ï¸', element:'ç«'},
  Capricorn:{name:'é­”ç¾¯åº§ â™‘ï¸', element:'åœŸ'},
  Aquarius:{name:'æ°´ç“¶åº§ â™’ï¸', element:'é¢¨'},
  Pisces:{name:'é›™é­šåº§ â™“ï¸', element:'æ°´'}
};
const QUESTIONS = {
  1:{ text:'ä½ çš„è·æ¥­æœ€æ¥è¿‘å“ªä¸€ç¨®ï¼Ÿ',
      opts:{ A:'å‰µæ¥­ï¼è‡ªé›‡', B:'ç®¡ç†ï¼è¡Œæ”¿ï¼ˆä¸Šç­æ—ï¼‰', C:'è¨­è¨ˆï¼è—è¡“ï¼å…§å®¹å‰µä½œ',
             D:'éŠ·å”®ï¼è¡ŒéŠ·ï¼å…¬é—œ', E:'å·¥ç¨‹ï¼æŠ€è¡“ï¼é‡‘èæ•¸æ“š', F:'æœå‹™ï¼é†«ç™‚ï¼æ•™è‚²ï¼èº«å¿ƒå·¥ä½œ',
             G:'è‡ªç”±è·ï¼å…¼è·ï¼è½‰è·ä¸­', H:'å…¬å‹™å“¡' } },
  2:{ text:'ç•¶ä½ æƒ³æ”¹è®Šç”Ÿæ´»æ™‚ï¼Œä½ æœ€æƒ³å…ˆç²å¾—ä»€éº¼ï¼Ÿ',
      opts:{A:'å¡é—œçš„åœ°æ–¹èƒ½å¤ æœ‰é€²å±•',B:'è²¡å¯Œç©©å®šèˆ‡å¯Œè¶³',C:'æ‰¾åˆ°æ›´æ·±çš„ç›®æ¨™èˆ‡æŒ‡å¼•',D:'å®‰å…¨æ„Ÿèˆ‡å®ˆè­·',E:'å­¸æœƒæ”¾ä¸‹èˆ‡çœ‹æ¸…è‡ªå·±'}},
  3:{ text:'å¦‚æœåªçµ¦ä½ ä¸€é …ç¥ç¦ï¼Œä½ æœ€æœŸå¾…å“ªä¸€ç¨®ï¼Ÿ',
      opts:{A:'é–‹å•Ÿæ›´å¤šé“è·¯èˆ‡é¸æ“‡',B:'å¥½é‹èˆ‡è³‡æºè‡ªå·±ä¾†',C:'äººç·£æ¡ƒèŠ±ç›¸åŠ©',D:'å¼·åŠ›ä¿è­·é é›¢å¹²æ“¾',E:'çœ‹æ¸…æ–¹å‘å°ˆæ³¨ç•¶ä¸‹ä¸å…§è€—'}},
  4:{ text:'ä½ è¦ºå¾—è‡ªå·±æœ€å¸¸åè¦†é‡åˆ°çš„èª²é¡Œæ˜¯ï¼Ÿ',
      opts:{A:'æ©Ÿæœƒèˆ‡é˜»ç¤™äº¤éŒ¯',B:'è²¡é‹å¿½ä¸Šå¿½ä¸‹',C:'æ„Ÿæƒ…æˆ–äººéš›åè¦†',D:'å®¹æ˜“è¢«ä»–äººèƒ½é‡å½±éŸ¿',E:'å…§åœ¨ç³¾çµæ–¼å¾—å¤±'}},
  5:{ text:'æœ‹å‹æœ€å¯èƒ½æ€éº¼å½¢å®¹ä½ ï¼Ÿ',
      opts:{A:'è¡å‹åè¶³æœ‰ä¸»è¦‹',B:'è¦ªåˆ‡æœ‰é­…åŠ›æœƒåšäºº',C:'è°æ˜å†·éœæœ‰åˆ¤æ–·',D:'ç©©é‡å¯é çµ¦äººå®‰å…¨æ„Ÿ',E:'æœ‰é è¦‹å–„è¦åŠƒ'}},
  6:{ text:'ç•¶äº‹æƒ…ä¸é †åˆ©æ™‚ï¼Œä½ é€šå¸¸æ€éº¼å›æ‡‰ï¼Ÿ',
      opts:{A:'èª¿æ•´æ–¹æ³•å†è©¦ä¸€æ¬¡',B:'åœä¸‹ä¾†ä¸¦å¥½å¥½è§€å¯Ÿä¸€åˆ‡',C:'æ‰¾äººå•†é‡æˆ–ä»¥ä¿¡å¿µç©©å¿ƒ',D:'é€€ä¸€æ­¥å…ˆç©©ä½è‡ªå·±',E:'æ­£é¢è¿æˆ°å‹‡æ•¢è¡Œå‹•'}},
  7:{ text:'ä½ ç†æƒ³ä¸­çš„äººç”Ÿç‹€æ…‹æ˜¯ï¼Ÿ',
      opts:{A:'ä¸æ–·æ¥å—æ–°æŒ‘æˆ°è®“è‡ªå·±é€²æ­¥',B:'è²¡å¯Œè‡ªç”±ç”Ÿæ´»å¯Œè¶³',C:'æ“æœ‰ç©©å®šè€Œæ·±åˆ»çš„äººéš›é—œä¿‚',D:'å…§å¿ƒå¹³ç©©è¢«ä¿è­·çš„è¸å¯¦æ„Ÿ',E:'æ–¹å‘æ¸…æ¥šä¸¦ä¸”å°ˆæ³¨å‰è¡Œ'}}
};
// å•é¡Œé¸é …å°æ‡‰åŠ æ¬Šï¼ˆæ¯é¡Œæ¯é¸é …å°æ‡‰ç¥ç¥‡ï¼‰
const MAP = {
  1:{ // è·æ¥­
    A:['FM','GA','JL','RH'], B:['FM','KP','WE','ZD'], C:['CD','WE','XZ','ZF'],
    D:['GA','KP','XZ','ZF'], E:['WE','HM','FM','JL'], F:['HP','XZ','KP','WE'],
    G:['RH','FM','JL','WE'], H:['CD','KP','ZD','FM']
  },
  2:{ A:['FM','WE','KP','JL'], B:['ZD','XZ','ZF','KP'], C:['FM','JL','CD','WE'], D:['HP','RH','WE','FM'], E:['CD','WE','FM','HP'] },
  3:{ A:['JL','FM','KP','WE'], B:['XZ','ZD','RH','FM'], C:['KP','GA','XZ','ZF'], D:['HP','RH','FM','WE'], E:['WE','CD','FM','JL'] },
  4:{ A:['FM','WE','JL','KP'], B:['ZD','XZ','RH','KP'], C:['KP','GA','XZ','ZF'], D:['HP','RH','FM','WE'], E:['WE','CD','FM','JL'] },
  5:{ A:['GA','FM','JL','HM'], B:['KP','XZ','ZF','WE'], C:['WE','CD','FM','JL'], D:['FM','HP','KP','ZD'], E:['WE','JL','FM','CD'] },
  6:{ A:['FM','WE','KP','JL'], B:['WE','CD','FM','JL'], C:['KP','XZ','ZF','WE'], D:['HP','FM','RH','WE'], E:['GA','HM','FM','JL'] },
  7:{ A:['FM','JL','WE','HM'], B:['XZ','ZD','ZF','KP'], C:['KP','GA','XZ','ZF'], D:['HP','FM','RH','WE'], E:['WE','CD','FM','JL'] }
};

/* =====================
   è¨ˆç®—é‚è¼¯ï¼ˆå–è‡ª worker.jsï¼‰
===================== */
const JOB_KEYS   = ['A','B','C','D','E','F','G','H'];
const DOW_KEYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const ZODIAC_KEYS= ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];

function stableHash(str){
  let h = 2166136261>>>0;
  for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h>>>0;
}
function encodeState(st){
  return [st.dow||'', st.zod||'', st.job||'', st.p2||'', st.p3||'', st.p4||'', st.p5||'', st.p6||'', st.p7||''].join('|');
}
function compileScore(st){
  const score = Object.fromEntries(GODS.map(g=>[g,0]));
  // æ˜ŸæœŸåŠ æ¬Š
  const dw = DOW[st.dow]?.weight || [];
  for (const g of dw){ score[g] += 1; }
  // é¡Œç›®åŠ æ¬Š
  for (let i=1;i<=7;i++){
    const pick = st['p'+i];
    const arr = MAP[i]?.[pick] || [];
    let w = 4;
    for (const g of arr){ score[g] += w; w--; if (w<=0) break; }
  }
  return score;
}
function decideWinner(st){
  const score = compileScore(st);
  let max=-Infinity, second=-Infinity, winner='';
  for (const [g,v] of Object.entries(score)){
    if (v>max){ second=max; max=v; winner=g; }
    else if (v>second){ second=v; }
  }
  const gap = Math.max(0, max - (second===-Infinity?0:second));
  if (gap <= 1){
    const picks = [st.p2,st.p3,st.p4,st.p5,st.p6,st.p7].map(p=>String(p||'')).join('');
    const tiebreak = stableHash(picks) % GODS.length;
    winner = GODS[tiebreak];
  }
  return winner;
}
function calcAffinityPercent(st, winner){
  const score = compileScore(st);
  let max=-Infinity, second=-Infinity;
  for (const v of Object.values(score)){
    if (v>max){ second=max; max=v; } else if (v>second){ second=v; }
  }
  const gap = Math.max(0, max - (second===-Infinity?0:second));
  const base = 86 + Math.min(8, gap*4);
  const tweak = stableHash(winner + ':' + encodeState(st)) % 5;
  const pct = Math.max(83, Math.min(99, base + tweak));
  return pct;
}
function affinityBrief(n){
  const p = Number(n)||0;
  if (p>=95) return 'æ¥µå¼·é€£çµ';
  if (p>=92) return 'é«˜åº¦å…±é³´';
  if (p>=88) return 'ç©©å®šåˆæ‹';
  if (p>=85) return 'æ­£åœ¨é è¿‘';
  return 'æœ‰ç¸å¾…å•Ÿå‹•';
}
// ç¥ç¥‡ä»£ç¢¼â†’ä¸­æ–‡åï¼ˆèˆ‡ deity.html åŒæ­¥ï¼‰
function deityName(code){
  const map = {FM:'å››é¢ç¥',GA:'è±¡ç¥',CD:'å´‡è¿ªä½›',KP:'å¤å¹³',HP:'é­‚é­„å‹‡',XZ:'å¾ç¥è€äºº',WE:'äº”çœ¼å››è€³',HM:'çŒ´ç¥å“ˆé­¯æ›¼',RH:'æ‹‰èƒ¡',JL:'è¿¦æ¨“ç¾…',ZD:'æ¾¤åº¦é‡‘',ZF:'æ‹›è²¡å¥³ç¥'};
  return map[code] || 'å®ˆè­·ç¥';
}

/* =====================
   UI ç‹€æ…‹
===================== */
const state = { dow:'', zod:'', job:'', p2:'', p3:'', p4:'', p5:'', p6:'', p7:'' };
let current = 1;

// render weekday
const dowBox = document.getElementById('dowBox');
Object.entries(DOW).forEach(([k,v])=>{
  const b = document.createElement('div');
  b.className = 'chip'; b.textContent = v.label;
  b.onclick = ()=>{ state.dow=k; [...dowBox.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
  dowBox.appendChild(b);
});

// render zodiac
const zodiacBox = document.getElementById('zodiacBox');
Object.entries(ZODIAC).forEach(([k,v])=>{
  const b = document.createElement('div');
  b.className='chip'; b.textContent = v.name;
  b.onclick = ()=>{ state.zod=k; [...zodiacBox.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
  zodiacBox.appendChild(b);
});

// render questions
const qTitle = document.getElementById('qTitle');
const optsEl  = document.getElementById('opts');
function renderQ(){
  const q = QUESTIONS[current];
  qTitle.textContent = `ç¬¬ ${current} é¡Œï¼ˆå‰©é¤˜ ${Math.max(7-current,0)} é¡Œï¼‰ï½œ${q.text}`;
  optsEl.innerHTML='';
  const isJob = (current===1);
  Object.entries(q.opts).forEach(([k,label])=>{
    const btn = document.createElement('button');
    btn.className = 'btn'; btn.textContent = label;
    btn.style.textAlign='left';
    btn.onclick = ()=>{
      state['p'+current] = k;
      if (isJob) state.job = k;
      if (current<7) { current++; renderQ(); }
      else { showResult(); }
    };
    const wrap = document.createElement('div'); wrap.appendChild(btn);
    optsEl.appendChild(wrap);
  });
  document.getElementById('prevBtn').style.display = current>1 ? 'inline-flex' : 'none';
  document.getElementById('nextBtn').style.display = current<7 ? 'inline-flex' : 'none';
}
document.getElementById('prevBtn').onclick = ()=>{
  if (current>1){ current--; renderQ(); }
};
document.getElementById('nextBtn').onclick = ()=>{
  if (current<7){ current++; renderQ(); }
};

renderQ();

/* =====================
   çµæœ
===================== */
function buildShareUrl({code, job, dow, zod, aff, img}){
  const deity = deityName(code);
  const dayName = (DOW[dow]?.label)||'';
  const zodiacName = (ZODIAC[zod]?.name)||'';
  const color = (DOW[dow]?.color)||'';
  const params = new URLSearchParams({
    t:'quiz', deity, zodiac:zodiacName, color, dow:dayName,
    job:(QUESTIONS[1].opts[job]||''), brand:BRAND_NAME, api:API_BASE, affinity:String(aff||''), img: (img||''),
    logo: BRAND_LOGO,
  });
  return `${SHARE_PAGE}?${params.toString()}`;
}
function generateCoupon(code){
  const alpha = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // å»æ‰æ˜“æ··å­—å…ƒ
  function rand(n){ let s=''; for(let i=0;i<n;i++){ s += alpha[Math.floor(Math.random()*alpha.length)]; } return s; }
  const ts = new Date();
  const y = String(ts.getFullYear()).slice(-2);
  const m = String(ts.getMonth()+1).padStart(2,'0');
  const d = String(ts.getDate()).padStart(2,'0');
  // ä»£ç¢¼æ ¼å¼ï¼šUC-<ç¥ç¥‡>-<YYMMDD>-<4>-<4>
  return `UC-${code}-${y}${m}${d}-${rand(4)}-${rand(4)}`;
}

async function issueCoupon(deityCode, amount){
  const token = readQuizToken();
  const payload = { deity: String(deityCode||'').toUpperCase(), amount: Number(amount||200) };
  const headers = { 'Content-Type':'application/json' };
  if (token) headers['X-Quiz-Token'] = token; // è®“å¾Œç«¯é©—è­‰è«‹æ±‚ä¾†æº
  const res = await fetch(`${COUPON_API}/issue`, {
    method: 'POST',
    headers,
    body: JSON.stringify(payload),
    credentials: 'omit',
    cache: 'no-store'
  });
  if (!res.ok) throw new Error(`ISSUE_FAILED_${res.status}`);
  const j = await res.json();
  if (!j || !j.code) throw new Error('NO_CODE');
  return j.code;
}

async function showResult(){
  // guard
  if (!state.dow || !state.zod || !state.job || !state.p2 || !state.p3 || !state.p4 || !state.p5 || !state.p6 || !state.p7){
    alert('è«‹å®Œæ•´ä½œç­”ã€Œæ˜ŸæœŸã€æ˜Ÿåº§èˆ‡ 7 é¡Œã€'); return;
  }
  const code = decideWinner(state);
  const aff  = calcAffinityPercent(state, code);
  const name = deityName(code);
  // å–ç¥ç¥‡è³‡æ–™
  let meta = { name: name, img: '', desc: '' };
  try {
    const r = await fetch(`${API_BASE}/getDeity?code=${encodeURIComponent(code)}`);
    if (r.ok) { const j = await r.json(); meta.name = j.name || meta.name; meta.img = j.img || ''; meta.desc = j.desc || ''; }
  } catch {}
  // åœ–ç‰‡è¦†è“‹
  const finalImg = DEITY_IMG_OVERRIDES[code] || meta.img || '';
  // é¡¯ç¤ºåœ–ç‰‡
  const imgEl = document.getElementById('deityImg');
  if (finalImg) { imgEl.src = finalImg; imgEl.crossOrigin='anonymous'; imgEl.referrerPolicy='no-referrer'; imgEl.style.display = 'block'; }
  // textï¼ˆæ¯”ç…§ LINE çµæœæ–‡æ¡ˆçš„å®Œæ•´åº¦ï¼‰
  const jobLabel = QUESTIONS[1].opts[state.job] || 'â€”';
  const dayName  = DOW[state.dow]?.label || 'â€”';
  const color    = DOW[state.dow]?.color || '';
  const tip      = DOW[state.dow]?.tip || '';
  const zName    = ZODIAC[state.zod]?.name || 'â€”';
  const result = [
    `å®ˆè­·è€…ï¼š${meta.name || name}`,
    meta.desc ? `æŒ‡å¼•ï¼š${meta.desc.trim()}` : '',
    `æ˜Ÿåº§ï¼š${zName}`,
    color ? `ç”Ÿæ—¥æ˜ŸæœŸï¼š${dayName}ï¼ˆå¹¸é‹è‰²ï¼š${color}ï¼‰` : `ç”Ÿæ—¥æ˜ŸæœŸï¼š${dayName}`,
    `è·æ¥­ï¼ç•¶å‰è§’è‰²ï¼š${jobLabel}`,
    tip ? `å®ˆè­·é‡é»ï¼š${tip}` : '',
    `ç·£åˆ†å€¼ï¼š${aff}%ï½œ${affinityBrief(aff)}`
  ].filter(Boolean).join('\n\n');
  document.getElementById('resultText').textContent = result;
  // affinity bar
  const bar = document.getElementById('affBar');
  bar.style.width = aff + '%';
  document.getElementById('affText').textContent = `${aff}% ï½œ ${affinityBrief(aff)}`;
  // links
  document.getElementById('deityLink').href = `${DEITY_PAGE}?code=${encodeURIComponent(code)}&api=${encodeURIComponent(API_BASE)}`;
  document.getElementById('shareLink').href = buildShareUrl({ code, job:state.job, dow:state.dow, zod:state.zod, aff:aff, img: finalImg });
  document.getElementById('menuLink').href = `${SHARE_PAGE}?view=deity-menu&api=${encodeURIComponent(API_BASE)}`;

  // å–å¾—ä½›ç‰Œé…æˆ´å»ºè­°ï¼ˆæ²¿ç”¨ LINE Bot çš„ç”Ÿæˆé‚è¼¯ï¼Œç”±å¾Œç«¯æä¾›ï¼‰
  try {
    const advUrl = `${API_BASE}/amulet/advice?code=${encodeURIComponent(code)}&job=${encodeURIComponent(state.job)}&dow=${encodeURIComponent(state.dow)}&zod=${encodeURIComponent(state.zod)}`;
    const advEl = document.getElementById('amuletAdvice');
    advEl.style.display = 'block';
    advEl.textContent = 'è¼‰å…¥ä¸­â€¦';
    const r2 = await fetch(advUrl);
    if (r2.ok) {
      const j2 = await r2.json();
      if (j2?.text) {
        const cleaned = (j2.text || '').replace(/^ğŸ‘‰.*$/gm, '').trim();
        advEl.textContent = cleaned || 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
      } else {
        advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
      }
    } else {
      advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
    }
  } catch (e) {
    const advEl = document.getElementById('amuletAdvice');
    advEl.style.display = 'block';
    advEl.textContent = 'ï¼ˆæš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œç¨å¾Œå†è©¦ï¼‰';
  }

  // å„ªæƒ ç¢¼ï¼šé»æ“Šç”¢ç”Ÿä¸¦é¡¯ç¤ºï¼ˆå„ªå…ˆå¾Œç«¯ç™¼åˆ¸ï¼Œå¤±æ•—å‰‡æœ¬åœ°è‡¨æ™‚åˆ¸ï¼‰
  (function(){
    const btn = document.getElementById('getCouponBtn');
    const box = document.getElementById('couponWrap');
    const copyBtn = document.getElementById('copyCouponBtn');
    const shopBtn = Array.from(document.querySelectorAll('#resultBox .footer a')).find(a=>/shopunalomecodes\.pages\.dev\/shop/.test(a.href) || /\\/shop$/.test(a.pathname));
    if (btn && !btn._bound){
      btn._bound = true;
      btn.addEventListener('click', async ()=>{
        const key = `coupon_${code}`;
        const box = document.getElementById('couponWrap');
        let stored = null; try{ stored = JSON.parse(localStorage.getItem(key)||'null'); }catch(_){ stored = null; }
        // åƒ…ç•¶å·²å­˜åœ¨ã€Œæ­£å¼åˆ¸ï¼ˆissued:trueï¼‰ã€æ‰ç›´æ¥ä½¿ç”¨ï¼›å¦å‰‡å¿…é ˆå‘¼å«å¾Œç«¯ /issue
        let coupon = (stored && stored.issued) ? stored.code : '';
        try{
          if (!coupon){
            const real = await issueCoupon(code, 200);
            if (!real || typeof real !== 'string') throw new Error('NO_CODE');
            coupon = real;
            try{ localStorage.setItem(key, JSON.stringify({ code: coupon, issued: true, deity: code })); }catch(_){ }
          }
          // é¡¯ç¤ºæ­£å¼åˆ¸ç¢¼ï¼ˆä¸å†é¡¯ç¤ºä»»ä½•è‡¨æ™‚åˆ¸æç¤ºï¼‰
          box.style.display = 'block';
          box.textContent = `æ‚¨çš„å„ªæƒ ç¢¼ï¼š${coupon}\næ­¤å„ªæƒ åƒ…é©ç”¨æ–¼ã€Œ${name}ã€ç›¸é—œå•†å“\nè«‹åœ¨çµå¸³é è¼¸å…¥æ­¤ä»£ç¢¼å³å¯æŠ˜æ‰£`;
          if (shopBtn){
            const u = new URL(shopBtn.href, location.origin);
            u.searchParams.set('coupon', coupon);
            u.searchParams.set('deity', code);
            shopBtn.href = u.toString();
          }
          if (copyBtn){
            copyBtn.style.display = 'inline-flex';
            copyBtn.dataset.code = coupon;
            if (!copyBtn._bound){
              copyBtn._bound = true;
              copyBtn.addEventListener('click', async ()=>{
                const c = copyBtn.dataset.code || '';
                try{
                  await navigator.clipboard.writeText(c);
                  const old = copyBtn.textContent;
                  copyBtn.textContent = 'å·²è¤‡è£½';
                  setTimeout(()=> copyBtn.textContent = old, 1200);
                }catch(e){
                  // fallback for older browsers
                  try{
                    const ta = document.createElement('textarea');
                    ta.value = c; document.body.appendChild(ta);
                    ta.select(); document.execCommand('copy');
                    document.body.removeChild(ta);
                  }catch(_){ }
                  const old = copyBtn.textContent;
                  copyBtn.textContent = 'å·²è¤‡è£½';
                  setTimeout(()=> copyBtn.textContent = old, 1200);
                }
              });
            }
          }
        }catch(err){
          // å®Œå…¨åœç”¨æœ¬åœ°è‡¨æ™‚åˆ¸ï¼šè‹¥ç™¼åˆ¸å¤±æ•—ï¼Œæ”¹ç‚ºé¡¯ç¤ºå‹å–„è¨Šæ¯
          box.style.display = 'block';
          box.textContent = 'ç›®å‰ç³»çµ±æš«æ™‚ç„¡æ³•ç™¼æ”¾å„ªæƒ ç¢¼ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœå”åŠ©';
          if (copyBtn) copyBtn.style.display = 'none';
        }
      });
    }
  })();


  document.getElementById('resultBox').style.display='block';
  window.scrollTo({ top: document.getElementById('resultBox').offsetTop - 12, behavior:'smooth' });
}
</script>
</body>
</html>

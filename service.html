<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="服務型商品專區，提供祈福、法會、代捐棺等服務內容。">
  <link rel="canonical" href="https://shop.unalomecodes.com/service">
  <link rel="icon" href="/img/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
  <title>服務型商品｜unalomecodes</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
body.service-view{background:var(--bg);color:var(--fg);}
.tool-link{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #fed7aa;
  background:linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%);
  color:#ea580c;
  font-weight:700;
  text-decoration:none;
  box-shadow:0 10px 20px rgba(234,88,12,0.12);
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.tool-link:hover{
  transform:translateY(-1px);
  border-color:#fdba74;
  box-shadow:0 14px 24px rgba(234,88,12,0.16);
}
.tool-link-title{display:flex;align-items:center;gap:8px;}
.tool-link-dot{width:10px;height:10px;border-radius:999px;background:#fb923c;box-shadow:0 0 0 4px rgba(251,146,60,.18);}
.service-hero{margin-top:14px;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:22px;box-shadow:var(--shadow);}
.service-hero h1{margin:0;font-size:26px;font-weight:800;}
.svc-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:22px 0 12px;}
.svc-head .title{font-weight:800;font-size:18px;}
.service-grid{margin-top:16px;}
.service-grid .card .meta{display:flex;gap:8px 10px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin:0 0 8px;line-height:1.4;}
.service-grid .card .meta.meta-limited{margin-bottom:6px;}
.service-grid .card .meta .badge{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;}
.service-grid .card .pic img{width:100%;height:100%;object-fit:cover !important;object-position:center;}
.svc-tags{margin:8px 0 10px;}
.service-grid .card .price{font-size:18px;margin-top:6px;}
.service-grid .card .cta .btn{font-size:14px;}
.svc-dialog{border:none;border-radius:18px;padding:0;background:var(--card);color:var(--fg);box-shadow:0 30px 60px rgba(15,23,42,.3);border:1px solid var(--line);}
.svc-dialog .closeBar{border-bottom:1px solid var(--line);}
.svc-dialog .dlgBody{display:grid;grid-template-columns:1fr;gap:18px;padding:18px;}
@media(min-width:820px){.svc-dialog .dlgBody{grid-template-columns:1fr 1fr;}}
.svc-dialog .svc-includes{border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px;list-style:disc;padding-left:22px;background:#f9fafb;}
.svc-dialog .svc-includes li{margin-bottom:6px;color:#374151;}
.svc-ig{margin-top:12px;}
.svc-ig iframe{width:100%;border:none;border-radius:16px;min-height:420px;background:#fff;}
.thumb-ig{border:1px dashed var(--line);border-radius:12px;padding:18px;text-align:center;font-weight:700;color:#2563eb;background:#eef2ff;cursor:pointer;display:flex;align-items:center;justify-content:center;}
#svcRvList > .rvItem:last-child{border-bottom:none;}
#svcRvList:empty::before{content:"還沒有人分享故事，成為第一個分享的人吧！";display:block;padding:20px;text-align:center;color:#94a3b8;font-size:14px;border:1px dashed #e5e7eb;}
#sideDeities .side-cat-btn{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #fed7aa;
  background:linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%);
  color:#9a3412;
  font-weight:800;
  font-size:14px;
  box-shadow:0 10px 18px rgba(234,88,12,.12);
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}
#sideDeities .side-cat-btn:hover{
  transform:translateY(-1px);
  border-color:#fdba74;
  box-shadow:0 14px 24px rgba(234,88,12,.18);
}
#sideDeities .side-cat-btn.active{
  border-color:#fb923c;
  color:#c2410c;
  background:linear-gradient(135deg,#ffedd5 0%,#fed7aa 100%);
  box-shadow:0 14px 24px rgba(234,88,12,.2);
}
.policy-link{color:#2563eb;text-decoration:underline;cursor:pointer;font-weight:600;}
.policy-dialog{border:none;border-radius:18px;padding:0;background:#fff;color:#0f172a;max-width:640px;width:95%;box-shadow:0 30px 60px rgba(15,23,42,.35);}
.dialog-fallback-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(6px);z-index:1000;display:none;}
.dialog-fallback-backdrop.active{display:block;}
dialog[data-fallback-open]{display:block;}
.policy-dialog[data-fallback-open]{position:fixed;z-index:1001;top:50%;left:50%;transform:translate(-50%,-50%);border:1px solid rgba(15,23,42,.1);}
.policy-dialog header{padding:18px;border-bottom:1px solid #e5e7eb;font-weight:800;font-size:18px;}
.policy-dialog .body{padding:18px;line-height:1.7;font-size:14px;max-height:70vh;overflow:auto;}
.policy-dialog footer{padding:0 18px 18px;text-align:right;}
.svc-dialog .svc-options{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
.svc-dialog .svc-options label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  border:1px solid var(--line);
  border-radius:10px;
  padding:6px 10px;
  font-size:14px;
  background:#f8fafc;
  width:100%;
}
.svc-dialog .svc-options label span{
  display:flex;
  align-items:center;
  gap:6px;
  flex:1;
  white-space:normal;
}
.svc-dialog .svc-options input{margin:0;flex-shrink:0;}
.svc-stepper{display:flex;gap:8px;justify-content:center;padding:14px;border-bottom:1px solid var(--line);background:linear-gradient(135deg,rgba(24,161,104,.08),rgba(16,149,214,.08));}
.svc-stepper span{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--line);font-size:13px;color:#6b7280;font-weight:700;background:#fff;}
.svc-stepper span.active{background:#16a34a;color:#fff;border-color:#16a34a;box-shadow:0 8px 20px rgba(22,163,74,.35);}
.svc-stepper span.done{background:#bbf7d0;color:#166534;border-color:#86efac;}
.svc-step-content{display:none;flex-direction:column;gap:16px;padding:18px;}
.svc-step-content.active{display:flex;}
.svc-step-title{font-weight:800;font-size:18px;}
.svc-form-section{display:grid;gap:12px;}
.svc-bank-box{border:1px solid var(--line);border-radius:14px;padding:14px;background:#f8fafc;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
.svc-bank-box .info{font-size:14px;color:#0f172a;font-weight:700;}
.svc-bank-box .info span{display:block;font-size:12px;color:#6b7280;font-weight:600;}
.svc-bank-copy{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 12px;font-weight:700;font-size:13px;cursor:pointer;}
.svc-bank-hint{font-size:12px;color:#6b7280;line-height:1.6;}
.svc-upload-hint{font-size:12px;color:#ef4444;}
.svc-step-actions{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;}
.svc-step-actions .btn{min-width:120px;}
.svc-success-icon{width:64px;height:64px;border-radius:50%;background:#dcfce7;color:#166534;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto;}
.svc-step3-card{border:1px solid var(--line);border-radius:14px;background:#f8fafc;padding:14px;display:grid;gap:8px;font-size:14px;color:#374151;}
.svc-step3-card strong{font-size:16px;}
.svc-cart-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:14px;padding:10px;gap:12px;background:#fff;}
.svc-cart-item .info{display:flex;gap:10px;align-items:center;flex:1;}
.svc-cart-item img{width:56px;height:56px;object-fit:cover;border-radius:12px;}
.svc-cart-item .meta{font-size:12px;color:#6b7280;margin-top:2px;}
.svc-cart-item .price{font-weight:800;margin-right:10px;}
.svc-cart-remove{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 12px;font-size:13px;font-weight:700;cursor:pointer;}
.svc-cart-qty{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:4px 6px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;}
.svc-cart-qty-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--line);background:#fff;font-weight:700;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;}
.svc-cart-qty input{width:48px;border:1px solid var(--line);border-radius:999px;padding:4px 6px;font-size:13px;font-weight:700;text-align:center;background:#fff;}
.svc-cart-actions{padding:0 18px 18px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:4px;}
.svc-cart-actions .btn{flex:1;min-width:120px;}
.btn.loading{position:relative;pointer-events:none;}
.btn.loading::after{
  content:"";
  position:absolute;
  right:10px;
  width:14px;height:14px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.6);
  border-top-color:transparent;
  animation:spin .8s linear infinite;
}
.btn.loading::before{
  content:"";
  position:absolute;
  left:10px;
  width:14px;height:14px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.6);
  border-top-color:transparent;
  animation:spin .8s linear infinite;
}
.submit-tip{font-size:12px;color:#64748b;margin-top:8px;display:none;}
.submit-tip.show{display:block;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
@media(max-width:560px){
  .svc-cart-item{flex-direction:column;align-items:flex-start;}
  .svc-cart-item .price{margin-right:0;}
  .svc-cart-actions .btn{flex:1 0 100%;}
}
#svcCartForm{padding:0;}
#svcCartForm section{padding:18px;display:grid;gap:12px;}
#svcCartForm label{display:grid;gap:4px;font-size:13px;color:#374151;font-weight:700;}
#svcCartForm input,#svcCartForm textarea,#svcCartForm select{padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;}
#svcCartForm textarea{min-height:110px;resize:vertical;}
#svcCart{max-width:640px;width:95%;max-height:90vh;overflow:hidden;box-sizing:border-box;margin:0 auto;}
#svcCartForm{flex:1;max-height:calc(90vh - 64px);overflow:hidden;display:flex;flex-direction:column;}
#svcCart .svc-step-content{max-height:calc(90vh - 160px);overflow:auto;}
@media (max-width: 640px){
  #svcCart{
    max-height:92vh;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    margin:0;
  }
  #svcCartForm{max-height:calc(92vh - 64px);}
  #svcCart .svc-step-content{max-height:calc(92vh - 160px);}
  #svcLookup input,
  #svcLookup textarea,
  #svcLookup select,
  #svcCartForm input,
  #svcCartForm textarea,
  #svcCartForm select{
    font-size:16px;
  }
}
.qty-stepper{display:flex;align-items:center;gap:8px;}
.qty-stepper button{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:18px;line-height:1;cursor:pointer;}
.qty-stepper input{width:72px;text-align:center;}
.svc-summary{background:#f8fafc;border:1px solid var(--line);border-radius:14px;padding:14px;margin:18px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
.svc-summary strong{font-size:18px;}
#svcLookup{border:none;border-radius:16px;padding:0;background:var(--card);border:1px solid var(--line);box-shadow:0 20px 50px rgba(15,23,42,.35);max-width:560px;width:92%;max-height:85vh;box-sizing:border-box;margin:0 auto;}
#svcLookup::backdrop{background:rgba(2,6,23,.45);}
#svcLookup header{padding:18px;border-bottom:1px solid var(--line);}
#svcLookup form{padding:18px;display:grid;gap:12px;max-height:calc(85vh - 210px);overflow:auto;}
#svcLookupResult{padding:0 18px 18px;max-height:calc(85vh - 260px);overflow:auto;}
#svcLookup label{display:grid;gap:6px;font-size:13px;color:#374151;font-weight:600;}
#svcLookup input{padding:10px 12px;border:1px solid var(--line);border-radius:12px;}
#svcLookup .actions{padding:0 18px 18px;display:flex;justify-content:flex-end;gap:10px;}
#svcLookupCards .lookup-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f8fafc;}
#svcSuccess .svc-success-body{padding:20px;display:grid;gap:12px;}
#svcSuccess .svc-success-body .order-id{font-size:22px;font-weight:800;}
#svcSuccess footer{padding:0 20px 20px;display:flex;justify-content:flex-end;gap:10px;}
.guardian-badge{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:linear-gradient(135deg,#0f172a,#111827);border:1px solid rgba(148,163,184,0.35);color:#e2e8f0;box-shadow:0 12px 24px rgba(15,23,42,0.25);}
.guardian-badge img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));}
.guardian-meta{display:flex;flex-direction:column;gap:2px;font-size:12px;}
.guardian-meta strong{font-size:13px;font-weight:700;color:#f8fafc;}
.fortune-btn{margin-top:2px;background:linear-gradient(135deg,#f59e0b,#f97316);color:#0b1120;border:none;border-radius:999px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(249,115,22,.35);}
.fortune-btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;}

.fortune-dialog{border:none;border-radius:18px;padding:0;max-width:560px;width:92%;background:#0b1022;color:#e5e7eb;box-shadow:0 24px 60px rgba(0,0,0,.45);}
.fortune-shell{padding:20px;display:grid;gap:16px;background:
  radial-gradient(circle at 20% 10%, rgba(253,224,71,.08), transparent 38%),
  radial-gradient(circle at 80% 0%, rgba(56,189,248,.12), transparent 40%),
  #0b1022;border-radius:18px;border:1px solid rgba(148,163,184,0.2);}
.fortune-head{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.fortune-title{font-size:18px;font-weight:800;letter-spacing:.5px;}
.fortune-date{font-size:12px;color:#94a3b8;}
.fortune-close{border:none;background:rgba(255,255,255,.1);color:#e2e8f0;border-radius:999px;width:28px;height:28px;cursor:pointer;}
.fortune-loading{padding:16px;border-radius:14px;border:1px dashed rgba(148,163,184,.3);background:rgba(15,23,42,.55);color:#cbd5f5;font-size:13px;text-align:center;}
.fortune-error{padding:12px;border-radius:12px;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.4);color:#fecaca;font-size:13px;}
.fortune-card{padding:16px;border-radius:16px;background:linear-gradient(135deg,#111827,#0f172a);border:1px solid rgba(94,234,212,.25);box-shadow:0 16px 36px rgba(0,0,0,.35);animation:fortuneFlip .6s ease;}
.fortune-card{position:relative;overflow:hidden;transform-style:preserve-3d;}
.fortune-stars{font-size:16px;letter-spacing:2px;color:#fbbf24;margin-bottom:6px;}
.fortune-summary{font-size:16px;font-weight:800;color:#f8fafc;margin-bottom:10px;}
.fortune-section{margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.18);}
.fortune-label{font-size:12px;letter-spacing:1px;color:#94a3b8;margin-bottom:6px;}
.fortune-text{font-size:14px;line-height:1.7;color:#e2e8f0;}
.fortune-meta{margin-top:12px;display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:#cbd5f5;}
.fortune-meta span{padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.3);background:rgba(15,23,42,.6);}
.fortune-actions{margin-top:14px;display:flex;justify-content:flex-end;}
.fortune-share-btn{border:none;border-radius:999px;padding:8px 14px;font-size:12px;font-weight:700;color:#0b1120;background:linear-gradient(135deg,#fde68a,#f59e0b);box-shadow:0 10px 20px rgba(245,158,11,.3);cursor:pointer;}
.fortune-share-btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;}
@keyframes fortuneFlip{from{transform:rotateY(20deg) scale(.98);opacity:.2;}to{transform:rotateY(0deg) scale(1);opacity:1;}}
@media(max-width:560px){
  .guardian-badge{justify-content:center;text-align:center;}
  .guardian-meta{align-items:center;}
  .guardian-badge{margin:6px auto 0;}
}
  </style>
</head>
<body class="service-view">
  <div class="wrap service-page">
    <div class="top service-top">
      <div class="brand">
        <img src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="">
        <div>
          <div class="t1">泰國寺廟map ©️ unalomecodes</div>
          <div class="t2">服務型商品專區</div>
        </div>
      </div>
      <div class="top-actions-right">
        <div class="member-menu">
          <button type="button" id="memberMenuBtnSvc">
            <span class="member-menu-label">會員中心</span>
            <span class="member-menu-arrow" id="memberMenuArrowSvc">▾</span>
            <span class="member-menu-badge" id="memberMenuBadgeSvc" style="display:none;">0</span>
          </button>
          <div class="member-menu-panel" id="memberMenuPanelSvc">
            <a href="#" data-profile>基本資料</a>
            <a href="/account-coupons" id="userCouponsLinkSvc" class="qna-link">我的優惠券 <span class="qna-badge" id="userCouponBadgeSvc">0</span></a>
            <a href="/account-orders" id="userOrdersLinkSvc" class="qna-link">我的訂單 <span class="qna-badge" id="userQnaBadgeSvc">0</span></a>
            <a href="/account-store">門市預設</a>
            <a href="/admin/orders" id="adminQnaLinkSvc" class="qna-link" data-admin-only data-admin-href="/admin/orders" style="display:none;">訂單問答 <span class="qna-badge" id="adminQnaBadgeSvc">0</span></a>
            <a href="/admin" data-admin-only data-admin-href="/admin" style="display:none;">後台管理</a>
          </div>
        </div>
        <div class="auth-widget" data-auth-widget>
          <span class="auth-status" data-auth-status>登入狀態載入中…</span>
          <button type="button" class="auth-btn" data-auth-btn>登入會員</button>
        </div>
        <div id="guardianBadgeSvc" class="guardian-badge" style="display:none;"></div>
      </div>
    </div>

    <dialog id="fortuneDialog" class="fortune-dialog">
      <div class="fortune-shell">
        <div class="fortune-head">
          <div>
            <div class="fortune-title">今日專屬日籤</div>
            <div class="fortune-date" id="fortuneDate">—</div>
          </div>
          <button type="button" class="fortune-close" id="fortuneClose">✕</button>
        </div>
        <div class="fortune-body">
          <div id="fortuneLoading" class="fortune-loading">正在翻牌中…</div>
          <div id="fortuneError" class="fortune-error" style="display:none;"></div>
          <div id="fortuneCard" class="fortune-card" style="display:none;">
            <div class="fortune-stars" id="fortuneStars"></div>
            <div class="fortune-summary" id="fortuneSummary"></div>
            <div class="fortune-section">
              <div class="fortune-label">生活小建議</div>
              <div class="fortune-text" id="fortuneAdvice"></div>
            </div>
            <div class="fortune-section">
              <div class="fortune-label" id="fortuneRitualLabel">守護神想對你說</div>
              <div class="fortune-text" id="fortuneRitual"></div>
            </div>
            <div class="fortune-meta" id="fortuneMeta"></div>
            <div class="fortune-actions">
              <button type="button" class="fortune-share-btn" id="fortuneShareBtn">自動截圖分享</button>
            </div>
          </div>
        </div>
      </div>
    </dialog>

    <div class="store service-layout">
      <aside id="sideDeities">
        <div class="side-cart">
          <button id="cartFab" type="button" title="查看購物車"><span class="lbl">服務購物車</span><span id="cartBadge">0</span></button>
        </div>
        <div class="tools-box">
          <h4>常用連結</h4>
          <div class="list">
            <a href="/shop">返回商品館</a>
            <a href="#" id="linkServiceLookup">祈福進度查詢</a>
            <button id="svcHotToggle" class="side-cat-btn" type="button">熱賣中服務</button>
          </div>
        </div>
        <div class="tools-box">
          <h4>實用工具連結</h4>
          <div class="list">
            <a href="https://shop.unalomecodes.com/food-map" class="tool-link">
              <span class="tool-link-title"><span class="tool-link-dot"></span>泰國美食地圖</span>
            </a>
            <a href="https://shop.unalomecodes.com/templemap" class="tool-link">
              <span class="tool-link-title"><span class="tool-link-dot"></span>泰國寺廟地圖</span>
            </a>
            <a class="line-support-btn" href="https://line.me/R/ti/p/@427oaemj" target="_blank" rel="noopener">官方LINE客服</a>
          </div>
        </div>
      </aside>

      <div class="main service-main">
        <section id="svcHotSection" class="hot-section" style="display:none;">
          <div class="hot-head">
            <div class="hot-title">熱賣中服務</div>
            <div class="hot-sub">人氣排行</div>
          </div>
          <div id="svcHotList" class="grid hot-grid service-grid"></div>
        </section>
        <section>
          <div id="svcList" class="grid service-grid">
            <div id="svcListEmpty">載入中…</div>
          </div>
        </section>
      </div>
    </div>

    <div class="footer">
      <div class="footer-logos" aria-label="付款方式">
        <span class="logo-item" title="Visa">
          <img src="/img/brand/logo-visa.svg" alt="Visa" width="32" height="32" decoding="async">
        </span>
        <span class="logo-item" title="Mastercard">
          <img src="/img/brand/logo-mastercard.svg" alt="Mastercard" width="32" height="32" decoding="async">
        </span>
        <span class="logo-item" title="JCB">
          <img src="/img/brand/logo-jcb.svg" alt="JCB" width="32" height="32" decoding="async">
        </span>
        <span class="logo-item" title="7-ELEVEN">
          <img src="/img/brand/logo-711.svg" alt="7-ELEVEN" width="32" height="32" decoding="async">
        </span>
        <span class="logo-item" title="LINE Pay" style="display:none;">
          <img src="/img/brand/logo-linepay.svg" alt="LINE Pay" width="32" height="32" decoding="async">
        </span>
        <span class="logo-item logo-item--ecpay" title="綠界 ECPay">
          <img src="/img/brand/logo-ecpay.png" alt="綠界 ECPay" width="32" height="32" decoding="async">
        </span>
      </div>
      <div class="footer-contact">
        <div class="footer-social" aria-label="社群連結">
          <a class="logo-item logo-item--social" href="https://www.instagram.com/unalomecodes" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
            <img src="/img/brand/logo-instagram.png" alt="Instagram" width="32" height="32" decoding="async">
          </a>
          <a class="logo-item logo-item--social" href="https://www.facebook.com/share/1QLyANxx92/?mibextid=wwXIfr" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
            <img src="/img/brand/logo-facebook.svg" alt="Facebook" width="32" height="32" decoding="async">
          </a>
          <a class="logo-item logo-item--social" href="https://line.me/R/ti/p/@427oaemj" target="_blank" rel="noopener noreferrer" aria-label="LINE">
            <img src="/img/brand/logo-line.png" alt="LINE" width="32" height="32" decoding="async">
          </a>
        </div>
        <strong>聯絡我們</strong>
        <div>bkkaiwei@gmail.com</div>
        <div>客服LINE official @427oaemj</div>
        <div>2025-2026©unalomecodes ｜ <a href="#" id="privacyLink" class="policy-link">隱私權政策</a> ｜ <a href="/faq" class="policy-link">常見問題</a> ｜ <a href="/service-guide" class="policy-link">服務介紹</a></div>
      </div>
    </div>
  </div>

  <dialog id="privacyDialog" class="policy-dialog">
    <header>隱私權政策</header>
    <div class="body">
      <p>感謝您使用 unalomecodes 服務商品，我們遵循一般電商平台對個資與交易資料的保護做法，以下條列服務型商品專區的個資使用方式：</p>
      <ol>
        <li><strong>蒐集來源：</strong>您透過下單表單、祈福進度查詢、顧客故事分享所提供的姓名、聯絡方式、祈福需求與上傳檔案。</li>
        <li><strong>Google 登入：</strong>若以 Google 帳號登入，我們僅取得您的姓名、Email、Google 帳號識別碼與頭像，用於身分驗證、維持登入狀態、顯示會員資料與判斷管理員白名單。登入資訊與會話 Cookie 僅儲存在本站及受控系統，不與第三方共享。</li>
        <li><strong>LINE 登入：</strong>若以 LINE 帳號登入，我們僅取得您的 LINE 帳號識別碼、顯示名稱、Email（若授權）與頭像，用於身分驗證、維持登入狀態、顯示會員資料與判斷管理員白名單。登入資訊與會話 Cookie 僅儲存在本站及受控系統，不與第三方共享。</li>
        <li><strong>使用目的：</strong>用於聯絡客戶、核對匯款、進行祈福流程、出貨或售後服務，以及寄送祈福成果或客服通知。</li>
        <li><strong>資料保存：</strong>訂單與匯款資訊會儲存在與實體商品相同的系統（Cloudflare / Google Workspace 等）；祈福成果照片僅用於通知本人，不會公開給第三方。</li>
        <li><strong>分享對象：</strong>僅在必要時提供給協助祈福的老師與合作神壇人員，不會轉售或提供給其他公司。若有金流或物流服務，僅提供必要資訊。</li>
        <li><strong>資料安全：</strong>我們使用與商城一致的加密連線與存取權限制度，並定期清查與刪除不再需要的個資。</li>
        <li><strong>您的權利：</strong>您可透過官方 LINE 或 email 要求查詢、下載、更新或刪除個資。我們會於合理時間內回覆並完成作業。</li>
      </ol>
      <p>使用本服務即表示您同意上述條款。如有疑問，歡迎透過官方 LINE 客服聯繫。</p>
    </div>
    <footer>
      <button type="button" class="btn" id="privacyClose">關閉</button>
    </footer>
  </dialog>

  <dialog id="profileDialogSvc" class="policy-dialog">
    <header>基本資料</header>
    <div class="body">
      <label>姓名</label>
      <input id="profileNameSvc" type="text">
      <label>Email</label>
      <input id="profileEmailSvc" type="email">
      <label>手機號碼</label>
      <input id="profilePhoneSvc" type="tel" placeholder="請輸入手機號碼">
      <p class="muted" style="font-size:12px;margin-top:8px;">儲存後，實體商品與服務商品結帳會自動帶入這三項資料。</p>
      <div id="profileStatusSvc" style="color:#ef4444;font-size:13px;min-height:18px;"></div>
    </div>
    <footer>
      <button type="button" class="btn" id="profileCloseSvc">取消</button>
      <button type="button" class="btn primary" id="profileSaveSvc">儲存</button>
    </footer>
  </dialog>

  <dialog id="svcLookup" style="border:none;border-radius:16px;padding:0;max-width:560px;width:92%;">
    <header>
      <div style="font-weight:800;font-size:18px;">祈福進度查詢</div>
      <p style="margin:6px 0 0;color:#6b7280;font-size:13px;">輸入手機並搭配訂單編號末五碼（英數）或匯款帳號末五碼，即可查看服務最新狀態。</p>
    </header>
    <form id="svcLookupForm">
      <label>
        手機號碼
        <input type="tel" name="phone" required placeholder="請輸入下單時的電話" pattern="09\d{8}">
      </label>
      <label>
        訂單編號末五碼（英數）
        <input type="text" name="orderDigits" inputmode="text" pattern="[A-Za-z0-9]{5}" placeholder="A1B2C">
      </label>
      <label>
        匯款帳號末五碼
        <input type="text" name="bankDigits" inputmode="numeric" pattern="\d{5}" placeholder="12345">
      </label>
      <div class="actions">
        <button type="button" class="btn" id="svcLookupClose">關閉</button>
        <button type="submit" class="btn primary">查詢</button>
      </div>
      <p id="svcLookupHint" style="margin:0;font-size:12px;color:#94a3b8;">查詢結果載入後會顯示於下方。</p>
    </form>
    <div id="svcLookupResult" style="display:none;">
      <div style="font-weight:700;margin-bottom:6px;">查詢結果</div>
      <div id="svcLookupCards" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>
  </dialog>

  <dialog id="svcDetail" class="svc-dialog">
    <div class="closeBar">
      <strong id="svcDetailTitle">服務名稱</strong>
      <button id="svcDetailClose" class="xbtn" type="button">✕</button>
    </div>
    <div class="dlgBody">
      <div>
        <div class="bigBox">
          <img id="svcDetailHero" class="big" alt="">
        </div>
        <div class="thumbs" id="svcDetailGallery"></div>
        <div id="svcDetailInstagram" class="svc-ig" style="display:none;"></div>
      </div>
      <div>
        <div style="font-weight:700;color:#6b7280;margin-bottom:4px;">服務內容</div>
        <div class="dlgTags svc-tags">
          <span id="svcDetailLimited" class="dlgTag dlgTag--limited" style="display:none;"></span>
          <span id="svcDetailRemaining" class="dlgTag dlgTag--remaining" style="display:none;"></span>
        </div>
        <div id="svcDetailDesc" style="font-size:14px;line-height:1.7;border:1px solid var(--line);border-radius:12px;padding:12px;white-space:pre-wrap;max-height:220px;overflow:auto;">服務說明</div>
        <ul id="svcDetailIncludes" class="svc-includes">
          <li>蠟燭祈請</li>
        </ul>
        <div id="svcDetailOptionsWrap" style="margin-top:12px;">
          <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px;">服務項目（選擇後加入購物車，可重複加入不同選項）</label>
          <select id="svcDetailVariant" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);font-size:14px;"></select>
        </div>
        <div id="svcDetailQtyWrap" style="margin-top:12px;display:none;">
          <label id="svcDetailQtyLabel" for="svcDetailQty" style="display:block;font-size:12px;color:#6b7280;margin-bottom:6px;">數量</label>
          <div class="qty-stepper">
            <button type="button" id="svcDetailQtyMinus" aria-label="減少數量">−</button>
            <input id="svcDetailQty" type="number" min="1" step="1" value="1" inputmode="numeric" style="padding:10px;border-radius:10px;border:1px solid var(--line);font-size:14px;">
            <button type="button" id="svcDetailQtyPlus" aria-label="增加數量">+</button>
            <span id="svcDetailFeeHint" style="font-size:12px;color:#6b7280;white-space:nowrap;"></span>
          </div>
          <div id="svcDetailPriceHint" style="font-size:12px;color:#6b7280;margin-top:6px;display:none;"></div>
        </div>
        <div style="margin-top:16px;font-weight:800;font-size:20px;color:#0f172a;">NT$ <span id="svcDetailPrice">0</span></div>
        <div style="margin-top:12px;">
          <button id="svcDetailAddCart" class="btn primary" style="width:100%;">加入購物車</button>
        </div>
        <div class="reviews" style="margin-top:20px;">
          <div style="font-weight:800;margin-bottom:6px">顧客評價／真實故事</div>
          <div id="svcRvList"></div>
          <div style="margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
            <div style="display:grid;gap:12px;margin-bottom:12px;">
              <div style="display:grid;gap:6px;">
                <label for="svcRvNick" style="font-size:12px;color:#6b7280">您的名字 (或暱稱)</label>
                <input id="svcRvNick" type="text" placeholder="例：林小姐" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
              </div>
              <div style="display:grid;gap:6px;">
                <label for="svcRvFile" style="font-size:12px;color:#6b7280">上傳圖片 (選填)</label>
                <input id="svcRvFile" type="file" accept="image/*" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
              </div>
            </div>
            <textarea id="svcRvText" placeholder="分享您的真實體驗、感應或故事..." style="min-height:100px;"></textarea>
            <div class="cta" style="margin-top:8px;">
              <button class="btn primary" id="svcRvSubmit">送出分享</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <dialog id="svcCartPanel" style="border:none;border-radius:16px;padding:0;max-width:640px;width:95%;box-shadow:0 30px 60px rgba(15,23,42,.35);">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--line);">
      <div style="font-weight:800;font-size:18px;">服務購物車</div>
      <button type="button" id="svcCartPanelClose" class="xbtn">✕</button>
    </div>
    <div id="svcCartList" style="max-height:50vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px;"></div>
    <div style="padding:0 18px 12px;">
      <div style="display:flex;justify-content:space-between;font-weight:700;">
        <span>應付金額</span>
        <span id="svcCartAmount">NT$ 0</span>
      </div>
    </div>
    <div class="svc-cart-actions">
      <button class="btn" id="svcCartPanelBack">返回上一頁</button>
      <button class="btn" id="svcCartClear">清空購物車</button>
      <button class="btn primary" id="svcCartCheckout">填寫訂單資料</button>
    </div>
  </dialog>

  <dialog id="svcCart" class="svc-dialog" data-bank-name="中國信託 (822)" data-bank-account="148540417073" style="width:min(920px,96vw);max-height:92vh;overflow:hidden;">
    <div class="svc-stepper">
      <span data-step="1" class="active">1. 確認服務</span>
      <span data-step="2">2. 匯款資料</span>
      <span data-step="3">3. 完成</span>
    </div>
    <form id="svcCartForm" class="svc-form" enctype="multipart/form-data" novalidate>
      <input type="hidden" id="svcCartServiceId">
      <div class="svc-step-content active" id="svcCartStep1" data-step="1">
        <div>
          <div class="svc-step-title">確認服務與填寫基本資料</div>
          <p class="svc-bank-hint">請先確認服務內容，再填寫聯絡資訊與祈福需求，下一步即可查看匯款帳戶並上傳憑證。</p>
        </div>
        <div class="svc-summary">
          <div>
            <div style="font-size:12px;color:#6b7280;font-weight:700;">服務內容確認</div>
            <div id="svcCartServiceName" style="font-weight:700;font-size:16px;margin-top:4px;">服務名稱</div>
            <ul id="svcCartSummary" style="margin:6px 0 0;padding-left:18px;color:#475569;font-size:13px;line-height:1.5;"></ul>
          </div>
          <strong id="svcCartTotal">NT$ 0</strong>
        </div>
        <section class="svc-form-section">
          <label>
            聯絡人姓名（必填）
            <input type="text" name="name" required placeholder="請輸入姓名">
          </label>
          <label>
            英文姓名（必填）
            <input type="text" name="nameEn" required placeholder="請輸入英文名字（護照/拼音）">
          </label>
          <label>
            手機號碼（必填）
            <input type="tel" name="phone" required placeholder="例：0969123456" inputmode="tel">
          </label>
          <label>
            Email（必填）
            <input type="email" name="email" required placeholder="請輸入通知用 Email">
          </label>
          <label>
            生日（西元年/月/日，必填）
            <input type="date" name="birth" required>
          </label>
          <label>
            指定祈福日期（可留白）
            <input type="date" name="requestDate">
            <span class="svc-bank-hint">如中午前完成下單，可選擇當日祈福；超過 12:00 請改選翌日以後。</span>
          </label>
          <label>
            備註
            <textarea name="note" placeholder="可輸入希望代許的願望，例如：身體健康、事業順利 或回向給眾生等等..."></textarea>
          </label>
          <label id="svcContactPhotoWrap">
            <span id="svcContactPhotoTitle">上傳個人照片（祈福使用，必填）</span>
            <input type="file" id="svcContactPhoto" accept="image/*" required>
            <span class="svc-bank-hint" id="svcContactPhotoHint">建議上傳清晰的正面照片，僅供老師祈福使用。</span>
            <span class="svc-bank-hint" id="svcContactPhotoName"></span>
          </label>
          <div class="svc-bank-hint" id="svcContactPhotoSkipHint" style="display:none;">此服務不需上傳個人照片。</div>
        </section>
        <div class="svc-step-actions">
          <button type="button" class="btn" id="svcCartBack">返回</button>
          <button type="button" class="btn primary" id="svcCartNext">前往匯款資料</button>
        </div>
      </div>

      <div class="svc-step-content" id="svcCartStep2" data-step="2">
        <div>
          <div class="svc-step-title">填寫匯款資料並上傳憑證</div>
          <p class="svc-bank-hint">請先完成轉帳，再輸入匯款末五碼並上傳匯款憑證，以便我們核帳、成立訂單。</p>
        </div>
        <div class="svc-bank-box">
          <div class="info">
            <span>匯款銀行</span>
            <strong id="svcBankName">中國信託 (822)</strong>
          </div>
          <div class="info">
            <span>匯款帳號</span>
            <strong id="svcBankAccount">148540417073</strong>
          </div>
          <button type="button" class="svc-bank-copy" id="svcBankCopy">複製帳號</button>
        </div>
        <section class="svc-form-section">
          <label>
            匯款金額（NT$）
            <input type="text" id="svcBankAmount" readonly>
            <span class="svc-bank-hint">系統自動帶入，請勿修改。</span>
            <span class="svc-bank-hint" id="svcMemberPerkHint" style="display:none;"></span>
          </label>
          <label>
            匯款末五碼
            <input type="text" id="svcBankLast5" placeholder="12345" inputmode="numeric" pattern="\d{5}" required>
          </label>
          <label>
            上傳匯款憑證（照片或截圖）
            <input type="file" id="svcBankReceipt" accept="image/*,application/pdf" required>
            <span class="svc-upload-hint">檔案需 20MB 以下，建議上傳清晰照片或 PDF。</span>
            <span class="svc-bank-hint" id="svcBankReceiptName"></span>
          </label>
          <label>
            匯款補充說明（可留白）
            <textarea id="svcBankMemo" placeholder="例：匯款人姓名與帳號、備註事項"></textarea>
          </label>
        </section>
        <div class="svc-step-actions">
          <button type="button" class="btn" id="svcBankBack">上一步</button>
          <button type="submit" id="svcBankSubmit" class="btn primary">送出匯款資料</button>
        </div>
        <div class="submit-tip" id="svcSubmitTip">若上傳圖片檔案較大，送出訂單時間會較久，請耐心等待。</div>
      </div>

      <div class="svc-step-content" id="svcCartStep3" data-step="3">
        <div class="svc-success-icon">✓</div>
        <div style="text-align:center;">
          <div class="svc-step-title">訂單送出成功</div>
          <p class="svc-bank-hint">我們已收到匯款資料並建立祈福訂單，請保留以下資訊或截圖備查。</p>
        </div>
        <div class="svc-step3-card">
          <div><span style="font-size:12px;color:#6b7280;">訂單編號</span><strong id="svcStep3OrderId">SVXXXXXX</strong></div>
          <div>服務內容：<span id="svcStep3Service">—</span></div>
          <div>應付金額：<span id="svcStep3Amount">NT$ 0</span></div>
          <div>匯款末五碼：<span id="svcStep3Last5">—</span></div>
          <div>聯絡人：<span id="svcStep3Buyer">—</span></div>
        </div>
        <div class="svc-bank-hint">之後可透過左側「祈福進度查詢」輸入手機與訂單末五碼（英數）查詢最新進度。</div>
        <div class="svc-step-actions">
          <button type="button" class="btn" id="svcStep3Lookup">查詢進度</button>
          <button type="button" class="btn primary" id="svcStep3Close">完成</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="svcSuccess" class="svc-dialog">
    <div class="closeBar">
      <strong>祈福訂單已送出</strong>
      <button id="svcSuccessClose" class="xbtn" type="button">✕</button>
    </div>
    <div class="svc-success-body">
      <div>
        <div style="color:#6b7280;font-size:13px;">訂單編號</div>
        <div id="svcSuccessId" class="order-id">SVXXXXXX</div>
      </div>
      <div id="svcSuccessHint" style="font-size:14px;color:#374151;line-height:1.7;">
        我們會在指定時間完成祈福並透過 Email/LINE 通知，亦可使用左側「查祈福進度」功能查看最新狀態。
      </div>
    </div>
    <footer>
      <button class="btn" id="svcSuccessLookup">查詢進度</button>
    </footer>
  </dialog>

  <script>window.LIFF_ID = '2008307812-RVDkHkD5';</script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/js/auth.js?v=20240930"></script>
  <script src="/js/track.js"></script>
  <script src="/js/service-main.js"></script>
  <script>
    (function(){
      const badge = document.getElementById('guardianBadgeSvc');
      const fortuneDialog = document.getElementById('fortuneDialog');
      const fortuneClose = document.getElementById('fortuneClose');
      const fortuneLoading = document.getElementById('fortuneLoading');
      const fortuneError = document.getElementById('fortuneError');
      const fortuneCard = document.getElementById('fortuneCard');
      const fortuneDate = document.getElementById('fortuneDate');
      const fortuneStars = document.getElementById('fortuneStars');
      const fortuneSummary = document.getElementById('fortuneSummary');
      const fortuneAdvice = document.getElementById('fortuneAdvice');
      const fortuneRitual = document.getElementById('fortuneRitual');
      const fortuneMeta = document.getElementById('fortuneMeta');
      const fortuneRitualLabel = document.getElementById('fortuneRitualLabel');
      const fortuneShareBtn = document.getElementById('fortuneShareBtn');
      let lastFortune = null;
      let lastGuardianName = '';
      const map = {FM:'四面神',GA:'象神',CD:'崇迪佛',KP:'坤平',HP:'魂魄勇',XZ:'徐祝老人',WE:'五眼四耳',HM:'猴神哈魯曼',RH:'拉胡',JL:'迦樓羅',ZD:'澤度金',ZF:'招財女神'};
      const badgeIcon = (function(){
        if (window.GUARDIAN_BADGE_ICON) return window.GUARDIAN_BADGE_ICON;
        return '/img/guardian-emblem.png';
      })();
      function showDialog(dlg){
        if (!dlg) return;
        if (typeof dlg.showModal === 'function') dlg.showModal();
        else dlg.setAttribute('open', 'open');
      }
      function closeDialog(dlg){
        if (!dlg) return;
        if (typeof dlg.close === 'function') dlg.close();
        else dlg.removeAttribute('open');
      }
      function setFortuneLoading(){
        if (fortuneLoading) fortuneLoading.style.display = '';
        if (fortuneError) fortuneError.style.display = 'none';
        if (fortuneCard) fortuneCard.style.display = 'none';
      }
      function setFortuneError(message){
        if (fortuneError){
          fortuneError.textContent = message || '暫時無法取得日籤，請稍後再試。';
          fortuneError.style.display = '';
        }
        if (fortuneLoading) fortuneLoading.style.display = 'none';
        if (fortuneCard) fortuneCard.style.display = 'none';
      }
      function renderFortune(fortune){
        if (!fortune) return;
        lastFortune = fortune;
        if (fortuneDate) fortuneDate.textContent = fortune.date || '';
        if (fortuneStars){
          const stars = fortune.stars || '';
          fortuneStars.textContent = stars;
          fortuneStars.style.display = stars ? '' : 'none';
        }
        if (fortuneSummary) fortuneSummary.textContent = fortune.summary || '';
        if (fortuneAdvice) fortuneAdvice.textContent = fortune.advice || '';
        if (fortuneRitual) fortuneRitual.textContent = fortune.ritual || '';
        if (fortuneMeta){
          const meta = fortune.meta || {};
          const tags = [];
          if (meta.userZodiac){
            const zodiacLabel = meta.userZodiacElement ? `${meta.userZodiac}（${meta.userZodiacElement}象）` : meta.userZodiac;
            tags.push(`星座 ${zodiacLabel}`);
          }
          if (meta.moonPhase) tags.push(`月相 ${meta.moonPhase}`);
          if (meta.iching) tags.push(`易經 ${meta.iching}`);
          if (meta.todayDow) tags.push(`今日星期${meta.todayDow}`);
          if (meta.thaiDayColor) tags.push(`泰國星期色 ${meta.thaiDayColor}`);
          if (meta.buddhistYear) tags.push(`佛曆 ${meta.buddhistYear}`);
          fortuneMeta.innerHTML = tags.map(t=>`<span>${t}</span>`).join('');
        }
        if (fortuneRitualLabel){
          const gName = (fortune.meta && fortune.meta.guardianName) || '';
          lastGuardianName = gName || lastGuardianName;
          fortuneRitualLabel.textContent = gName ? `守護神 ${gName} 想對你說` : '守護神想對你說';
        }
        if (fortuneLoading) fortuneLoading.style.display = 'none';
        if (fortuneError) fortuneError.style.display = 'none';
        if (fortuneCard) fortuneCard.style.display = '';
      }
      async function fetchFortune(){
        setFortuneLoading();
        try{
          const res = await fetch('/api/fortune', { cache:'no-store', credentials:'include' });
          const data = await res.json().catch(()=>({}));
          if (!res.ok || !data || data.ok === false){
            if (data && data.needQuiz) throw new Error('請先完成守護神測驗後再領取日籤。');
            throw new Error((data && data.error) || '取得日籤失敗');
          }
          renderFortune(data.fortune || null);
        }catch(err){
          setFortuneError(err && err.message ? err.message : '暫時無法取得日籤');
        }
      }
      async function openFortuneDialog(){
        if (!fortuneDialog) return;
        const loggedIn = window.authState && typeof window.authState.isLoggedIn==='function' ? window.authState.isLoggedIn() : false;
        if (!loggedIn){
          if (window.authState && typeof window.authState.promptLogin === 'function'){
            window.authState.promptLogin('請先登入後再領取日籤。');
          }
          return;
        }
        showDialog(fortuneDialog);
        await fetchFortune();
      }
      function drawRoundRect(ctx, x, y, w, h, r){
        const rr = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }
      function wrapText(ctx, text, x, y, maxWidth, lineHeight){
        const words = String(text || '').split('');
        let line = '';
        for (let i = 0; i < words.length; i++) {
          const test = line + words[i];
          const metrics = ctx.measureText(test);
          if (metrics.width > maxWidth && i > 0) {
            ctx.fillText(line, x, y);
            line = words[i];
            y += lineHeight;
          } else {
            line = test;
          }
        }
        if (line) ctx.fillText(line, x, y);
        return y;
      }
      async function loadImageFromUrl(url){
        try{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          return await new Promise(resolve=>{
            img.onload = ()=> resolve(img);
            img.onerror = ()=> resolve(null);
            img.src = url;
          });
        }catch(_){ return null; }
      }
      async function buildFortuneShareImage(){
        const canvas = document.createElement('canvas');
        const w = 1080;
        const h = 1920;
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0b1022';
        ctx.fillRect(0,0,w,h);
        ctx.fillStyle = 'rgba(253,224,71,0.08)';
        ctx.beginPath();
        ctx.arc(200, 160, 220, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'rgba(245,158,11,0.08)';
        ctx.beginPath();
        ctx.arc(900, 180, 240, 0, Math.PI * 2);
        ctx.fill();
        const pad = 80;
        ctx.fillStyle = 'rgba(15,23,42,0.9)';
        ctx.strokeStyle = 'rgba(148,163,184,0.25)';
        ctx.lineWidth = 3;
        drawRoundRect(ctx, pad, 150, w - pad * 2, h - 260, 36);
        ctx.fill();
        ctx.stroke();
        const brandImg = document.querySelector('.brand img');
        const preferredLogo = window.UNALOME_LOGO || '/logo.png';
        let logo = await loadImageFromUrl(preferredLogo);
        if (!logo && brandImg && brandImg.src){
          logo = await loadImageFromUrl(brandImg.src);
        }
        if (!logo){
          logo = await loadImageFromUrl('/img/guardian-emblem.png');
        }
        if (logo){
          ctx.drawImage(logo, pad + 40, 190, 88, 88);
        }
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '600 28px system-ui, -apple-system, "Segoe UI", sans-serif';
        ctx.fillText('unalomecodes', pad + 140, 240);
        ctx.fillStyle = '#f8fafc';
        ctx.font = '800 42px system-ui, -apple-system, "Segoe UI", sans-serif';
        ctx.fillText('今日專屬日籤', pad + 40, 320);
        ctx.fillStyle = '#94a3b8';
        ctx.font = '500 24px system-ui, -apple-system, "Segoe UI", sans-serif';
        ctx.fillText(lastFortune.date || '', pad + 40, 360);
        let summaryStart = lastGuardianName ? 460 : 440;
        if (lastGuardianName){
          ctx.fillStyle = '#cbd5f5';
          ctx.font = '600 24px system-ui, -apple-system, "Segoe UI", sans-serif';
          ctx.fillText(`守護神：${lastGuardianName}`, pad + 40, 398);
        }
        const starLine = lastFortune.stars || '';
        if (starLine){
          ctx.fillStyle = '#fbbf24';
          ctx.font = '600 28px system-ui, -apple-system, "Segoe UI", sans-serif';
          ctx.fillText(starLine, pad + 40, summaryStart);
          summaryStart += 52;
        }
        ctx.fillStyle = '#f8fafc';
        ctx.font = '700 32px system-ui, -apple-system, "Segoe UI", sans-serif';
        const summaryEnd = wrapText(ctx, lastFortune.summary || '', pad + 40, summaryStart, w - pad * 2 - 80, 44);
        let y = summaryEnd + 70;
        ctx.fillStyle = '#94a3b8';
        ctx.font = '600 22px system-ui, -apple-system, "Segoe UI", sans-serif';
        ctx.fillText('生活小建議', pad + 40, y);
        y += 50;
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '500 28px system-ui, -apple-system, "Segoe UI", sans-serif';
        const adviceEnd = wrapText(ctx, lastFortune.advice || '', pad + 40, y, w - pad * 2 - 80, 40);
        y = adviceEnd + 70;
        const label = lastGuardianName ? `守護神 ${lastGuardianName} 想對你說` : '守護神想對你說';
        ctx.fillStyle = '#94a3b8';
        ctx.font = '600 22px system-ui, -apple-system, "Segoe UI", sans-serif';
        ctx.fillText(label, pad + 40, y);
        y += 50;
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '500 28px system-ui, -apple-system, "Segoe UI", sans-serif';
        wrapText(ctx, lastFortune.ritual || '', pad + 40, y, w - pad * 2 - 80, 40);
        return new Promise(resolve=>{
          canvas.toBlob(b=> resolve(b), 'image/png');
        });
      }
      async function shareFortuneImage(){
        if (!lastFortune) return;
        if (fortuneShareBtn) {
          fortuneShareBtn.disabled = true;
          fortuneShareBtn.textContent = '產生中…';
        }
        try{
          const blob = await buildFortuneShareImage();
          if (!blob) throw new Error('圖片產生失敗');
          const fileName = `fortune-${(lastFortune.date || '').replace(/\//g,'-') || 'today'}.png`;
          const file = new File([blob], fileName, { type:'image/png' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
            await navigator.share({ title:'我的今日日籤', files:[file] });
          }else{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=> URL.revokeObjectURL(url), 500);
          }
        }catch(err){
          if (fortuneError){
            fortuneError.textContent = err && err.message ? err.message : '分享失敗，請稍後再試。';
            fortuneError.style.display = '';
          }
        }finally{
          if (fortuneShareBtn) {
            fortuneShareBtn.disabled = false;
            fortuneShareBtn.textContent = '自動截圖分享';
          }
        }
      }
      function readGuardian(){
        try{
          const loggedIn = window.authState && typeof window.authState.isLoggedIn === 'function'
            ? window.authState.isLoggedIn()
            : false;
          if (loggedIn && window.authState && typeof window.authState.getProfile === 'function'){
            const p = window.authState.getProfile();
            if (p && p.guardian) return p.guardian;
            return null;
          }
          const raw = localStorage.getItem('__lastQuizGuardian__');
          if (raw){
            const obj = JSON.parse(raw);
            if (obj && obj.code) return obj;
          }
          return null;
        }catch(_){ return null; }
      }
      function render(){
        if (!badge) return;
        const loggedIn = window.authState && typeof window.authState.isLoggedIn==='function' ? window.authState.isLoggedIn() : false;
        if (!loggedIn){
          badge.style.display = 'none';
          return;
        }
        const g = readGuardian();
        if (!g){
          badge.style.display = 'none';
          return;
        }
        const code = String(g.code||'').toUpperCase();
        const name = map[code] || '守護神';
        badge.innerHTML = `<img src="${badgeIcon}" alt="守護神"><div class="guardian-meta"><strong>守護神：${name}</strong><button type="button" class="fortune-btn" data-fortune-btn>領取日籤</button></div>`;
        badge.style.display = 'flex';
        const btn = badge.querySelector('[data-fortune-btn]');
        if (btn){
          btn.addEventListener('click', openFortuneDialog);
        }
      }
      if (window.authState && typeof window.authState.onProfile === 'function'){
        window.authState.onProfile(()=>render());
      }
      setTimeout(render, 800);
      render();
      if (fortuneClose){
        fortuneClose.addEventListener('click', ()=> closeDialog(fortuneDialog));
      }
      if (fortuneShareBtn){
        fortuneShareBtn.addEventListener('click', shareFortuneImage);
      }
    })();
  </script>
</body>
</html>

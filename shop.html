



<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="coupon-api" content="https://coupon-service.kaiwei425.workers.dev/">
<meta name="api-base" content="/">
<title>æ³°åœ‹å¯ºå»Ÿmap Â©ï¸ unalomecodes</title>
<link rel="stylesheet" href="/css/style.css">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <img src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="">
      <div>
        <div class="t1">æ³°åœ‹å¯ºå»Ÿmap Â©ï¸ unalomecodes</div>
        <div class="t2">unalomeè±¡å¾µäººç”Ÿä¿®è¡Œä¸¦é€šå¾€è¦ºæ‚Ÿçš„é“è·¯</div>
      </div>
    </div>
    <div class="filters">
      <select id="fDeity">
        <option value="">å…¨éƒ¨ç¥ç¥‡</option>
      </select>
      <select id="fSort">
        <option value="">æ’åºï¼šé è¨­</option>
        <option value="sold-desc">å·²å”®å‡ºï¼ˆå¤šâ†’å°‘ï¼‰</option>
        <option value="price-asc">åƒ¹æ ¼ï¼ˆä½â†’é«˜ï¼‰</option>
        <option value="price-desc">åƒ¹æ ¼ï¼ˆé«˜â†’ä½ï¼‰</option>
        <option value="newest">æœ€æ–°ä¸Šæ¶</option>
      </select>
      <input id="fMin" type="number" placeholder="æœ€ä½åƒ¹">
      <input id="fMax" type="number" placeholder="æœ€é«˜åƒ¹">
    </div>
  </div>

  <div class="store">
    <aside id="sideDeities"><h3>é€£çµ</h3>
    <div class="list">
      <a href="#" id="linkOrderLookup">æŸ¥è©¢è¨‚å–®ç‹€æ…‹</a>
      <a href="https://unalomecodes.pages.dev/share?view=deity-menu&amp;api=https%3A%2F%2Fproud-boat-794c.kaiwei425.workers.dev" target="_blank" rel="noopener">ç¥ç¥‡ä»‹ç´¹</a>
      <a href="https://myship.7-11.com.tw/general/detail/GM2509114839878" target="_blank" rel="noopener">7-11è³£è²¨ä¾¿</a>
    </div>
</aside>
    <div class="main">
      <div id="banner" class="empty" style="display:none"></div>
      <div id="skeleton" class="skeleton-grid"><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div><div class="skeleton-card"><div class="skeleton-pic"></div><div class="skeleton-line"></div><div class="skeleton-line w60"></div></div></div>
      <div id="list" class="grid"></div>
    </div>
  </div>
  <div class="footer">
  <strong>è¯çµ¡æˆ‘å€‘</strong><br>
  bkkaiwei@gmail.com<br>
  å®¢æœLINE official @427oaemj<br>
  2025Â©unalomecodes
</div>
</div>

<dialog id="dlg">
  <div class="closeBar">
    <strong id="dlgTitle">å•†å“è³‡è¨Š</strong>
    <button class="xbtn" onclick="dlg.close()">âœ•</button>
  </div>
  <div class="dlgBody">
    <div>
      <div class="bigBox">
        <img id="dlgBig" class="big" alt="">
      </div>
      <div class="thumbs" id="dlgThumbs"></div>
    </div>
    <div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div id="dlgName" style="font-weight:800;margin:2px 0 6px"></div>
        <span class="chip" id="dlgChip"></span>
      </div>
      <div id="dlgDeity" style="font-size:13px;color:#6b7280;margin-bottom:6px"></div>
      <div id="dlgDesc" style="font-size:14px;white-space:pre-wrap;line-height:1.6;border:1px solid var(--line);border-radius:10px;padding:10px;max-height:220px;overflow:auto"></div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>è¦æ ¼</label>
          <select id="dlgVariant"></select>
        </div>
        <div class="field">
          <label>æ•¸é‡</label>
          <input id="dlgQty" type="number" value="1" min="1">
        </div>
      </div>

      <div style="margin-top:10px;font-weight:800">
        NT$ <span id="dlgPrice">0</span>
      </div>

      <div class="cta" style="margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnAddCart">åŠ å…¥è³¼ç‰©è»Š</button>
        <button class="btn link" id="btnCheckout">ç›´æ¥çµå¸³</button>
      </div>

      <!-- é¡§å®¢è©•åƒ¹ / çœŸå¯¦æ•…äº‹ -->
      <div class="reviews">
        <div style="font-weight:800;margin-bottom:6px">é¡§å®¢è©•åƒ¹ï¼çœŸå¯¦æ•…äº‹</div>
        <div id="rvList"></div>
        <div style="margin-top:12px; border-top: 1px solid #e5e7eb; padding-top: 12px;">
          <div style="display:grid; gap:12px; margin-bottom:12px;">
            <div style="display:grid; gap:6px;">
              <label for="rvNick" style="font-size:12px;color:#6b7280">æ‚¨çš„åå­— (æˆ–æš±ç¨±)</label>
              <input id="rvNick" type="text" placeholder="ä¾‹ï¼šæ—å°å§" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
            </div>
            <div style="display:grid; gap:6px;">
              <label for="rvFile" style="font-size:12px;color:#6b7280">ä¸Šå‚³åœ–ç‰‡ (é¸å¡«)</label>
              <input id="rvFile" type="file" accept="image/*" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
            </div>
          </div>
          <textarea id="rvText" placeholder="åˆ†äº«æ‚¨çš„çœŸå¯¦é«”é©—ã€æ„Ÿæ‡‰æˆ–æ•…äº‹..."></textarea>
          <div class="cta" style="margin-top:8px">
            <button class="btn primary" id="rvSubmit">é€å‡ºåˆ†äº«</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</dialog>

<script>
const SHIP_LINK = "https://myship.7-11.com.tw/general/detail/GM2509114839878";

</script>

  <!-- å°è¦–çª—ï¼šç›´æ¥çµå¸³ -->
  <dialog id="dlgCheckout" style="border:none;border-radius:16px;padding:0;max-width:420px;width:90%;">
    <div style="padding:18px 18px 8px;font-weight:800;font-size:18px">é¸æ“‡çµå¸³æ–¹å¼</div>
    <div style="padding:0 18px 18px;color:#6b7280;font-size:14px">è«‹é¸æ“‡ä½ æƒ³ä½¿ç”¨çš„çµå¸³æ–¹å¼</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;padding:0 18px 18px">
      <a id="pay711" class="btn primary" target="_blank" rel="noopener">è½‰å¸³åŒ¯æ¬¾</a>
      <button id="payCC" class="btn">ä¿¡ç”¨å¡ï¼ˆæš«æœªé–‹æ”¾ï¼‰</button>
      <button id="payClose" class="btn link" style="margin-left:auto">é—œé–‰</button>
    </div>
  </dialog>

  <!-- Cart floating preview -->
  <button id="cartFab" title="æŸ¥çœ‹è³¼ç‰©è»Š"><span class="lbl">è³¼ç‰©è»Š</span><span id="cartBadge">0</span></button>

  <!-- Cart dialog -->
  <dialog id="dlgCart">
    <div class="cartWrap">
      <div class="cartHead">
        <div>è³¼ç‰©è»Š</div>
        <button id="cartClose" class="btn link">é—œé–‰</button>
      </div>
      <div id="cartList" class="cartList"></div>
      <div class="cartSum">
        <div>å°è¨ˆ</div>
        <div id="cartTotal">NT$ 0</div>
      </div>
      <!-- Coupon input widget -->
      <div class="cartCoupon" style="display:grid;gap:8px;margin:8px 0 0">
        <label for="cartCouponInput" style="font-size:12px;color:#6b7280">å„ªæƒ ç¢¼</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="cartCouponInput" type="text" inputmode="latin" placeholder="è«‹è¼¸å…¥å„ªæƒ ç¢¼"
                 style="flex:1 1 auto;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
          <button id="cartApply" class="btn" style="flex:0 0 auto">å¥—ç”¨</button>
        </div>
        <div id="cartCouponHint" style="display:none;font-size:12px;color:#6b7280;line-height:1.6"></div>
      </div>

      <!-- Discount row (hidden until a valid coupon is applied) -->
      <div class="cartSum cartDiscount" style="display:none;margin-top:6px">
        <div>æŠ˜æ‰£</div>
        <div id="cartOff">-NT$ 0</div>
      </div>

      <!-- Grand total -->
      <div class="cartSum">
        <div style="font-weight:800">æ‡‰ä»˜é‡‘é¡</div>
        <div id="cartGrandTotal" style="font-weight:800">NT$ 0</div>
      </div>
      <div class="cartActions">
        <button id="cartClear" class="btn">æ¸…ç©º</button>
        <a id="cartGo711" class="btn primary" target="_blank" rel="noopener">è½‰å¸³åŒ¯æ¬¾</a>
      </div>
    </div>
  </dialog>
<div id="toast" style="position:fixed;right:16px;bottom:16px;z-index:1000;display:none;max-width:92vw"></div>


<script id="cats-inline">
(function(){
  const CATS = ["ä½›ç‰Œ/è–ç‰©","è Ÿç‡­åŠ æŒç¥ˆç¦","è·‘å»Ÿè¡Œç¨‹","å…¶ä»–"];
  let selectedCat = "ä½›ç‰Œ/è–ç‰©";

  function normalizeCat(cat){
    if (!cat) return "";
    // æ¥å—å¾Œå°ç›´æ¥å¡«å››ç¨®åˆ†é¡åç¨±ï¼ˆå®Œå…¨æ¯”å°ï¼‰
    if (CATS.includes(cat)) return cat;
    return "";
  }

  function classify(p){
    // åƒ…ä½¿ç”¨å¾Œå°æ­£å¼åˆ†é¡ï¼›æœªæä¾›æ™‚é è¨­ç‚ºã€Œä½›ç‰Œ/è–ç‰©ã€
    const explicit = normalizeCat(p && p.category);
    return explicit || "ä½›ç‰Œ/è–ç‰©";
  }

  function buildCats(){
    const side = document.getElementById('sideDeities');
    if(!side || side.querySelector('.cats')) return;
    const box = document.createElement('div');
    box.className = 'cats';
    box.innerHTML = '<h4>å•†å“åˆ†é¡</h4><div class="list"></div>';
    const list = box.querySelector('.list');
    CATS.forEach(cat=>{
      const b = document.createElement('button');
      b.textContent = cat; b.dataset.cat = cat;
      if(cat===selectedCat) b.classList.add('active');
      b.addEventListener('click', ()=>{
        if (selectedCat === cat) {
          selectedCat = null;
        } else {
          selectedCat = cat;
        }
        [...list.children].forEach(x=> x.classList.toggle('active', x===b));
        // å°‡é¸æ“‡çš„åˆ†é¡å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œç„¶å¾Œå‘¼å« main.js çš„ applyFilter
        window.__currentCategoryFilter = selectedCat;
        if(typeof applyFilter === 'function') applyFilter();
      });
      list.appendChild(b);
    });
    side.appendChild(box);
  }

  document.addEventListener('DOMContentLoaded', buildCats);
})();
</script>

<script id="line-support-link">
(function(){
  function addLineSupportLink(){
    var side = document.getElementById('sideDeities');
    if (!side) return;
    // avoid duplicates if script runs multiple times
    if (document.getElementById('lineSupportLink')) return;
    var a = document.createElement('a');
    a.id = 'lineSupportLink';
    a.href = 'https://line.me/R/ti/p/@427oaemj';
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.className = 'side-link line-support-btn';
    a.textContent = 'ğŸ’¬ å®˜æ–¹LINEå®¢æœ';
    // place the link at the end of the sidebar container
    side.appendChild(a);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', addLineSupportLink);
  }else{
    addLineSupportLink();
  }
})();
</script>
</script>)

<script id="quiz-side-link">
(function(){
  function addQuizSideLink(){
    var side = document.getElementById('sideDeities');
    if (!side) return;
    if (document.getElementById('quizSideLink')) return; // avoid duplicate
    var a = document.createElement('a');
    a.id = 'quizSideLink';
    a.href = '/quiz/';
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.className = 'side-link quiz-link-btn';
    a.textContent = 'ğŸ”® æ¸¬é©—èˆ‡æ‚¨æœ‰ç·£çš„å®ˆè­·ç¥';
    side.appendChild(a);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', addQuizSideLink);
  } else {
    addQuizSideLink();
  }
})();
</script>


  <!-- é–€å¸‚é¸æ“‡ Dialogï¼ˆæ–°ï¼‰ -->
  <dialog id="dlgStore" style="border:none;border-radius:16px;padding:0;max-width:520px;width:92%;">
    <div style="padding:16px 18px 0;display:flex;gap:8px;font-size:12px;font-weight:600;">
      <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #e5e7eb;color:#6b7280;">1 ç¢ºèªè¨‚å–®</div>
      <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #16a34a;color:#16a34a;">2 é¸æ“‡é–€å¸‚</div>
      <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #e5e7eb;color:#6b7280;">3 åŒ¯æ¬¾è³‡æ–™</div>
    </div>
    <div style="padding:18px 18px 10px;">
      <div style="font-weight:800;font-size:18px;">é¸æ“‡å–è²¨é–€å¸‚</div>
      <div style="color:#6b7280;font-size:14px;margin-top:4px">
        è«‹å…ˆé¸æ“‡ 7-11 å–è²¨é–€å¸‚ï¼Œå†é€²å…¥åŒ¯æ¬¾è³‡è¨Šé é¢
      </div>
      <div style="color:#ef4444;font-size:12px;margin-top:2px">
        è‹¥æ˜¯è³¼è²·æœå‹™æ€§å•†å“ï¼ˆä¾‹å¦‚è Ÿç‡­ç¥ˆç¦ç­‰ï¼‰ï¼Œå¯è·³éæ­¤æ­¥é©Ÿï¼Œä¸éœ€å¡«å¯«é–€å¸‚è³‡è¨Š
      </div>
    </div>
    <div style="padding:0 18px 16px;display:grid;gap:10px">
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">å–è²¨é–€å¸‚</label>
        <input id="dlgStoreInput" type="text"
               placeholder="å°šæœªé¸æ“‡é–€å¸‚"
               style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background-color:#f9fafb;">
        <div style="font-size:12px;color:#6b7280;line-height:1.6">
          è«‹é»é¸ä¸‹æ–¹ã€ŒæŸ¥è©¢ 7-11 é–€å¸‚ã€æŒ‰éˆ•ï¼Œæ–¼åœ°åœ–ä¸­é¸æ“‡é–€å¸‚å¾Œï¼Œé€™è£¡èˆ‡åŒ¯æ¬¾è³‡æ–™é é¢æœƒè‡ªå‹•å¸¶å…¥ç›¸åŒé–€å¸‚
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px">
        <button type="button" id="storeOpenCvsBtn" class="btn link" style="flex:1 1 auto">æŸ¥è©¢ 7-11 é–€å¸‚</button>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button type="button" id="storeBackBtn" class="btn">è¿”å›ä¸Šä¸€é </button>
        <button type="button" id="storeNextBtn" class="btn primary">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«åŒ¯æ¬¾è³‡è¨Š</button>
      </div>
    </div>
  </dialog>

  <!-- è½‰å¸³åŒ¯æ¬¾ Dialog -->
  <dialog id="dlgBank" style="border:none;border-radius:16px;padding:0;max-width:680px;width:96%;">
  <div style="padding:16px 18px 0;display:flex;gap:8px;font-size:12px;font-weight:600;">
    <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #e5e7eb;color:#6b7280;">1 ç¢ºèªè¨‚å–®</div>
    <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #e5e7eb;color:#6b7280;">2 é¸æ“‡é–€å¸‚</div>
    <div style="flex:1;text-align:center;padding:6px 0;border-bottom:2px solid #16a34a;color:#16a34a;">3 åŒ¯æ¬¾è³‡æ–™</div>
  </div>
  <div style="padding:18px 18px 10px;">
    <div style="font-weight:800;font-size:18px;">è½‰å¸³åŒ¯æ¬¾è³‡è¨Š</div>
    <div style="color:#6b7280;font-size:14px;margin-top:4px">è«‹å…ˆå®ŒæˆåŒ¯æ¬¾ï¼Œå†ä¸Šå‚³åŒ¯æ¬¾æ†‘è­‰ä¸¦å¡«å¯«è³‡æ–™ã€‚</div>
  </div>
  <div style="padding:0 18px 16px;display:grid;gap:10px;">
    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
      <div class="bankHeader">
        <div class="bankTitle" id="bankBankVal">ä¸­åœ‹ä¿¡è¨— (822)</div>
        <button id="bankCopyAll" class="btn" style="padding:6px 10px;border-radius:8px">è¤‡è£½å…¨éƒ¨</button>
      </div>
      <div class="bankInfoGrid">
        <div class="label">å¸³è™Ÿ</div><div class="value" id="bankNoVal">148540417073</div>
      </div>
    </div>

    <form id="bankForm" enctype="multipart/form-data" style="display:grid;gap:10px">
      <div id="bfCouponBackHint" style="font-size:12px;color:#6b7280;line-height:1.6;margin-top:4px">
        è‹¥æ¬²ä½¿ç”¨å„ªæƒ åˆ¸ï¼Œè«‹è¿”å›ä¸Šä¸€é è¼¸å…¥å„ªæƒ åˆ¸ä¸¦å¥—ç”¨ã€‚
      </div>
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">æ”¶ä»¶äººå§“å</label>
        <input id="bfName" name="name" required type="text" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººå§“å">
      </div>
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">æ‰‹æ©Ÿè™Ÿç¢¼</label>
        <input id="bfContact" name="phone" type="tel" placeholder="ä¾‹ï¼š0969123456" pattern="^09\d{8}$" inputmode="tel" title="è«‹è¼¸å…¥æœ‰æ•ˆæ‰‹æ©Ÿè™Ÿç¢¼" required>
      </div>
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">é›»å­éƒµä»¶</label>
        <input id="bfEmail" name="email" type="email" placeholder="name@example.com" inputmode="email" autocomplete="email">
      </div>
      <div class="bank-field" style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">æ”¶ä»¶ 7-11 é–€å¸‚ï¼ˆè‹¥éå¯¦é«”å¯„é€å•†å“ï¼Œè«‹å¡«å¯«ã€Œç„¡ã€ï¼‰</label>
        <input id="bfStore" name="store" type="text" placeholder="å°šæœªé¸æ“‡é–€å¸‚" readonly>
        <div style="margin-top:4px;font-size:12px;color:#555">è‹¥éœ€ä¿®æ”¹é–€å¸‚ï¼Œè«‹è¿”å›ä¸Šä¸€æ­¥</div>
        <button type="button" id="bfBackToStoreBtn" class="btn link" style="margin-top:4px;max-width:180px;justify-self:flex-start">è¿”å›ä¸Šä¸€é ä¿®æ”¹é–€å¸‚</button>
      </div>
      <div class="bank-field" style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">åŒ¯æ¬¾é‡‘é¡ï¼ˆNT$ï¼‰</label>
        <input id="bfAmount" name="amount" type="number" min="1" required>
        <div id="bfAmtHint" style="font-size:12px;color:#6b7280">ç³»çµ±è‡ªå‹•å¸¶å…¥é‡‘é¡ï¼Œç„¡éœ€ä¿®æ”¹</div>
      </div>
      <div class="bank-field" style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">åŒ¯æ¬¾æœ«äº”ç¢¼</label>
        <input id="bfLast5" name="last5" pattern="\d{5}" placeholder="12345" required>
      </div>
      <div class="bank-field" style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">ä¸Šå‚³åŒ¯æ¬¾æ†‘è­‰ï¼ˆç…§ç‰‡æˆ–æˆªåœ–ï¼‰</label>
        <input id="bfFile" name="receipt" type="file" accept="image/*,application/pdf" required>
      </div>
      <div id="bfRitualBlock" class="bank-field" style="display:none;gap:6px">
        <label style="font-size:12px;color:#6b7280">ä¸Šå‚³æ‚¨çš„ç…§ç‰‡ï¼ˆç”¨æ–¼ç¥ˆç¦å„€å¼ï¼‰</label>
        <input id="bfRitualPhoto" name="ritual_photo" type="file" accept="image/*">
      </div>
      <div id="bfCandleTip" style="display:none;font-size:12px;color:#ef4444;line-height:1.6">
        ğŸ”¥ è‹¥æ‚¨è³¼è²·è Ÿç‡­ç¥ˆç¦ï¼Œè«‹æ–¼å‚™è¨»æ¬„è¼¸å…¥æ‚¨çš„è‹±æ–‡åå­—èˆ‡è¥¿å…ƒç”Ÿæ—¥ã€‚
      </div>
      <div class="bank-field" style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
        <textarea id="bfNote" name="note" placeholder="æƒ³è£œå……çš„è³‡æ–™ï¼ˆå¦‚ï¼šè¨‚è³¼äººå§“åã€åœ°å€ã€å•†å“è¦æ ¼ï¼‰"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button type="button" id="bfCancel" class="btn">å–æ¶ˆ</button>
        <button type="submit" id="bfSubmit" class="btn primary">é€å‡ºåŒ¯æ¬¾è³‡è¨Š</button>
      </div>
    </form>
    <div id="bfHint" style="font-size:12px;color:#6b7280;line-height:1.6">
      é€å‡ºåŒ¯æ¬¾è³‡è¨Šå¾Œè«‹ç­‰å¾…5è‡³10ç§’æ‰æœƒè·³å‡ºé€å‡ºæˆåŠŸï¼Œæœ‰æ™‚å€™å› åœ–ç‰‡æª”æ¡ˆè¼ƒå¤§è¦ä¸Šå‚³è¼ƒä¹…ï¼Œè«‹å‹¿é‡è¤‡é»ã€Œé€å‡ºåŒ¯æ¬¾è³‡è¨Šã€æŒ‰éˆ•ã€‚å¦å¤–é€å‡ºå¾Œå¯è‡³å·¦é‚Šé€£çµæŸ¥è©¢è¨‚å–®ç‹€æ…‹ï¼Œç¢ºèªè¨‚å–®æ˜¯å¦æˆåŠŸå»ºç«‹ã€‚
    </div>
  </div>
</dialog>


<script id="storeFillOverride">
// çµ±ä¸€è™•ç† 7-11 é–€å¸‚å›å¡«ï¼šåŒæ™‚å¯«å…¥ã€Œé¸æ“‡é–€å¸‚ã€æ­¥é©Ÿèˆ‡åŒ¯æ¬¾è¡¨å–®
// ä¸¦æ”¯æ´æ–°å¾Œç«¯å‚³å…¥çš„æ¬„ä½åç¨±ï¼ˆstorename/storeid/storeaddress/storetelï¼‰
// ä»¥åŠèˆŠç‰ˆ 7-11 ç‰©ä»¶æ¬„ä½ï¼ˆstName/storeNameã€stCode/codeã€stAddr/storeAddr...ï¼‰
function fillStoreIntoForm(p){
  if (!p) return false;

  // 1) æ­£è¦åŒ–æ¬„ä½åç¨±
  var name = '';
  var id   = '';
  var addr = '';
  var tel  = '';

  try{
    name = (p.storename || p.storeName || p.stName || '').toString().trim();
  }catch(e){ name = ''; }
  try{
    id   = (p.storeid   || p.storeId   || p.stCode || p.code || '').toString().trim();
  }catch(e){ id = ''; }
  try{
    addr = (p.storeaddress || p.storeAddr || p.stAddr || '').toString().trim();
  }catch(e){ addr = ''; }
  try{
    tel  = (p.storetel || p.storeTel || p.stTel || '').toString().trim();
  }catch(e){ tel = ''; }

  // 2) é¡¯ç¤ºç”¨æ–‡å­—ï¼šå„ªå…ˆã€Œé–€å¸‚åç¨± + (é–€å¸‚ä»£è™Ÿ)ã€ï¼Œæ²’æœ‰ä»£è™Ÿå†é€€è€Œæ±‚å…¶æ¬¡
  var text = '';
  if (name && id){
    text = name + ' (' + id + ')';
  } else if (name){
    text = name;
  } else if (addr){
    text = addr;
  } else if (id){
    text = id;
  }

  if (!text) return false;

  // 3) Step 2 é è¦½æ¬„ä½ï¼ˆé¸æ“‡é–€å¸‚å°è©±æ¡†ï¼‰
  var preview = document.getElementById('dlgStoreInput');
  if (preview){
    preview.value = text;
  }

  // 4) Step 3 åŒ¯æ¬¾è¡¨å–®æ¬„ä½ï¼ˆæ”¶ä»¶ 7-11 é–€å¸‚ï¼‰ï¼‹ data-* å±¬æ€§ï¼ˆçµ¦å¾Œç«¯ç”¨ï¼‰
  var bank = document.getElementById('bfStore');
  if (bank){
    bank.value = text;
    // å°‡åŸå§‹è³‡è¨Šå¡é€² data-*ï¼Œæ–¹ä¾¿åŒ¯æ¬¾é€å–®æ™‚é™„å¸¶çµ¦å¾Œç«¯
    bank.setAttribute('data-storeid',      id   || '');
    bank.setAttribute('data-storename',    name || '');
    bank.setAttribute('data-storeaddress', addr || '');
    bank.setAttribute('data-storetel',     tel  || '');
  }

  return true;
}
</script>
<script id="candleExtrasFormal">
function needCandleExtras(){
  // Simplified flow: no extra required fields; use å‚™è¨» + é¡å¤–ç…§ç‰‡
  return false;
}
function ensureCandleFields(required){
  // Keep legacy extra block hidden, but allow ritual photo block to be controlled by toggleCandleUI()
  var legacy = document.getElementById('candleExtra');
  if (legacy) legacy.style.display = 'none';
  // Do not touch bfRitualPhoto requirements (not required by default)
  var nameEn = document.getElementById('bfNameEn');
  var bday  = document.getElementById('bfBirthday');
  var photo = document.getElementById('bfPhoto');
  if (nameEn) nameEn.required = false;
  if (bday)  bday.required = false;
  if (photo) photo.required = false;
}
</script>

<script>
(function(){
  const BANK = { bank: 'ä¸­åœ‹ä¿¡è¨— (822)', no: '148540417073' };

  // Rich success panel (uses #toast) with "æŸ¥è©¢è¨‚å–®ç‹€æ…‹" action
  window.showOrderSuccessPanel = function(phone, last5){
    try{
      var host = document.getElementById('toast');
      if (!host) return;
      var html = ''
        + '<div id="toastCard" style="background:#111827;color:#e5e7eb;border:1px solid rgba(255,255,255,.06);'
        + 'padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);min-width:260px;max-width:380px">'
        + '<div style="font-weight:800;margin-bottom:6px;font-size:14px">é€å‡ºæˆåŠŸ</div>'
        + '<div style="font-size:13px;line-height:1.5;color:#cbd5e1">'
        + 'å·²æ”¶åˆ°ä½ çš„åŒ¯æ¬¾è³‡è¨Šã€‚åœ–ç‰‡è¼ƒå¤§æ™‚ä¸Šå‚³éœ€æ•¸ç§’ï¼Œè«‹å‹¿é‡è¤‡é»æ“Šã€‚ä½ ä¹Ÿå¯ä»¥ç«‹å³æŸ¥çœ‹è¨‚å–®è™•ç†é€²åº¦èˆ‡ç¥ˆç¦æˆæœã€‚'
        + '</div>'
        + '<div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">'
        +   '<button id="toastClose" class="btn" style="padding:6px 10px;border-radius:8px;font-size:13px;background:#374151;color:#fff;border:1px solid rgba(255,255,255,.08)">ç¨å¾Œ</button>'
        +   '<button id="toastLookup" class="btn" style="padding:6px 10px;border-radius:8px;font-size:13px;background:#10b981;color:#062a1a;border:1px solid rgba(0,0,0,.06)">ç«‹å³æŸ¥è©¢</button>'
        + '</div>'
        + '</div>';
      host.innerHTML = html;
      host.style.display = '';
      // wire buttons
      var closeBtn = document.getElementById('toastClose');
      var goBtn = document.getElementById('toastLookup');
      if (closeBtn){ closeBtn.onclick = function(){ host.style.display='none'; }; }
      if (goBtn){
        goBtn.onclick = function(){
          host.style.display = 'none';
          if (typeof window.openOrderLookup === 'function'){
            window.openOrderLookup(phone||'', (String(last5||'').replace(/\D+/g,'').slice(-5)));
          }
        };
      }
      // auto-hide after 10s (if not interacted)
      setTimeout(function(){ try{ if (host && host.style.display !== 'none') host.style.display='none'; }catch(e){} }, 10000);
    }catch(e){}
  };

  function copyAll(){
    const text = `éŠ€è¡Œï¼š${BANK.bank}\nå¸³è™Ÿï¼š${BANK.no}`;
    try{ navigator.clipboard.writeText(text); }catch(e){
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    }
    alert('å·²è¤‡è£½åŒ¯æ¬¾è³‡è¨Š');
  }

  window.openBankDialog = function(from){
    window.__checkoutSource = (from === 'cart') ? 'cart' : 'direct';
    try{
      const dlg = document.getElementById('dlgBank');
      if(!dlg) return alert('ç„¡æ³•é¡¯ç¤ºåŒ¯æ¬¾è¦–çª—');
      // å¡«å…¥å±•ç¤ºè³‡è¨Š
      const bankEl = document.getElementById('bankBankVal');
      const noEl   = document.getElementById('bankNoVal');
      if (bankEl) bankEl.textContent = BANK.bank;
      if (noEl)   noEl.textContent   = BANK.no;
      // æ¸…è¡¨å–®
      const f = document.getElementById('bankForm');
      if (f) f.reset();
      // åŒæ­¥ 7-11 é–€å¸‚è³‡è¨Šåˆ°åŒ¯æ¬¾è¦–çª—ï¼ˆè‹¥å·²åœ¨å‰ä¸€æ­¥é¸å¥½ï¼‰
      try{
        var storeFromDlg = document.getElementById('dlgStoreInput');
        var storeField   = document.getElementById('bfStore');
        // åªåŒæ­¥æ¬„ä½å€¼ï¼Œä¸ç”¢ç”Ÿä»»ä½•é¡å¤–ã€ŒæŸ¥è©¢é–€å¸‚ã€æŒ‰éˆ•
        if (storeFromDlg || storeField){
          var vDlg  = (storeFromDlg && storeFromDlg.value || '').trim();
          var vBank = (storeField   && storeField.value   || '').trim();
          if (vDlg && vBank){
            if (storeField && storeField.value !== vDlg){
              storeField.value = vDlg;
            }
            if (storeFromDlg && storeFromDlg.value !== vDlg){
              storeFromDlg.value = vDlg;
            }
          } else if (vDlg && !vBank){
            if (storeField){ storeField.value = vDlg; }
          } else if (!vDlg && vBank){
            if (storeFromDlg){ storeFromDlg.value = vBank; }
          }
        }
      }catch(e){}
      // If opened from product detail, capture the current detail as a pending item
      try{
        if (from !== 'cart'){
          var nameEl = document.getElementById('dlgTitle');
          var selEl  = document.getElementById('dlgVariant');
          var qtyEl  = document.getElementById('dlgQty');
          var priceNode = document.getElementById('dlgPrice');
          var pName = (nameEl && nameEl.textContent || '').trim();
          var spec  = (selEl && selEl.options && selEl.selectedIndex>=0) ? (selEl.options[selEl.selectedIndex].textContent||'').trim() : '';
          if (spec) spec = spec.replace(/ï¼ˆ\+[^ï¼‰]*ï¼‰/g,'').trim();
          var qty   = qtyEl ? Math.max(1, Number(qtyEl.value||1)) : 1;
          var total = 0;
          if (priceNode){
            var dp = Number(priceNode.getAttribute('data-price')||0);
            if (!dp){
              var txt = (priceNode.textContent||'').replace(/[ ,\s]/g,'');
              dp = Number(txt)||0;
            }
            total = dp;
          }
          var unit  = qty ? (total/qty) : total;
          var dlgEl = document.getElementById('dlg');
          var cat   = dlgEl && dlgEl.getAttribute('data-product-cat');
          var looks = /è Ÿç‡­/.test(pName);
          var pid   = dlgEl && dlgEl.getAttribute('data-product-id'); // ensure product id is captured
          var pending = pName ? {
            id: pid || '',                 // for cart compatibility
            productId: pid || '',          // explicit for backend fallback
            name: pName,
            productName: pName,
            variantName: spec || '',
            qty: Number(qty||1),
            price: Number(unit||0),
            category: (cat === 'è Ÿç‡­åŠ æŒç¥ˆç¦' || looks) ? 'è Ÿç‡­åŠ æŒç¥ˆç¦' : (cat || 'ä½›ç‰Œ/è–ç‰©')
          } : null;
          // --- deity detection ---
          // try to capture deity code from dialog dataset or name keywords
          var deityCode = '';
          if (dlgEl){
            deityCode = (dlgEl.getAttribute('data-product-deity') || dlgEl.getAttribute('data-deity') || '').toUpperCase();
          }
          if (!deityCode && pName){
            var nm = pName.replace(/\s+/g,'').toUpperCase();
            // keyword â†’ code map
            if (/å››é¢ç¥|BRAHMA|PHRA PHROM|PHROM|ERAWAN/.test(pName)) deityCode = 'FM';
            else if (/è±¡ç¥|GANESHA|PHIKANET|PHIKANES|PIKANES/.test(pName)) deityCode = 'GA';
            else if (/å´‡è¿ª|SOMDEJ|SOMDEJ|SOMDET/.test(pName)) deityCode = 'CD';
            else if (/å¤å¹³|KHUNPHAEN|KHUN PAEN|K\.P\.|KP/.test(pName)) deityCode = 'KP';
            else if (/å“ˆé­¯æ›¼|H(AN|AR)UMAN|HANUMAN/.test(pName)) deityCode = 'HM';
            else if (/æ‹‰èƒ¡|RAHU/.test(pName)) deityCode = 'RH';
            else if (/è¿¦æ¨“ç¾…|GARUDA|K(AR|AL)UDA/.test(pName)) deityCode = 'JL';
            else if (/æ¾¤åº¦é‡‘|JATUKAM|R(AM|A)MATHEP|ZEDOGON|ZEDUKIN/.test(pName)) deityCode = 'ZD';
            else if (/æ‹›è²¡å¥³ç¥|L(AX|AK)SHMI|LAKSHMI|LAMSI|ZF/.test(pName)) deityCode = 'ZF';
            else if (/äº”çœ¼å››è€³|FIVE[-\s]*EYES|5EYES|WE/.test(pName)) deityCode = 'WE';
            else if (/å¾ç¥|XUZHU|XU ZHU|XZ/.test(pName)) deityCode = 'XZ';
            else if (/é­‚é­„å‹‡|HPY|HUN PO YONG/.test(pName)) deityCode = 'HP';
          }
          if (deityCode) pending.deity = deityCode;
          // --- end deity detection ---
          if (pending){
            pending.deity = deityCodeOf(pending.deity || pending.name || '');
            sessionStorage.setItem('__pendingDetail__', JSON.stringify(pending));
          }
        }
      }catch(e){}
      // è‡ªå‹•å¸¶å…¥é‡‘é¡ï¼šè³¼ç‰©è»Šåˆè¨ˆå„ªå…ˆï¼Œå¦å‰‡è©³æƒ…åƒ¹
      let amount = 0;
      try{
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        if (Array.isArray(cart) && cart.length){
          amount = cart.reduce((s,it)=> s + Number(it.price||0)*Math.max(1, Number(it.qty||1)), 0);
        }
      }catch{}
      if (!amount){
        try{
          const priceNode = document.getElementById('dlgPrice');
          const p = priceNode ? Number(priceNode.getAttribute('data-price')||0) : 0;
          if (p>0) amount = p;
        }catch{}
      }
      // apply active coupon (fixed NT$200) only if deity matches any item
      function readCart(){ try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch(e){ return []; } }
      function getActiveCoupon(){
        try{ if (window.__coupon && typeof window.__coupon.getActiveCoupon==='function') return window.__coupon.getActiveCoupon(); }catch(e){}
        try{ var raw = localStorage.getItem('__activeCoupon__'); if (raw) return JSON.parse(raw); }catch(e){}
        return null;
      }
      // Normalize any deity input (2-letter code or Chinese/English name) â†’ 2-letter code
      function deityCodeOf(input){
        try{
          var s = (input||'').toString().trim();
          if (!s) return '';
          // already a 2-letter code
          if (/^[A-Z]{2}$/.test(s)) return s.toUpperCase();

          var raw = s.toUpperCase();
          // Chinese/English keyword matching (same rules as pending detection)
          if (/å››é¢ç¥|BRAHMA|PHRA\s*PHROM|PHROM|ERAWAN/i.test(s)) return 'FM';
          if (/è±¡ç¥|GANESHA|PHIKANET|PHIKANES|PIKANES/i.test(s))   return 'GA';
          if (/å´‡è¿ª|SOMDEJ|SOMDET/i.test(s))                      return 'CD';
          if (/å¤å¹³|KHUN\s*PHAEN|KHUN\s*PAEN|K\.?P\.?/i.test(s))  return 'KP';
          if (/å“ˆé­¯æ›¼|H(AN|AR)UMAN/i.test(s))                     return 'HM';
          if (/æ‹‰èƒ¡|RAHU/i.test(s))                                return 'RH';
          if (/è¿¦æ¨“ç¾…|GARUDA|K(AR|AL)UDA/i.test(s))               return 'JL';
          if (/æ¾¤åº¦é‡‘|JATUKAM|R(AM|A)MATHEP|ZEDO(G|K)ON|ZEDUKIN/i.test(s)) return 'ZD';
          if (/æ‹›è²¡å¥³ç¥|LAKSHMI|LAXSHMI|LAMSI/i.test(s))          return 'ZF';
          if (/äº”çœ¼å››è€³|FIVE[\-\s]*EYES|5EYES|FIVEEYES/i.test(s)) return 'WE';
          if (/å¾ç¥|XU\s*ZHU|XUZHU/i.test(s))                     return 'XZ';
          if (/é­‚é­„å‹‡|HUN\s*PO\s*YONG|HPY/i.test(s))              return 'HP';

          return raw.length === 2 ? raw : raw; // fallback: return uppercased raw
        }catch(e){ return ''; }
      }

      function sumEligible(items, deity){
        if (!deity) return 0;
        var want = deityCodeOf(deity);
        if (!want) return 0;
        try{
          return items.reduce(function(s,it){
            var itemCode = deityCodeOf( (it && (it.deity || it.name || it.title || it.productName)) || '' );
            var ok = (itemCode && itemCode === want);
            return s + (ok ? Number(it.price||0)*Math.max(1, Number(it.qty||1)) : 0);
          }, 0);
        }catch(e){ return 0; }
      }
      var coupon = getActiveCoupon();
      var off = 0;
      if (coupon && coupon.code){
        // build a combined items list = cart + pending detail
        var items = readCart().slice();
        try{
          var _pend = JSON.parse(sessionStorage.getItem('__pendingDetail__')||'null');
          if (_pend) items.push(_pend);
        }catch(_){}
        var elig = sumEligible(items, coupon.deity);
        if (elig > 0){ off = Number(coupon.amount||200) || 200; }
      }
      var grand = Math.max(0, Math.round(amount - off));
      const amtEl = document.getElementById('bfAmount');
      if (amtEl) amtEl.value = grand;
      // show small line under amount to indicate coupon state
      (function(){
        var hint = document.getElementById('bfAmtHint');
        if (!hint) return;
        if (off > 0){
          hint.textContent = 'å·²å¥—ç”¨å„ªæƒ ç¢¼ '+ (coupon && coupon.code || '') +' æŠ˜æŠµ NT$' + (Number(coupon.amount||200)||200);
          hint.style.color = '#059669';
        }else{
          hint.textContent = 'ç³»çµ±è‡ªå‹•å¸¶å…¥é‡‘é¡ï¼Œç„¡éœ€ä¿®æ”¹';
          hint.style.color = '#6b7280';
        }
      })();
      // Candle extras based on formal category
      try{ var need = needCandleExtras(); ensureCandleFields(need); }catch(_){ }
      // Ensure toggleCandleUI runs after order state is set (only one copy)
      try{ if (typeof toggleCandleUI === 'function') toggleCandleUI(); }catch(e){}
      // é—œé–‰å…¶ä»–å·²é–‹å•Ÿçš„ dialogï¼Œé¿å… showModal å¤±æ•—
      try{ document.querySelectorAll('dialog[open]').forEach(d=>{ if(d!==dlg) d.close(); }); }catch{}
      // é¡¯ç¤º Dialog
      if (typeof dlg.showModal === 'function') dlg.showModal();
      else alert('è«‹ä½¿ç”¨æ”¯æ´å°è©±æ¡†çš„ç€è¦½å™¨');

      // ç§»é™¤åŒ¯æ¬¾é æœ€ä¸‹æ–¹ã€Œæ–‡å­—ç‰ˆè³¼ç‰©è»Šæ‘˜è¦ã€å€å¡Šï¼ˆæœ¬æ¬¡åŒ¯æ¬¾é‡‘é¡åŒ…å«ä»¥ä¸‹è³¼ç‰©è»Šå•†å“ï¼š...ï¼‰
      // åªåˆªæ‰ç´”æ–‡å­—æ‘˜è¦ï¼Œä¸ç¢°ä¸Šæ–¹åœ–ç‰‡ç‰ˆè¨‚å–®ç¢ºèªè¡¨æ ¼
      try{
        var dlgRoot = document.getElementById('dlgBank');
        if (dlgRoot){
          var blocks = dlgRoot.querySelectorAll('div,section');
          blocks.forEach(function(node){
            var txt = (node.textContent || '').replace(/\s+/g,'');
            if (txt.indexOf('æœ¬æ¬¡åŒ¯æ¬¾é‡‘é¡åŒ…å«ä»¥ä¸‹è³¼ç‰©è»Šå•†å“ï¼š') === 0){
              node.remove();
            }
          });
        }
      }catch(e){}

    }catch(e){ console.error(e); alert('é–‹å•ŸåŒ¯æ¬¾è¦–çª—å¤±æ•—'); }
  };

  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'bankCopyAll'){ e.preventDefault(); copyAll(); }
    if (e.target && e.target.id === 'bfCancel'){ e.preventDefault(); const d=document.getElementById('dlgBank'); if(d) d.close(); }
  });

  const form = document.getElementById('bankForm');
  if (form){
    // åŒ¯æ¬¾æ†‘è­‰å¤§å°é™åˆ¶
    try{
      var rec = document.getElementById('bfFile');
      if (rec){
        rec.addEventListener('change', function(){
          try{
            var f = rec.files && rec.files[0];
            if (f && f.size > 20 * 1024 * 1024){
              alert('åŒ¯æ¬¾æ†‘è­‰æª”æ¡ˆéå¤§ï¼ˆä¸Šé™ 20MBï¼‰');
              rec.value = '';
            }
          }catch(e){}
        });
      }
    }catch(e){}
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const dlg = document.getElementById('dlgBank');

      const submitBtn = document.getElementById('bfSubmit');
      let pendingOverlay = document.getElementById('orderPendingOverlay');
      let pendingText = document.getElementById('orderPendingText');
      if (!pendingOverlay) {
        pendingOverlay = document.createElement('div');
        pendingOverlay.id = 'orderPendingOverlay';
        pendingOverlay.style.position = 'fixed';
        pendingOverlay.style.inset = '0';
        pendingOverlay.style.zIndex = '9999';
        pendingOverlay.style.display = 'none';
        pendingOverlay.style.alignItems = 'center';
        pendingOverlay.style.justifyContent = 'center';
        pendingOverlay.style.background = 'rgba(15,23,42,0.45)';
        pendingOverlay.style.backdropFilter = 'blur(2px)';
        pendingOverlay.innerHTML = '<div id="orderPendingOverlayBox" style="display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:999px;background:#ffffff;box-shadow:0 10px 25px rgba(15,23,42,0.35);font-size:14px;color:#374151;"><div id="orderPendingSpinner" style="width:18px;height:18px;border-radius:999px;border:2px solid #e5e7eb;border-top-color:#4b5563;animation:orderPendingSpin 0.8s linear infinite;"></div><div id="orderPendingText">è¨‚å–®é€å‡ºä¸­ï¼Œè«‹ç¨å€™...</div></div>';
        (dlg || document.body).appendChild(pendingOverlay);
        if (!document.getElementById('orderPendingSpinStyle')) {
          const st = document.createElement('style');
          st.id = 'orderPendingSpinStyle';
          st.textContent = '@keyframes orderPendingSpin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}';
          document.head.appendChild(st);
        }
        pendingText = document.getElementById('orderPendingText');
      }

      if (pendingOverlay) {
        pendingOverlay.style.display = 'flex';
        if (pendingText) pendingText.textContent = 'è¨‚å–®é€å‡ºä¸­ï¼Œè«‹ç¨å€™...';
      }
      if (submitBtn) {
        submitBtn.disabled = true;
      }

      const fd = new FormData(form);
      // é™„åŠ  7-11 é–€å¸‚è³‡è¨Š
      try{
        var sEl = document.getElementById('bfStore');
        if (sEl){
          fd.set('store', (sEl.value||'').trim());
          fd.append('store_id', sEl.getAttribute('data-storeid')||'');
          fd.append('store_name', sEl.getAttribute('data-storename')||'');
          fd.append('store_address', sEl.getAttribute('data-storeaddress')||'');
          fd.append('store_tel', sEl.getAttribute('data-storetel')||'');
        }
      }catch(_){ }
      // ä¸å†å¼·åˆ¶æª¢æŸ¥è Ÿç‡­åŠ æŒé¡å¤–æ¬„ä½ï¼›æ”¹ä»¥å‚™è¨»ï¼‹å¯é¸ç…§ç‰‡
      try{ /* no-op */ }catch(_){ }
      try{
        // Merge: existing cart + pending detail (if any)
        var cart = [];
        try{ cart = JSON.parse(localStorage.getItem('cart')||'[]'); }catch(e){}
        if (!Array.isArray(cart)) cart = [];
        try{
          var pendRaw = sessionStorage.getItem('__pendingDetail__');
          var pend = pendRaw ? JSON.parse(pendRaw) : null;
          if (pend && typeof pend === 'object'){
            // è‹¥è³¼ç‰©è»Šæœ¬èº«å·²æœ‰å•†å“ï¼ˆå¾è³¼ç‰©è»ŠåŒ¯æ¬¾ï¼‰ï¼Œå°±ä¸è¦å†åŠ  pendingï¼Œé¿å…é‡è¤‡è¨ˆç®—
            if (!cart.length){
              cart.push(pend);
            }
          }
        }catch(e){}
        fd.set('cart', JSON.stringify(cart));
        fd.set('method', 'BANK_TRANSFER');
        if (Array.isArray(cart) && cart.length > 0) {
          fd.set('mode', 'cart');
          fd.set('useCart', '1');
        }

        // Fallback product identity for backend counters (when no cart or missing id)
        try{
          var pendRaw2 = sessionStorage.getItem('__pendingDetail__');
          var pend2 = pendRaw2 ? JSON.parse(pendRaw2) : null;
          var fpid = (pend2 && (pend2.productId || pend2.id)) || '';
          var fqty = (pend2 && Number(pend2.qty||1)) || '';
          if (fpid){ fd.set('productId', String(fpid)); }
          if (fqty){ fd.set('qty', String(fqty)); }
          if (pend2 && pend2.variantName){ fd.set('variantName', String(pend2.variantName)); }
        }catch(_){}

        // attach coupon info if present
        try{
          var c = (window.__coupon && window.__coupon.getActiveCoupon && window.__coupon.getActiveCoupon()) || null;
          if (c){ fd.set('coupon', String(c.code||'')); fd.set('coupon_deity', String(c.deity||'')); }
        }catch(e){}

        const res = await fetch('/api/payment/bank',  { method:'POST', body: fd });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json().catch(()=>({}));
        try{ sessionStorage.removeItem('__pendingDetail__'); }catch(e){}
        alert(data && data.ok ? 'âœ… å·²é€å‡ºåŒ¯æ¬¾è³‡è¨Šï¼Œæˆ‘å€‘å°‡ç›¡å¿«æ ¸å°ï¼' : 'âœ… å·²é€å‡ºï¼Œæ„Ÿè¬ï¼');
        if (dlg) dlg.close();
        // Show a rich success panel with an action button to open the lookup dialog (prefilled)
        try{
          var phoneVal = (document.getElementById('bfContact') && document.getElementById('bfContact').value) || '';
          var last5Val = (document.getElementById('bfLast5') && document.getElementById('bfLast5').value) || '';
          if (typeof window.showOrderSuccessPanel === 'function'){
            window.showOrderSuccessPanel(phoneVal, last5Val);
          }
        }catch(e){}

        // After success: clear cart and refresh product list to reflect updated "å·²å”®å‡º"
        try{ localStorage.removeItem('cart'); }catch(_){}
        try{ window.__coupon && window.__coupon.updateTotalsDisplay(); }catch(_){ }
        try{
          if (typeof loadProducts === 'function'){
            await loadProducts();
          }
          // also refresh the badge in the opened detail dialog if same product
          var dlgEl2 = document.getElementById('dlg');
          var pidNow = dlgEl2 && dlgEl2.getAttribute('data-product-id');
          if (pidNow && Array.isArray(window.rawItems)){
            var pNew = window.rawItems.find(function(x){ return String(x.id) === String(pidNow); });
            if (pNew){
              var chip = document.getElementById('dlgChip');
              if (chip) chip.textContent = 'å·²å”®å‡ºï¼š' + Number(pNew.sold||0);
            }
          }
        }catch(_){}
      }catch(err){
        console.error(err);
        try{
          const stash = JSON.parse(localStorage.getItem('bankSubmits')||'[]');
          const obj = {}; fd.forEach((v,k)=>{ if(k==='receipt'){ obj[k] = (v && v.name) || 'file'; } else obj[k]=v; });
          obj.ts = Date.now();
          stash.push(obj);
          localStorage.setItem('bankSubmits', JSON.stringify(stash));
        }catch{}
        try{ sessionStorage.removeItem('__pendingDetail__'); }catch(e){}
        alert('å·²é€å‡ºè¨‚å–®ï¼Œæ ¸å°åŒ¯æ¬¾è³‡è¨Šç„¡èª¤å¾Œæœƒç›¡å¿«å®‰æ’å‡ºè²¨ã€‚');
        if (dlg) dlg.close();
      }finally{
        if (pendingOverlay) {
          pendingOverlay.style.display = 'none';
        }
        if (submitBtn) {
          submitBtn.disabled = false;
        }
      }
    });
  }
})();
// ---- bank dialog coupon apply (for direct-buy path) ----
(function(){
  var BASE = 'https://coupon-service.kaiwei425.workers.dev';
  function getPendingDeity(){
    try{
      var p = JSON.parse(sessionStorage.getItem('__pendingDetail__')||'null');
      if (p && (p.deity || p.name)) return deityCodeOf(p.deity || p.name);
    }catch(_){}
    try{
      var dlg = document.getElementById('dlg');
      var d = (dlg && (dlg.getAttribute('data-product-deitycode') || dlg.getAttribute('data-product-deity') || dlg.getAttribute('data-deity') || dlg.getAttribute('data-product-name'))) || '';
      if (d) return deityCodeOf(d);
    }catch(_){}
    return '';
  }
  async function checkCoupon(code, deity){
    var url = BASE + '/check?code=' + encodeURIComponent(code) + (deity ? '&deity=' + encodeURIComponent(deity) : '');
    var r = await fetch(url, { method:'GET', mode:'cors', credentials:'omit', cache:'no-store' });
    var j = await r.json().catch(()=>({}));
    return j && j.ok ? j : { ok:false };
  }
  function setActiveCoupon(obj){
    try{
      // write to localStorage so other modules react (top bar/cart observers)
      localStorage.setItem('__activeCoupon__', JSON.stringify(obj||{}));
      // minimal window.__coupon shim
      window.__coupon = window.__coupon || {};
      window.__coupon.getActiveCoupon = function(){ try{ var raw=localStorage.getItem('__activeCoupon__'); return raw?JSON.parse(raw):null; }catch(e){ return null; } };
      window.__coupon.updateTotalsDisplay && window.__coupon.updateTotalsDisplay();
      // notify listeners
      window.dispatchEvent(new StorageEvent('storage', { key:'__activeCoupon__', newValue:JSON.stringify(obj||{}) }));
    }catch(e){}
  }
  function markHint(ok, text){
    var hint = document.getElementById('bfCouponHint');
    if (!hint) return;
    hint.style.display = '';
    hint.textContent = text || (ok ? 'å·²å¥—ç”¨å„ªæƒ ç¢¼' : 'å„ªæƒ ç¢¼ç„¡æ•ˆæˆ–ä¸é©ç”¨');
    hint.style.color = ok ? '#059669' : '#ef4444';
  }
  function recalcAmount(){
    try{
      var amtEl = document.getElementById('bfAmount');
      var aHint = document.getElementById('bfAmtHint');

      // 1) Collect current items exactly like the order-summary does:
      var items = [];
      // 1a) cart (unless checkoutSource === 'direct')
      try{
        var src = (typeof window !== 'undefined' && window.__checkoutSource) ? String(window.__checkoutSource) : '';
        if (src !== 'direct'){
          var cart = JSON.parse(localStorage.getItem('cart')||'[]');
          if (Array.isArray(cart) && cart.length){
            items = cart.map(function(it){
              return {
                name:  (it && (it.name||it.title)) || 'å•†å“',
                spec:  (it && (it.variantName||'')) || '',
                qty:   Math.max(1, Number((it && it.qty) || 1)),
                price: Number((it && it.price) || 0),
                deity: (it && it.deity) || ''
              };
            });
          }
        }
      }catch(_){}
      // 1b) pending detail (direct-buy path)
      try{
        var pendRaw = sessionStorage.getItem('__pendingDetail__');
        var pend = pendRaw ? JSON.parse(pendRaw) : null;
        if (pend && (pend.name || pend.productName)){
          items.push({
            name:  pend.name || pend.productName || 'å•†å“',
            spec:  pend.variantName || '',
            qty:   Math.max(1, Number(pend.qty||1)),
            price: Number(pend.price||0),
            deity: (pend.deity||'')
          });
        }
      }catch(_){}

      // 2) Subtotal
      var amount = 0;
      try{
        amount = items.reduce(function(s,it){
          return s + Number(it.price||0) * Math.max(1, Number(it.qty||1));
        }, 0);
      }catch(_){ amount = 0; }

      // 3) Coupon discount (fixed -200 if eligible deity is present in items)
      var cpnRaw = localStorage.getItem('__activeCoupon__');
      var cpn = cpnRaw ? JSON.parse(cpnRaw) : null;
      var off = 0;
      if (cpn && cpn.code){
        var want = (typeof deityCodeOf === 'function') ? deityCodeOf(cpn.deity) : String(cpn.deity||'').toUpperCase();
        var elig = 0;
        try{
          elig = items.reduce(function(s,it){
            var code = (it && it.deity && /^[A-Z]{2}$/.test(String(it.deity))) ? String(it.deity).toUpperCase()
                      : (typeof deityCodeOf === 'function' ? deityCodeOf((it && (it.name||'')) || '') : String(it.deity||'').toUpperCase());
            var ok = (code && want && code === want);
            return s + (ok ? Number(it.price||0) * Math.max(1, Number(it.qty||1)) : 0);
          }, 0);
        }catch(_){ elig = 0; }
        if (elig > 0) off = Number(cpn.amount||200) || 200;
      }

      var grand = Math.max(0, Math.round(amount - off));

      if (amtEl) amtEl.value = grand;
      if (aHint){
        if (off>0){
          aHint.textContent = 'å·²å¥—ç”¨å„ªæƒ ç¢¼ ' + (cpn && cpn.code || '') + ' æŠ˜æŠµ NT$' + (Number(cpn && cpn.amount || 200) || 200);
          aHint.style.color = '#059669';
        }else{
          aHint.textContent = 'ç³»çµ±è‡ªå‹•å¸¶å…¥é‡‘é¡ï¼Œç„¡éœ€ä¿®æ”¹';
          aHint.style.color = '#6b7280';
        }
      }

      // é€šçŸ¥å…¶ä»–ç¸½è¨ˆå€å¡Šï¼ˆè‹¥æœ‰ï¼‰
      try{ window.__coupon && window.__coupon.updateTotalsDisplay && window.__coupon.updateTotalsDisplay(); }catch(_){}
    }catch(e){}
  }

  // expose and react to changes
  window.__recalcBankAmount = recalcAmount;
  window.addEventListener('storage', function(ev){
    try{
      if (!ev) return;
      if (ev.key === 'cart' || ev.key === '__activeCoupon__'){ recalcAmount(); }
    }catch(_){}
  });

  // MutationObserver: watch order list for changes and recalc
  try{
    var orderListNode = document.getElementById('bfOrderList');
    if (orderListNode){
      var mo = new MutationObserver(function(){ recalcAmount(); });
      mo.observe(orderListNode, { childList:true, subtree:false });
    }
  }catch(_){}

  document.addEventListener('click', async function(e){
    if (!(e.target && e.target.id === 'bfCouponApply')) return;
    e.preventDefault();
    var code = (document.getElementById('bfCouponInput') && document.getElementById('bfCouponInput').value || '').trim().toUpperCase();
    if (!code){ markHint(false, 'è«‹è¼¸å…¥å„ªæƒ ç¢¼'); return; }
    var deity = getPendingDeity();
    var res = await checkCoupon(code, deity);
    if (res && res.ok){
      setActiveCoupon({ code:res.code||code, deity:res.deity||deity, amount:Number(res.amount||200)||200 });
      markHint(true, 'å·²å¥—ç”¨å„ªæƒ ç¢¼ ' + (res.code||code) + 'ï¼ˆé™å®šï¼š'+ (res.deity||deity) +'ï¼‰');
      recalcAmount();
    }else{
      markHint(false, 'å„ªæƒ ç¢¼ç„¡æ•ˆã€å·²ä½¿ç”¨ï¼Œæˆ–ä¸é©ç”¨æ­¤å®ˆè­·ç¥å•†å“');
    }
  });
})();
</script>



<script id="bankPriceStorePatch">
(function(){
  if (window.__bankPriceStorePatched) return; window.__bankPriceStorePatched = true;

  function fmt(n){
    try{ return 'NT$ ' + Number(n||0).toLocaleString('zh-TW'); }catch(e){ return 'NT$ ' + (Number(n||0).toFixed(0)); }
  }

  function ensureOrderBox(){
    var dlg = document.getElementById('dlgBank');
    if (!dlg) return {list:null, box:null};
    var box = document.getElementById('bfOrderBox');
    if (!box){
      box = document.createElement('div');
      box.id = 'bfOrderBox';
      box.style.cssText = 'background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:none;margin-bottom:8px';
      box.innerHTML = '<div style="font-weight:800;margin-bottom:6px">è¨‚å–®å…§å®¹ç¢ºèª</div><div id="bfOrderList" style="display:flex;flex-direction:column;gap:8px"></div>';
      // Insert before bankForm
      var form = document.getElementById('bankForm');
      if (form && form.parentNode){
        form.parentNode.insertBefore(box, form);
      } else {
        dlg.appendChild(box);
      }
    }
    var list = document.getElementById('bfOrderList');
    return {list:list, box:box};
  }

  function buildItems(){
    var items = [];

    // Determine checkout source: 'direct' (single item flow) vs 'cart' (multi-item cart flow)
    var src = (typeof window !== 'undefined' && window.__checkoutSource) ? String(window.__checkoutSource) : '';

    if (src === 'direct'){
      // ---- DIRECT CHECKOUT: ONLY the pending detail item ----
      // read optional "removed ad-hoc ui keys" to avoid re-adding after user removed
      var removedUI = [];
      try{ removedUI = JSON.parse(sessionStorage.getItem('__bank_removed_ui__')||'[]'); if(!Array.isArray(removedUI)) removedUI = []; }catch(e){ removedUI = []; }

      // Pending detail captured from product page/dialog
      try{
        var pendRaw = sessionStorage.getItem('__pendingDetail__');
        var pend = pendRaw ? JSON.parse(pendRaw) : null;
        if (pend && pend.name){
          items.push({
            name: pend.name,
            spec: pend.variantName || '',
            qty:  Math.max(1, Number(pend.qty||1)),
            unit: Number(pend.price||0),
            source:'pending',
            index:0
          });
        }
      }catch(e){}

      // Fallback: if pending isn't present, attempt a last-resort snapshot from current UI
      if (!items.length){
        try{
          var name = (document.getElementById('dlgTitle') && document.getElementById('dlgTitle').textContent) || '';
          var sel  = document.getElementById('dlgVariant');
          var spec = (sel && sel.options && sel.selectedIndex>=0) ? sel.options[sel.selectedIndex].textContent : '';
          if (spec) spec = spec.replace(/ï¼ˆ\+[^ï¼‰]*ï¼‰/g,'').trim();
          if (!spec) spec = 'æ¨™æº–å¤–æ®¼';
          var qtyEl = document.getElementById('dlgQty');
          var qty = qtyEl ? Math.max(1, Number(qtyEl.value||1)) : 1;
          var priceNode = document.getElementById('dlgPrice');
          var total = 0;
          if (priceNode){
            var dp = Number(priceNode.getAttribute('data-price')||0);
            if (!dp){
              var txt = (priceNode.textContent||'').replace(/[ ,\s]/g,'');
              dp = Number(txt)||0;
            }
            total = dp;
          }
          var unit = qty ? (total/qty) : total;
          if (name){
            var snap = { name:name, spec:spec, qty:qty, unit:unit, source:'ui', index:0 };
            snap.__key = JSON.stringify({n:snap.name,s:snap.spec,u:snap.unit,q:snap.qty});
            if (!removedUI.includes(snap.__key)) items.push(snap);
          }
        }catch(e){}
      }
      return items;
    }

    // ---- CART CHECKOUT (default): ONLY cart items, do NOT append pending ----
    try{
      var cart = JSON.parse(localStorage.getItem('cart')||'[]');
      if (Array.isArray(cart) && cart.length){
        items = cart.map(function(it, idx){
          var name = (it && (it.name||it.title)) || 'å•†å“';
          var spec = (it && (it.variantName||'')) || '';
          var qty  = Math.max(1, Number((it && it.qty) || 1));
          var unit = Number((it && it.price) || 0);
          return { name:name, spec:spec, qty:qty, unit:unit, source:'cart', index:idx };
        });
      }
    }catch(e){}

    // No pending fallback here by design â€” cart and direct are strictly separated
    return items;
  }

  function renderOrderSummary(){
    // å·²æ”¹ç”¨ bankCouponBridgeUnified çš„è¨‚å–®å…§å®¹è¡¨æ ¼
    // é€™è£¡åªä¿ç•™èˆŠè…³æœ¬éœ€è¦çš„é‡‘é¡é‡ç®—ï¼Œä¸å†æ¸²æŸ“ bfOrderBoxï¼ˆè¨‚å–®å…§å®¹ç¢ºèªï¼‹å–®è¡Œé è¦½ï¼‹ç§»é™¤æŒ‰éˆ•ï¼‰
    try{
      if (window.__coupon && typeof window.__coupon.updateTotalsDisplay === 'function'){
        window.__coupon.updateTotalsDisplay();
      }
    }catch(_){}

    try{
      if (typeof window.__recalcBankAmount === 'function'){
        window.__recalcBankAmount();
      }
    }catch(_){}
  }

  // çœŸæ­£ç§»é™¤è¨‚å–®é …ç›®ä¸¦åˆ·æ–°
  function removeItemFromOrder(source, index, key){
    try{
      if (source === 'cart'){
        var cart = JSON.parse(localStorage.getItem('cart')||'[]');
        if (Array.isArray(cart) && cart.length){
          var idx = Number(index);
          if (!isNaN(idx) && idx>=0 && idx<cart.length){
            cart.splice(idx,1);
          }else{
            // fallback by snapshot key (ifæä¾›)
            if (key){
              var found = cart.findIndex(function(it){
                var snap = JSON.stringify({n:String(it.name||it.title||'å•†å“'), s:String(it.variantName||''), u:Number(it.price||0), q:Math.max(1,Number(it.qty||1))});
                return snap === decodeURIComponent(key);
              });
              if (found>=0) cart.splice(found,1);
            }
          }
          localStorage.setItem('cart', JSON.stringify(cart));
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'cart', newValue: JSON.stringify(cart) })); }catch(_){}
        }
      }else if (source === 'pending'){
        sessionStorage.removeItem('__pendingDetail__');
      }else if (source === 'ui'){
        // è¨˜éŒ„ç”¨æˆ¶ç§»é™¤çš„ ad-hoc UI é …ï¼Œé¿å…é‡å»ºæ™‚åˆå‡ºç¾
        if (key){
          var arr = [];
          try{ arr = JSON.parse(sessionStorage.getItem('__bank_removed_ui__')||'[]'); }catch(e){}
          if (!Array.isArray(arr)) arr = [];
          if (arr.indexOf(decodeURIComponent(key)) === -1) arr.push(decodeURIComponent(key));
          sessionStorage.setItem('__bank_removed_ui__', JSON.stringify(arr));
        }
      }
    }catch(e){}
    // é‡æ–°æ¸²æŸ“èˆ‡é‡ç®—é‡‘é¡
    try{ renderOrderSummary(); }catch(_){}
    try{ if (typeof window.__recalcBankAmount === 'function') window.__recalcBankAmount(); }catch(_){}
  }

  function ensureStoreField(){
    var form = document.getElementById('bankForm');
    if (!form) return;
    if (document.getElementById('bfStore')) return; // already exists
    // Find the "ä¸Šå‚³åŒ¯æ¬¾æ†‘è­‰" block to insert before
    var uploadLabel = null;
    var labels = form.querySelectorAll('label');
    for (var i=0;i<labels.length;i++){
      var t = (labels[i].textContent||'').trim();
      if (t.indexOf('ä¸Šå‚³åŒ¯æ¬¾æ†‘è­‰') !== -1){ uploadLabel = labels[i]; break; }
    }
    var field = document.createElement('div');
    field.style.display='grid';
    field.style.gap='6px';
    field.innerHTML = '<label style="font-size:12px;color:#6b7280">æ”¶ä»¶7-11é–€å¸‚ï¼ˆè‹¥éå¯¦é«”å•†å“ï¼Œè«‹å¡«å¯«ã€Œç„¡ã€ï¼‰</label>' +
                      '<input id="bfStore" name="store" placeholder="è«‹è¼¸å…¥é–€å¸‚åç¨±æˆ–åº—è™Ÿ" required ' +
                      'style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">' +
                      '<div id="bfStoreHelp" style="margin-top:6px;font-size:12px;color:#6b7280;display:none"></div>';
    if (uploadLabel && uploadLabel.parentNode){
      uploadLabel.parentNode.parentNode.insertBefore(field, uploadLabel.parentNode);
    }else{
      form.insertBefore(field, form.firstChild);
    }
  }

  // --- Candle UI helpers ---
  function isCandleOrder(){
    // 1) Check cart categories or names
    try{
      var cart = JSON.parse(localStorage.getItem('cart')||'[]');
      if (Array.isArray(cart) && cart.some(function(it){
        var cat = String((it && it.category) || '').trim();
        var nm  = String((it && (it.name||it.title||'')) || '');
        return cat === 'è Ÿç‡­åŠ æŒç¥ˆç¦' || /è Ÿç‡­/.test(nm);
      })){
        return true;
      }
    }catch(e){}
    // 2) Fallback: check current detail dialog dataset
    try{
      var dlg = document.getElementById('dlg');
      var cat = dlg && dlg.getAttribute('data-product-cat');
      if (cat === 'è Ÿç‡­åŠ æŒç¥ˆç¦') return true;
      var nm = dlg && dlg.getAttribute('data-product-name');
      if (nm && /è Ÿç‡­/.test(nm)) return true;
    }catch(e){}
    // 3) Also consider pending detail captured when opening from product page
    try{
      var pRaw = sessionStorage.getItem('__pendingDetail__');
      var p = pRaw ? JSON.parse(pRaw) : null;
      if (p && (p.category === 'è Ÿç‡­åŠ æŒç¥ˆç¦' || /è Ÿç‡­/.test(p.name||''))) return true;
    }catch(e){}
    return false;
  }

  function toggleCandleUI(){
    var isCandle = isCandleOrder();

    // 1) Ritual photo block
    try{
      var rb = document.getElementById('bfRitualBlock');
      if (rb){ rb.style.display = isCandle ? '' : 'none'; }
    }catch(e){}

    // 2) Candle tip above note
    try{
      var tip = document.getElementById('bfCandleTip');
      if (tip){ tip.style.display = isCandle ? '' : 'none'; }
    }catch(e){}

    // 3) Store help hint
    try{
      var help = document.getElementById('bfStoreHelp');
      if (help){
        if (isCandle){
          help.textContent = 'è‹¥ç‚ºè Ÿç‡­ç¥ˆç¦ç­‰æœå‹™é¡å•†å“ï¼Œè«‹å¡«å¯«ã€Œç„¡ã€ã€‚';
          help.style.display = '';
        }else{
          help.textContent = '';
          help.style.display = 'none';
        }
      }
    }catch(e){}
  }

  function onOpen(){
    var __src = (typeof window !== 'undefined' && window.__checkoutSource) ? String(window.__checkoutSource) : '';
    if (__src !== 'direct'){
      try{ sessionStorage.removeItem('__pendingDetail__'); }catch(_){ }
    }
    try{
      ensureStoreField();
      renderOrderSummary();
      toggleCandleUI();
    }catch(e){ console.error('bank patch error', e); }
  }

  // Hook into clicks that open bank dialog (without changing their original logic)
  document.addEventListener('click', function(e){
    var btn = e.target && ( e.target.id ? e.target : (e.target.closest && e.target.closest('#pay711, #cartGo711')) );
    if (!btn) return;
    var id = btn.id || '';
    if (id === 'cartGo711')      window.__checkoutSource = 'cart';
    else if (id === 'pay711')    window.__checkoutSource = 'direct';
    else if ((btn.matches && btn.matches('#cartGo711')) || (btn.closest && btn.closest('#cartGo711'))) window.__checkoutSource = 'cart';
    else if ((btn.matches && btn.matches('#pay711'))   || (btn.closest && btn.closest('#pay711')))   window.__checkoutSource = 'direct';

    setTimeout(onOpen, 0);
    setTimeout(toggleCandleUI, 0);
  }, true);

  // Handle remove clicks in the order summary list
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('.ok-remove');
    if (!btn) return;
    e.preventDefault();
    var src = btn.getAttribute('data-remove-source') || '';
    var idx = btn.getAttribute('data-remove-index') || '';
    var key = btn.getAttribute('data-remove-key') || '';
    removeItemFromOrder(src, idx, key);
  }, true);

  // Also run on DOM ready in case dialog is already present
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(onOpen, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(onOpen, 0); });
  }

  // Expose for other scripts
  window.toggleCandleUI = toggleCandleUI;
  window.isCandleOrder = isCandleOrder;
})();
</script>

<script id="bankUnifiedReset">
(function(){
  // Disabled: previously this script stripped inline styles from the bank dialog,
  // which removed necessary paddings and caused the form to look cropped on the edges.
  // Keep the guard flag to avoid re-injection, but perform no mutations.
  if (window.__bankUnifiedReset__) return;
  window.__bankUnifiedReset__ = true;
})();
</script>


<script id="bankRestorePatch">
(function(){
  if (window.__bankRestorePatched) return; window.__bankRestorePatched = true;

  function digitsOnly(s){ return String(s||'').replace(/[^0-9]/g,''); }

  function restoreBankUI(){
    var dlg = document.getElementById('dlgBank');
    if (!dlg) return;

    // read values
    var bankVal = 'ä¸­åœ‹ä¿¡è¨— (822)';
    var acctVal = '148540417073';
    var bankEl = document.getElementById('bankBankVal');
    var noEl   = document.getElementById('bankNoVal');
    if (bankEl && bankEl.textContent.trim()) bankVal = bankEl.textContent.trim();
    if (noEl && noEl.textContent.trim()) acctVal = noEl.textContent.trim();

    // hide old header title and grid
    try{
      var title = dlg.querySelector('.bankHeader .bankTitle'); if (title) title.style.display='none';
      var grid  = dlg.querySelector('.bankInfoGrid'); if (grid) grid.style.display='none';
    }catch(e){}

    // inject four-line block
    var box = document.getElementById('bankFourLines');
    if (!box){
      box = document.createElement('div');
      box.id = 'bankFourLines';
      var header = dlg.querySelector('.bankHeader');
      if (header && header.parentNode){
        header.parentNode.insertBefore(box, header.nextSibling);
      }else{
        dlg.appendChild(box);
      }
    }
    box.innerHTML = ''
      + '<div class="line16">éŠ€è¡Œåç¨±ï¼š</div>'
      + '<div class="line16" id="bankNameLine"></div>'
      + '<div class="line16">åŒ¯æ¬¾å¸³è™Ÿï¼š</div>'
      + '<div class="line16" id="bankNoLine"></div>';

    var nameLine = document.getElementById('bankNameLine');
    var noLine   = document.getElementById('bankNoLine');
    if (nameLine) nameLine.textContent = bankVal;
    if (noLine)   noLine.textContent   = digitsOnly(acctVal) || acctVal;

    // shrink & rebind copy button
    var btn = document.getElementById('bankCopyAll');
    if (btn){
      btn.textContent = 'è¤‡è£½å¸³è™Ÿ';
      btn.style.padding = '4px 8px';
      btn.style.fontSize = '12px';
      btn.style.borderRadius = '8px';
      btn.onclick = function(ev){
        ev && ev.preventDefault && ev.preventDefault();
        var text = digitsOnly((document.getElementById('bankNoLine')||{}).textContent||acctVal);
        try{
          navigator.clipboard.writeText(text);
          alert('å·²è¤‡è£½å¸³è™Ÿ');
        }catch(e){
          var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
          alert('å·²è¤‡è£½å¸³è™Ÿ');
        }
      };
    }

    // set amount readonly and hint
    var amt = document.getElementById('bfAmount');
    if (amt){
      amt.readOnly = true;
      var hint = document.getElementById('bfAmtHint');
      if (!hint){
        hint = document.createElement('div');
        hint.id = 'bfAmtHint';
        hint.textContent = 'ç³»çµ±è‡ªå‹•å¸¶å…¥é‡‘é¡ï¼Œç„¡éœ€ä¿®æ”¹';
        // place right below amount input (same grid column)
        try{
          var parentCol = amt.parentNode;
          if (parentCol && parentCol.appendChild) parentCol.appendChild(hint);
        }catch(e){}
      }
    }

    // æ ¹æ“šè³¼ç‰©è»Šèˆ‡å„ªæƒ åˆ¸é‡æ–°è¨ˆç®—å¯¦éš›æ‡‰ä»˜é‡‘é¡ï¼Œç¢ºä¿èˆ‡è³¼ç‰©è»Šè¦–çª—é¡¯ç¤ºä¸€è‡´
    try{
      var cartRaw = localStorage.getItem('cart') || '[]';
      // --- æ’å…¥ twLocal helper ---
      function twLocal(n){
        try{
          return 'NT$ ' + Number(n || 0).toLocaleString('zh-TW');
        }catch(e){
          var num = Number(n || 0);
          if (!isFinite(num)) num = 0;
          return 'NT$ ' + num.toFixed(0);
        }
      }
      var items = [];
      try{
        var parsed = JSON.parse(cartRaw);
        if (Array.isArray(parsed)) items = parsed;
      }catch(e){}

      function baseAmountOfItemForBank(it){
        if (!it) return 0;
        var unit = Number(it.price != null ? it.price : (it.unit != null ? it.unit : 0)) || 0;
        var qty  = Math.max(1, Number(it.qty != null ? it.qty : (it.quantity != null ? it.quantity : 1)) || 1);
        return unit * qty;
      }

      var sub = 0;
      for (var i = 0; i < items.length; i++){
        sub += baseAmountOfItemForBank(items[i]);
      }

      var off = 0;
      try{
        if (window.__cartCouponState && window.__cartCouponState.assignment){
          off = Number(window.__cartCouponState.assignment.total || 0) || 0;
        }
      }catch(e){}

      var grand = Math.max(0, sub - off);
      if (amt && grand > 0){
        amt.value = grand;
      }

      // Render a full cart item summary inside the bank dialog so
      // ã€Œè¨‚å–®å…§å®¹ç¢ºèªã€å°æ‡‰å¯¦éš›åŒ¯æ¬¾é‡‘é¡ï¼ˆåŒ…å«è³¼ç‰©è»Šæ‰€æœ‰å•†å“ï¼‰
      try{
        if (items && items.length){
          var dlgRoot = dlg;
          // Create or reuse a container for the cart summary
          var summaryBox = document.getElementById('bankCartSummary');
          if (!summaryBox){
            summaryBox = document.createElement('div');
            summaryBox.id = 'bankCartSummary';
            summaryBox.style.marginTop = '12px';
            summaryBox.style.padding = '10px 12px';
            summaryBox.style.borderRadius = '10px';
            summaryBox.style.background = '#f9fafb';
            summaryBox.style.fontSize = '13px';
            summaryBox.style.lineHeight = '1.6';

            // Try to insert the box right after the existing ã€Œè¨‚å–®å…§å®¹ç¢ºèªã€å€å¡Šï¼Œ
            // è‹¥æ‰¾ä¸åˆ°å°±åŠ åœ¨ dialog å…§æ–‡çš„æœ€ä¸‹æ–¹ã€‚
            var heading = dlgRoot.querySelector('.bankOrderTitle, .bankOrderHeader, .bank-order-title');
            if (!heading){
              // Fallback: try to locate a block containing the text "è¨‚å–®å…§å®¹ç¢ºèª"
              var labels = dlgRoot.querySelectorAll('div, h2, h3');
              for (var i = 0; i < labels.length; i++){
                if ((labels[i].textContent || '').indexOf('è¨‚å–®å…§å®¹ç¢ºèª') !== -1){
                  heading = labels[i];
                  break;
                }
              }
            }
            if (heading && heading.parentNode){
              heading.parentNode.insertBefore(summaryBox, heading.nextSibling);
            }else{
              dlgRoot.appendChild(summaryBox);
            }
          }

          // Build HTML for all cart items
          var html = '';
          html += '<div style="font-weight:700;margin-bottom:4px">æœ¬æ¬¡åŒ¯æ¬¾é‡‘é¡åŒ…å«ä»¥ä¸‹è³¼ç‰©è»Šå•†å“ï¼š</div>';
          for (var j = 0; j < items.length; j++){
            var it = items[j] || {};
            var name = it.name || it.title || it.productName || 'å•†å“';
            var spec = it.variantName || it.spec || it.deity || '';
            var qty  = Number(it.qty != null ? it.qty : (it.quantity != null ? it.quantity : 1)) || 1;
            var unit = Number(it.price != null ? it.price : (it.unit != null ? it.unit : 0)) || 0;
            var line = '<div>'
                     + name
                     + (spec ? 'ï½œè¦æ ¼ï¼š' + spec : '')
                     + 'ï½œæ•¸é‡ï¼š' + qty
                     + 'ï½œå–®åƒ¹ï¼š' + twLocal(unit)
                     + '</div>';
            html += line;
          }

          // Show discount info if any coupon is applied
          if (off > 0){
            html += '<div style="margin-top:6px;color:#059669">å·²å¥—ç”¨å„ªæƒ æŠ˜æŠµ '
                 + twLocal(off).replace(/^NT\$\s*/, 'NT$ ')
                 + 'ï¼Œå¯¦éš›æ‡‰ä»˜é‡‘é¡ç‚º '
                 + twLocal(grand).replace(/^NT\$\s*/, 'NT$ ')
                 + '</div>';
          }else{
            html += '<div style="margin-top:6px;color:#6b7280">æœ¬æ¬¡åŒ¯æ¬¾é‡‘é¡ï¼š'
                 + twLocal(grand).replace(/^NT\$\s*/, 'NT$ ')
                 + '</div>';
          }

          summaryBox.innerHTML = html;
        }
      }catch(_){}
    }catch(e){}
  }

  function onOpen(){
    try{ restoreBankUI(); }catch(e){ console.error(e); }
  }

  // Trigger when bank dialog opens (respect existing logic, don't override)
  document.addEventListener('click', function(e){
    var t = e.target;
    var fire = t && (t.id==='pay711' || t.id==='cartGo711' || (t.closest && t.closest('#pay711,#cartGo711')));
    if (fire){ setTimeout(onOpen, 0); }
  }, true);

  // Also run on DOM ready (for cases where dialog is already present)
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(onOpen, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(onOpen, 0); });
  }
})();
</script>

<script id="cvsAutoFillStrict">
(function(){
  if (window.__cvsAutoFillStrict) return; window.__cvsAutoFillStrict = true;

  function pick(sp, keys){
    for (var i=0;i<keys.length;i++){
      var v = sp.get(keys[i]);
      if (v) return v;
    }
    return '';
  }
  function parseFromURL(u){
    try{
      var sp = new URLSearchParams((u && u.search) || location.search || '');
      var id   = pick(sp, ['storeid','StoreId','stCode','code','store']);
      var name = pick(sp, ['storename','StoreName','stName','name']);
      var addr = pick(sp, ['storeaddress','StoreAddress','address','Addr']);
      var tel  = pick(sp, ['storetel','StoreTel','tel','TEL']);
      return {id:id||'', name:name||'', addr:addr||'', tel:tel||''};
    }catch(e){ return {id:'',name:'',addr:'',tel:''}; }
  }
  function composeText(d){
    var t = '';
    if (d.name && d.id) t = d.name + ' (' + d.id + ')';
    else if (d.name)    t = d.name;
    else if (d.id)      t = d.id;
    // è‹¥éœ€è¦å¯åŠ åœ°å€é›»è©±ï¼š
    // if (d.addr) t += (t?' Â· ':'') + d.addr;
    // if (d.tel)  t += (t?' Â· ':'') + d.tel;
    return t;
  }
  function openBankIfPossible(){
    try{
      if (typeof openBankDialog === 'function'){ openBankDialog('detail'); return; }
      var dlg = document.getElementById('dlgBank');
      if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
    }catch(e){}
  }
  function fillIntoField(d){
    var text = composeText(d);
    if (!text) return false;
    var el = document.getElementById('bfStore');
    if (!el) return false;
    try{
      el.value = text;
      el.setAttribute('data-storeid', d.id||'');
      el.setAttribute('data-storename', d.name||'');
      el.setAttribute('data-storeaddress', d.addr||'');
      el.setAttribute('data-storetel', d.tel||'');
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
      return true;
    }catch(e){ return false; }
  }
  function whenFieldReady(cb){
    if (document.getElementById('bfStore')){ cb(); return; }
    var mo = new MutationObserver(function(){
      if (document.getElementById('bfStore')){ mo.disconnect(); cb(); }
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }

  // 1) DOM ready: è‹¥ URL å·²æœ‰é–€å¸‚è³‡æ–™ï¼Œç­‰å¾…æ¬„ä½å‡ºç¾å¾Œå›å¡«
  document.addEventListener('DOMContentLoaded', function(){
    var data = parseFromURL(location);
    var has = data.id || data.name || data.addr || data.tel;
    if (!has) return;
    whenFieldReady(function(){
      if (fillIntoField(data)) openBankIfPossible();
    });
  });

  // 2) postMessageï¼šè‹¥ popup/æ–°è¦–çª—å›å‚³ï¼Œç…§æ¨£å›å¡«
  window.addEventListener('message', function(ev){
    try{
      var d = ev.data || {};
      if (!d.__cvs_store__) return;
      var got = { id: d.storeid||'', name: d.storename||'', addr: d.storeaddress||'', tel: d.storetel||'' };
      whenFieldReady(function(){
        if (fillIntoField(got)) openBankIfPossible();
      });
    }catch(e){}
  });
})();
</script>


<script id="cart-coupon-normalize-and-apply">
(function(){
  if (window.__cartCouponPatchedMulti__) return; 
  window.__cartCouponPatchedMulti__ = true;

  // åˆå§‹åŒ–å¤šåˆ¸ç‹€æ…‹ï¼šå„ªå…ˆè®€å– localStorage
  var __cartCouponsMem = [];
  var __cartCouponsMemSig = '';
  try{
    var _raw = localStorage.getItem('__cartCoupons__');
    var _sig = localStorage.getItem('__cartCouponsCartSig__') || '';
    var _arr = _raw ? JSON.parse(_raw) : [];
    if (Array.isArray(_arr)) __cartCouponsMem = _arr;
    __cartCouponsMemSig = _sig;
  }catch(_){}

  // è‹¥ URL å¸¶æœ‰ coupon/deityï¼ˆä¾‹å¦‚æ¸¬é©—é è¿”å›ï¼‰ï¼Œè‡ªå‹•å¥—ç”¨åˆ°æœ¬åœ°å„ªæƒ åˆ¸ç‹€æ…‹
  try{
    var sp = new URLSearchParams((window && window.location && window.location.search) || '');
    var qc = (sp.get('coupon') || '').trim();
    var qd = (sp.get('deity') || '').trim();
    var qa = Number(sp.get('amount') || sp.get('off') || 200) || 200;
    if (qc){
      var obj = { code: qc, deity: qd || '', amount: qa };
      // æ¨å…¥å¤šåˆ¸ç³»çµ±ï¼ˆé¿å…é‡è¤‡ï¼‰
      var cur = getCartCoupons();
      var dup = cur.some(function(c){ return String(c.code||'').toUpperCase() === qc.toUpperCase(); });
      if (!dup){
        cur.push(obj);
        setCartCoupons(cur);
      }
      // ä¹Ÿå¯«å…¥èˆŠç‰ˆ activeCouponï¼Œä¾› direct-buy æµç¨‹ä½¿ç”¨
      try{
        localStorage.setItem('__activeCoupon__', JSON.stringify(obj));
        window.__coupon = window.__coupon || {};
        window.__coupon.getActiveCoupon = function(){
          try{ var raw=localStorage.getItem('__activeCoupon__'); return raw?JSON.parse(raw):null; }catch(e){ return null; }
        };
      }catch(_){}
      try{ window.__coupon && window.__coupon.updateTotalsDisplay && window.__coupon.updateTotalsDisplay(); }catch(_){}
      try{ if (typeof updateCartTotals === 'function') updateCartTotals(); }catch(_){}
    }
  }catch(_){}

  // ---------- åŸºæœ¬å·¥å…· ----------
  function deityCodeOf(input){
    try{
      var s = (input||'').toString().trim();
      if (!s) return '';
      if (/^[A-Z]{2}$/.test(s)) return s.toUpperCase();
      if (/å››é¢ç¥|BRAHMA|PHRA\s*PHROM|PHROM|ERAWAN/i.test(s)) return 'FM';
      if (/è±¡ç¥|GANESHA|PHIKANET|PHIKANES|PIKANES/i.test(s))   return 'GA';
      if (/å´‡è¿ª|SOMDEJ|SOMDET/i.test(s))                      return 'CD';
      if (/å¤å¹³|KHUN\s*PHAEN|KHUN\s*PAEN|K\.?P\.?/i.test(s))  return 'KP';
      if (/å“ˆé­¯æ›¼|H(AN|AR)UMAN/i.test(s))                     return 'HM';
      if (/æ‹‰èƒ¡|RAHU/i.test(s))                               return 'RH';
      if (/è¿¦æ¨“ç¾…|GARUDA|K(AR|AL)UDA/i.test(s))              return 'JL';
      if (/æ¾¤åº¦é‡‘|JATUKAM|R(AM|A)MATHEP|ZEDO(G|K)ON|ZEDUKIN/i.test(s)) return 'ZD';
      if (/æ‹›è²¡å¥³ç¥|LAKSHMI|LAXSHMI|LAMSI/i.test(s))          return 'ZF';
      if (/äº”çœ¼å››è€³|FIVE[\-\s]*EYES|5EYES|FIVEEYES/i.test(s)) return 'WE';
      if (/å¾ç¥|XU\s*ZHU|XUZHU/i.test(s))                     return 'XZ';
      if (/é­‚é­„å‹‡|HUN\s*PO\s*YONG|HPY/i.test(s))              return 'HP';
      return s.toUpperCase();
    }catch(e){ return ''; }
  }
  function readCart(){
    try{
      var c = JSON.parse(localStorage.getItem('cart')||'[]');
      return Array.isArray(c) ? c : [];
    }catch(e){ return []; }
  }
  function subTotal(items){
    try{
      return (items || []).reduce(function(sum, it){
        return sum + baseAmountOfItem(it);
      }, 0);
    }catch(e){
      return 0;
    }
  }
  // --- è³¼ç‰©è»Šå…§å®¹ç°½ç« ï¼ˆå¿«ç…§ï¼‰ ---
  function cartSignature(){
    try{
      var items = readCart();
      return JSON.stringify(items.map(function(it){
        return {
          id: (it && (it.id || it.code || it.sku || it.productId || it.name || it.title || '')),
          deity: (it && (it.deity || '')),
          price: Number(it && it.price || 0),
          qty: Math.max(1, Number(it && (it.qty || it.quantity || 1)) || 1)
        };
      }));
    }catch(e){ return '[]'; }
  }
  function tw(n){
    try{ return 'NT$ ' + Number(n||0).toLocaleString('zh-TW'); }
    catch(e){ return 'NT$ ' + (Number(n||0).toFixed(0)); }
  }

  // ---------- å„ªæƒ åˆ¸å­˜å–ï¼šæ”¯æ´å¤šå¼µ ----------
  function getCartCoupons(){
    try{
      var curSig = cartSignature();
      // æ›´æ–°ç›®å‰è³¼ç‰©è»Šç°½ç« ï¼Œä½†ä¿ç•™å·²å¥—ç”¨çš„å„ªæƒ åˆ¸
      __cartCouponsMemSig = curSig;

      // å›å‚³ä¸€ä»½æ‹·è²ï¼Œé¿å…å¤–éƒ¨æ„å¤–ä¿®æ”¹
      return __cartCouponsMem.slice();
    }catch(e){
      return [];
    }
  }
  function setCartCoupons(list){
    try{
      var arr = Array.isArray(list) ? list : [];
      __cartCouponsMem = arr.slice();
      __cartCouponsMemSig = cartSignature();

      // å°‡ç›®å‰ç‹€æ…‹å¯«å…¥ localStorage åªæ˜¯ç‚ºäº†è®“å…¶å®ƒæ¨¡çµ„ï¼ˆä¾‹å¦‚é ‚éƒ¨ barï¼‰å¯ä»¥åŒæ­¥é¡¯ç¤º
      try{
        localStorage.setItem('__cartCoupons__', JSON.stringify(arr));
        localStorage.setItem('__cartCouponsCartSig__', __cartCouponsMemSig);
      }catch(_){ }
      // æ¸…é™¤èˆŠç‰ˆ coupon keys
      try{
        localStorage.removeItem('__activeCoupon__');
        localStorage.removeItem('__activeCoupons__');
      }catch(_){ }

      // å°å…¶ä»–æ¨¡çµ„å…¬å¸ƒç‹€æ…‹ï¼ˆä»¥è¨˜æ†¶é«”ç‚ºä¸»ï¼‰
      window.__cartCouponState = window.__cartCouponState || {};
      window.__cartCouponState.coupons = __cartCouponsMem.slice();
      // æ¸…é™¤èˆŠç‰ˆå…¨åŸŸç‹€æ…‹
      try{
        window.__activeCoupon = null;
        window.__activeCoupons = null;
      }catch(_){ }

      // å»£æ’­äº‹ä»¶è®“å…¶å®ƒç›£è½è€…å¯æ›´æ–°
      try{
        window.dispatchEvent(new StorageEvent('storage', { key:'__cartCoupons__', newValue: JSON.stringify(arr) }));
      }catch(_){}
    }catch(e){}
  }
  function removeCartCoupon(code){
    var list = getCartCoupons().filter(function(c){
      return String(c.code||'').toUpperCase() !== String(code||'').toUpperCase();
    });
    setCartCoupons(list);
  }

  // ---------- å•†å“èˆ‡æŠ˜æ‰£åˆ†é… ----------
  function baseAmountOfItem(it){
    if (!it) return 0;
    var unit = Number(it.price != null ? it.price : it.unit != null ? it.unit : 0) || 0;
    var qty  = Math.max(1, Number(it.qty != null ? it.qty : it.quantity != null ? it.quantity : 1) || 1);
    return unit * qty;
  }
  function itemDeityOf(it){
    if (!it) return '';
    var d = it.deity || it.deityCode || it.deity_id || '';
    if (!d){
      var nm = it.name || it.title || it.productName || '';
      d = deityCodeOf(nm);
    }
    return deityCodeOf(d);
  }
  function normDeity(d){
    return deityCodeOf(d||'');
  }

  // ä¾ç…§ã€Œä¸€å€‹å•†å“æœ€å¤šä¸€å¼µåˆ¸ã€è¦å‰‡ï¼ŒæŠŠå¤šå¼µåˆ¸åˆ†é…åˆ°è³¼ç‰©è»Šå•†å“ä¸Š
  function assignCouponsToItems(items, coupons){
    var discountedItemIdx = {};   // itemIndex -> true
    var lines = [];
    var total = 0;

    for (var ci = 0; ci < coupons.length; ci++){
      var cpn = coupons[ci];
      if (!cpn || !cpn.code) continue;

      var deity = normDeity(cpn.deity || '');
      var bestIdx  = -1;
      var bestBase = 0;

      for (var i = 0; i < items.length; i++){
        if (discountedItemIdx[i]) continue; // ä¸€å€‹å•†å“åªèƒ½åƒä¸€å¼µåˆ¸

        var it = items[i] || {};
        var itemDeity = itemDeityOf(it);

        if (deity && itemDeity && itemDeity !== deity) continue;

        var base = baseAmountOfItem(it);
        if (base <= 0) continue;

        if (base > bestBase){
          bestBase = base;
          bestIdx  = i;
        }
      }

      if (bestIdx < 0) continue; // æ‰¾ä¸åˆ°é©ç”¨å•†å“

      var rawAmt   = (cpn.amount != null ? cpn.amount : (cpn.off != null ? cpn.off : cpn.discount));
      var discount = Number(rawAmt || 0);
      if (!discount || discount <= 0) discount = 200;
      if (discount > bestBase) discount = bestBase;

      total += discount;
      discountedItemIdx[bestIdx] = true;

      lines.push({
        code:      String(cpn.code || ''),
        deity:     deity,
        amount:    discount,
        itemIndex: bestIdx
      });
    }

    return { total: total, lines: lines, usedItems: discountedItemIdx };
  }

  // ---------- å„ªæƒ åˆ¸æ¸…å–® UIï¼ˆåœ¨è³¼ç‰©è»Šæ¬„ä½ä¸‹æ–¹ï¼‰ ----------
  function deityNameOf(code){
    var m = {
      FM:'å››é¢ç¥',
      GA:'è±¡ç¥',
      CD:'å´‡è¿ª',
      KP:'å¤å¹³',
      HM:'å“ˆé­¯æ›¼',
      RH:'æ‹‰èƒ¡',
      JL:'è¿¦æ¨“ç¾…',
      ZD:'æ¾¤åº¦é‡‘',
      ZF:'æ‹›è²¡å¥³ç¥',
      WE:'äº”çœ¼å››è€³',
      XZ:'å¾ç¥',
      HP:'é­‚é­„å‹‡'
    };
    return m[ normDeity(code) ] || '';
  }

  function ensureCouponListBox(){
    var box = document.getElementById('cartCouponList');
    if (box) return box;

    box = document.createElement('div');
    box.id = 'cartCouponList';
    box.style.marginTop = '6px';
    box.style.display = 'none';
    box.style.fontSize = '13px';
    box.style.lineHeight = '1.6';

    var hint = document.getElementById('cartCouponHint');
    if (hint && hint.parentNode){
      hint.parentNode.insertBefore(box, hint.nextSibling);
    }else{
      var input = document.getElementById('cartCouponInput');
      if (input && input.parentNode){
        input.parentNode.appendChild(box);
      }else{
        document.body.appendChild(box);
      }
    }
    return box;
  }

  function renderCouponList(assignInfo){
    var box = ensureCouponListBox();
    var coupons = getCartCoupons();
    box.innerHTML = '';

    if (!coupons.length){
      box.style.display = 'none';
      return;
    }
    box.style.display = '';

    var items = readCart();
    var assignedLines = (assignInfo && assignInfo.lines) ? assignInfo.lines : [];

    coupons.forEach(function(cpn){
      var row = document.createElement('div');
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'center';
      row.style.gap = '8px';
      row.style.padding = '6px 8px';
      row.style.border = '1px solid #e5e7eb';
      row.style.borderRadius = '8px';
      row.style.marginBottom = '4px';

      var deity = normDeity(cpn.deity || '');
      var dName = deityNameOf(deity);
      var line  = assignedLines.find(function(l){ 
        return String(l.code||'').toUpperCase() === String(cpn.code||'').toUpperCase();
      });
      var appliedText = '';
      if (line && typeof line.itemIndex === 'number'){
        var it = items[line.itemIndex] || {};
        var nm = it.name || it.title || it.productName || 'å•†å“';
        appliedText = 'å·²å¥—ç”¨æ–¼ï¼šã€Œ' + nm + 'ã€ æŠ˜æŠµ ' + tw(line.amount).replace(/^NT\$\s*/, 'NT$ ');
      }else{
        appliedText = 'ç›®å‰å°šæœªæ‰¾åˆ°å¯å¥—ç”¨çš„å•†å“ï¼ˆæˆ–å…¨éƒ¨å•†å“å·²ä½¿ç”¨å…¶ä»–å„ªæƒ ï¼‰';
      }

      var left = document.createElement('div');
      left.innerHTML = ''
        + '<div style="font-weight:700">å„ªæƒ ç¢¼ï¼š'+ String(cpn.code||'') +'</div>'
        + '<div style="color:#6b7280">å®ˆè­·ç¥ï¼š'
        + (deity ? deity + (dName ? 'ï½œ'+dName : '') : 'ä¸é™')
        + '</div>'
        + '<div style="color:#6b7280;font-size:12px">'+ appliedText +'</div>';

      var btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'ç§»é™¤';
      btn.setAttribute('data-coupon-code', String(cpn.code||''));
      btn.style.fontSize = '12px';
      btn.style.padding = '4px 8px';
      btn.style.borderRadius = '8px';
      btn.style.border = '1px solid #ef4444';
      btn.style.background = '#fff';
      btn.style.color = '#ef4444';
      btn.style.cursor = 'pointer';

      row.appendChild(left);
      row.appendChild(btn);
      box.appendChild(row);
    });
  }

  // ---------- åˆè¨ˆé‡‘é¡ï¼šä½¿ç”¨å¤šåˆ¸åˆ†é…çµæœ ----------
  function updateCartTotals(){
    // ç¢ºä¿è³¼ç‰©è»Šå„ªæƒ ç¢¼è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•æ°¸é å¯ä»¥ä½¿ç”¨ï¼ˆä¸æœƒè¢«å…¶ä»–è…³æœ¬é–ä½ï¼‰
    try{
      var _input = document.getElementById('cartCouponInput');
      if (_input){
        _input.disabled = false;
        _input.readOnly = false;
        _input.removeAttribute('disabled');
        _input.removeAttribute('readonly');
      }
      var _btn = document.getElementById('cartApply');
      if (_btn){
        _btn.disabled = false;
        _btn.removeAttribute('disabled');
      }
    }catch(e){}

    var items = readCart();
    var sub   = subTotal(items);
    var coupons = getCartCoupons();
    var assign = assignCouponsToItems(items, coupons);
    var off   = assign.total || 0;
    var grand = Math.max(0, sub - off);


    // å°å¤–è¼¸å‡ºç›®å‰åˆ†é…çµæœï¼Œçµ¦ä¸Šæ–¹ bar / å…¶ä»–æ¨¡çµ„ä½¿ç”¨
    window.__cartCouponState = window.__cartCouponState || {};
    window.__cartCouponState.assignment = assign;

    function setText(selList, val){
      selList.forEach(function(sel){
        try{
          var nodes = [];
          if (typeof sel === 'string') nodes = Array.prototype.slice.call(document.querySelectorAll(sel));
          else if (sel && sel.nodeType === 1) nodes = [sel];
          nodes.forEach(function(n){ n.textContent = val; });
        }catch(_){}
      });
    }

    // å°è¨ˆï¼ˆcart overlay + å…¶ä»–å¯èƒ½çš„é¡¯ç¤ºå€åŸŸï¼‰
    setText([
      '#cartTotal',            // è³¼ç‰©è»Šè¦–çª—ä¸­çš„ã€Œå°è¨ˆã€
      '#cartSubtotal',         // èˆŠç‰ˆå‚™æ´
      '#topSubtotal',          // é ‚éƒ¨ bar
      '[data-cart-subtotal]',
      '.cart-subtotal'
    ], tw(sub));

    // æŠ˜æ‰£ï¼ˆé¡¯ç¤ºæˆ -NT$ xxxï¼‰ï¼›æ²’æœ‰æŠ˜æ‰£æ™‚é¡¯ç¤º -NT$ 0 ä¸¦å¯é¸æ“‡éš±è—æŠ˜æ‰£åˆ—
    var offText = off ? ('-' + tw(off).replace(/^NT\$\s*/, 'NT$ ')) : '-NT$ 0';
    setText([
      '#cartOff',              // è³¼ç‰©è»Šè¦–çª—ä¸­çš„ã€ŒæŠ˜æ‰£ã€
      '#cartDiscount',         // èˆŠç‰ˆå‚™æ´
      '#topDiscount',          // é ‚éƒ¨ bar
      '[data-cart-discount]',
      '.cart-discount'
    ], offText);

    // æ§åˆ¶æŠ˜æ‰£é‚£ä¸€æ•´åˆ—è¦ä¸è¦é¡¯ç¤º
    try{
      var offRow = document.querySelector('.cartSum.cartDiscount');
      if (offRow){ offRow.style.display = off ? '' : 'none'; }
    }catch(_){ }

    // æ‡‰ä»˜é‡‘é¡ / ç¸½é‡‘é¡
    setText([
      '#cartGrandTotal',       // è³¼ç‰©è»Šè¦–çª—ä¸­çš„ã€Œæ‡‰ä»˜é‡‘é¡ã€
      '#cartGrand',            // èˆŠç‰ˆå‚™æ´
      '#cartSum',              // å…¶ä»–èˆŠç‰ˆ ID
      '#topGrand',             // é ‚éƒ¨ bar
      '[data-cart-grand]',
      '.cartGrandTotal',
      '.cart-grand',
      '.cart-total'
    ], tw(grand));

    var hint = document.getElementById('cartCouponHint');
    if (hint){
      var state = hint.getAttribute('data-state') || '';
      if (coupons && coupons.length){
        hint.style.display = '';
        hint.textContent = 'å·²å¥—ç”¨ ' + coupons.length + ' å¼µå„ªæƒ åˆ¸ï¼Œç¸½æŠ˜æŠµ ' + tw(off).replace(/^NT\$\s*/, 'NT$ ');
        hint.style.color = '#059669';
        hint.style.background = 'transparent';
        hint.style.padding = '0';
        hint.style.borderRadius = '0';
        hint.style.marginTop = '0';
        hint.setAttribute('data-state', 'ok');
      }else{
        // è‹¥ç›®å‰æ˜¯éŒ¯èª¤ç‹€æ…‹ï¼Œå°±ä¿ç•™éŒ¯èª¤æç¤ºï¼Œä¸è¦æ¸…ç©º
        if (state !== 'error'){
          hint.style.display = 'none';
          hint.textContent = '';
          hint.style.background = 'transparent';
          hint.style.padding = '0';
          hint.style.borderRadius = '0';
          hint.style.marginTop = '0';
          hint.removeAttribute('data-state');
        }
      }
    }

    // æ¸²æŸ“ã€Œå·²å¥—ç”¨å„ªæƒ åˆ¸ã€æ¸…å–®
    renderCouponList(assign);

  }

  // storage è®Šå‹•å³æ™‚æ›´æ–°
  window.addEventListener('storage', function(ev){
    if (!ev) return;
    if (ev.key === 'cart' || ev.key === '__cartCoupons__'){
      updateCartTotals();
    }
  });
  document.addEventListener('DOMContentLoaded', updateCartTotals);

  // è®“æ–°çš„æŠ˜æ‰£èˆ‡ç¸½é‡‘é¡é‚è¼¯æˆç‚ºå”¯ä¸€ä¾†æºï¼š
  // 1) æŠŠ updateCartTotals æš´éœ²çµ¦å…¶ä»–è…³æœ¬ä½¿ç”¨
  // 2) ç”¨ä½é »ç‡è¨ˆæ™‚å™¨é‡ç®—ï¼Œé¿å…èˆŠçš„è³¼ç‰©è»Šè…³æœ¬åœ¨ä¹‹å¾Œè¦†å¯«ç¸½é‡‘é¡æˆ–æŠ˜æ‰£
  try{
    window.__cartCouponRecalc = updateCartTotals;
    if (!window.__cartGrandWatch){
      window.__cartGrandWatch = setInterval(function(){
        try{ updateCartTotals(); }catch(_){ }
      }, 500);
    }
  }catch(_){ }

  // ---------- é ç«¯æª¢æŸ¥å„ªæƒ ç¢¼ ----------
  async function checkCoupon(code, deity) {
    try {
      // æ”¹ç‚ºå‘¼å«æˆ‘å€‘è‡ªå·±çš„å¾Œç«¯ APIï¼Œç”±å¾Œç«¯å»å®‰å…¨åœ°é©—è­‰å„ªæƒ åˆ¸
      const res = await fetch('/api/coupons/check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ code, deity })
      });
      const data = await res.json();
      return data && data.ok ? data : { ok: false, reason: data.reason || 'check_failed' };
    } catch (e) {
      return { ok: false, reason: 'fetch_error' };
    }
  }

  function computeCartDeitySet(items){
    var set = new Set();
    (items||[]).forEach(function(it){
      var code = itemDeityOf(it);
      if (code) set.add(code);
    });
    return Array.from(set);
  }

  // æª¢æŸ¥æ–°åˆ¸åŠ å…¥å¾Œæ˜¯å¦çœŸçš„èƒ½åˆ†é…åˆ°æŸå€‹å•†å“
  function canAssignCoupon(items, coupons, newCoupon){
    var currentAssign = assignCouponsToItems(items, coupons);
    var withNew = coupons.concat([newCoupon]);
    var assign2 = assignCouponsToItems(items, withNew);

    var beforeCodes = {};
    (currentAssign.lines||[]).forEach(function(l){
      beforeCodes[String(l.code||'').toUpperCase()] = true;
    });

    var added = (assign2.lines||[]).some(function(l){
      var c = String(l.code||'').toUpperCase();
      return c === String(newCoupon.code||'').toUpperCase();
    });
    return added;
  }

  // ---------- å¥—ç”¨å„ªæƒ ç¢¼æŒ‰éˆ•ï¼ˆè³¼ç‰©è»Šï¼‰ ----------
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!(t && t.id === 'cartApply')) return;
    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

    (async function(){
      var input = document.getElementById('cartCouponInput');
      var code = (input && input.value || '').trim().toUpperCase();
      if (!code){
        input && input.focus();
        return;
      }

      var items = readCart();
      if (!items.length){
        alert('è³¼ç‰©è»Šå…§æ²’æœ‰å•†å“ï¼Œç„¡æ³•å¥—ç”¨å„ªæƒ åˆ¸');
        return;
      }

      // ä¸å…è¨±åŒä¸€å¼µåˆ¸é‡è¤‡åŠ å…¥
      var existing = getCartCoupons();
      var dup = existing.some(function(c){
        return String(c.code||'').toUpperCase() === code;
      });
      if (dup){
        var h1 = document.getElementById('cartCouponHint');
        if (h1){
          h1.style.display = '';
          h1.textContent = 'æ­¤å„ªæƒ ç¢¼å·²å¥—ç”¨ï¼Œç„¡éœ€é‡è¤‡ä½¿ç”¨';
          h1.style.color = '#ef4444';
        }else{
          alert('æ­¤å„ªæƒ ç¢¼å·²å¥—ç”¨ï¼Œç„¡éœ€é‡è¤‡ä½¿ç”¨');
        }
        return;
      }

      // è‹¥è³¼ç‰©è»Šåªæœ‰å–®ä¸€å®ˆè­·ç¥ï¼Œå¸¶å…¥ deity ä¾›å¾Œç«¯æª¢æŸ¥
      var deities = computeCartDeitySet(items);
      var deity = deities.length === 1 ? deities[0] : '';

      var res = await checkCoupon(code, deity);
      if (!(res && res.ok)){
        var h2 = document.getElementById('cartCouponHint');
        var msg;
        // å¦‚æœæ˜¯åœ¨åŒä¸€å°è£ç½®ä¸Šé‡è¤‡è¼¸å…¥åŒä¸€å¼µåˆ¸ï¼Œæˆ–å¾Œç«¯åˆ¤å®šè©²åˆ¸å·²ä½¿ç”¨é
        if (res && (res.reason === 'already_used' || res.reason === 'already_used_local')){
          msg = 'æ­¤å„ªæƒ åˆ¸å·²ä½¿ç”¨éï¼Œç„¡æ³•å†æ¬¡ä½¿ç”¨';
        }else{
          // å…¶ä»–æƒ…æ³ï¼ˆå¾Œç«¯å›å‚³ç„¡æ•ˆã€å®ˆè­·ç¥ä¸ç¬¦ç­‰ç­‰ï¼‰ç¶­æŒåŸæœ¬æ–‡æ¡ˆ
          msg = 'å„ªæƒ ç¢¼ç„¡æ•ˆã€å·²ä½¿ç”¨ï¼Œæˆ–ä¸é©ç”¨æ­¤å®ˆè­·ç¥å•†å“';
        }
        if (h2){
          h2.style.display = '';
          h2.textContent = msg;
          h2.style.color = '#ffffff';
          h2.style.background = '#ef4444';
          h2.style.padding = '6px 10px';
          h2.style.borderRadius = '6px';
          h2.style.marginTop = '6px';
          h2.setAttribute('data-state', 'error');
        }else{
          alert(msg);
        }
        return;
      }

      var newCoupon = {
        code:   res.code || code,
        deity:  res.deity || deity || '',
        amount: Number(res.amount||200)||200
      };

      // ç¢ºèªé€™å¼µåˆ¸åŠ å…¥å¾Œï¼Œæ˜¯å¦çœŸçš„èƒ½å¥—ç”¨åˆ°æŸå€‹å•†å“
      var okAssign = canAssignCoupon(items, existing, newCoupon);
      if (!okAssign){
        var h3 = document.getElementById('cartCouponHint');
        var msg = 'ç›®å‰è³¼ç‰©è»Šå…§æ²’æœ‰å¯å¥—ç”¨æ­¤å„ªæƒ åˆ¸çš„å•†å“ï¼Œæˆ–ç›¸é—œå•†å“å·²ä½¿ç”¨å…¶ä»–å„ªæƒ ã€‚';
        if (h3){
          h3.style.display = '';
          h3.textContent = msg;
          h3.style.color = '#ef4444';
        }else{
          alert(msg);
        }
        return;
      }

      // æ­£å¼åŠ å…¥
      existing.push(newCoupon);
      setCartCoupons(existing);
      updateCartTotals();
      try{
        if (input){ input.value = ''; input.focus(); }
      }catch(e){}

      var hint = document.getElementById('cartCouponHint');
      if (hint){
        hint.style.display = '';
        hint.textContent = 'å·²å¥—ç”¨å„ªæƒ ç¢¼ ' + newCoupon.code + 'ï¼Œç›®å‰å…± ' + existing.length + ' å¼µå„ªæƒ åˆ¸ç”Ÿæ•ˆ';
        hint.style.color = '#059669';
        hint.style.background = 'transparent';
        hint.style.padding = '0';
        hint.style.borderRadius = '0';
        hint.style.marginTop = '0';
        hint.setAttribute('data-state', 'ok');
      }
    })();
  }, true);

  // ---------- ã€Œç§»é™¤å„ªæƒ åˆ¸ã€æŒ‰éˆ• ----------
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('button[data-coupon-code]');
    if (!btn) return;
    var code = btn.getAttribute('data-coupon-code') || '';
    if (!code) return;
    e.preventDefault();
    removeCartCoupon(code);
    updateCartTotals();
  });

  // å°‡æ–°ç‰ˆè³¼ç‰©è»Šåˆè¨ˆå‡½å¼å°å¤–å…¬é–‹ï¼Œä¸¦å®šæœŸåˆ·æ–°ï¼Œé¿å…è¢«èˆŠè…³æœ¬è¦†è“‹
  try{
    window.__cartUpdateTotals = updateCartTotals;
  }catch(_){ }
  try{
    // æ¯ 800ms é‡æ–°è¨ˆç®—ä¸€æ¬¡ï¼Œç¢ºä¿ã€Œå°è¨ˆã€èˆ‡ã€Œæ‡‰ä»˜é‡‘é¡ã€å§‹çµ‚ä¸€è‡´
    setInterval(function(){
      try{ updateCartTotals(); }catch(_){ }
    }, 800);
  }catch(_){ }

  // === Unified totals helper for ALL pages (cart + top bar + bank dialog) ===
  // ä¹‹å¾Œæ‰€æœ‰åœ°æ–¹åªè¦å‘¼å« getUnifiedCartTotals()ï¼Œå°±æœƒç”¨åŒä¸€å¥—é‚è¼¯ï¼š
  // è®€å– cart å…§å®¹ + å¤šå¼µå„ªæƒ åˆ¸åˆ†é…çµæœï¼Œç®—å‡ºå°è¨ˆ / æŠ˜æ‰£ / æ‡‰ä»˜é‡‘é¡ã€‚
  try{
    window.getUnifiedCartTotals = function(){
      var items = readCart();
      var coupons = getCartCoupons();
      var assign = assignCouponsToItems(items, coupons);
      var sub    = subTotal(items);
      var off    = assign && assign.total ? assign.total : 0;
      var grand  = Math.max(0, sub - off);
      return {
        items:      items,
        coupons:    coupons,
        assignment: assign,
        sub:        sub,
        off:        off,
        grand:      grand
      };
    };

    // çµ±ä¸€å°å¤–çš„å„ªæƒ åˆ¸ APIï¼Œè®“åŒ¯æ¬¾é æˆ–å…¶ä»–æ¨¡çµ„éƒ½ç”¨åŒä¸€å¥—ç‹€æ…‹
    window.cartCouponAPI = {
      getCoupons:   getCartCoupons,
      setCoupons:   setCartCoupons,
      removeCoupon: removeCartCoupon,
      recalcTotals: updateCartTotals
    };
  }catch(_){}
})();
</script>
<script id="bankCouponBridgeUnified">
(function(){
  if (window.__bankCouponBridgeUnified__) return;
  window.__bankCouponBridgeUnified__ = true;

  function hasUnified(){
    return typeof window.getUnifiedCartTotals === 'function';
  }

  function formatTW(n){
    try{
      return 'NT$ ' + Number(n||0).toLocaleString('zh-TW');
    }catch(e){
      var num = Number(n||0);
      if (!isFinite(num)) num = 0;
      return 'NT$ ' + num.toFixed(0);
    }
  }


  // è®“åŒ¯æ¬¾é é¢çš„é‡‘é¡èˆ‡å„ªæƒ åˆ¸é¡¯ç¤ºï¼Œå®Œå…¨åƒ unified totals
  function refreshBankFromUnified(){
    // --- renderBankOrderItems helper, nested inside refreshBankFromUnified ---
    function renderBankOrderItems(totals){
      var dlg = document.getElementById('dlgBank');
      if (!dlg) return;

      var items = totals && Array.isArray(totals.items) ? totals.items : [];
      var html = '';

      // æ¨™é¡Œ + è¡¨æ ¼ HTML
      html += '<div style="font-weight:800;font-size:18px;margin-bottom:8px;">è¨‚å–®å…§å®¹ç¢ºèª</div>';

      if (!items.length){
        html += '<div style="padding:8px 0;color:#6b7280;">ç›®å‰æ²’æœ‰ä»»ä½•å•†å“ã€‚</div>';
      }else{
        html += '<div style="overflow-x:auto;">';
        html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
        html += '<thead><tr>';
        html += '<th style="text-align:center;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å•†å“åœ–ç‰‡</th>';
        html += '<th style="text-align:left;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å•†å“åç¨±</th>';
        html += '<th style="text-align:right;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å–®åƒ¹</th>';
        html += '<th style="text-align:center;padding:6px 4px;border-bottom:1px solid #e5e7eb;">æ•¸é‡</th>';
        html += '<th style="text-align:right;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å°è¨ˆ</th>';
        html += '</tr></thead><tbody>';

        for (var i = 0; i < items.length; i++){
          var it = items[i] || {};
          var imgSrc = it.img || it.image || it.picture || '';
          var name   = it.name || it.title || it.productName || 'å•†å“';
          var spec   = it.variantName || it.spec || it.deity || '';
          var unit   = Number(it.price != null ? it.price : (it.unit != null ? it.unit : 0)) || 0;
          var qty    = Math.max(1, Number(it.qty != null ? it.qty : (it.quantity != null ? it.quantity : 1)) || 1);
          var subtotal = unit * qty;

          html += '<tr>';
          html += '<td style="padding:6px 4px;text-align:center;vertical-align:top;">';
          if (imgSrc){
            html += '<img src="' + String(imgSrc).replace(/"/g,'&quot;') + '" style="width:60px;height:60px;object-fit:cover;border-radius:8px;background:#f3f4f6;" />';
          }else{
            html += '<div style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;color:#9ca3af;border-radius:8px;font-size:12px;">No Image</div>';
          }
          html += '</td>';

          html += '<td style="padding:6px 4px;vertical-align:top;">'
               +  '<div style="font-weight:600;">' + escapeHtml(name) + '</div>';
          if (spec){
            html += '<div style="color:#6b7280;font-size:12px;">è¦æ ¼ï¼š' + escapeHtml(spec) + '</div>';
          }
          html += '</td>';

          html += '<td style="padding:6px 4px;text-align:right;vertical-align:top;">' + tw(unit) + '</td>';
          html += '<td style="padding:6px 4px;text-align:center;vertical-align:top;">' + qty + '</td>';
          html += '<td style="padding:6px 4px;text-align:right;vertical-align:top;">' + tw(subtotal) + '</td>';
          html += '</tr>';
        }

        html += '</tbody></table></div>';
      }

      // æ‰¾åˆ°æˆ–å»ºç«‹å°ˆç”¨å®¹å™¨ï¼š#bankOrderItemsBox
      var box = document.getElementById('bankOrderItemsBox');
      if (!box){
        box = document.createElement('div');
        box.id = 'bankOrderItemsBox';
        box.style.margin = '0 0 12px 0';

        // å„ªå…ˆæ”¾åœ¨åŒ¯æ¬¾è¡¨å–®ä¹‹å‰ï¼Œæ•´å€‹ dialog åªä¿ç•™é€™ä¸€ä»½è¨‚å–®å…§å®¹
        var form = dlg.querySelector('form');
        if (form && form.parentNode){
          form.parentNode.insertBefore(box, form);
        }else{
          dlg.insertBefore(box, dlg.firstChild);
        }
      }

      box.innerHTML = html;
    }
    // --- end renderBankOrderItems ---
    function hideLegacyOrderSections(dlg){
      if (!dlg) return;
      try{
        var nodes = dlg.querySelectorAll('*');
        for (var i = 0; i < nodes.length; i++){
          var el = nodes[i];
          if (!el) continue;
          var txt = (el.textContent || '').trim();
          if (!txt) continue;
          if (txt.indexOf('è¨‚å–®å…§å®¹ç¢ºèª') !== -1){
            var container = el.closest('section,fieldset,table,tbody,tr,div');
            if (container && container !== dlg){
              container.style.display = 'none';
            }
          }
        }
      }catch(_){ }
    }
    if (!hasUnified()) return;
    var dlg = document.getElementById('dlgBank');
    if (!dlg) return;

    function ensureBankBackButton(dlg){
      if (!dlg || dlg.__hasBackButton) return;
      dlg.__hasBackButton = true;

      var form = dlg.querySelector('form');
      var host = form || dlg;

      var wrapper = document.createElement('div');
      wrapper.style.margin = '0 0 10px 0';

      // ä¸‹æ–¹è¿”å›æŒ‰éˆ•åˆ—
      var btnRow = document.createElement('div');
      btnRow.style.display = 'flex';
      btnRow.style.justifyContent = 'flex-end';

      var backBtn = document.createElement('button');
      backBtn.type = 'button';
      backBtn.id = 'bankBackBtn';
      backBtn.textContent = 'è¿”å›ä¸Šä¸€é ';
      backBtn.style.padding = '6px 12px';
      backBtn.style.borderRadius = '999px';
      backBtn.style.border = '1px solid #e5e7eb';
      backBtn.style.background = '#ffffff';
      backBtn.style.color = '#374151';
      backBtn.style.fontSize = '13px';
      backBtn.style.cursor = 'pointer';

      btnRow.appendChild(backBtn);
      wrapper.appendChild(btnRow);

      var nameInput = dlg.querySelector('#bfName');
      if (nameInput && nameInput.parentNode){
        nameInput.parentNode.parentNode.insertBefore(wrapper, nameInput.parentNode);
      } else {
        host.insertBefore(wrapper, host.firstChild);
      }

      // ç¶å®šè¿”å›é‚è¼¯ï¼šé—œé–‰åŒ¯æ¬¾ Dialogï¼Œè¿”å›è¨‚å–®ç¢ºèªé 
      if (!window.__bankBackBtnHandler__){
        window.__bankBackBtnHandler__ = true;

        document.addEventListener('click', function(e){
          var t = e.target;
          if (!t || t.id !== 'bankBackBtn') return;
          e.preventDefault();

          try{
            var bankDlg = document.getElementById('dlgBank');
            if (bankDlg && bankDlg.open){ bankDlg.close(); }
          }catch(_){ }

          try{
            if (typeof window.__openOrderConfirmDialogUnified === 'function'){
              window.__openOrderConfirmDialogUnified();
            }else{
              var orderDlg = document.getElementById('dlgOrderConfirm');
              if (orderDlg && typeof orderDlg.showModal === 'function'){
                orderDlg.showModal();
              }
            }
          }catch(_){ }
        });
      }
    }

    ensureBankBackButton(dlg);

    var totals = window.getUnifiedCartTotals();
    // Render order items section
    renderBankOrderItems(totals);
    var amtInput = document.getElementById('bfAmount');
    if (amtInput && totals){
      var target = Number(totals.grand || 0);
      if (isFinite(target) && target >= 0){
        // èˆŠè…³æœ¬è‹¥å¯«å…¥åŸåƒ¹ï¼Œæˆ‘å€‘ç›´æ¥è¦†è“‹å›çµ±ä¸€é‡‘é¡
        if (Number(amtInput.value || 0) !== target){
          amtInput.value = target;
        }
      }
    }

    // åŒ¯æ¬¾é åªéœ€è¦é¡¯ç¤ºæç¤ºæ–‡å­—èˆ‡å·²å¥—ç”¨çš„å„ªæƒ åˆ¸æ¸…å–®ï¼Œä¸å†æä¾›è¼¸å…¥åŠŸèƒ½
    var hint   = document.getElementById('bfCouponHint');
    var listBox = ensureBankCouponListBox();

    var coupons = (totals && totals.coupons) || [];
    // --- recompute off from assignment lines if possible ---
    var off = 0;
    if (totals && totals.assignment && Array.isArray(totals.assignment.lines)){
      totals.assignment.lines.forEach(function(l){ off += Number(l.amount||0); });
    } else if (totals && typeof totals.off === 'number'){
      off = Number(totals.off)||0;
    }

    if (hint){
      if (coupons.length){
        hint.style.display = '';
        hint.textContent = 'å·²å¥—ç”¨ ' + coupons.length + ' å¼µè³¼ç‰©è»Šå„ªæƒ åˆ¸ï¼Œç¸½æŠ˜æŠµ ' +
                           formatTW(off).replace(/^NT\$\s*/, 'NT$ ');
      }else{
        hint.style.display = '';
        hint.textContent = 'è‹¥æ¬²ä½¿ç”¨å„ªæƒ åˆ¸ï¼Œè«‹è¿”å›ä¸Šä¸€é è¼¸å…¥å„ªæƒ ç¢¼ä¸¦å¥—ç”¨ã€‚';
      }
    }


    // åœ¨åŒ¯æ¬¾é ä¸‹æ–¹é¡¯ç¤ºã€Œå·²å¥—ç”¨å„ªæƒ åˆ¸æ¸…å–®ã€ï¼Œæ–¹ä¾¿åœ¨é€™è£¡ç›´æ¥ç§»é™¤
    if (listBox){
      listBox.innerHTML = '';
      if (!coupons.length){
        listBox.style.display = 'none';
      }else{
        listBox.style.display = '';
        var assign = (totals && totals.assignment) || { lines: [] };
        var items  = totals.items || [];
        coupons.forEach(function(cpn){
          var code = String(cpn.code || '');
          var line = (assign.lines || []).find(function(l){
            return String(l.code||'').toUpperCase() === code.toUpperCase();
          });
          var it   = line && typeof line.itemIndex === 'number' ? (items[line.itemIndex] || {}) : null;
          var name = it ? (it.name || it.title || it.productName || 'å•†å“') : 'å•†å“';
          var amount = line && line.amount ? line.amount : (cpn.amount || 0);

          var row = document.createElement('div');
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.padding = '6px 8px';
          row.style.border = '1px solid #e5e7eb';
          row.style.borderRadius = '8px';
          row.style.marginTop = '4px';

          var left = document.createElement('div');
          left.style.fontSize = '13px';
          left.style.lineHeight = '1.5';
          left.innerHTML =
            '<div style="font-weight:700">å„ªæƒ ç¢¼ï¼š' + code + '</div>' +
            '<div style="color:#6b7280">å·²å¥—ç”¨æ–¼ï¼šã€Œ' + name +
            'ã€ï¼ŒæŠ˜æŠµ ' + formatTW(amount).replace(/^NT\$\s*/, 'NT$ ') + '</div>';

          var btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = 'ç§»é™¤';
          btn.setAttribute('data-coupon-code', code);
          btn.style.fontSize = '12px';
          btn.style.padding = '4px 8px';
          btn.style.borderRadius = '8px';
          btn.style.border = '1px solid #ef4444';
          btn.style.background = '#fff';
          btn.style.color = '#ef4444';
          btn.style.cursor = 'pointer';

          row.appendChild(left);
          row.appendChild(btn);
          listBox.appendChild(row);
        });
      }
    }
    // --- escapeHtml and tw helpers for renderBankOrderItems ---
    function escapeHtml(s){
      return String(s||'').replace(/[&<>\"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] || m;
      });
    }
    function tw(n){
      try{ return 'NT$ ' + Number(n||0).toLocaleString('zh-TW'); }
      catch(e){ return 'NT$ ' + (Number(n||0).toFixed(0)); }
    }
  }

  function ensureBankCouponListBox(){
    var box = document.getElementById('bfCouponList');
    if (box) return box;

    var dlg = document.getElementById('dlgBank');
    var hintEl = document.getElementById('bfCouponBackHint');

    box = document.createElement('div');
    box.id = 'bfCouponList';
    box.style.marginTop = '10px';
    box.style.fontSize = '13px';
    box.style.lineHeight = '1.5';

    // å°‡å„ªæƒ åˆ¸åˆ—è¡¨æ’å…¥åˆ°æç¤ºæ–‡å­—çš„ä¸‹æ–¹
    if (hintEl && hintEl.parentNode) {
      hintEl.parentNode.insertBefore(box, hintEl.nextSibling);
    } else if (dlg) {
      // Fallback: å¦‚æœæ‰¾ä¸åˆ°æç¤ºæ–‡å­—ï¼Œå°±åŠ åˆ° dialog çš„æœ€ä¸‹æ–¹
      dlg.appendChild(box);
    }
    return box;
  }


  // ç•¶è³¼ç‰©è»Šæˆ–å„ªæƒ åˆ¸ç‹€æ…‹è®Šå‹•æ™‚ï¼Œè‡ªå‹•åˆ·æ–°åŒ¯æ¬¾é é¡¯ç¤º
  window.addEventListener('storage', function(ev){
    if (!ev) return;
    if (ev.key === 'cart' || ev.key === '__cartCoupons__'){
      setTimeout(refreshBankFromUnified, 150);
    }
  });

  // æ¯ç•¶åŒ¯æ¬¾è¦–çª—æ‰“é–‹ & å¡«å¯«è¡¨å–®æ¬„ä½æ™‚ï¼Œéƒ½é‡æ–°å¥—ç”¨ unified é‡‘é¡ï¼Œé¿å…èˆŠè…³æœ¬æ”¹å›åŸåƒ¹
  function tick(){
    var dlg = document.getElementById('dlgBank');
    if (!dlg) return;
    if (dlg.open){
      refreshBankFromUnified();
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // å®šæ™‚å®ˆé–€å“¡ï¼šå°±ç®—æœ‰èˆŠè…³æœ¬å¯«å…¥ bfAmountï¼Œæˆ‘å€‘ä¹Ÿæœƒåœ¨ä¸‹ä¸€å€‹ interval æŠŠå®ƒæ”¹å› unified çµæœ
    try{
      setInterval(tick, 500);
    }catch(_){}
  });
})();
</script>
<script id="bankBackBtn-handler">
(function(){
  if (window.__bankBackBtnHandler__) return; window.__bankBackBtnHandler__ = true;

  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t || t.id !== 'bankBackBtn') return;
    e.preventDefault();

    try{
      var bankDlg = document.getElementById('dlgBank');
      if (bankDlg && bankDlg.open){ bankDlg.close(); }
    }catch(_){ }

    try{
      if (typeof window.__openOrderConfirmDialogUnified === 'function'){
        window.__openOrderConfirmDialogUnified();
      }else{
        var orderDlg = document.getElementById('dlgOrderConfirm');
        if (orderDlg && typeof orderDlg.showModal === 'function'){
          orderDlg.showModal();
        }
      }
    }catch(_){ }
  });
})();
</script>
<script id="coupon-legacy-disable">
(function(){
  // å°‡èˆŠç‰ˆå–®ä¸€å„ªæƒ åˆ¸é‚è¼¯å…¨é¢é™ç´šç‚º no-opï¼Œé¿å…èˆ‡ã€Œcart-coupon-normalize-and-applyã€çš„æ–°å¤šåˆ¸é‚è¼¯ç”¢ç”Ÿè¡çª
  try{
    // 1) é—œæ‰èˆŠç‰ˆå…¨åŸŸç‰©ä»¶ __coupon ä¸Šæ‰€æœ‰å¯èƒ½çš„å‹•ä½œå‡½å¼
    window.__coupon = window.__coupon || {};
    var legacyFns = [
      'updateTotalsDisplay',
      'apply',
      'applyToCart',
      'applyToPending',
      'remove',
      'clear',
      'reset',
      'syncFromStorage',
      'init'
    ];
    legacyFns.forEach(function(k){
      try{ window.__coupon[k] = function(){ /* legacy disabled */ }; }catch(_){ }
    });

    // 2) å¸¸è¦‹èˆŠç‰ˆå…¨åŸŸå‡½å¼åç¨±ï¼šä¸€å¾‹è¦†å¯«ç‚ºç©ºå‡½å¼ï¼Œé¿å…å†æ”¹å‹•é‡‘é¡
    var globalNames = [
      'applyCoupon',
      'applyCartCoupon',
      'applyBankCoupon',
      'cartApplyCoupon',
      'bankApplyCoupon',
      'recalcCartTotals',
      'recalcCouponTotals'
    ];
    globalNames.forEach(function(name){
      try{
        if (typeof window[name] === 'function'){
          window[name] = function(){ /* legacy disabled */ };
        }
      }catch(_){ }
    });

    // 3) æ¸…é™¤èˆŠç‰ˆåœ¨ localStorage / sessionStorage è£¡ä½¿ç”¨çš„æš«å­˜ keyï¼Œé¿å…æ®˜ç•™ -200 æŠ˜æ‰£
    try{
      var lsKeys = [
        '__activeCoupon__',
        '__activeCoupons__',
        'coupon_subtotal',
        'coupon_discount',
        'coupon_grand',
        'coupon_lines'
      ];
      lsKeys.forEach(function(k){ try{ localStorage.removeItem(k); }catch(_){ } });
    }catch(_){ }

    try{
      var ssKeys = [
        '__activeCoupon__',
        '__activeCoupons__',
        'coupon_subtotal',
        'coupon_discount',
        'coupon_grand',
        'coupon_lines'
      ];
      ssKeys.forEach(function(k){ try{ sessionStorage.removeItem(k); }catch(_){ } });
    }catch(_){ }

  }catch(_){ }
})();
</script>


  <!-- çµ±ä¸€è¨‚å–®ç¢ºèª Dialogï¼ˆè³¼ç‰©è»Š & ç›´æ¥çµå¸³å…±ç”¨ï¼‰ -->
  <dialog id="dlgOrderConfirm" style="border:none;border-radius:16px;padding:0;max-width:960px;width:96%;max-height:90vh;overflow:auto;">
    <div style="padding:18px 18px 10px;">
      <div style="font-weight:800;font-size:18px;">ç¢ºèªè¨‚å–®å…§å®¹</div>
      <div style="color:#6b7280;font-size:14px;margin-top:4px">
        è«‹å…ˆç¢ºèªå•†å“ã€æ•¸é‡èˆ‡å„ªæƒ æŠ˜æ‰£æ˜¯å¦æ­£ç¢ºï¼Œå†æŒ‰ä¸‹ä¸€æ­¥å¡«å¯«åŒ¯æ¬¾ / æ”¶ä»¶è³‡è¨Šã€‚
      </div>
    </div>

    <div id="orderItemsBox" style="padding:0 18px 10px;"></div>

    <div id="orderCouponArea" style="padding:0 18px 10px;display:grid;grid-template-columns:minmax(0,1fr) auto;gap:8px;align-items:center;">
      <div style="display:grid;gap:6px">
        <label for="orderCouponInput" style="font-size:12px;color:#6b7280;">å„ªæƒ ç¢¼</label>
        <input id="orderCouponInput" type="text" placeholder="è«‹è¼¸å…¥å„ªæƒ ç¢¼"
               style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;">
        <div id="orderCouponHint" style="font-size:12px;color:#6b7280;line-height:1.6;"></div>
      </div>
      <div style="align-self:flex-end">
        <button type="button" id="orderCouponApply"
                style="padding:10px 16px;border-radius:10px;border:1px solid #16a34a;background:#16a34a;color:#fff;font-weight:600;cursor:pointer;">
          å¥—ç”¨
        </button>
      </div>
    </div>

    <div id="orderTotalsBox" style="padding:0 18px 14px;border-top:1px solid #f3f4f6;margin-top:4px;">
      <div style="display:flex;justify-content:flex-end;font-size:14px;margin-top:6px;">
        <div style="min-width:220px;display:grid;row-gap:4px;">
          <div style="display:flex;justify-content:space-between;">
            <span>å°è¨ˆ</span>
            <span id="orderSubtotalText">NT$ 0</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span>æŠ˜æ‰£</span>
            <span id="orderDiscountText">-NT$ 0</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-weight:800;font-size:15px;margin-top:4px;">
            <span>æ‡‰ä»˜é‡‘é¡</span>
            <span id="orderGrandText">NT$ 0</span>
          </div>
        </div>
      </div>
    </div>

    <div style="padding:0 18px 14px;">
      <div id="orderCouponList" style="font-size:13px;line-height:1.6;"></div>
    </div>

    <div style="padding:0 18px 16px;display:flex;justify-content:flex-end;gap:10px;">
      <button type="button" id="orderCancelBtn"
              style="padding:8px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#374151;cursor:pointer;">
        è¿”å›
      </button>
      <button type="button" id="orderNextBtn"
              style="padding:8px 16px;border-radius:10px;border:none;background:#16a34a;color:#fff;font-weight:700;cursor:pointer;">
        ä¸‹ä¸€æ­¥ï¼šå¡«å¯«è³‡æ–™
      </button>
    </div>
  </dialog>

  <!-- é¸æ“‡é–€å¸‚ Dialogï¼ˆæ’åœ¨è¨‚å–®ç¢ºèªèˆ‡åŒ¯æ¬¾è³‡æ–™ä¹‹é–“ï¼‰ -->
  <dialog id="dlgStore" style="border:none;border-radius:16px;padding:0;max-width:680px;width:96%;max-height:90vh;overflow:auto;">
    <div style="padding:18px 18px 10px;">
      <div style="font-weight:800;font-size:18px;">é¸æ“‡å–è²¨é–€å¸‚</div>
      <div style="color:#6b7280;font-size:14px;margin-top:4px;line-height:1.6;">
        è«‹å…ˆé¸æ“‡ 7-11 å–è²¨é–€å¸‚ï¼Œå†é€²å…¥åŒ¯æ¬¾è³‡è¨Šé é¢
        <br>
        è‹¥æ˜¯è³¼è²·æœå‹™æ€§å•†å“ï¼ˆå¦‚è Ÿç‡­ç¥ˆç¦ç­‰ï¼‰ï¼Œå¯è·³éæ­¤æ­¥é©Ÿç›´æ¥æŒ‰ä¸‹ä¸€æ­¥
      </div>
    </div>

    <form id="storeForm" style="padding:0 18px 16px;display:grid;gap:10px;">
      <div style="display:grid;gap:6px;">
        <label for="bfStorePreview" style="font-size:12px;color:#6b7280;">å–è²¨é–€å¸‚</label>
        <input id="bfStorePreview" type="text" readonly
               placeholder="å°šæœªé¸æ“‡é–€å¸‚"
               style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#f9fafb;color:#4b5563;">
        <div style="font-size:12px;color:#6b7280;">
          è«‹é»é¸ä¸‹æ–¹ã€ŒæŸ¥è©¢ 7-11 é–€å¸‚ã€æŒ‰éˆ•ï¼Œæ–¼åœ°åœ–ä¸­é¸æ“‡é–€å¸‚å¾Œï¼Œé€™è£¡èˆ‡åŒ¯æ¬¾è³‡æ–™é é¢æœƒè‡ªå‹•å¸¶å…¥ç›¸åŒé–€å¸‚
        </div>
      </div>

      <div style="display:flex;justify-content:flex-start;gap:10px;margin-top:4px;">
        <!-- ä½¿ç”¨åŸæœ¬çš„ 7-11 æŸ¥è©¢é–€å¸‚é€£çµé‚è¼¯ï¼šé€™å€‹æŒ‰éˆ•åªè² è²¬è§¸ç™¼ popupï¼Œç”±æ—¢æœ‰è…³æœ¬æ¥æ”¶å›å¡« -->
        <button type="button" id="storeOpenCvsBtn"
                style="padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#ffffff;color:#374151;font-size:13px;cursor:pointer;">
          æŸ¥è©¢ 7-11 é–€å¸‚
        </button>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;">
        <button type="button" id="storeBackBtn"
                style="padding:8px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#ffffff;color:#374151;font-size:13px;cursor:pointer;">
          è¿”å›ä¸Šä¸€é 
        </button>
        <button type="button" id="storeNextBtn"
                style="padding:8px 16px;border-radius:10px;border:none;background:#16a34a;color:#ffffff;font-weight:700;font-size:13px;cursor:pointer;">
          ä¸‹ä¸€æ­¥ï¼šå¡«å¯«åŒ¯æ¬¾è³‡æ–™
        </button>
      </div>
    </form>
  </dialog>
<!-- Remove the element whose inner text contains ã€Œå»ºè­°å…ˆåœ¨ 7-11 å®˜ç¶²æˆ–åœ°åœ–æŸ¥å¥½é–€å¸‚ï¼Œå†å°‡é–€å¸‚åç¨±èˆ‡åœ°å€è²¼åˆ°é€™è£¡ã€ -->

<script id="order-confirm-unified">
(function(){
  if (window.__orderConfirmUnified__) return;
  window.__orderConfirmUnified__ = true;

  function tw(n){
    try{ return 'NT$ ' + Number(n||0).toLocaleString('zh-TW'); }
    catch(e){ var num = Number(n||0); if(!isFinite(num)) num = 0; return 'NT$ ' + num.toFixed(0); }
  }

  // --- å…±ç”¨ï¼šåœ¨ä¸‰å€‹ Dialog ä¸Šæ–¹ç•«å‡º 1/2/3 æ­¥é©Ÿæ¢ ---
  function renderStepBar(dlgId, activeStep){
    try{
      var dlg = document.getElementById(dlgId);
      if (!dlg) return;
      var header = dlg.firstElementChild;
      if (!header) return;

      var bar = dlg.querySelector('.checkout-step-bar');
      if (!bar){
        bar = document.createElement('div');
        bar.className = 'checkout-step-bar';
        bar.style.padding = '0 18px 8px';
        bar.style.display = 'flex';
        bar.style.gap = '8px';
        bar.style.marginTop = '4px';
        header.parentNode.insertBefore(bar, header.nextSibling);
      }

      var steps = [
        { idx:1, label:'ç¢ºèªè¨‚å–®' },
        { idx:2, label:'é¸æ“‡é–€å¸‚' },
        { idx:3, label:'å¡«å¯«åŒ¯æ¬¾è³‡æ–™' }
      ];

      var html = '<div style="display:flex;gap:8px;font-size:12px;color:#6b7280;">';
      steps.forEach(function(s){
        var active = (s.idx === activeStep);
        html += '<div style="flex:1;display:flex;align-items:center;gap:6px;">'
              +   '<div style="width:20px;height:20px;border-radius:999px;display:flex;align-items:center;justify-content:center;'
              +        'font-weight:600;font-size:11px;'
              +        (active ? 'background:#16a34a;color:#ffffff;' : 'background:#e5e7eb;color:#6b7280;')
              +   '\">' + s.idx + '</div>'
              +   '<div style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'
              +        (active ? 'color:#111827;font-weight:600;' : 'color:#6b7280;')
              +   '\">' + s.label + '</div>'
              + '</div>';
      });
      html += '</div>';
      bar.innerHTML = html;
    }catch(e){}
  }

  function readCartLS(){
    try{
      var c = JSON.parse(localStorage.getItem('cart')||'[]');
      return Array.isArray(c) ? c : [];
    }catch(e){ return []; }
  }
  function saveCartLS(cart){
    try{
      localStorage.setItem('cart', JSON.stringify(cart||[]));
      try{
        if (window.cartCouponAPI && typeof window.cartCouponAPI.recalcTotals === 'function'){
          window.cartCouponAPI.recalcTotals();
        }
      }catch(_){ }
      try{
        window.dispatchEvent(new StorageEvent('storage', { key:'cart', newValue: JSON.stringify(cart||[]) }));
      }catch(_){ }
    }catch(e){}
  }

  function getTotals(){
    try{
      if (typeof window.getUnifiedCartTotals === 'function'){
        return window.getUnifiedCartTotals();
      }
    }catch(e){}
    var items = readCartLS();
    var sub = 0;
    items.forEach(function(it){
      var unit = Number(it && (it.price!=null?it.price:it.unit)) || 0;
      var qty  = Number(it && (it.qty!=null?it.qty:it.quantity)) || 1;
      if (qty<1) qty = 1;
      sub += unit * qty;
    });
    return {
      items: items,
      coupons: [],
      assignment:{ total:0, lines:[] },
      sub: sub,
      off: 0,
      grand: sub
    };
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] || m;
    });
  }

  function renderOrderDialog(){
    var dlg  = document.getElementById('dlgOrderConfirm');
    if (!dlg) return;

    var box  = document.getElementById('orderItemsBox');
    var listBox = document.getElementById('orderCouponList');
    var hint = document.getElementById('orderCouponHint');
    var subtotalEl = document.getElementById('orderSubtotalText');
    var discountEl = document.getElementById('orderDiscountText');
    var grandEl    = document.getElementById('orderGrandText');

    var totals = getTotals();
    var items  = totals.items || [];
    var coupons = totals.coupons || [];
    var assign  = totals.assignment || {lines:[], total:0};

    if (!box) return;

    if (!items.length){
      box.innerHTML = '<div style="padding:8px 0;color:#6b7280;">ç›®å‰è³¼ç‰©è»Šæ²’æœ‰ä»»ä½•å•†å“ã€‚</div>';
    }else{
      var html = '';
      html += '<div style="overflow-x:auto;">';
      html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
      html += '<thead><tr>';
      html += '<th style="text-align:left;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å•†å“</th>';
      html += '<th style="text-align:left;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å–®åƒ¹</th>';
      html += '<th style="text-align:center;padding:6px 4px;border-bottom:1px solid #e5e7eb;">æ•¸é‡</th>';
      html += '<th style="text-align:right;padding:6px 4px;border-bottom:1px solid #e5e7eb;">å°è¨ˆ</th>';
      html += '<th style="text-align:center;padding:6px 4px;border-bottom:1px solid #e5e7eb;">æ“ä½œ</th>';
      html += '</tr></thead><tbody>';

      for (var i=0;i<items.length;i++){
        var it   = items[i] || {};
        var name = it.name || it.title || it.productName || 'å•†å“';
        var spec = it.variantName || it.spec || it.deity || '';
        var qty  = Number(it.qty!=null?it.qty:it.quantity) || 1;
        if (qty<1) qty = 1;
        var unit = Number(it.price!=null?it.price:it.unit) || 0;
        var line = unit * qty;
        html += '<tr data-index="'+i+'">';
        html += '<td style="padding:6px 4px;vertical-align:top;">'
             +  '<div style="font-weight:600;">'+ escapeHtml(name) +'</div>'
             +  (spec ? '<div style="color:#6b7280;font-size:12px;">è¦æ ¼ï¼š'+ escapeHtml(spec) +'</div>' : '')
             +  '</td>';
        html += '<td style="padding:6px 4px;vertical-align:top;">'+ tw(unit) +'</td>';
        html += '<td style="padding:6px 4px;text-align:center;vertical-align:top;">'
             +  '<button type="button" class="order-qty-minus" style="width:28px;height:28px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">-</button>'
             +  '<input type="number" class="order-qty-input" min="1" value="'+ qty +'" style="width:56px;margin:0 4px;padding:4px 6px;border-radius:8px;border:1px solid #e5e7eb;text-align:center;font-size:13px;">'
             +  '<button type="button" class="order-qty-plus" style="width:28px;height:28px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">+</button>'
             +  '</td>';
        html += '<td style="padding:6px 4px;text-align:right;vertical-align:top;">'+ tw(line) +'</td>';
        html += '<td style="padding:6px 4px;text-align:center;vertical-align:top;">'
             +  '<button type="button" class="order-remove-item" style="padding:4px 8px;border-radius:8px;border:1px solid #ef4444;background:#fff;color:#ef4444;font-size:12px;cursor:pointer;">ç§»é™¤</button>'
             +  '</td>';
        html += '</tr>';
      }

      html += '</tbody></table></div>';
      box.innerHTML = html;
    }

    if (subtotalEl) subtotalEl.textContent = tw(totals.sub || 0);
    if (discountEl) discountEl.textContent = '-' + tw(totals.off || 0).replace(/^NT\$\s*/, 'NT$ ');
    if (grandEl)    grandEl.textContent    = tw(totals.grand || 0);

    if (hint){
      if (coupons.length){
        hint.style.display = '';
        hint.textContent = 'å·²å¥—ç”¨ ' + coupons.length + ' å¼µå„ªæƒ åˆ¸ï¼Œç¸½æŠ˜æŠµ ' +
                           tw(assign.total || totals.off || 0).replace(/^NT\$\s*/, 'NT$ ');
        hint.style.color = '#059669';
      }else{
        hint.style.display = '';
        hint.textContent = 'å¦‚éœ€ä½¿ç”¨å„ªæƒ åˆ¸ï¼Œè«‹è¼¸å…¥å„ªæƒ ç¢¼å¾ŒæŒ‰ã€Œå¥—ç”¨ã€ã€‚';
        hint.style.color = '#6b7280';
      }
    }

    if (listBox){
      listBox.innerHTML = '';
      if (!coupons.length){
        listBox.style.display = 'none';
      }else{
        listBox.style.display = '';
        coupons.forEach(function(cpn){
          var code = String(cpn.code||'');
          var line = (assign.lines||[]).find(function(l){
            return String(l.code||'').toUpperCase() === code.toUpperCase();
          });
          var it = line && typeof line.itemIndex === 'number' ? (items[line.itemIndex]||{}) : null;
          var nm = it ? (it.name||it.title||it.productName||'å•†å“') : 'å•†å“';
          var amt = line && line.amount ? line.amount : (cpn.amount||0);
          var row = document.createElement('div');
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.style.gap = '8px';
          row.style.padding = '6px 8px';
          row.style.border = '1px solid #e5e7eb';
          row.style.borderRadius = '8px';
          row.style.marginBottom = '4px';
          row.innerHTML =
            '<div style="font-size:13px;line-height:1.5;">'
            +'<div style="font-weight:700;">å„ªæƒ ç¢¼ï¼š'+ escapeHtml(code) +'</div>'
            +'<div style="color:#6b7280;">å·²å¥—ç”¨æ–¼ï¼šã€Œ'+ escapeHtml(nm) +'ã€ï¼ŒæŠ˜æŠµ '+ tw(amt).replace(/^NT\\$\\s*/, "NT$ ") +'</div>'
            +'</div>'
            +'<button type="button" class="order-remove-coupon" data-coupon-code="'+ escapeHtml(code) +'"'
            +' style="font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid #ef4444;background:#fff;color:#ef4444;cursor:pointer;">ç§»é™¤</button>';
          listBox.appendChild(row);
        });
      }
    }
  }

  function openOrderDialog(){
    var dlg = document.getElementById('dlgOrderConfirm');
    if (!dlg) return;
    var totals = getTotals();
    if (!totals.items || !totals.items.length){
      alert('ç›®å‰è³¼ç‰©è»Šæ²’æœ‰å•†å“ï¼Œç„¡æ³•é€²è¡Œçµå¸³');
      return;
    }
    renderOrderDialog();
    renderStepBar('dlgOrderConfirm', 1);
    try{ dlg.showModal(); }catch(e){}
  }

  function closeOrderDialog(){
    var dlg = document.getElementById('dlgOrderConfirm');
    if (!dlg) return;
    try{ dlg.close(); }catch(e){}
  }

  function openBankStep(){
    try{
      if (typeof openBankDialog === 'function'){
        openBankDialog('detail');
        var b = document.getElementById('dlgBank');
        if (b) renderStepBar('dlgBank', 3);
      }else{
        var dlg = document.getElementById('dlgBank');
        if (dlg && typeof dlg.showModal === 'function'){
          renderStepBar('dlgBank', 3);
          dlg.showModal();
        }
      }
    }catch(err){}
  }

  function openStoreDialog(){
    var dlg = document.getElementById('dlgStore');
    if (!dlg){
      // è‹¥å°šæœªå»ºç«‹é–€å¸‚ Dialogï¼Œç›´æ¥é€²åŒ¯æ¬¾æ­¥é©Ÿ
      openBankStep();
      return;
    }
    try{
      try{ syncStorePreviewFromBank(); }catch(e){}
      renderStepBar('dlgStore', 2);
      dlg.showModal();
    }catch(e){}
  }

  function closeStoreDialog(){
    var dlg = document.getElementById('dlgStore');
    if (!dlg) return;
    try{ dlg.close(); }catch(e){}
  }

  function syncStorePreviewFromBank(){
    try{
      var bankInput = document.getElementById('bfStore');
      var preview   = document.getElementById('bfStorePreview');
      if (!preview) return;
      var v = bankInput ? (bankInput.value || '').trim() : '';
      if (v){
        preview.value = v;
      }else{
        preview.value = 'å°šæœªé¸æ“‡é–€å¸‚';
      }
    }catch(e){}
  }
  try{ window.__syncStorePreviewFromBank = syncStorePreviewFromBank; }catch(_){}

  // æ–°å¢ï¼šå°‡é–€å¸‚é è¦½æ¬„ä½çš„è³‡æ–™ï¼ŒåŒæ­¥åˆ°æœ€çµ‚çš„åŒ¯æ¬¾è¡¨å–®æ¬„ä½
  function syncStoreToBankForm(){
    try {
      var previewInput = document.getElementById('bfStorePreview');
      var bankInput = document.getElementById('bfStore');
      if (previewInput && bankInput) {
        bankInput.value = previewInput.value;
      }
    } catch(e) {}
  }
  try{ window.syncStoreToBankForm = syncStoreToBankForm; }catch(e){}


  // --- 7-11 é–€å¸‚é¸æ“‡ï¼špostMessage ç›£è½å™¨ ---
  // ç›£è½ä¾†è‡ª 7-11 callback å½ˆå‡ºè¦–çª—çš„è¨Šæ¯
  window.addEventListener('message', function(ev){
    try {
      var d = ev.data || {};
      // ç¢ºèªæ˜¯æˆ‘å€‘éœ€è¦çš„é–€å¸‚è³‡æ–™
      if (d && d.__cvs_store__) {
        // å‘¼å«çµ±ä¸€çš„å¡«å¯«å‡½å¼ï¼Œå°‡è³‡æ–™å¡«å…¥æ‰€æœ‰ç›¸é—œæ¬„ä½
        if (typeof fillStoreIntoForm === 'function') {
          fillStoreIntoForm(d);
        }
      }
    } catch(e) {}
  });
  // pay711 / cartGo711 é€²å…¥ç¬¬ä¸€æ­¥ï¼šè¨‚å–®ç¢ºèª
  document.addEventListener('click', function(e){
    var t = e.target;
    var btn = t && t.closest && t.closest('#pay711,#cartGo711');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
    openOrderDialog();
  }, true);

  // è¨‚å–®ç¢ºèªã€é–€å¸‚é¸æ“‡ èˆ‡ ä¸‹ä¸€æ­¥ / è¿”å› çš„æŒ‰éˆ•é‚è¼¯
  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('#orderCancelBtn,#orderNextBtn,#storeBackBtn,#storeNextBtn');
    if (!btn) return;
    e.preventDefault();

    if (btn.id === 'orderCancelBtn'){
      closeOrderDialog();
      return;
    }
    if (btn.id === 'orderNextBtn'){
      closeOrderDialog();
      openStoreDialog();
      return;
    }
    if (btn.id === 'storeBackBtn'){
      closeStoreDialog();
      openOrderDialog();
      return;
    }
    if (btn.id === 'storeNextBtn'){
      // å…è¨±æœå‹™æ€§å•†å“ç›´æ¥ç•¥éé–€å¸‚ï¼Œæˆ–åœ¨å·²é¸é–€å¸‚å¾Œé€²å…¥åŒ¯æ¬¾é 
      closeStoreDialog();
      // ç¢ºä¿åœ¨é–‹å•ŸåŒ¯æ¬¾è¦–çª—å‰ï¼Œå°‡é–€å¸‚é¸æ“‡çš„çµæœåŒæ­¥éå»
      try{
        if (typeof window.syncStoreToBankForm === 'function') window.syncStoreToBankForm();
      }catch(e){}
      openBankStep();
      return;
    }
  });

  // æ•¸é‡å¢æ¸› / ç§»é™¤å•†å“ / ç§»é™¤å„ªæƒ åˆ¸
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t) return;
    var row, idx, cart, q;
    if (t.classList && t.classList.contains('order-qty-minus')){
      e.preventDefault();
      row = t.closest('tr[data-index]');
      if (!row) return;
      idx = parseInt(row.getAttribute('data-index'),10);
      cart = readCartLS();
      if (!cart[idx]) return;
      q = Number(cart[idx].qty!=null?cart[idx].qty:cart[idx].quantity) || 1;
      if (q>1) q--;
      cart[idx].qty = q;
      cart[idx].quantity = q;
      saveCartLS(cart);
      renderOrderDialog();
    }else if (t.classList && t.classList.contains('order-qty-plus')){
      e.preventDefault();
      row = t.closest('tr[data-index]');
      if (!row) return;
      idx = parseInt(row.getAttribute('data-index'),10);
      cart = readCartLS();
      if (!cart[idx]) return;
      q = Number(cart[idx].qty!=null?cart[idx].qty:cart[idx].quantity) || 1;
      q++;
      cart[idx].qty = q;
      cart[idx].quantity = q;
      saveCartLS(cart);
      renderOrderDialog();
    }else if (t.classList && t.classList.contains('order-remove-item')){
      e.preventDefault();
      row = t.closest('tr[data-index]');
      if (!row) return;
      idx = parseInt(row.getAttribute('data-index'),10);
      cart = readCartLS();
      if (!cart.length) return;
      cart.splice(idx,1);
      saveCartLS(cart);
      renderOrderDialog();
    }else if (t.classList && t.classList.contains('order-remove-coupon')){
      e.preventDefault();
      var code = t.getAttribute('data-coupon-code') || '';
      if (code && window.cartCouponAPI && typeof window.cartCouponAPI.removeCoupon === 'function'){
        window.cartCouponAPI.removeCoupon(code);
        if (typeof window.cartCouponAPI.recalcTotals === 'function'){
          window.cartCouponAPI.recalcTotals();
        }
      }
      renderOrderDialog();
    }
  });

  document.addEventListener('change', function(e){
    var t = e.target;
    if (!t || !t.classList || !t.classList.contains('order-qty-input')) return;
    var row = t.closest('tr[data-index]');
    if (!row) return;
    var idx = parseInt(row.getAttribute('data-index'),10);
    var cart = readCartLS();
    if (!cart[idx]) return;
    var v = Number(t.value||'1'); if (!isFinite(v) || v<1) v = 1;
    cart[idx].qty = v;
    cart[idx].quantity = v;
    saveCartLS(cart);
    renderOrderDialog();
  });

  // è¨‚å–®ç¢ºèª Dialog å…§è¼¸å…¥å„ªæƒ ç¢¼ï¼Œå¯¦éš›ä»å§”æ´¾çµ¦è³¼ç‰©è»Šæ¬„ä½
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!(t && t.id === 'orderCouponApply')) return;
    e.preventDefault();
    var input = document.getElementById('orderCouponInput');
    var code  = (input && input.value || '').trim();
    if (!code){
      input && input.focus();
      return;
    }
    var cartInput = document.getElementById('cartCouponInput');
    var cartBtn   = document.getElementById('cartApply');
    if (cartInput && cartBtn){
      cartInput.value = code;
      cartBtn.click();
      setTimeout(function(){
        try{
          if (input){ input.value = ''; }
        }catch(_){ }
        renderOrderDialog();
      }, 600);
    }else{
      alert('æ‰¾ä¸åˆ°è³¼ç‰©è»Šå„ªæƒ ç¢¼æ¬„ä½ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  });

  // Expose helper forå…¶ä»–è…³æœ¬ï¼ˆä¾‹å¦‚ bankBackBtn-handlerï¼‰
  try{
    window.__openOrderConfirmDialogUnified   = openOrderDialog;
    window.__renderOrderConfirmDialogUnified = renderOrderDialog;
  }catch(_){ }

  // ç•¶è¦–çª—ç²å¾—ç„¦é»æ™‚ï¼Œè‹¥é–€å¸‚ Dialog é–‹å•Ÿå‰‡åŒæ­¥é è¦½æ¬„ä½
  window.addEventListener('focus', function(){
    try{
      var dlgStore = document.getElementById('dlgStore');
      if (dlgStore && dlgStore.open && typeof syncStorePreviewFromBank === 'function'){
        syncStorePreviewFromBank();
      }
    }catch(e){}
  });

  
  // Step3 åŒ¯æ¬¾é é¢ï¼šå¾é–€å¸‚æ¬„ä½ã€Œè¿”å›ä¸Šä¸€é ä¿®æ”¹é–€å¸‚ã€
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t || t.id !== 'bfBackToStoreBtn') return;
    e.preventDefault();
    try{
      var bankDlg = document.getElementById('dlgBank');
      if (bankDlg && bankDlg.open){ bankDlg.close(); }
    }catch(_){}
    try{
      if (typeof openStoreDialog === 'function'){
        openStoreDialog();
      }else{
        var storeDlg = document.getElementById('dlgStore');
        if (storeDlg && typeof storeDlg.showModal === 'function'){
          renderStepBar('dlgStore', 2);
          storeDlg.showModal();
        }
      }
    }catch(_){}
  }, true);
// é–€å¸‚ Dialog çš„ã€ŒæŸ¥è©¢ 7-11 é–€å¸‚ã€æŒ‰éˆ•ï¼šæ²¿ç”¨ç¾æœ‰ bfStoreLink çš„ href
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t || t.id !== 'storeOpenCvsBtn') return;
    e.preventDefault();
    try {
      // å‹•æ…‹ç”¢ç”Ÿ 7-11 åœ°åœ–çš„ URL
      var base = "https://emap.presco.com.tw/c2cemap.ashx";
      var params = new URLSearchParams();
      params.set("eshopid", "870");
      params.set("servicetype", "1");
      // è¨­å®š callback URL ç‚ºæˆ‘å€‘çš„å¾Œç«¯ Function
      var callbackUrl = new URL("/cvs_callback", location.origin);
      params.set("url", callbackUrl.toString());
      var href = base + "?" + params.toString();

      var w = window.open(href, 'cvs_popup', 'width=980,height=720,resizable=yes,scrollbars=yes');
    }catch(err){}
  });

})();
</script>
  <!-- è¨‚å–®ç‹€æ…‹æŸ¥è©¢ Dialog -->
  <dialog id="dlgLookup" style="border:none;border-radius:16px;padding:0;max-width:560px;width:92%;">
    <div style="padding:18px 18px 10px;">
      <div style="font-weight:800;font-size:18px;">æŸ¥è©¢è¨‚å–®ç‹€æ…‹</div>
      <div style="color:#6b7280;font-size:14px;margin-top:4px">è«‹è¼¸å…¥ <b>æ‰‹æ©Ÿè™Ÿç¢¼</b> èˆ‡ <b>åŒ¯æ¬¾æœ«äº”ç¢¼</b>ï¼ˆå…©è€…çš†é ˆè¼¸å…¥ï¼‰ã€‚</div>
    </div>
    <form id="lookupForm" style="padding:0 18px 16px;display:grid;gap:10px">
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09 é–‹é ­ï¼‰</label>
        <input id="qPhone" name="phone" type="tel" inputmode="tel"
               pattern="^(?:\+?886[-\s]?9\d{8}|09\d{8}|\d{9,13})$" required
               placeholder="ä¾‹ï¼š0969123456 æˆ– +886 969 123 456"
               title="è«‹è¼¸å…¥ 09 é–‹é ­æˆ– +8869 é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå…è¨±ç©ºç™½èˆ‡ç ´æŠ˜è™Ÿï¼‰"
               style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">
      </div>
      <div style="display:grid;gap:6px">
        <label style="font-size:12px;color:#6b7280">åŒ¯æ¬¾æœ«äº”ç¢¼</label>
        <input id="qLast5" name="last5" type="text" pattern="\d{5}" placeholder="12345" title="è«‹è¼¸å…¥åŒ¯æ¬¾æœ«äº”ç¢¼ï¼ˆ5 ä½æ•¸å­—ï¼‰" required
               style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">
      </div>
      <div class="cta" style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
        <button type="button" id="lookupCancel" class="btn">é—œé–‰</button>
        <button type="submit" id="lookupSubmit" class="btn primary">æŸ¥è©¢</button>
      </div>
      <div id="lookupHint" style="font-size:12px;color:#6b7280;line-height:1.6">
        è«‹åŒæ™‚è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡åŒ¯æ¬¾æœ«äº”ç¢¼ã€‚
      </div>
    </form>

    <!-- æç¤ºï¼šæŸ¥è©¢çµæœä¸Šæ–¹ï¼ˆè Ÿç‡­ç¥ˆç¦æˆæœèªªæ˜ï¼‰ -->
    <div id="lookupResultHint" style="padding:0 18px 8px;color:#6b7280;font-size:12px;line-height:1.6">
      è‹¥è¨‚å–®åŒ…å«<span style="font-weight:700">è Ÿç‡­åŠ æŒç¥ˆç¦</span>æœå‹™ï¼Œå®Œæˆå¾Œæœƒåœ¨è©²è¨‚å–®å¡ç‰‡ä¸­å‡ºç¾
      <span style="font-weight:700">æŸ¥çœ‹ç¥ˆç¦æˆæœ</span>æŒ‰éˆ•ï¼Œé»æ“Šå³å¯æŸ¥çœ‹å„€å¼çš„ç…§ç‰‡æˆ–å½±ç‰‡ã€‚
    </div>

    <div id="lookupResult" style="display:none;padding:0 18px 18px">
      <div style="font-weight:800;margin:4px 0 8px">æŸ¥è©¢çµæœ</div>
      <div id="lookupList" style="display:flex;flex-direction:column;gap:10px"></div>
    </div>
  </dialog>

<script>
/* ==== order-lookup script ==== */
(function(){
  // ---------- helpers ----------
  function statusBadge(s){
    var t = String(s||'').trim();
    var cls = 'ok-badge';
    if (t === 'å·²å®Œæˆè¨‚å–®') cls += ' ok-done';
    else if (t === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨') cls += ' ok-paid';
    else if (t === 'å·²å¯„ä»¶') cls += ' ok-ship';
    return '<span class="'+cls+'">'+ (t||'è™•ç†ä¸­') +'</span>';
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m] || m; }); }
  function numTW(v){ try{ return 'NT$ ' + Number(String(v||0).toString().replace(/[^\d.]/g,'')).toLocaleString('zh-TW'); }catch(e){ return String(v||''); } }
  function digitsOnly(s){ return String(s||'').replace(/\D+/g,''); }
  function normalizeTWPhone(s){
    var d = digitsOnly(s);
    if (d.startsWith('8869') && d.length >= 11) return '0' + d.slice(3, 11);
    if (d.startsWith('8860') && d.length >= 13) return d.slice(3, 13);
    if (d.length === 9 && d.startsWith('9')) return '0' + d;
    if (d.length === 10 && d.startsWith('09')) return d;
    if (d.length > 10) return d.slice(-10);
    return d;
  }
  function phonesEqualLoose(a, b){
    var A = normalizeTWPhone(a);
    var B = normalizeTWPhone(b);
    if (!A || !B) return false;
    if (A === B) return true;
    var tA = A.slice(-9), tB = B.slice(-9);
    return (tA && B.endsWith(tA)) || (tB && A.endsWith(tB));
  }
  function matchesOrder(o, phone, last5){
    try{
      var pUser = normalizeTWPhone(phone);
      var l5User = String(last5||'').replace(/\D+/g,'').slice(-5);
      var wantPhone = !!pUser;
      var wantL5 = (l5User.length === 5);

      // Gather as many phone candidates as possible from common schemas
      var phoneCandidates = [
        o && o.phone, o && o.contact, o && o.mobile, o && o.phoneNumber, o && o.contactPhone,
        o && o.recipientPhone, o && o.buyerPhone, o && o.customerPhone,
        // buyer object from your backend schema
        o && o.buyer && (o.buyer.phone || o.buyer.mobile || o.buyer.contactPhone),
        // nested shipping/billing/customer/payment/bank/transfer objects
        o && o.shipping && (o.shipping.phone || o.shipping.contactPhone),
        o && o.billing  && (o.billing.phone  || o.billing.contactPhone),
        o && o.customer && (o.customer.phone || o.customer.mobile || (o.customer.contact && o.customer.contact.phone)),
        o && o.payment  && (o.payment.phone  || o.payment.contactPhone),
        o && o.bank     && (o.bank.phone     || o.bank.contactPhone),
        o && o.transfer && (o.transfer.phone || o.transfer.contactPhone)
      ].filter(Boolean);

      var phoneOk = phoneCandidates.some(function(v){ return phonesEqualLoose(v, pUser); });

      // Try to recover phone from notes/free text
      if (!phoneOk){
        var note = (o && (o.notes || o.note || o.remark || o.memo || '')) || '';
        var digits = digitsOnly(note);
        if (digits){
          var pn = normalizeTWPhone(digits);
          phoneOk = phonesEqualLoose(pn, pUser) || (!!pUser && digits.indexOf(pUser) !== -1);
        }
        // also check nested comment fields
        var cm = o && (o.comment || o.comments);
        if (!phoneOk && typeof cm === 'string'){
          var d2 = digitsOnly(cm);
          var pn2 = normalizeTWPhone(d2);
          phoneOk = phonesEqualLoose(pn2, pUser);
        }
      }

      // Gather last-5 candidates from multiple places
      var last5Candidates = [
        o && o.last5,
        o && o.transferLast5, // root-level field used by current backend
        o && o.payment && (o.payment.last5 || o.payment.ref_last5 || o.payment.lastfive || o.payment.transferLast5),
        o && o.bank    && (o.bank.last5    || o.bank.ref_last5    || o.bank.lastfive    || o.bank.transferLast5),
        o && o.transfer&& (o.transfer.last5|| o.transfer.ref_last5|| o.transfer.lastfive|| o.transfer.transferLast5)
      ].filter(Boolean).map(function(x){ return String(x||'').replace(/\D+/g,'').slice(-5); });

      var l5Ok = last5Candidates.some(function(v){ return v === l5User; });
      
      return phoneOk && l5Ok;
    }catch(e){ return false; }
  }
  function filterOrdersByQuery(list, phone, last5){
    try{
      var arr = Array.isArray(list) ? list : [];
      return arr.filter(function(o){ return matchesOrder(o, phone, last5); });
    }catch(e){ return []; }
  }
  function getAmount(o){
    var a = o && (o.amount || o.total || o.grandTotal || o.price || 0);
    if (!a){
      try{
        var items = Array.isArray(o.items) ? o.items : [];
        a = items.reduce(function(s,it){
          var unit = Number(it.unitPrice||it.price||0);
          var qty  = Number(it.qty||it.quantity||1);
          return s + unit * qty;
        }, 0);
      }catch(_){}
    }
    return a || 0;
  }
  function renderOrders(arr){
    var box = document.getElementById('lookupList');
    var wrap = document.getElementById('lookupResult');
    if (!box || !wrap) return;
    box.innerHTML = '';
    if (!Array.isArray(arr) || !arr.length){
      box.innerHTML = '<div class="ok-muted">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ï¼Œè«‹ç¢ºèªè¼¸å…¥å†å˜—è©¦ã€‚</div>';
      wrap.style.display = '';
      return;
    }
    if (arr.length > 20) arr = arr.slice(0, 20);
    arr.forEach(function(o){
      var id = o.id || o.orderId || '';
      var amt = numTW(getAmount(o));
      var items = Array.isArray(o.items) ? o.items : [];
      var lines = [];
      if (items.length){
        items.forEach(function(it){
          var name = it.name || it.productName || it.title || 'å•†å“';
          var spec = it.variantName || it.spec || it.deity || '';
          var qty  = it.qty || it.quantity || 1;
          var unit = numTW(it.unitPrice||it.price);
          lines.push('<div>'+ escapeHtml(name) +'ï½œå–®åƒ¹ï¼š'+ unit +'ï½œè¦æ ¼ï¼š'+ escapeHtml(spec) +'ï½œæ•¸é‡ï¼š'+ qty +'</div>');
        });
      }else if (o.productName){
        lines.push('<div>'+ escapeHtml(o.productName) +'</div>');
      }
      var div = document.createElement('div');
      div.className = 'ok-card';
      div.innerHTML = ''
        + '<div style="font-weight:800">è¨‚å–®ç·¨è™Ÿï¼š'+ escapeHtml(String(id||'')) +'</div>'
        + '<div class="ok-muted">é‡‘é¡ï¼š'+ amt + (lines.length? 'ï¼ˆä»¥ä¸‹ç‚ºæ˜ç´°ï¼‰' : '') +'</div>'
        + (lines.join('')||'')
        + (o.store ? '<div class="ok-muted">é–€å¸‚ï¼š'+ escapeHtml(o.store) +'</div>' : '')
        + (o.contact ? '<div class="ok-muted">è¯çµ¡æ–¹å¼ï¼š'+ escapeHtml(o.contact) +'</div>' : '')
        + '<div class="ok-row" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;justify-content:space-between;margin-top:8px">'
        +   '<div class="ok-status">'+ statusBadge(o.status) +'</div>'
        +   ( (o && o.resultToken)
              ? ('<div class="ok-actions"><a class="btn" style="padding:6px 10px;font-size:13px" target="_blank" rel="noopener" href="/o/'+ encodeURIComponent(String(id||'')) +'?token='+ encodeURIComponent(String(o.resultToken||'')) +'">æŸ¥çœ‹ç¥ˆç¦æˆæœ</a></div>')
              : '' )
        + '</div>';
      box.appendChild(div);
    });
    wrap.style.display = '';
  }

  // ---------- multi-endpoint lookup ----------
  async function fetchJsonSafe(url, init){
    try{
      var opts = Object.assign({ cache:'no-store' }, init||{});
      var r = await fetch(url, opts);
      var text = await r.text();
      if (!text) return {};
      try{ return JSON.parse(text); }catch(_){ return {}; }
    }catch(e){ return {}; }
  }
  function pickArrayLike(obj){
    if (!obj || typeof obj !== 'object') return [];
    if (Array.isArray(obj)) return obj;
    return obj.orders || obj.items || obj.list || obj.data || [];
  }
  async function tryAllLookups(phone, last5){
    // Normalize inputs
    var pNorm = normalizeTWPhone(phone);
    var l5 = String(last5||'').replace(/\D+/g,'').slice(-5);

    // Compose common query variants (read-only)
    var usp1 = new URLSearchParams();
    usp1.set('phone', phone);
    usp1.set('last5', l5);
    usp1.set('lookupOnly','1');

    var usp2 = new URLSearchParams();
    usp2.set('lookup','1');
    usp2.set('phone', phone);
    usp2.set('last5', l5);

    var headersRO = {'X-Lookup':'phone+last5','X-Read-Only':'1','Cache-Control':'no-cache'};

    var all = [];

    // Helper to add unique array-like results
    function pushArr(x){
      try{
        var arr = pickArrayLike(x);
        if (Array.isArray(arr)) all = all.concat(arr);
      }catch(_){}
    }

    // --- Tier 1: filtered GET endpoints (preferred, zero side effects) ---
    pushArr(await fetchJsonSafe('/api/orders/lookup?'+usp1.toString(), {headers:headersRO}));
    pushArr(await fetchJsonSafe('/api/orders?'+usp1.toString(), {headers:headersRO}));
    pushArr(await fetchJsonSafe('/api/payment/bank?'+usp2.toString(), {headers:headersRO}));

    // --- Tier 2: plain reads (backend may ignore filters), capped by limit param if supported ---
    if (all.length === 0){
      pushArr(await fetchJsonSafe('/api/orders?limit=200', {headers:headersRO}));
      pushArr(await fetchJsonSafe('/api/payment/bank?limit=200', {headers:headersRO}));
    }

    // --- Tier 3: ultimate fallback to bare endpoints (no params) ---
    if (all.length === 0){
      pushArr(await fetchJsonSafe('/api/orders', {headers:headersRO}));
      pushArr(await fetchJsonSafe('/api/payment/bank', {headers:headersRO}));
    }

    // De-dup (by id + amount)
    var seen = new Set();
    var uniq = [];
    for (var i=0;i<all.length;i++){
      var o = all[i] || {};
      var key = (o.id||o.orderId||'') + '|' + String(getAmount(o)||0);
      if (seen.has(key)) continue;
      seen.add(key);
      uniq.push(o);
    }
    return uniq;
  }

  // ---------- UI wiring ----------
  function openLookup(){
    var d = document.getElementById('dlgLookup');
    if (!d) return alert('ç„¡æ³•é¡¯ç¤ºæŸ¥è©¢è¦–çª—');
    try{
      // reset form and result box on every open
      var f = document.getElementById('lookupForm');
      if (f) f.reset();
      var list = document.getElementById('lookupList');
      var wrap = document.getElementById('lookupResult');
      if (list) list.innerHTML = '';
      if (wrap) wrap.style.display = 'none';
      d.showModal();
      // small delay to ensure focus lands after dialog opens
      setTimeout(function(){ try{ document.getElementById('qPhone').focus(); }catch(e){} }, 50);
    }catch(e){
      alert('è«‹ä½¿ç”¨æ”¯æ´å°è©±æ¡†çš„ç€è¦½å™¨');
    }
  }
  document.addEventListener('click', function(e){
    var t = e.target;
    if (t && t.id === 'linkOrderLookup'){ e.preventDefault(); openLookup(); }
    if (t && t.id === 'lookupCancel'){ e.preventDefault(); var d=document.getElementById('dlgLookup'); if(d) d.close(); }
  });

  var form = document.getElementById('lookupForm');
  if (form){
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      e.stopPropagation();
      var phone = (document.getElementById('qPhone').value||'').trim();
      var last5 = (document.getElementById('qLast5').value||'').trim();
      var hasPhone = !!phone.trim();
      var hasLast5 = !!last5.trim();
      if (!hasPhone || !hasLast5){
        alert('è«‹åŒæ™‚è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡åŒ¯æ¬¾æœ«äº”ç¢¼');
        return;
      }
      last5 = String(last5).replace(/\D+/g,'').slice(-5);
      var box = document.getElementById('lookupList');
      var wrap = document.getElementById('lookupResult');
      if (box){ box.innerHTML = '<div class="ok-muted">æŸ¥è©¢ä¸­â€¦</div>'; }
      if (wrap){ wrap.style.display = ''; }

      try{
        var raw = await tryAllLookups(phone, last5);
        var list = filterOrdersByQuery(raw, phone, last5);
        renderOrders(list);
      }catch(err){
        console.error('lookup error', err);
        if (box){ box.innerHTML = '<div class="ok-muted">æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>'; }
      }
    });
  }
  // Expose a helper so other modules can open the lookup dialog with prefilled fields
  window.openOrderLookup = function(phone, last5){
    try{
      openLookup();
      setTimeout(function(){
        try{
          var p = document.getElementById('qPhone');
          var l = document.getElementById('qLast5');
          if (p && typeof phone === 'string') p.value = phone;
          if (l && typeof last5 === 'string') l.value = String(last5).replace(/\D+/g,'').slice(-5);
          // focus on the next empty field
          if (p && !p.value) p.focus();
          else if (l && !l.value) l.focus();
        }catch(e){}
      }, 50);
    }catch(e){}
  };
})();
</script>
<script id="topCouponBar-logic">
(function(){
  function tw(n){ 
    try{ return 'NT$ ' + Number(n||0).toLocaleString('zh-TW'); }
    catch(e){ return 'NT$ ' + (Number(n||0).toFixed(0)); }
  }
  function readCart(){ 
    try{ var c = JSON.parse(localStorage.getItem('cart')||'[]'); return Array.isArray(c)?c:[]; }
    catch(e){ return []; } 
  }
  function subTotal(items){
    try{
      return items.reduce(function(s,it){
        return s + Number(it.price||0)*Math.max(1,Number(it.qty||1));
      },0);
    }catch(e){ return 0; }
  }

  // è®“é ‚éƒ¨ bar å„ªå…ˆä½¿ç”¨ window.__cartCouponState.assignment çš„æŠ˜æ‰£
  function getCurrentDiscountTotal(){
    try{
      if (window.__cartCouponState && window.__cartCouponState.assignment){
        return Number(window.__cartCouponState.assignment.total||0) || 0;
      }
    }catch(e){}
    // å¾Œå‚™ï¼šè‹¥å°šæœªå»ºç«‹å¤šåˆ¸ç‹€æ…‹ï¼Œé è¨­ 0ï¼ˆç”±è³¼ç‰©è»Šè…³æœ¬è² è²¬ä¸»å°æŠ˜æ‰£ï¼‰
    return 0;
  }

  function updateTopTotals(){
    try{
      var items = readCart();
      var sub   = subTotal(items);
      var off   = getCurrentDiscountTotal();
      var grand = Math.max(0, sub - off);

      var elSub   = document.getElementById('topSubtotal');
      var elOff   = document.getElementById('topDiscount');
      var elGrand = document.getElementById('topGrand');
      if (elSub)   elSub.textContent   = tw(sub);
      if (elOff)   elOff.textContent   = off ? ('-' + tw(off).replace(/^NT\$\s*/, 'NT$ ')) : 'NT$ 0';
      if (elGrand) elGrand.textContent = tw(grand);

      var hint = document.getElementById('topCouponHint');
      if (hint){
        var cps = (window.__cartCouponState && window.__cartCouponState.coupons) || [];
        if (cps && cps.length){
          hint.style.display = '';
          hint.textContent = 'å·²å¥—ç”¨ ' + cps.length + ' å¼µå„ªæƒ åˆ¸ï¼Œç¸½æŠ˜æŠµ ' 
                             + tw(off).replace(/^NT\$\s*/, 'NT$ ');
        }else{
          hint.style.display = 'none';
          hint.textContent = '';
        }
      }
    }catch(e){}
  }

  function applyTopCoupon(){
    try{
      var input = document.getElementById('topCouponInput');
      var code = (input && input.value || '').trim();
      if (!code){
        input && input.focus();
        return;
      }
      var cartInput = document.getElementById('cartCouponInput');
      var cartBtn   = document.getElementById('cartApply');
      if (!cartInput || !cartBtn){
        alert('æ‰¾ä¸åˆ°è³¼ç‰©è»Šå„ªæƒ ç¢¼æ¬„ä½ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
      }
      cartInput.value = code;
      cartBtn.click();
      setTimeout(updateTopTotals, 300);
    }catch(e){}
  }

  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'topCouponApply'){
      e.preventDefault();
      applyTopCoupon();
    }
  });

  document.addEventListener('DOMContentLoaded', updateTopTotals);
  window.addEventListener('storage', function(ev){
    if (!ev) return;
    if (ev.key === 'cart' || ev.key === '__cartCoupons__'){
      updateTopTotals();
    }
  });
})();
</style>

<script id="product-image-fallback-fix">
(function(){
  if (window.__productImageFix__) return; window.__productImageFix__ = true;
  var PLACEHOLDER = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600" viewBox="0 0 600 600">\n'
    + '<rect width="100%" height="100%" fill="#f3f4f6"/>\n'
    + '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20" font-family="-apple-system,system-ui,Segoe UI,Roboto">No Image</text>\n'
    + '</svg>'
  );

  function fixOne(img){
    if (!img || img.__fixed) return; img.__fixed = true;
    // lazy helpers
    img.loading = img.loading || 'lazy';
    img.decoding = 'async';
    // è‹¥ src ç©ºæˆ–åªå«ç©ºç™½ï¼Œå¥— placeholder
    var s = (img.getAttribute('src')||'').trim();
    if (!s){ img.setAttribute('src', PLACEHOLDER); }
    // onerror fallback
    img.addEventListener('error', function(){
      if (img.getAttribute('src') !== PLACEHOLDER){ img.setAttribute('src', PLACEHOLDER); }
    });
  }

  function scan(){
    try{
      var list = document.querySelectorAll('.card .pic img');
      for (var i=0;i<list.length;i++) fixOne(list[i]);
    }catch(e){}
  }

  // åˆæ¬¡èˆ‡å¾ŒçºŒåˆ·æ–°ï¼ˆå•†å“é‡æ–°æ¸²æŸ“ï¼‰
  document.addEventListener('DOMContentLoaded', scan);
  var mo; try{
    mo = new MutationObserver(function(){ scan(); });
    mo.observe(document.documentElement, { childList:true, subtree:true });
  }catch(e){ setInterval(scan, 1000); }
})();
</script>
<script id="coupon-deity-normalize">
(function(){
  if (window.__couponDeityNormalize__) return; window.__couponDeityNormalize__ = true;

  // --- deity inference from product name/title (both zh & en keywords) ---
  function inferDeityFromName(name){
    var s = (name||'').toString().toUpperCase();
    // Chinese keywords don't need case conversion, but keep both checks on same source string
    var raw = (name||'').toString();
    if (/å››é¢ç¥|BRAHMA|PHRA\s*PHROM|PHROM|ERAWAN/i.test(raw)) return 'FM';
    if (/è±¡ç¥|GANESHA|PHIKANET|PHIKANES|PIKANES/i.test(raw)) return 'GA';
    if (/å´‡è¿ª|SOMDEJ|SOMDET/i.test(raw)) return 'CD';
    if (/å¤å¹³|KHUN\s*PHAEN|KHUN\s*PAEN|K\.?P\.?/i.test(raw)) return 'KP';
    if (/å“ˆé­¯æ›¼|H(AN|AR)UMAN/i.test(raw)) return 'HM';
    if (/æ‹‰èƒ¡|RAHU/i.test(raw)) return 'RH';
    if (/è¿¦æ¨“ç¾…|GARUDA|K(AR|AL)UDA/i.test(raw)) return 'JL';
    if (/æ¾¤åº¦é‡‘|JATUKAM|R(AM|A)MATHEP|ZEDO(G|K)ON|ZEDUKIN/i.test(raw)) return 'ZD';
    if (/æ‹›è²¡å¥³ç¥|LAKSHMI|LAXSHMI|LAMSI/i.test(raw)) return 'ZF';
    if (/äº”çœ¼å››è€³|FIVE[\-\s]*EYES|5EYES|FIVEEYES/i.test(raw)) return 'WE';
    if (/å¾ç¥|XU\s*ZHU|XUZHU/i.test(raw)) return 'XZ';
    if (/é­‚é­„å‹‡|HUN\s*PO\s*YONG|HPY/i.test(raw)) return 'HP';
    return '';
  }

  // Normalize deity for a single cart/pending item
  function normalizeItemDeity(it){
    if (!it || typeof it !== 'object') return it;
    var d = it.deity ? String(it.deity).toUpperCase() : '';
    if (!d){
      var nm = it.name || it.title || it.productName || '';
      d = inferDeityFromName(nm);
    }
    if (d) it.deity = d;
    return it;
  }

  // Normalize entire cart
  function normalizeCart(){
    try{
      var cart = JSON.parse(localStorage.getItem('cart')||'[]');
      if (Array.isArray(cart) && cart.length){
        var changed = false;
        for (var i=0;i<cart.length;i++){
          var before = cart[i] && cart[i].deity;
          normalizeItemDeity(cart[i]);
          if ((cart[i] && cart[i].deity) !== before) changed = true;
        }
        if (changed){
          localStorage.setItem('cart', JSON.stringify(cart));
          // notify observers (totals bar, etc.)
          try{ window.dispatchEvent(new StorageEvent('storage', { key:'cart', newValue: JSON.stringify(cart) })); }catch(e){}
        }
      }
    }catch(e){}
  }

  // Normalize pending detail (direct-buy path)
  function normalizePending(){
    try{
      var raw = sessionStorage.getItem('__pendingDetail__');
      if (!raw) return;
      var p = JSON.parse(raw);
      var before = p && p.deity;
      normalizeItemDeity(p);
      if (before !== p.deity){
        sessionStorage.setItem('__pendingDetail__', JSON.stringify(p));
      }
    }catch(e){}
  }

  // Compute "current deity" for /check fallback (when getPendingDeity() returns blank)
  function computeCurrentDeity(){
    // 1) pending first
    try{
      var p = JSON.parse(sessionStorage.getItem('__pendingDetail__')||'null');
      if (p && p.deity) return String(p.deity).toUpperCase();
    }catch(e){}
    // 2) if cart has only one distinct deity, use it
    try{
      var cart = JSON.parse(localStorage.getItem('cart')||'[]');
      if (Array.isArray(cart) && cart.length){
        var set = new Set();
        cart.forEach(function(it){
          if (it && it.deity) set.add(String(it.deity).toUpperCase());
          else {
            var d = inferDeityFromName((it && (it.name||it.title||''))||'');
            if (d) set.add(d);
          }
        });
        if (set.size === 1) return Array.from(set)[0];
      }
    }catch(e){}
    // 3) fallback: from current product dialog dataset/name
    try{
      var dlg = document.getElementById('dlg');
      var d = (dlg && (dlg.getAttribute('data-product-deity') || dlg.getAttribute('data-deity'))) || '';
      if (d) return String(d).toUpperCase();
      var nm = (document.getElementById('dlgTitle') && document.getElementById('dlgTitle').textContent) || '';
      var g = inferDeityFromName(nm);
      if (g) return g;
    }catch(e){}
    return '';
  }

  // Hook coupon "å¥—ç”¨" æŒ‰éˆ•ï¼Œè‹¥ deity å–ä¸åˆ°å‰‡ç”¨ computeCurrentDeity()
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!(t && t.id === 'bfCouponApply')) return;
    setTimeout(function(){
      try{
        // normalize first
        normalizePending();
        normalizeCart();
        // if the existing script's getPendingDeity()å›å‚³ç©ºï¼Œé€™è£¡è£œä¸Š dataset
        var deity = computeCurrentDeity();
        if (deity){
          // æš«å­˜åˆ° session è®“åŸæµç¨‹ä¹Ÿèƒ½æ‹¿åˆ°
          try{
            var raw = sessionStorage.getItem('__pendingDetail__');
            var obj = raw ? JSON.parse(raw) : {};
            if (typeof obj !== 'object' || !obj) obj = {};
            obj.deity = deity;
            sessionStorage.setItem('__pendingDetail__', JSON.stringify(obj));
          }catch(e){}
        }
      }catch(e){}
    }, 0);
  }, true);

  // When opening the bank dialog, normalize first
  document.addEventListener('click', function(e){
    var t = e.target;
    if (t && (t.id==='pay711' || t.id==='cartGo711' || (t.closest && t.closest('#pay711,#cartGo711')))){
      setTimeout(function(){ normalizePending(); normalizeCart(); }, 0);
    }
  }, true);

  // Initial pass on load
  document.addEventListener('DOMContentLoaded', function(){
    normalizePending();
    normalizeCart();
  });
})();
</script>

<script id="api-path-interceptor">
(function() {
  // 1. å¾ meta æ¨™ç±¤è®€å– API çš„åŸºç¤è·¯å¾‘
  const meta = document.querySelector('meta[name="api-base"]');
  // å¦‚æœæ‰¾ä¸åˆ° meta æ¨™ç±¤ï¼Œé è¨­ä½¿ç”¨ç›¸å°è·¯å¾‘ "/"
  const apiBase = (meta ? meta.getAttribute('content') : '/').replace(/\/$/, '');

  // å¦‚æœåŸºç¤è·¯å¾‘åªæ˜¯æ ¹ç›®éŒ„ "/"ï¼Œå‰‡ä¸éœ€è¦æ””æˆªï¼Œç€è¦½å™¨æœƒè‡ªå‹•è™•ç†
  if (apiBase === '' || apiBase === '/') {
    return;
  }

  // 2. å„²å­˜åŸå§‹çš„ fetch å‡½å¼
  const originalFetch = window.fetch;

  // 3. å»ºç«‹ä¸€å€‹æ–°çš„ fetch å‡½å¼ä¾†è¦†è“‹åŸå§‹çš„
  window.fetch = function(input, init) {
    let url = input;

    // 4. æª¢æŸ¥è«‹æ±‚çš„ URL æ˜¯å¦ç‚ºæŒ‡å‘æˆ‘å€‘ API çš„ç›¸å°è·¯å¾‘
    if (typeof input === 'string' && input.startsWith('/api/')) {
      // 5. å°‡ç›¸å°è·¯å¾‘èˆ‡åŸºç¤è·¯å¾‘çµ„åˆï¼Œå½¢æˆå®Œæ•´çš„ API ç¶²å€
      url = apiBase + input;
    }

    // 6. ä½¿ç”¨ä¿®æ­£å¾Œçš„ URL å‘¼å«åŸå§‹çš„ fetch å‡½å¼
    return originalFetch.call(this, url, init);
  };
})();

// ç¢ºä¿åœ¨æ‰€æœ‰è…³æœ¬ï¼ˆåŒ…å«æ””æˆªå™¨ï¼‰éƒ½è¼‰å…¥å¾Œæ‰åŸ·è¡Œ main.js çš„ä¸»è¦é‚è¼¯
document.addEventListener('DOMContentLoaded', function() {
  if (typeof window.runMain === 'function') {
    window.runMain();
  }
});
</script>
<script src="/js/utils.js"></script>
<script src="/js/cart.js"></script>
<script src="/js/ui.js"></script>
<script src="/js/main.js"></script>
<script src="/js/checkout.js"></script>
<script id="story-submission-logic">
document.addEventListener('DOMContentLoaded', function() {
  const submitBtn = document.getElementById('rvSubmit');
  if (!submitBtn) return;

  // ç‚ºäº†å®‰å…¨åœ°è¦†è“‹æ‰å¯èƒ½å­˜åœ¨æ–¼å¤–éƒ¨ JS æª”æ¡ˆä¸­çš„èˆŠç‰ˆé»æ“Šäº‹ä»¶ï¼Œ
  // æˆ‘å€‘è¤‡è£½æŒ‰éˆ•ä¸¦å–ä»£å®ƒï¼Œé€™æ¨£å¯ä»¥æ¸…é™¤æ‰€æœ‰èˆŠçš„äº‹ä»¶ç›£è½å™¨ã€‚
  const newBtn = submitBtn.cloneNode(true);
  submitBtn.parentNode.replaceChild(newBtn, submitBtn);

  newBtn.addEventListener('click', async function(event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();

    const dlg = document.getElementById('dlg');
    // ç•™è¨€æ˜¯è·Ÿè‘—ã€Œç¥ç¥‡ã€çš„ï¼Œæˆ‘å€‘ç›´æ¥å¾å•†å“è¦–çª—çš„è³‡æ–™å±¬æ€§ä¸­å–å¾—ç¥ç¥‡ä»£ç¢¼
    // å¾Œç«¯ API ç¾åœ¨æœƒç¢ºä¿æ‰€æœ‰å•†å“éƒ½æœ‰ deityCode
    const productCode = (() => {
      if (!dlg) return '';
      const raw = dlg.getAttribute('data-product-deitycode')
        || dlg.getAttribute('data-product-deity')
        || dlg.getAttribute('data-deity')
        || dlg.dataset.productDeitycode
        || dlg.dataset.productDeityCode
        || dlg.getAttribute('data-product-name')
        || '';
      const code = (typeof toDeityCode === 'function') ? (toDeityCode(raw) || raw) : raw;
      return (code || '').toString().trim().toUpperCase();
    })();

    if (!productCode) {
      alert('ç„¡æ³•å–å¾—å•†å“è³‡è¨Šï¼Œè«‹é‡æ–°é–‹å•Ÿå•†å“è¦–çª—ã€‚');
      return;
    }

    const nickInput = document.getElementById('rvNick');
    const textInput = document.getElementById('rvText');
    const fileInput = document.getElementById('rvFile');

    const nick = nickInput ? nickInput.value.trim() : '';
    const msg = textInput ? textInput.value.trim() : '';
    const file = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;

    if (!nick) {
      alert('è«‹è¼¸å…¥æ‚¨çš„åå­—æˆ–æš±ç¨±ã€‚');
      nickInput.focus();
      return;
    }
    if (!msg) {
      alert('è«‹åˆ†äº«æ‚¨çš„é«”é©—æˆ–æ•…äº‹ã€‚');
      textInput.focus();
      return;
    }

    newBtn.disabled = true;
    newBtn.textContent = 'é€å‡ºä¸­...';

    try {
      let imageUrl = '';
      if (file) {
        const formData = new FormData();
        formData.append('files[]', file);
        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
        const uploadData = await uploadRes.json();
        if (!uploadRes.ok || !uploadData.ok || !uploadData.files || !uploadData.files.length) throw new Error(uploadData.error || 'åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
        imageUrl = uploadData.files[0].url;
      }

      const storyPayload = { code: productCode, nick: nick, msg: msg, imageUrl: imageUrl };
      const storyRes = await fetch('/api/stories', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(storyPayload) });
      const storyData = await storyRes.json();
      if (!storyRes.ok || !storyData.ok) throw new Error(storyData.error || 'é€å‡ºåˆ†äº«å¤±æ•—');

      alert('æ„Ÿè¬æ‚¨çš„åˆ†äº«ï¼');
      if (nickInput) nickInput.value = '';
      if (textInput) textInput.value = '';
      if (fileInput) fileInput.value = '';
      if (typeof loadReviews === 'function') loadReviews(productCode);
    } catch (err) {
      alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
    } finally {
      newBtn.disabled = false;
      newBtn.textContent = 'é€å‡ºåˆ†äº«';
    }
  });
});
</script>
<script id="story-display-logic">
// This function will be called to load and display stories/reviews.
// It's designed to override any existing `loadReviews` function.
window.loadReviews = async function(productCode) {
  const listEl = document.getElementById('rvList');
  if (!listEl) return;

  listEl.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:10px;">è®€å–ä¸­...</div>';

  try {
    const code = (productCode || '').toString().trim().toUpperCase();
    if (!code) throw new Error('ç„¡æ³•å–å¾—ç•™è¨€ä»£ç¢¼');
    const cacheBust = new Date().getTime();
    const res = await fetch(`/api/stories?code=${encodeURIComponent(code)}&_=${cacheBust}`);
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error('ç„¡æ³•è®€å–ç•™è¨€');

    listEl.innerHTML = ''; // Clear loading message

    if (!data.items || data.items.length === 0) {
      // The empty state is now handled by the CSS :empty::before pseudo-element
      return;
    }

    data.items.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'rvItem';

      // 1. Create image element (if imageUrl exists)
      if (item.imageUrl) {
        const link = document.createElement('a');
        link.href = escapeHtml(item.imageUrl);
        link.target = '_blank';
        link.rel = 'noopener';
        link.innerHTML = `<img src="${escapeHtml(item.imageUrl)}" class="rvImage" loading="lazy" alt="é¡§å®¢åˆ†äº«çš„åœ–ç‰‡">`;
        itemEl.appendChild(link);
      }

      // 2. Create a container for all text content
      const contentEl = document.createElement('div');
      contentEl.className = 'rvContent';

      // Format date to YYYY-MM-DD HH:mm:ss (24h)
      const date = new Date(item.ts).toLocaleString('zh-TW', {
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        hour12:false
      });

      contentEl.innerHTML = `
        <div class="rvHead">
          <strong class="rvNick">${escapeHtml(item.nick)}</strong>
          <span class="rvDate">${date}</span>
        </div>
        <div class="rvMsg">${escapeHtml(item.msg)}</div>
      `;
      itemEl.appendChild(contentEl);

      listEl.appendChild(itemEl);
    });

  } catch (err) {
    listEl.innerHTML = `<div style="text-align:center; color:#ef4444; padding:10px;">${err.message || 'è®€å–å¤±æ•—'}</div>`;
  }
};

// Helper to escape HTML to prevent XSS
function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>

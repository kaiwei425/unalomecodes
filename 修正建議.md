# ä»£ç ä¿®æ­£å»ºè®®æŠ¥å‘Š

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. å®‰å…¨æ€§é—®é¢˜

#### 1.1 XSS æ¼æ´é£é™©
**ä½ç½®**: å¤šå¤„ä½¿ç”¨ `innerHTML` ç›´æ¥æ’å…¥ç”¨æˆ·è¾“å…¥

**é—®é¢˜ä»£ç ç¤ºä¾‹**:
```javascript
// js/main.js, js/ui.js ç­‰
card.innerHTML = `<div>${escapeHtml(p.name)}</div>`; // éƒ¨åˆ†è½¬ä¹‰ï¼Œä½†ä¸å®Œæ•´
div.innerHTML = rows.map(...).join(''); // å¯èƒ½åŒ…å«æœªè½¬ä¹‰å†…å®¹
```

**ä¿®æ­£å»ºè®®**:
```javascript
// ä½¿ç”¨ textContent æ›¿ä»£ innerHTMLï¼Œæˆ–ç¡®ä¿å®Œæ•´è½¬ä¹‰
function safeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// æˆ–ä½¿ç”¨ DOMPurify åº“
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInput);
```

#### 1.2 æ•æ„Ÿä¿¡æ¯æ³„éœ²
**ä½ç½®**: `functions/[[path]].handler.js`

**é—®é¢˜**:
- é”™è¯¯ä¿¡æ¯å¯èƒ½æ³„éœ²ç³»ç»Ÿå†…éƒ¨ç»“æ„
- è°ƒè¯•ä¿¡æ¯æš´éœ²åœ¨æ§åˆ¶å°

**ä¿®æ­£å»ºè®®**:
```javascript
// ç”Ÿäº§ç¯å¢ƒéšè—è¯¦ç»†é”™è¯¯
const isDev = env.ENVIRONMENT === 'development';
return json({ 
  ok: false, 
  error: isDev ? err.message : 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' 
}, 500);
```

#### 1.3 localStorage æ•°æ®æœªåŠ å¯†
**ä½ç½®**: `js/cart.js`, `js/auth.js` ç­‰

**é—®é¢˜**: è´­ç‰©è½¦ã€ç”¨æˆ·åå¥½ç­‰æ•æ„Ÿæ•°æ®æ˜æ–‡å­˜å‚¨

**ä¿®æ­£å»ºè®®**:
```javascript
// å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œç®€å•åŠ å¯†
function encryptData(data) {
  // ä½¿ç”¨ Web Crypto API æˆ–ç®€å•ç¼–ç 
  return btoa(JSON.stringify(data));
}

function decryptData(encrypted) {
  try {
    return JSON.parse(atob(encrypted));
  } catch {
    return null;
  }
}
```

#### 1.4 CORS é…ç½®è¿‡äºå®½æ¾
**ä½ç½®**: `functions/[[path]].handler.js:4`

**é—®é¢˜**:
```javascript
'Access-Control-Allow-Origin': '*', // å…è®¸æ‰€æœ‰æ¥æº
```

**ä¿®æ­£å»ºè®®**:
```javascript
// ä½¿ç”¨åŠ¨æ€ CORSï¼Œåªå…è®¸ä¿¡ä»»çš„æ¥æº
const allowedOrigins = [
  'https://shop.unalomecodes.com',
  'https://unalomecodes.pages.dev'
];
const origin = request.headers.get('Origin');
if (allowedOrigins.includes(origin)) {
  headers['Access-Control-Allow-Origin'] = origin;
}
```

### 2. ä»£ç è´¨é‡é—®é¢˜

#### 2.1 å·¨å‹æ–‡ä»¶é—®é¢˜
**ä½ç½®**: `functions/[[path]].handler.js` (10,000+ è¡Œ)

**é—®é¢˜**: å•ä¸ªæ–‡ä»¶è¿‡å¤§ï¼Œéš¾ä»¥ç»´æŠ¤

**ä¿®æ­£å»ºè®®**:
```
functions/
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ products.js      # å•†å“ç›¸å…³ API
â”‚   â”œâ”€â”€ orders.js        # è®¢å•ç›¸å…³ API
â”‚   â”œâ”€â”€ auth.js          # è®¤è¯ç›¸å…³ API
â”‚   â”œâ”€â”€ coupons.js       # ä¼˜æƒ åˆ¸ API
â”‚   â”œâ”€â”€ stories.js       # æ•…äº‹åˆ†äº« API
â”‚   â””â”€â”€ admin.js         # ç®¡ç†å‘˜ API
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ validation.js    # æ•°æ®éªŒè¯
â”‚   â”œâ”€â”€ rate-limit.js    # é™æµå·¥å…·
â”‚   â””â”€â”€ cors.js          # CORS å¤„ç†
â””â”€â”€ [[path]].handler.js  # è·¯ç”±åˆ†å‘å™¨
```

#### 2.2 é”™è¯¯å¤„ç†ä¸å®Œæ•´
**ä½ç½®**: å¤šå¤„ä½¿ç”¨ `catch(_){}` å¿½ç•¥é”™è¯¯

**é—®é¢˜ä»£ç **:
```javascript
try {
  // é‡è¦æ“ä½œ
} catch(_) {} // é™é»˜å¿½ç•¥é”™è¯¯
```

**ä¿®æ­£å»ºè®®**:
```javascript
try {
  // é‡è¦æ“ä½œ
} catch(err) {
  console.error('[æ¨¡å—å] æ“ä½œå¤±è´¥:', err);
  // è‡³å°‘è®°å½•é”™è¯¯ï¼Œé‡è¦æ“ä½œéœ€è¦ç”¨æˆ·æç¤º
  if (isCritical) {
    showError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}
```

#### 2.3 é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²
**ä½ç½®**: å…¨é¡¹ç›®

**é—®é¢˜**:
```javascript
if (ids.length > 300) ids.length = 300; // ä¸ºä»€ä¹ˆæ˜¯ 300ï¼Ÿ
setTimeout(() => {}, 600); // ä¸ºä»€ä¹ˆæ˜¯ 600msï¼Ÿ
```

**ä¿®æ­£å»ºè®®**:
```javascript
// constants.js
export const LIMITS = {
  STORY_INDEX_MAX: 300,
  ORDER_REFRESH_DELAY: 600,
  CART_MAX_ITEMS: 50
};

// ä½¿ç”¨
if (ids.length > LIMITS.STORY_INDEX_MAX) {
  ids.length = LIMITS.STORY_INDEX_MAX;
}
```

### 3. æ€§èƒ½é—®é¢˜

#### 3.1 é¢‘ç¹çš„ localStorage æ“ä½œ
**ä½ç½®**: `js/cart.js`, `js/checkout.js`

**é—®é¢˜**: æ¯æ¬¡æ“ä½œéƒ½è¯»å†™ localStorageï¼Œå¯èƒ½é˜»å¡ä¸»çº¿ç¨‹

**ä¿®æ­£å»ºè®®**:
```javascript
// ä½¿ç”¨é˜²æŠ–å’Œæ‰¹é‡æ›´æ–°
let cartUpdateTimer = null;
function updateCartDebounced() {
  clearTimeout(cartUpdateTimer);
  cartUpdateTimer = setTimeout(() => {
    localStorage.setItem('cart', JSON.stringify(cart));
  }, 100);
}
```

#### 3.2 æœªä¼˜åŒ–çš„å›¾ç‰‡åŠ è½½
**ä½ç½®**: `js/main.js`, `js/ui.js`

**é—®é¢˜**: æ‰€æœ‰å›¾ç‰‡åŒæ—¶åŠ è½½ï¼Œæ²¡æœ‰æ‡’åŠ è½½ä¼˜åŒ–

**ä¿®æ­£å»ºè®®**:
```javascript
// ä½¿ç”¨ Intersection Observer
const imageObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      imageObserver.unobserve(img);
    }
  });
});

// æ ‡è®°éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡
img.dataset.src = imageUrl;
img.src = 'placeholder.jpg';
imageObserver.observe(img);
```

#### 3.3 é‡å¤çš„ API è¯·æ±‚
**ä½ç½®**: `js/main.js`, `js/account.js`

**é—®é¢˜**: å¤šä¸ªç»„ä»¶å¯èƒ½é‡å¤è¯·æ±‚ç›¸åŒæ•°æ®

**ä¿®æ­£å»ºè®®**:
```javascript
// å®ç°ç®€å•çš„è¯·æ±‚ç¼“å­˜
const apiCache = new Map();
async function cachedFetch(url, options) {
  const key = `${url}:${JSON.stringify(options)}`;
  if (apiCache.has(key)) {
    const cached = apiCache.get(key);
    if (Date.now() - cached.timestamp < 60000) { // 1åˆ†é’Ÿç¼“å­˜
      return cached.data;
    }
  }
  const res = await fetch(url, options);
  const data = await res.json();
  apiCache.set(key, { data, timestamp: Date.now() });
  return data;
}
```

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. ä»£ç ç»„ç»‡é—®é¢˜

#### 4.1 å…¨å±€å˜é‡æ±¡æŸ“
**ä½ç½®**: å¤šä¸ª JS æ–‡ä»¶

**é—®é¢˜**:
```javascript
window.rawItems = rawItems; // æ±¡æŸ“å…¨å±€å‘½åç©ºé—´
window.__coupon = {}; // ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€è¡¨ç¤ºç§æœ‰ï¼Œä½†ä»æ˜¯å…¨å±€
```

**ä¿®æ­£å»ºè®®**:
```javascript
// ä½¿ç”¨å‘½åç©ºé—´å¯¹è±¡
const App = {
  state: {
    products: [],
    cart: []
  },
  utils: {
    formatPrice,
    escapeHtml
  }
};

// æˆ–ä½¿ç”¨æ¨¡å—åŒ–
export const state = { products: [] };
export const utils = { formatPrice };
```

#### 4.2 å‡½æ•°èŒè´£ä¸æ¸…
**ä½ç½®**: `js/checkout.js` (2000+ è¡Œ)

**é—®é¢˜**: å•ä¸ªæ–‡ä»¶åŒ…å«å¤ªå¤šåŠŸèƒ½

**ä¿®æ­£å»ºè®®**:
```javascript
// checkout/
//   â”œâ”€â”€ bank-transfer.js    # é“¶è¡Œè½¬è´¦
//   â”œâ”€â”€ credit-card.js      # ä¿¡ç”¨å¡æ”¯ä»˜
//   â”œâ”€â”€ order-lookup.js     # è®¢å•æŸ¥è¯¢
//   â”œâ”€â”€ coupon-handler.js   # ä¼˜æƒ åˆ¸å¤„ç†
//   â””â”€â”€ index.js            # ç»Ÿä¸€å¯¼å‡º
```

#### 4.3 ç¼ºå°‘ç±»å‹æ£€æŸ¥
**ä½ç½®**: å…¨é¡¹ç›®

**é—®é¢˜**: JavaScript åŠ¨æ€ç±»å‹å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

**ä¿®æ­£å»ºè®®**:
```javascript
// æ·»åŠ  JSDoc ç±»å‹æ³¨é‡Š
/**
 * @param {Object} product - å•†å“å¯¹è±¡
 * @param {string} product.id - å•†å“ID
 * @param {string} product.name - å•†å“åç§°
 * @param {number} product.price - ä»·æ ¼
 * @returns {HTMLElement} å•†å“å¡ç‰‡å…ƒç´ 
 */
function buildProductCard(product) {
  // ...
}

// æˆ–è¿ç§»åˆ° TypeScript
interface Product {
  id: string;
  name: string;
  price: number;
}
```

### 5. ç”¨æˆ·ä½“éªŒé—®é¢˜

#### 5.1 é”™è¯¯æç¤ºä¸å‹å¥½
**ä½ç½®**: å¤šå¤„ä½¿ç”¨ `alert()`

**é—®é¢˜**:
```javascript
alert('æ“ä½œå¤±è´¥'); // åŸç”Ÿ alert ä½“éªŒå·®
```

**ä¿®æ­£å»ºè®®**:
```javascript
// ç»Ÿä¸€çš„é”™è¯¯æç¤ºç³»ç»Ÿ
function showError(message, duration = 3000) {
  const toast = document.createElement('div');
  toast.className = 'error-toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}
```

#### 5.2 åŠ è½½çŠ¶æ€ä¸æ˜ç¡®
**ä½ç½®**: å¤šä¸ªå¼‚æ­¥æ“ä½œ

**é—®é¢˜**: ç”¨æˆ·ä¸çŸ¥é“æ“ä½œæ˜¯å¦åœ¨è¿›è¡Œ

**ä¿®æ­£å»ºè®®**:
```javascript
// ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†
const loadingStates = new Set();

function setLoading(id, isLoading) {
  if (isLoading) {
    loadingStates.add(id);
    showSpinner(id);
  } else {
    loadingStates.delete(id);
    hideSpinner(id);
  }
}
```

#### 5.3 è¡¨å•éªŒè¯ä¸è¶³
**ä½ç½®**: `checkout.js`, `account.js`

**é—®é¢˜**: å‰ç«¯éªŒè¯ä¸å®Œæ•´ï¼Œä¾èµ–åç«¯

**ä¿®æ­£å»ºè®®**:
```javascript
// ç»Ÿä¸€çš„è¡¨å•éªŒè¯
const validators = {
  phone: (value) => /^09\d{8}$/.test(value),
  email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
  required: (value) => value.trim().length > 0
};

function validateForm(form, rules) {
  const errors = {};
  for (const [field, validators] of Object.entries(rules)) {
    const value = form[field]?.value || '';
    for (const validator of validators) {
      if (!validator(value)) {
        errors[field] = validator.message || 'éªŒè¯å¤±è´¥';
        break;
      }
    }
  }
  return errors;
}
```

## ğŸŸ¢ ä½ä¼˜å…ˆçº§æ”¹è¿›

### 6. ä»£ç é£æ ¼ç»Ÿä¸€

#### 6.1 å‘½åè§„èŒƒä¸ä¸€è‡´
**é—®é¢˜**: æ··ç”¨é©¼å³°ã€ä¸‹åˆ’çº¿ã€çŸ­å‘½å

**å»ºè®®**:
```javascript
// ç»Ÿä¸€ä½¿ç”¨é©¼å³°å‘½å
const productList = []; // âœ…
const product_list = []; // âŒ
const prodList = []; // âŒ
```

#### 6.2 æ³¨é‡Šä¸è¶³
**é—®é¢˜**: å¤æ‚é€»è¾‘ç¼ºå°‘æ³¨é‡Š

**å»ºè®®**:
```javascript
/**
 * è®¡ç®—è´­ç‰©è½¦æ€»ä»·ï¼ŒåŒ…å«ä¼˜æƒ åˆ¸æŠ˜æ‰£
 * @param {boolean} includePending - æ˜¯å¦åŒ…å«å¾…åŠ å…¥å•†å“
 * @param {Object} opts - é€‰é¡¹
 * @param {number} opts.shippingFee - è¿è´¹è¦†ç›–å€¼
 * @returns {Object} åŒ…å« subtotal, off, shipping, grand
 */
function __cartPricing(includePending, opts) {
  // ...
}
```

### 7. æµ‹è¯•è¦†ç›–

#### 7.1 ç¼ºå°‘å•å…ƒæµ‹è¯•
**å»ºè®®**: ä¸ºæ ¸å¿ƒåŠŸèƒ½æ·»åŠ æµ‹è¯•

```javascript
// tests/utils.test.js
import { formatPrice, escapeHtml } from '../js/utils.js';

test('formatPrice formats numbers correctly', () => {
  expect(formatPrice(1000)).toBe('1,000');
  expect(formatPrice(0)).toBe('0');
});
```

### 8. æ–‡æ¡£å®Œå–„

#### 8.1 API æ–‡æ¡£
**å»ºè®®**: ä½¿ç”¨ OpenAPI/Swagger ç”Ÿæˆ API æ–‡æ¡£

#### 8.2 å¼€å‘æ–‡æ¡£
**å»ºè®®**: æ·»åŠ  README.md è¯´æ˜é¡¹ç›®ç»“æ„ã€å¼€å‘æµç¨‹

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… ä¿®å¤ XSS æ¼æ´
2. âœ… æ”¶ç´§ CORS é…ç½®
3. âœ… å®Œå–„é”™è¯¯å¤„ç†
4. âœ… æ‹†åˆ†å·¨å‹æ–‡ä»¶

### ç¬¬äºŒé˜¶æ®µï¼ˆ1-2å‘¨å†…ï¼‰
1. âš ï¸ ä¼˜åŒ–æ€§èƒ½é—®é¢˜
2. âš ï¸ æ”¹è¿›ä»£ç ç»„ç»‡
3. âš ï¸ æ·»åŠ ç±»å‹æ£€æŸ¥

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæŒç»­æ”¹è¿›ï¼‰
1. ğŸ“ ç»Ÿä¸€ä»£ç é£æ ¼
2. ğŸ“ æ·»åŠ æµ‹è¯•è¦†ç›–
3. ğŸ“ å®Œå–„æ–‡æ¡£

## ğŸ”§ å·¥å…·æ¨è

1. **ä»£ç è´¨é‡**: ESLint + Prettier
2. **ç±»å‹æ£€æŸ¥**: TypeScript æˆ– JSDoc
3. **å®‰å…¨æ‰«æ**: npm audit, Snyk
4. **æ€§èƒ½åˆ†æ**: Lighthouse, WebPageTest
5. **æµ‹è¯•æ¡†æ¶**: Jest, Vitest

## ğŸ“ ä»£ç ç¤ºä¾‹ï¼šé‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰
```javascript
// é—®é¢˜ï¼šé”™è¯¯å¤„ç†ä¸å®Œæ•´ï¼Œç¡¬ç¼–ç å€¼
try {
  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
  if (cart.length > 20) {
    alert('è´­ç‰©è½¦å•†å“è¿‡å¤š');
    return;
  }
} catch(_) {}
```

### é‡æ„å
```javascript
// æ”¹è¿›ï¼šå®Œæ•´é”™è¯¯å¤„ç†ï¼Œä½¿ç”¨å¸¸é‡ï¼Œå‹å¥½æç¤º
import { LIMITS } from './constants.js';
import { showError } from './ui/toast.js';

function loadCart() {
  try {
    const raw = localStorage.getItem('cart');
    if (!raw) return [];
    
    const cart = JSON.parse(raw);
    if (!Array.isArray(cart)) {
      throw new Error('Invalid cart data');
    }
    
    if (cart.length > LIMITS.CART_MAX_ITEMS) {
      showError(`è´­ç‰©è½¦æœ€å¤šå¯æ·»åŠ  ${LIMITS.CART_MAX_ITEMS} ä»¶å•†å“`);
      return cart.slice(0, LIMITS.CART_MAX_ITEMS);
    }
    
    return cart;
  } catch (err) {
    console.error('[Cart] Failed to load:', err);
    showError('è´­ç‰©è½¦æ•°æ®è¯»å–å¤±è´¥ï¼Œå·²é‡ç½®');
    localStorage.removeItem('cart');
    return [];
  }
}
```

---

**æœ€åæ›´æ–°**: 2024å¹´
**å»ºè®®å®¡æŸ¥å‘¨æœŸ**: æ¯å­£åº¦ä¸€æ¬¡

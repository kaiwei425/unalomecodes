<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="æ³°åœ‹ç¾é£Ÿåœ°åœ–èˆ‡æ¨è–¦æ¸…å–®ï¼Œå¿«é€Ÿæœå°‹èˆ‡æ”¶è—å–œæ„›çš„æ³°åœ‹é¤å»³èˆ‡å°åƒã€‚">
  <link rel="canonical" href="https://shop.unalomecodes.com/food-map">
  <title>æ³°åœ‹ç¾é£Ÿåœ°åœ–ï½œunalomecodes</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&display=swap');
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#ff5a3c;
      --accent-2:#ff8a00;
      --line:#e2e8f0;
      --pill:#fff3ee;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:'Sora','Segoe UI',system-ui,-apple-system,sans-serif;color:var(--text);line-height:1.6;}
    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line);box-shadow:0 12px 26px rgba(15,23,42,.08);}
    .wrap{max-width:1120px;margin:0 auto;padding:18px;}
    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:42px;height:42px;border-radius:12px;box-shadow:0 0 0 3px rgba(255,90,60,.16);}
    .brand-title{font-size:13px;font-weight:700;color:var(--muted);letter-spacing:.2px;}
    .brand-sub{font-size:12px;color:var(--muted);}
    h1{margin:0;font-size:28px;font-weight:800;}
    .sub{margin:6px 0 0;font-size:14px;color:var(--muted);}
    .top-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:14px;align-items:stretch;}
    .hero-panel{background:linear-gradient(135deg, rgba(255,90,60,.14), rgba(255,138,0,.1));border:1px solid rgba(255,90,60,.25);border-radius:18px;padding:14px;display:grid;gap:10px;}
    .searchbox{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;box-shadow:0 10px 18px rgba(15,23,42,.08);}
    .searchbox input{border:none;outline:none;font-size:14px;width:100%;font-family:inherit;background:transparent;}
    .search-icon{font-size:16px;color:var(--accent);}
    .filter-row{display:flex;gap:8px;flex-wrap:wrap;}
    .filter-select{appearance:none;background:#fff;border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:13px;font-family:inherit;color:var(--text);box-shadow:0 6px 14px rgba(15,23,42,.06);}
    .cards{display:grid;gap:14px;margin:18px 0 32px;}
    .card{display:grid;grid-template-columns:190px 1fr;gap:16px;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:var(--shadow);}
    .cover{position:relative;border-radius:14px;overflow:hidden;background:#0f172a;height:140px;}
    .cover img{width:100%;height:100%;object-fit:cover;}
    .card-body{display:grid;gap:8px;align-content:start;}
    .card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .card-title{font-size:18px;font-weight:800;margin:0;}
    .card-sub{font-size:12px;color:var(--muted);}
    .card-addr{font-size:13px;color:#475569;}
    .card-tags{display:flex;flex-wrap:wrap;gap:6px;}
    .tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;background:var(--pill);color:#c2410c;font-weight:700;border:1px solid rgba(255,90,60,.25);font-size:12px;}
    .badge-hot{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:rgba(255,90,60,.12);color:var(--accent);font-weight:700;font-size:11px;}
    .card-actions{display:flex;flex-wrap:wrap;gap:8px;}
    .btn{flex:1 1 140px;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer;text-decoration:none;color:var(--text);font-family:inherit;transition:transform .15s ease, box-shadow .15s ease;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(15,23,42,.1);}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent;}
    .btn.ghost{background:#fff3ee;border-color:#ffd4c4;color:#d9480f;}
    .btn.pill{border-radius:999px;padding:8px 14px;font-size:12px;flex:0 0 auto;}
    .fav-btn{border:1px solid var(--line);background:#fff;border-radius:999px;width:34px;height:34px;display:grid;place-items:center;cursor:pointer;box-shadow:0 6px 12px rgba(15,23,42,.12);}
    .pill-inline{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;background:#f8fafc;border:1px solid var(--line);font-size:12px;}
    .tag-row{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;}
    .admin-panel{margin-top:12px;padding-top:12px;border-top:1px dashed var(--line);display:grid;gap:10px;}
    .admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;}
    .admin-field{display:grid;gap:6px;font-size:12px;color:var(--muted);}
    .admin-grid label{display:grid;gap:6px;font-size:12px;color:var(--muted);}
    .admin-input{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px;font-family:inherit;}
    .admin-textarea{min-height:70px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px;font-family:inherit;resize:vertical;}
    .admin-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .admin-hint{font-size:11px;color:#ef4444;}
    @media(max-width:900px){
      .hero{grid-template-columns:1fr;}
    }
    @media(max-width:720px){
      .card{grid-template-columns:1fr;}
      .cover{height:180px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <img src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="">
          <div>
            <div class="brand-title">unalomecodes</div>
            <div class="brand-sub">Thailand Food Map</div>
          </div>
        </div>
        <div class="top-actions">
          <button class="btn ghost pill" id="btnBack">â† è¿”å›ä¸Šä¸€é </button>
          <button class="btn ghost pill" id="btnFav">æ”¶è—æ¸…å–®</button>
          <button class="btn ghost pill" id="btnAdmin">ç®¡ç†ç·¨è¼¯</button>
        </div>
      </div>
      <div class="hero">
        <div>
          <h1>æ³°åœ‹ç¾é£Ÿåœ°åœ–</h1>
          <div class="sub">ç²¾é¸ IG å½±éŸ³ï¼‹åœ°åœ–å°èˆªï¼Œå¿«é€Ÿæ‰¾åˆ°ä½ è¦çš„é¤å»³</div>
        </div>
        <div class="hero-panel">
          <div class="searchbox">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="kw" placeholder="æœå°‹åº—å / é—œéµå­—">
          </div>
          <div class="filter-row">
            <select id="fCat" class="filter-select">
              <option value="">å…¨éƒ¨åˆ†é¡</option>
            </select>
            <select id="fArea" class="filter-select">
              <option value="">å…¨éƒ¨åœ°å€</option>
            </select>
            <select id="fPrice" class="filter-select">
              <option value="">å…¨éƒ¨åƒ¹ä½</option>
              <option value="$">$ï¼ˆâ‰¤200ï¼‰</option>
              <option value="$$">$$ï¼ˆ200â€“500ï¼‰</option>
              <option value="$$$">$$$ï¼ˆ500+ï¼‰</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="cards" id="cards"></div>
  </main>

  <dialog id="foodModal" style="border:none;border-radius:16px;padding:0;max-width:720px;width:95%;box-shadow:0 20px 40px rgba(0,0,0,.25);">
    <div id="foodModalBody" style="padding:0;overflow:hidden;border-radius:16px;"></div>
  </dialog>

<script>
const BASE_DATA = [
  {
    id:'bkk-brunch-001',
    name:'After You Ari',
    category:'æ—©åˆé¤ / ç”œé»',
    area:'Ari',
    price:'$$',
    address:'Ari Soi 4, Bangkok',
    maps:'https://maps.google.com/?q=After%20You%20Ari',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CmKxXj5Lw2s/',
    highlights:['èˆ’èŠ™è•¾åšé¬†é¤…','å¿…é»èœœç³–åå¸','è¿‘ BTS Ari'],
    dishes:[{name:'è‰è“èˆ’èŠ™è•¾', price:'190'},{name:'å¥¶æ²¹åå¸', price:'180'}]
  },
  {
    id:'bkk-jp-001',
    name:'Mensho Tokyo BKK',
    category:'æ—¥å¼æ–™ç†',
    area:'Thonglor',
    price:'$$',
    address:'72 Courtyard, Thonglor, Bangkok',
    maps:'https://maps.google.com/?q=Mensho%20Tokyo%20Bangkok',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc83c?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/Ck9tKzqPz6U/',
    highlights:['å’Œç‰›æ¿ƒæ¹¯æ‹‰éºµ','åº§ä½å°‘å»ºè­°é›¢å³°','é è¿‘ BTS Thong Lo'],
    dishes:[{name:'å’Œç‰›æ¿ƒæ¹¯æ‹‰éºµ', price:'320'},{name:'æŸšå­é¹½æ‹‰éºµ', price:'280'}]
  },
  {
    id:'bkk-th-001',
    name:'Phed Mark è¾£åˆ°å“­ç‚’é£¯',
    category:'æ³°å¼æ–™ç†',
    area:'Ekkamai',
    price:'$',
    address:'Ekkamai Soi 10, Bangkok',
    maps:'https://maps.google.com/?q=Phed%20Mark',
    cover:'https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CFsmn5-Hr9x/',
    highlights:['æ³°è¾£æ‰“æ‹‹ç‚’é£¯','å¯é¸è¾£åº¦ 1â€“5','å¤–å¸¶å¿«é€Ÿ'],
    dishes:[{name:'æ‰“æ‹‹ç‰›ç‚’é£¯', price:'120'},{name:'é’æœ¨ç“œæ²™æ‹‰', price:'80'}]
  },
  {
    id:'bkk-cafe-001',
    name:'Blue Whale Cafe',
    category:'å’–å•¡å»³',
    area:'ç‹æœ—ç¢¼é ­',
    price:'$$',
    address:'392/37 Maha Rat Rd, Bangkok',
    maps:'https://maps.google.com/?q=Blue%20Whale%20Cafe',
    cover:'https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/B9SP0KXAs5x/',
    highlights:['è—è‰²è¶è±†èŠ±æ‹¿éµ','è¿‘è‡¥ä½›å¯ºã€æ²³ç•”','ç©ºé–“å°å»ºè­°å¹³æ—¥'],
    dishes:[{name:'è¶è±†èŠ±æ‹¿éµ', price:'140'},{name:'æ¤°å­å†°æ·‡æ·‹', price:'120'}]
  },
  {
    id:'bkk-hotpot-001',
    name:'è€é—†å¨˜é…¸èœç™½è‚‰é‹',
    category:'ç«é‹ / ç‡’è‚‰',
    area:'Sukhumvit 39',
    price:'$$$',
    address:'39 Sukhumvit, Bangkok',
    maps:'https://maps.google.com/?q=è€é—†å¨˜é…¸èœç™½è‚‰é‹',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc845?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/Cd8q1mAq8nz/',
    highlights:['é…¸ç™½èœæ¹¯é ­','æ‰‹åˆ‡æ¢…èŠ±è±¬','åŒ…å»‚å‹å–„èšé¤'],
    dishes:[{name:'é…¸èœç™½è‚‰é‹', price:'650'},{name:'æ‰‹åˆ‡æ¢…èŠ±è±¬', price:'380'}]
  },
  {
    id:'bkk-street-001',
    name:'Thip Samai Pad Thai',
    category:'æ³°å¼æ–™ç†',
    area:'è€åŸå€',
    price:'$',
    address:'Maha Chai Rd, Bangkok',
    maps:'https://maps.google.com/?q=Thip%20Samai%20Pad%20Thai',
    cover:'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CLt7pp6H1W9/',
    highlights:['æ‹›ç‰Œè¦æ²¹ç‚’æ²³ç²‰','æ’éšŠç†±é–€','æ™šé–“äººæ½®å¤š'],
    dishes:[{name:'è¦æ²¹ç‚’æ²³ç²‰', price:'120'},{name:'è›‹åŒ…ç‚’æ²³ç²‰', price:'150'}]
  },
  {
    id:'bkk-dessert-002',
    name:'Nana Coffee Roasters',
    category:'å’–å•¡å»³',
    area:'Ari',
    price:'$$',
    address:'Ari Soi 1, Bangkok',
    maps:'https://maps.google.com/?q=Nana%20Coffee%20Roasters%20Ari',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CbX8YgRr6zm/',
    highlights:['å† è»å’–å•¡è±†','å¯æ‹ç…§æ‰“å¡','ç©ºé–“å¯¬æ•'],
    dishes:[{name:'æ‰‹æ²–å’–å•¡', price:'160'},{name:'å·´æ–¯å…‹è›‹ç³•', price:'180'}]
  },
  {
    id:'bkk-thai-002',
    name:'Nara Thai Cuisine',
    category:'æ³°å¼æ–™ç†',
    area:'Siam',
    price:'$$',
    address:'Siam Paragon, Bangkok',
    maps:'https://maps.google.com/?q=Nara%20Thai%20Cuisine%20Siam%20Paragon',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc845?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/Cn4NBBsr4dA/',
    highlights:['æ‹›ç‰Œç¶ å’–å“©','å¤šäººå¥—é¤å‹å–„','å•†å ´å…§å¥½æŠµé”'],
    dishes:[{name:'ç¶ å’–å“©é›', price:'260'},{name:'æœˆäº®è¦é¤…', price:'280'}]
  }
];

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}
function safeUrl(input){
  const raw = String(input || '').trim();
  if (!raw) return '';
  try{
    const u = new URL(raw, window.location.origin);
    if (u.protocol === 'http:' || u.protocol === 'https:') return u.href;
  }catch(_){}
  return '';
}
function buildInstagramEmbedUrl(input){
  const raw = safeUrl(input);
  if (!raw) return '';
  try{
    const u = new URL(raw);
    const host = (u.hostname || '').toLowerCase();
    if (!host.endsWith('instagram.com')) return '';
    if (!/^\/(p|reel|tv)\//.test(u.pathname)) return '';
    const cleanPath = u.pathname.replace(/\/?$/, '/');
    return `${u.origin}${cleanPath}embed`;
  }catch(_){ return ''; }
}
function buildIntroText(item){
  const intro = (item && item.intro) ? String(item.intro).trim() : '';
  if (intro) return intro;
  const parts = [];
  const highlights = Array.isArray(item && item.highlights) ? item.highlights.filter(Boolean) : [];
  if (highlights.length){
    parts.push(`äº®é»ï¼š${highlights.join('ã€')}`);
  }
  const dishes = Array.isArray(item && item.dishes) ? item.dishes.filter(d=>d && (d.name || d.price)) : [];
  if (dishes.length){
    const dishLine = dishes.map(d=>{
      const name = d.name ? String(d.name).trim() : '';
      const price = d.price ? `à¸¿${String(d.price).trim()}` : '';
      return [name, price].filter(Boolean).join(' ');
    }).filter(Boolean).join('ã€');
    if (dishLine) parts.push(`æ¨è–¦é¤é»ï¼š${dishLine}`);
  }
  return parts.join('ã€‚');
}

const cardsEl = document.getElementById('cards');
const fCat = document.getElementById('fCat');
const fArea = document.getElementById('fArea');
const fPrice = document.getElementById('fPrice');
const kwInput = document.getElementById('kw');
const btnBack = document.getElementById('btnBack');
const btnFav = document.getElementById('btnFav');
const btnAdmin = document.getElementById('btnAdmin');

let DATA = BASE_DATA.slice();
let favs = [];
let adminMode = false;
const ADMIN_KEY = 'foodMapAdminMode';

function getAdminMode(){
  try{
    const params = new URLSearchParams(location.search);
    if (params.get('admin') === '1') return true;
    return localStorage.getItem(ADMIN_KEY) === '1';
  }catch(_){
    return false;
  }
}
function setAdminMode(next){
  adminMode = !!next;
  try{ localStorage.setItem(ADMIN_KEY, adminMode ? '1' : '0'); }catch(_){}
  document.body.classList.toggle('admin-editing', adminMode);
  if (btnAdmin) btnAdmin.textContent = adminMode ? 'å®Œæˆç·¨è¼¯' : 'ç®¡ç†ç·¨è¼¯';
}

function initFilters(){
  fCat.innerHTML = '<option value=\"\">å…¨éƒ¨åˆ†é¡</option>';
  fArea.innerHTML= '<option value=\"\">å…¨éƒ¨åœ°å€</option>';
  const cats = Array.from(new Set(DATA.map(d=>d.category))).sort();
  cats.forEach(c=>{ const opt=document.createElement('option');opt.value=c;opt.textContent=c;fCat.appendChild(opt); });
  const areas = Array.from(new Set(DATA.map(d=>d.area))).sort();
  areas.forEach(a=>{ const opt=document.createElement('option');opt.value=a;opt.textContent=a;fArea.appendChild(opt); });
}

function render(){
  const kw = (kwInput.value||'').trim().toLowerCase();
  const cat = fCat.value;
  const area= fArea.value;
  const price= fPrice.value;
  const list = DATA.filter(item=>{
    if (kw && !JSON.stringify(item).toLowerCase().includes(kw)) return false;
    if (cat && item.category !== cat) return false;
    if (area && item.area !== area) return false;
    if (price && item.price !== price) return false;
    return true;
  });
  cardsEl.innerHTML = list.map(item=>{
    const tags = [item.category, item.area, item.price ? `åƒ¹ä½ï¼š${item.price}` : '']
      .filter(Boolean)
      .map(t=>`<span class="tag">${escapeHtml(t)}</span>`)
      .join('');
    const liked = favs.includes(item.id);
    const safeId = escapeHtml(item.id || '');
    const safeName = escapeHtml(item.name || '');
    const coverUrl = safeUrl(item.cover);
    const coverImg = coverUrl ? `<img src="${escapeHtml(coverUrl)}" alt="${safeName}">` : '';
    const mapsUrl = safeUrl(item.maps);
    const introText = buildIntroText(item);
    const adminPanel = adminMode ? `
      <div class="admin-panel" data-admin-id="${safeId}">
        <div class="admin-grid">
          <label>åº—å<input class="admin-input" data-admin-field="name" value="${safeName}"></label>
          <label>åˆ†é¡<input class="admin-input" data-admin-field="category" value="${escapeHtml(item.category || '')}"></label>
          <label>åœ°å€<input class="admin-input" data-admin-field="area" value="${escapeHtml(item.area || '')}"></label>
          <label>åƒ¹ä½<input class="admin-input" data-admin-field="price" value="${escapeHtml(item.price || '')}"></label>
          <label>åœ°å€<input class="admin-input" data-admin-field="address" value="${escapeHtml(item.address || '')}"></label>
          <label>Google Maps<input class="admin-input" data-admin-field="maps" value="${escapeHtml(item.maps || '')}"></label>
          <label>IG å½±ç‰‡<input class="admin-input" data-admin-field="ig" value="${escapeHtml(item.ig || '')}"></label>
          <label>å°é¢åœ–<input class="admin-input" data-admin-field="cover" value="${escapeHtml(item.cover || '')}"></label>
        </div>
        <label class="admin-field">åº—å®¶ä»‹ç´¹
          <textarea class="admin-textarea" data-admin-field="intro">${escapeHtml(introText)}</textarea>
        </label>
        <div class="admin-actions">
          <button class="btn ghost" data-admin-save="${safeId}">å„²å­˜</button>
        </div>
        <div class="admin-hint">éœ€ç®¡ç†å“¡æ¬Šé™ï¼Œè³‡æ–™æœƒç›´æ¥å¯«å…¥è³‡æ–™åº«ã€‚</div>
      </div>
    ` : '';
    return `<article class="card">
      <div class="cover">${coverImg}</div>
      <div class="card-body">
        <div class="card-head">
          <div>
            <div class="card-title">${safeName}</div>
            <div class="card-sub">${escapeHtml(item.category || '')} Â· ${escapeHtml(item.area || '')}${item.price ? ` Â· åƒ¹ä½ ${escapeHtml(item.price)}` : ''}</div>
          </div>
          <button class="fav-btn" data-fav="${safeId}" title="æ”¶è—">${liked?'â˜…':'â˜†'}</button>
        </div>
        <div class="card-tags">${tags}<span class="badge-hot">æ¨è–¦</span></div>
        <div class="card-addr">${escapeHtml(item.address || '')}</div>
        <div class="card-actions">
          <button class="btn primary" data-open="${safeId}">æŸ¥çœ‹åº—å®¶è³‡è¨Š</button>
          <a class="btn ghost" href="${escapeHtml(mapsUrl || '#')}" target="_blank" rel="noopener">åœ°åœ–å°èˆª</a>
        </div>
        ${adminPanel}
      </div>
    </article>`;
  }).join('');
  // ç¶å®šå¡ç‰‡æŒ‰éˆ•
  cardsEl.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = (ev)=>{
      const id = btn.getAttribute('data-open');
      openModal(id);
    };
  });
  cardsEl.querySelectorAll('button[data-fav]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-fav');
      try{
        const action = favs.includes(id) ? 'remove' : 'add';
        const res = await fetch('/api/me/food-favs', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ id, action })
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 401){
          alert('è«‹å…ˆç™»å…¥å¾Œå†æ”¶è—');
          return;
        }
        if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        favs = data.favorites || [];
        render();
      }catch(err){
        alert('æ”¶è—å¤±æ•—ï¼š'+ (err.message||err));
      }
    };
  });
  if (adminMode){
    cardsEl.querySelectorAll('[data-admin-save]').forEach(btn=>{
      btn.onclick = async ()=>{
        const wrap = btn.closest('[data-admin-id]');
        if (!wrap) return;
        const id = wrap.getAttribute('data-admin-id');
        const read = (field)=>{
          const el = wrap.querySelector(`[data-admin-field="${field}"]`);
          return el ? el.value.trim() : '';
        };
        const introRaw = read('intro');
        const introLines = introRaw.split(/\n+/).filter(Boolean);
        const payload = {
          id: id || undefined,
          name: read('name'),
          category: read('category'),
          area: read('area'),
          price: read('price'),
          address: read('address'),
          maps: read('maps'),
          ig: read('ig'),
          cover: read('cover'),
          intro: introRaw,
          highlights: introLines,
          dishes: []
        };
        try{
          btn.disabled = true;
          const res = await fetch('/api/foods', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=>({}));
          if (res.status === 401){
            alert('éœ€è¦ç®¡ç†å“¡æ¬Šé™æ‰èƒ½ç·¨è¼¯ã€‚');
            return;
          }
          if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
          await loadRemote();
        }catch(err){
          alert('å„²å­˜å¤±æ•—ï¼š' + (err.message||err));
        }finally{
          btn.disabled = false;
        }
      };
    });
  }
}

// æŒ‰éˆ•äº‹ä»¶
[btnBack, btnFav, btnAdmin].forEach(btn=>{
  if (!btn) return;
  if (btn.id === 'btnBack') btn.onclick = ()=> history.back();
});
if (btnFav) btnFav.onclick = ()=> openFavList();
if (btnAdmin) btnAdmin.onclick = ()=>{ setAdminMode(!adminMode); render(); };

adminMode = getAdminMode();
setAdminMode(adminMode);
initFilters();
render();
[kwInput, fCat, fArea, fPrice].forEach(el=> el.addEventListener('input', render));

// è®€å–é ç«¯è³‡æ–™èˆ‡æ”¶è—
async function loadRemote(){
  try{
    const res = await fetch('/api/foods',{cache:'no-store'});
    const data = await res.json().catch(()=>({}));
    if (res.ok && Array.isArray(data.items) && data.items.length){
      DATA = data.items;
    }
  }catch(_){}
  await refreshFavorites();
  initFilters();
  render();
}
loadRemote();

// Modalï¼šåº—å®¶è³‡è¨Š
function openModal(id){
  const item = DATA.find(x=>x.id===id);
  if (!item) return;
  const body = document.getElementById('foodModalBody');
  const dlg = document.getElementById('foodModal');
  const introText = buildIntroText(item);
  const embedUrl = buildInstagramEmbedUrl(item.ig);
  const iframe = embedUrl ? `<iframe src="${escapeHtml(embedUrl)}" style="width:100%;min-height:420px;border:none;"></iframe>` : '';
  const mapsUrl = safeUrl(item.maps);
  const safeId = escapeHtml(item.id || '');
  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:12px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-size:18px;font-weight:800;">${escapeHtml(item.name || '')}</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">é—œé–‰</button>
      </div>
      <div style="border-radius:12px;overflow:hidden;background:#f8fafc;">${iframe || '<div style="padding:20px;color:#94a3b8;">ç„¡ IG å½±ç‰‡</div>'}</div>
      <div style="font-size:14px;color:#0f172a;line-height:1.7;">
        <div><strong>åœ°å€ï¼š</strong>${escapeHtml(item.address || '')}</div>
        <div><strong>åˆ†é¡ï¼š</strong>${escapeHtml(item.category || '')}ï½œ${escapeHtml(item.area || '')}ï½œåƒ¹ä½ï¼š${escapeHtml(item.price || '')}</div>
      </div>
      <div>
        <strong>åº—å®¶ä»‹ç´¹ï¼š</strong>
        <div style="margin:6px 0 0;color:#475569;white-space:pre-wrap;">${escapeHtml(introText || 'æš«ç„¡ä»‹ç´¹')}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn primary" style="flex:1;" href="${escapeHtml(mapsUrl || '#')}" target="_blank" rel="noopener">é–‹å•Ÿ Google Maps</a>
        <button class="btn ghost" style="flex:1;" data-fav="${safeId}">åŠ å…¥æ”¶è—</button>
      </div>
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  const favBtn = body.querySelector('button[data-fav]');
  if (favBtn){ favBtn.onclick = ()=> toggleFav(item.id); }
}

// æ”¶è—æ¸…å–®èˆ‡æ”¶è— API
async function refreshFavorites(){
  try{
    const r = await fetch('/api/me/food-favs',{credentials:'include',cache:'no-store'});
    const j = await r.json().catch(()=>({}));
    if (r.ok && Array.isArray(j.favorites)){
      favs = j.favorites;
      render();
    }
    return r.ok;
  }catch(_){ return false; }
}
async function toggleFav(id){
  try{
    const action = favs.includes(id) ? 'remove' : 'add';
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action })
    });
    const data = await res.json().catch(()=>({}));
    if (res.status === 401){ alert('è«‹å…ˆç™»å…¥å¾Œå†æ”¶è—'); return; }
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    render();
  }catch(err){
    alert('æ”¶è—å¤±æ•—ï¼š' + (err.message||err));
  }
}
function openFavList(){
  const dlg = document.getElementById('foodModal');
  const body = document.getElementById('foodModalBody');
  const list = DATA.filter(it=> favs.includes(it.id));
  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:12px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:18px;font-weight:800;">æ”¶è—æ¸…å–®</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">é—œé–‰</button>
      </div>
      ${!list.length ? '<div style="color:#94a3b8;">ç›®å‰æ²’æœ‰æ”¶è—ã€‚</div>' : `
        <div style="display:grid;gap:8px;">
          ${list.map(it=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;">
            <div>
              <div style="font-weight:700;">${escapeHtml(it.name || '')}</div>
              <div style="color:#64748b;font-size:12px;">${escapeHtml(it.category || '')}ï½œ${escapeHtml(it.area || '')}</div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn ghost" style="padding:6px 10px;font-size:12px;" data-open="${escapeHtml(it.id || '')}">æŸ¥çœ‹</button>
              <button class="btn" style="padding:6px 10px;font-size:12px;" data-remove="${escapeHtml(it.id || '')}">ç§»é™¤</button>
            </div>
          </div>`).join('')}
        </div>
      `}
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  body.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = ()=> openModal(btn.getAttribute('data-open'));
  });
  body.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.onclick = ()=> removeFav(btn.getAttribute('data-remove'));
  });
}
async function removeFav(id){
  try{
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action:'remove' })
    });
    const data = await res.json().catch(()=>({}));
    if (res.status === 401){ alert('è«‹å…ˆç™»å…¥å¾Œå†æ“ä½œ'); return; }
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    render();
    const dlg = document.getElementById('foodModal');
    if (dlg.open) openFavList();
  }catch(err){
    alert('ç§»é™¤å¤±æ•—ï¼š' + (err.message||err));
  }
}

</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>泰國美食地圖｜unalomecodes</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap');
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --accent:#2563eb;
      --line:#e5e7eb;
      --pill:#eef2ff;
      --shadow:0 16px 38px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:'Inter','Segoe UI',system-ui,-apple-system,sans-serif;color:var(--text);line-height:1.6;}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--line);box-shadow:0 10px 24px rgba(15,23,42,.08);}
    .wrap{max-width:1080px;margin:0 auto;padding:16px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:42px;height:42px;border-radius:12px;box-shadow:0 0 0 3px rgba(37,99,235,.12);}
    h1{margin:0;font-size:22px;font-weight:800;}
    .sub{margin:2px 0 0;font-size:13px;color:var(--muted);}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:12px 0;}
    select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:14px;}
    input[type="text"]{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:14px;width:100%;}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:10px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px;display:grid;gap:10px;position:relative;}
    .cover{position:relative;border-radius:12px;overflow:hidden;background:#000;height:160px;}
    .cover img{width:100%;height:100%;object-fit:cover;}
    .tag-row{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;color:var(--muted);}
    .tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;background:var(--pill);color:#1d4ed8;font-weight:700;border:1px solid #c7d2fe;}
    .actions{display:flex;flex-wrap:wrap;gap:8px;}
    .btn{flex:1 1 140px;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer;text-decoration:none;color:var(--text);}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-color:#16a34a;}
    .btn.ghost{background:#eef2ff;border-color:#c7d2fe;color:#1d4ed8;}
    .info{font-size:13px;color:var(--muted);}
    .pill-inline{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;background:#f8fafc;border:1px solid var(--line);font-size:12px;}
    @media(max-width:600px){
      .cover{height:180px;}
      .actions{flex-direction:column;}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <div class="brand">
        <img src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="">
        <div>
          <h1>泰國美食地圖</h1>
          <div class="sub">精選 IG 影音＋地圖導航，快速找到你要的餐廳</div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn ghost" id="btnBack" style="padding:8px 12px;font-size:12px;border-radius:999px;border:1px solid #cbd5e1;box-shadow:none;">← 返回上一頁</button>
        <button class="btn ghost" id="btnFav" style="padding:8px 12px;font-size:12px;border-radius:999px;border:1px solid #cbd5e1;box-shadow:none;">收藏清單</button>
        <button class="btn ghost" id="btnAdmin" style="padding:8px 12px;font-size:12px;border-radius:999px;border:1px solid #cbd5e1;box-shadow:none;">管理編輯</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="filters">
      <input type="text" id="kw" placeholder="搜尋店名 / 關鍵字">
      <select id="fCat">
        <option value="">全部分類</option>
      </select>
      <select id="fArea">
        <option value="">全部地區</option>
      </select>
      <select id="fPrice">
        <option value="">全部價位</option>
        <option value="$">$（≤200）</option>
        <option value="$$">$$（200–500）</option>
        <option value="$$$">$$$（500+）</option>
      </select>
    </div>

    <div class="cards" id="cards"></div>
  </main>

  <dialog id="foodModal" style="border:none;border-radius:16px;padding:0;max-width:720px;width:95%;box-shadow:0 20px 40px rgba(0,0,0,.25);">
    <div id="foodModalBody" style="padding:0;overflow:hidden;border-radius:16px;"></div>
  </dialog>

<script>
const BASE_DATA = [
  {
    id:'bkk-brunch-001',
    name:'After You Ari',
    category:'早午餐 / 甜點',
    area:'Ari',
    price:'$$',
    address:'Ari Soi 4, Bangkok',
    maps:'https://maps.google.com/?q=After%20You%20Ari',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CmKxXj5Lw2s/',
    highlights:['舒芙蕾厚鬆餅','必點蜜糖吐司','近 BTS Ari'],
    dishes:[{name:'草莓舒芙蕾', price:'190'},{name:'奶油吐司', price:'180'}]
  },
  {
    id:'bkk-jp-001',
    name:'Mensho Tokyo BKK',
    category:'日式料理',
    area:'Thonglor',
    price:'$$',
    address:'72 Courtyard, Thonglor, Bangkok',
    maps:'https://maps.google.com/?q=Mensho%20Tokyo%20Bangkok',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc83c?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/Ck9tKzqPz6U/',
    highlights:['和牛濃湯拉麵','座位少建議離峰','靠近 BTS Thong Lo'],
    dishes:[{name:'和牛濃湯拉麵', price:'320'},{name:'柚子鹽拉麵', price:'280'}]
  },
  {
    id:'bkk-th-001',
    name:'Phed Mark 辣到哭炒飯',
    category:'泰式料理',
    area:'Ekkamai',
    price:'$',
    address:'Ekkamai Soi 10, Bangkok',
    maps:'https://maps.google.com/?q=Phed%20Mark',
    cover:'https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/CFsmn5-Hr9x/',
    highlights:['泰辣打拋炒飯','可選辣度 1–5','外帶快速'],
    dishes:[{name:'打拋牛炒飯', price:'120'},{name:'青木瓜沙拉', price:'80'}]
  },
  {
    id:'bkk-cafe-001',
    name:'Blue Whale Cafe',
    category:'咖啡廳',
    area:'王朗碼頭',
    price:'$$',
    address:'392/37 Maha Rat Rd, Bangkok',
    maps:'https://maps.google.com/?q=Blue%20Whale%20Cafe',
    cover:'https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/B9SP0KXAs5x/',
    highlights:['藍色蝶豆花拿鐵','近臥佛寺、河畔','空間小建議平日'],
    dishes:[{name:'蝶豆花拿鐵', price:'140'},{name:'椰子冰淇淋', price:'120'}]
  },
  {
    id:'bkk-hotpot-001',
    name:'老闆娘酸菜白肉鍋',
    category:'火鍋 / 燒肉',
    area:'Sukhumvit 39',
    price:'$$$',
    address:'39 Sukhumvit, Bangkok',
    maps:'https://maps.google.com/?q=老闆娘酸菜白肉鍋',
    cover:'https://images.unsplash.com/photo-1504674900247-0877df9cc845?auto=format&fit=crop&w=900&q=60',
    ig:'https://www.instagram.com/p/Cd8q1mAq8nz/',
    highlights:['酸白菜湯頭','手切梅花豬','包廂友善聚餐'],
    dishes:[{name:'酸菜白肉鍋', price:'650'},{name:'手切梅花豬', price:'380'}]
  }
];

const cardsEl = document.getElementById('cards');
const fCat = document.getElementById('fCat');
const fArea = document.getElementById('fArea');
const fPrice = document.getElementById('fPrice');
const kwInput = document.getElementById('kw');
const btnBack = document.getElementById('btnBack');
const btnFav = document.getElementById('btnFav');
const btnAdmin = document.getElementById('btnAdmin');

let DATA = BASE_DATA.slice();
let favs = [];

function initFilters(){
  fCat.innerHTML = '<option value=\"\">全部分類</option>';
  fArea.innerHTML= '<option value=\"\">全部地區</option>';
  const cats = Array.from(new Set(DATA.map(d=>d.category))).sort();
  cats.forEach(c=>{ const opt=document.createElement('option');opt.value=c;opt.textContent=c;fCat.appendChild(opt); });
  const areas = Array.from(new Set(DATA.map(d=>d.area))).sort();
  areas.forEach(a=>{ const opt=document.createElement('option');opt.value=a;opt.textContent=a;fArea.appendChild(opt); });
}

function render(){
  const kw = (kwInput.value||'').trim().toLowerCase();
  const cat = fCat.value;
  const area= fArea.value;
  const price= fPrice.value;
  const list = DATA.filter(item=>{
    if (kw && !JSON.stringify(item).toLowerCase().includes(kw)) return false;
    if (cat && item.category !== cat) return false;
    if (area && item.area !== area) return false;
    if (price && item.price !== price) return false;
    return true;
  });
  cardsEl.innerHTML = list.map(item=>{
    const dishes = item.dishes?.slice(0,3).map(d=>`${d.name}｜฿${d.price}`).join('、') || '';
    const tags = [item.category, item.area, `價位：${item.price}`].map(t=>`<span class="tag">${t}</span>`).join('');
    const liked = favs.includes(item.id);
    return `<div class="card">
      <button class="btn ghost" data-fav="${item.id}" title="收藏" style="position:absolute;top:10px;right:10px;width:34px;height:34px;padding:0;justify-content:center;">${liked?'★':'☆'}</button>
      <div class="cover">${item.cover ? `<img src="${item.cover}" alt="${item.name}">` : ''}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div style="font-weight:800;font-size:17px;">${item.name}</div>
        <div class="pill-inline">推薦</div>
      </div>
      <div class="tag-row">${tags}</div>
      <div class="info">${item.address}</div>
      <div class="actions">
        <button class="btn primary" data-open="${item.id}">查看店家資訊</button>
      </div>
    </div>`;
  }).join('');
  // 綁定卡片按鈕
  cardsEl.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = (ev)=>{
      const id = btn.getAttribute('data-open');
      openModal(id);
    };
  });
  cardsEl.querySelectorAll('button[data-fav]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-fav');
      try{
        const action = favs.includes(id) ? 'remove' : 'add';
        const res = await fetch('/api/me/food-favs', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ id, action })
        });
        const data = await res.json().catch(()=>({}));
        if (res.status === 401){
          alert('請先登入後再收藏');
          return;
        }
        if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        favs = data.favorites || [];
        render();
      }catch(err){
        alert('收藏失敗：'+ (err.message||err));
      }
    };
  });
}

// 按鈕事件
[btnBack, btnFav, btnAdmin].forEach(btn=>{
  if (!btn) return;
  if (btn.id === 'btnBack') btn.onclick = ()=> history.back();
});
if (btnFav) btnFav.onclick = ()=> openFavList();
if (btnAdmin) btnAdmin.onclick = ()=> openAdminEditor();

initFilters();
render();
[kwInput, fCat, fArea, fPrice].forEach(el=> el.addEventListener('input', render));

// 讀取遠端資料與收藏
async function loadRemote(){
  try{
    const res = await fetch('/api/foods',{cache:'no-store'});
    const data = await res.json().catch(()=>({}));
    if (res.ok && data.items){ DATA = data.items; }
  }catch(_){}
  await refreshFavorites();
  initFilters();
  render();
}
loadRemote();

// Modal：店家資訊
function openModal(id){
  const item = DATA.find(x=>x.id===id);
  if (!item) return;
  const body = document.getElementById('foodModalBody');
  const dlg = document.getElementById('foodModal');
  const dishes = item.dishes?.map(d=>`<li>${d.name}｜฿${d.price}</li>`).join('') || '';
  const highlights = (item.highlights||[]).map(h=>`<li>${h}</li>`).join('');
  const iframe = item.ig ? `<iframe src="${item.ig.replace('https://www.instagram.com/p/','https://www.instagram.com/p/') }embed" style="width:100%;min-height:420px;border:none;"></iframe>` : '';
  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:12px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-size:18px;font-weight:800;">${item.name}</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">關閉</button>
      </div>
      <div style="border-radius:12px;overflow:hidden;background:#f8fafc;">${iframe || '<div style="padding:20px;color:#94a3b8;">無 IG 影片</div>'}</div>
      <div style="font-size:14px;color:#0f172a;line-height:1.7;">
        <div><strong>地址：</strong>${item.address}</div>
        <div><strong>分類：</strong>${item.category}｜${item.area}｜價位：${item.price}</div>
      </div>
      ${highlights ? `<div><strong>簡介：</strong><ul style="margin:6px 0 0 18px;color:#475569;">${highlights}</ul></div>` : ''}
      ${dishes ? `<div><strong>餐點：</strong><ul style="margin:6px 0 0 18px;color:#475569;">${dishes}</ul></div>` : ''}
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn primary" style="flex:1;" href="${item.maps}" target="_blank" rel="noopener">開啟 Google Maps</a>
        <button class="btn ghost" style="flex:1;" data-fav="${item.id}">加入收藏</button>
      </div>
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  const favBtn = body.querySelector('button[data-fav]');
  if (favBtn){ favBtn.onclick = ()=> toggleFav(item.id); }
}

// 收藏清單與收藏 API
async function refreshFavorites(){
  try{
    const r = await fetch('/api/me/food-favs',{credentials:'include',cache:'no-store'});
    const j = await r.json().catch(()=>({}));
    if (r.ok && Array.isArray(j.favorites)){
      favs = j.favorites;
      render();
    }
    return r.ok;
  }catch(_){ return false; }
}
async function toggleFav(id){
  try{
    const action = favs.includes(id) ? 'remove' : 'add';
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action })
    });
    const data = await res.json().catch(()=>({}));
    if (res.status === 401){ alert('請先登入後再收藏'); return; }
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    render();
  }catch(err){
    alert('收藏失敗：' + (err.message||err));
  }
}
function openFavList(){
  const dlg = document.getElementById('foodModal');
  const body = document.getElementById('foodModalBody');
  const list = DATA.filter(it=> favs.includes(it.id));
  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:12px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:18px;font-weight:800;">收藏清單</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">關閉</button>
      </div>
      ${!list.length ? '<div style="color:#94a3b8;">目前沒有收藏。</div>' : `
        <div style="display:grid;gap:8px;">
          ${list.map(it=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;">
            <div>
              <div style="font-weight:700;">${it.name}</div>
              <div style="color:#64748b;font-size:12px;">${it.category}｜${it.area}</div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn ghost" style="padding:6px 10px;font-size:12px;" onclick="openModal('${it.id}')">查看</button>
              <button class="btn" style="padding:6px 10px;font-size:12px;" onclick="removeFav('${it.id}')">移除</button>
            </div>
          </div>`).join('')}
        </div>
      `}
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
}
async function removeFav(id){
  try{
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action:'remove' })
    });
    const data = await res.json().catch(()=>({}));
    if (res.status === 401){ alert('請先登入後再操作'); return; }
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    render();
    const dlg = document.getElementById('foodModal');
    if (dlg.open) openFavList();
  }catch(err){
    alert('移除失敗：' + (err.message||err));
  }
}

// 管理編輯（後端）
function openAdminEditor(){
  const dlg = document.getElementById('foodModal');
  const body = document.getElementById('foodModalBody');
  const options = ['<option value=\"\">新增</option>'].concat(DATA.map(d=>`<option value=\"${d.id}\">${d.name}</option>`)).join('');
  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:10px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:18px;font-weight:800;">管理編輯</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">關閉</button>
      </div>
      <select id="admSelect">${options}</select>
      <input id="admId" placeholder="ID（留空自動）">
      <input id="admName" placeholder="店名">
      <input id="admCategory" placeholder="分類">
      <input id="admArea" placeholder="地區">
      <input id="admPrice" placeholder="價位（$ / $$ / $$$）">
      <input id="admAddress" placeholder="地址">
      <input id="admMaps" placeholder="Google Maps 連結">
      <input id="admIg" placeholder="IG 影片連結">
      <input id="admCover" placeholder="封面圖 URL">
      <textarea id="admHighlights" placeholder="亮點（以換行分隔）" style="min-height:80px;"></textarea>
      <button class="btn primary" id="admSave" style="width:100%;">儲存</button>
      <div style="font-size:12px;color:#ef4444;">需管理員登入，資料會直接寫入遠端資料庫（KV）。</div>
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  const sel = document.getElementById('admSelect');
  function fill(id){
    const it = DATA.find(x=>x.id===id) || {};
    document.getElementById('admId').value = it.id || '';
    document.getElementById('admName').value = it.name||'';
    document.getElementById('admCategory').value = it.category||'';
    document.getElementById('admArea').value = it.area||'';
    document.getElementById('admPrice').value = it.price||'';
    document.getElementById('admAddress').value = it.address||'';
    document.getElementById('admMaps').value = it.maps||'';
    document.getElementById('admIg').value = it.ig||'';
    document.getElementById('admCover').value = it.cover||'';
    document.getElementById('admHighlights').value = (it.highlights||[]).join('\\n');
  }
  fill(sel.value);
  sel.onchange = ()=> fill(sel.value);
  document.getElementById('admSave').onclick = async ()=>{
    const payload = {
      id: document.getElementById('admId').value.trim() || undefined,
      name: document.getElementById('admName').value.trim(),
      category: document.getElementById('admCategory').value.trim(),
      area: document.getElementById('admArea').value.trim(),
      price: document.getElementById('admPrice').value.trim(),
      address: document.getElementById('admAddress').value.trim(),
      maps: document.getElementById('admMaps').value.trim(),
      ig: document.getElementById('admIg').value.trim(),
      cover: document.getElementById('admCover').value.trim(),
      highlights: document.getElementById('admHighlights').value.split(/\\n+/).filter(Boolean)
    };
    try{
      const res = await fetch('/api/foods', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if (res.status === 401){
        alert('需要管理員權限才能編輯。');
        return;
      }
      if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
      alert('已儲存');
      dlg.close();
      await loadRemote();
    }catch(err){
      alert('儲存失敗：' + (err.message||err));
    }
  };
}
</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="å°ç£äººä¾†æ³°åœ‹å¿…ç”¨çš„ç¾é£Ÿå…¥å£ï¼šæ›¼è°·/æ¸…é‚/è¯æ¬£é¤å»³æ¨è–¦ã€IG å½±ç‰‡ã€åœ°åœ–å°èˆªã€é™„è¿‘æœå°‹èˆ‡æ”¶è—æ¸…å–®ï¼Œä¸€é è¦åŠƒä»Šå¤©åƒä»€éº¼ã€‚">
  <link rel="canonical" href="https://shop.unalomecodes.com/food-map">
  <title>unalomecodes æ³°åœ‹ç¾é£Ÿåœ°åœ–ï½œå°ç£æ—…å®¢æ³°åœ‹å¿…åƒæ¨è–¦</title>
  <link rel="icon" href="/img/logo.png" type="image/png">
  <link rel="apple-touch-icon" href="/img/logo.png">
  <meta property="og:title" content="unalomecodes æ³°åœ‹ç¾é£Ÿåœ°åœ–ï½œå°ç£æ—…å®¢æ³°åœ‹å¿…åƒæ¨è–¦">
  <meta property="og:description" content="å°ç£äººä¾†æ³°åœ‹å¿…ç”¨çš„ç¾é£Ÿå…¥å£ï¼šæ›¼è°·/æ¸…é‚/è¯æ¬£é¤å»³æ¨è–¦ã€IG å½±ç‰‡ã€åœ°åœ–å°èˆªã€é™„è¿‘æœå°‹èˆ‡æ”¶è—æ¸…å–®ï¼Œä¸€é è¦åŠƒä»Šå¤©åƒä»€éº¼ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://shop.unalomecodes.com/food-map">
  <meta property="og:image" content="https://shop.unalomecodes.com/img/logo.png">
  <meta name="twitter:card" content="summary">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#ff5a3c;
      --accent-2:#ff8a00;
      --line:#e2e8f0;
      --pill:#fff3ee;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:'Sora','Segoe UI',system-ui,-apple-system,sans-serif;color:var(--text);line-height:1.6;}
    header{position:static;background:#fff;border-bottom:1px solid var(--line);box-shadow:0 10px 22px rgba(15,23,42,.08);}
    .wrap{max-width:1120px;margin:0 auto;padding:16px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{width:38px;height:38px;border-radius:10px;box-shadow:0 0 0 2px rgba(255,90,60,.16);}
    .brand-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.2px;}
    .brand-sub{font-size:11px;color:var(--muted);}
    h1{margin:0;font-size:24px;font-weight:800;}
    .sub{margin:4px 0 0;font-size:13px;color:var(--muted);}
    .top-actions{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap;position:relative;overflow:visible;}
    .top-actions .btn{padding:6px 12px;font-size:12px;}
    .top-actions .btn,
    .top-actions .auth-btn,
    .member-menu button{
      height:40px;
      border-radius:14px;
      font-size:13px;
    }
    .topbar-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .topbar-actions .btn{height:34px;border-radius:12px;font-size:12px;padding:6px 10px;}
    .top-actions .action-group{display:flex;align-items:center;gap:8px;flex-wrap:wrap;overflow:visible;}
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1200;
      border-radius: 10px;
      padding: 5px;
      right: 0;
    }
    .dropdown-content button {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
    }
    .dropdown-content button:hover {background-color: #f1f1f1;}
    .dropdown.active .dropdown-content {display: block;}
    .admin-note{margin-top:8px;font-size:12px;color:#9a3412;background:#fff7ed;border:1px dashed #fdba74;border-radius:12px;padding:8px 12px;display:none;}
    .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;margin-top:10px;align-items:flex-start;}
    .hero-left{display:grid;gap:12px;}
    .title-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .title-ig{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;box-shadow:0 8px 16px rgba(15,23,42,.08);text-decoration:none;}
    .title-ig img{width:16px;height:16px;display:block;}
    .hero-panel{background:linear-gradient(135deg, rgba(255,90,60,.12), rgba(255,138,0,.08));border:1px solid rgba(255,90,60,.2);border-radius:16px;padding:12px;display:grid;gap:8px;}
    .hero-right{background:#fff;border:1px solid rgba(255,90,60,.2);border-radius:16px;padding:12px;display:grid;gap:10px;box-shadow:0 10px 22px rgba(15,23,42,.06);}
    .searchbox{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px;box-shadow:0 8px 16px rgba(15,23,42,.06);}
    .searchbox input{border:none;outline:none;font-size:13px;width:100%;font-family:inherit;background:transparent;}
    .search-icon{font-size:16px;color:var(--accent);}
    .filter-row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}
    .filter-select{appearance:none;background:#fff;border:1px solid var(--line);border-radius:999px;padding:7px 12px;font-size:12px;font-family:inherit;color:var(--text);box-shadow:0 6px 12px rgba(15,23,42,.05);height:34px;width:100%;}
    .cat-tabs{display:flex;gap:6px;flex-wrap:nowrap;margin:6px 0 12px;overflow-x:auto;padding-bottom:2px;}
    .cat-tab{border:1px solid #ffd7c7;background:#fff;border-radius:999px;padding:5px 10px;font-size:11px;font-weight:700;color:#f97316;cursor:pointer;white-space:nowrap;flex:0 0 auto;}
    .cat-tab.active{background:#ffedd5;border-color:#fb923c;color:#ea580c;}
    .nearby-panel{background:#fff;border:1px dashed rgba(255,90,60,.25);border-radius:14px;padding:10px;display:grid;gap:8px;box-shadow:0 10px 20px rgba(15,23,42,.05);}
    .nearby-head{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .nearby-head-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .nearby-panel.collapsed .nearby-body{display:none;}
    .nearby-title{font-size:12px;font-weight:800;color:#0f172a;}
    .nearby-input{display:grid;grid-template-columns:1fr auto;gap:8px;}
    .nearby-input input{border:1px solid var(--line);border-radius:10px;padding:7px 10px;font-size:12px;font-family:inherit;background:#fff;}
    .nearby-status{font-size:11px;color:var(--muted);}
    .nearby-list{display:grid;gap:8px;}
    .nearby-map{height:180px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f8fafc;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:12px;text-align:center;padding:8px;}
    .nearby-item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff;}
    .nearby-name{font-size:13px;font-weight:700;color:#0f172a;}
    .nearby-meta{font-size:11px;color:#64748b;}
    .nearby-actions{display:flex;gap:6px;flex-shrink:0;}
    .nearby-btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid #ffd7c7;background:#fff7f2;color:#d9480f;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:700;cursor:pointer;text-decoration:none;white-space:nowrap;}
    .nearby-btn.primary{background:linear-gradient(135deg,#ff6a3d 0%, #ff9a2f 100%);color:#fff;border-color:transparent;}
    .nearby-empty{font-size:12px;color:#94a3b8;padding:6px 0;text-align:center;}
    .cards{display:grid;gap:14px;margin:18px 0 32px;}
    .page-footer{background:#fff;border-top:1px solid var(--line);padding:12px 0;margin-top:10px;}
    .footer-inner{display:grid;gap:4px;font-size:12px;color:var(--muted);text-align:center;}
    .card{display:grid;grid-template-columns:190px 1fr;gap:16px;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:var(--shadow);}
    .cover{position:relative;border-radius:14px;overflow:hidden;background:#0f172a;aspect-ratio:4/5;width:100%;}
    .cover img{width:100%;height:100%;object-fit:cover;}
    .card-body{display:grid;gap:8px;align-content:start;}
    .card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .card-title{font-size:18px;font-weight:800;margin:0;}
    .card-sub{font-size:12px;color:var(--muted);}
    .card-addr{font-size:13px;color:#475569;}
    .card-desc{font-size:13px;color:#334155;line-height:1.65;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .card-tags{display:flex;flex-wrap:wrap;gap:6px;}
    .tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;background:var(--pill);color:#c2410c;font-weight:700;border:1px solid rgba(255,90,60,.25);font-size:12px;}
    .badge-hot{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:rgba(255,90,60,.12);color:var(--accent);font-weight:700;font-size:11px;}
    .card-actions{display:flex;flex-wrap:wrap;gap:8px;}
    .btn{flex:1 1 140px;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer;text-decoration:none;color:var(--text);font-family:inherit;font-size:13px;letter-spacing:.2px;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(15,23,42,.12);border-color:#cbd5e1;}
    .btn.primary{background:linear-gradient(135deg,#ff6a3d 0%, #ff9a2f 100%);color:#fff;border-color:transparent;box-shadow:0 12px 24px rgba(255,106,61,.28);}
    .btn.primary:hover{box-shadow:0 14px 28px rgba(255,106,61,.32);}
    .btn.ghost{background:#fff7f2;border-color:#ffd9cc;color:#d9480f;}
    .btn.pill{border-radius:999px;padding:7px 12px;font-size:12px;flex:0 0 auto;}
    .fav-btn{border:1px solid var(--line);background:#fff;border-radius:999px;width:34px;height:34px;display:grid;place-items:center;cursor:pointer;box-shadow:0 8px 16px rgba(15,23,42,.12);font-size:13px;}
    .edit-btn{border:1px solid #cbd5e1;background:#fff;border-radius:999px;padding:0 10px;height:32px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;font-weight:700;color:#0f172a;box-shadow:0 8px 16px rgba(15,23,42,.08);}
    .edit-btn:hover{border-color:#94a3b8;}
    .card-head-actions{display:flex;align-items:center;gap:8px;}
    .pill-inline{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;background:#f8fafc;border:1px solid var(--line);font-size:12px;}
    .tag-row{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;}
    .admin-panel{margin-top:12px;padding-top:12px;border-top:1px dashed var(--line);display:grid;gap:10px;min-width:0;}
    .admin-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:start;}
    .admin-field{display:grid;gap:6px;font-size:12px;color:var(--muted);}
    .admin-grid label{display:grid;gap:6px;font-size:12px;color:var(--muted);min-width:0;}
    .admin-input{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px;font-family:inherit;width:100%;box-sizing:border-box;}
    .admin-textarea{min-height:90px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px;font-family:inherit;resize:vertical;width:100%;box-sizing:border-box;}
    .admin-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .admin-hint{font-size:11px;color:#64748b;}
    .admin-msg{font-size:12px;color:#0f766e;font-weight:700;min-height:16px;}
    .admin-upload{display:grid;gap:8px;width:100%;justify-items:start;}
    .admin-file{width:100%;font-size:12px;}
    .admin-preview{width:100%;max-width:220px;aspect-ratio:4/5;border-radius:12px;border:1px dashed var(--line);background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;touch-action:none;cursor:grab;pointer-events:auto;}
    .admin-preview img{width:100%;height:100%;object-fit:cover;display:block;touch-action:none;user-select:none;pointer-events:auto;}
    .admin-preview-empty{font-size:12px;color:#94a3b8;}
    .admin-upload-hint{font-size:11px;color:#94a3b8;}
    .admin-upload-status{font-size:11px;color:#64748b;}
    .admin-cover{grid-column:1 / -1;}
    .modal-body{padding:16px;display:grid;gap:14px;background:#fff;max-height:80vh;overflow:auto;}
    .modal-head{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .modal-title{font-size:18px;font-weight:800;color:#0f172a;}
    .modal-close{border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;color:#0f172a;font-weight:700;font-size:12px;}
    .modal-tags{display:flex;gap:6px;flex-wrap:wrap;}
    .modal-chip{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:8px;padding:5px 10px;font-size:12px;font-weight:600;box-shadow:0 2px 4px rgba(251,146,60,0.05);}
    .modal-embed{border-radius:14px;overflow:hidden;background:#f8fafc;border:1px solid #e2e8f0;}
    .modal-embed-inner{max-width:420px;margin:0 auto;}
    .modal-embed iframe{width:100%;aspect-ratio:9/16;border:0;display:block;background:#fff;}
    .modal-embed.yt .modal-embed-inner{max-width:420px;}
    .modal-embed.yt iframe{aspect-ratio:9/16;}
    .modal-section{display:grid;gap:6px;font-size:13px;color:#334155;line-height:1.7;}
    .modal-section strong{color:#0f172a;}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap;}
    .modal-actions .btn{flex:1;min-width:150px;font-size:13px;}
    .empty-state{background:#fff;border:1px dashed var(--line);border-radius:16px;padding:24px;text-align:center;color:var(--muted);box-shadow:var(--shadow);}
    .empty-state h3{margin:0 0 6px;font-size:18px;color:var(--text);}
    .empty-state p{margin:0 0 14px;font-size:13px;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#0f172a;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;display:none;z-index:999;box-shadow:0 12px 24px rgba(15,23,42,.25);}
    .count-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 14px;flex-wrap:wrap;}
    .count-total{font-size:13px;font-weight:700;color:#0f172a;background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px;box-shadow:0 8px 16px rgba(15,23,42,.06);}
    .count-sync{font-size:11px;font-weight:700;color:#d9480f;background:#fff7f2;border:1px dashed #ffd7c7;border-radius:999px;padding:5px 10px;display:none;}
    .count-tags{display:none;}
    .count-pill{font-size:12px;color:#475569;border:1px solid #e2e8f0;border-radius:999px;padding:4px 10px;background:#fff;}
    .main-map{width:100%;height:calc(100vh - 180px);min-height:400px;border-radius:16px;border:1px solid var(--line);display:none;margin-bottom:20px;}
    @media(max-width:720px){.main-map{height:calc(100vh - 140px);}}
    @media(max-width:900px){
      .hero{grid-template-columns:1fr;}
      .filter-row{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:720px){
      header{position:static;box-shadow:none;}
      .card{grid-template-columns:1fr;}
      .cover{aspect-ratio:4/5;}
      .admin-grid{grid-template-columns:1fr;}
      .filter-row{grid-template-columns:1fr;}
      .nearby-input{grid-template-columns:1fr;}
      .nearby-item{flex-direction:column;align-items:flex-start;}
      .nearby-actions{width:100%;}
      .nearby-actions .nearby-btn{flex:1;}
      .nearby-map{height:160px;}
    }
    .policy-dialog{border:none;border-radius:18px;padding:0;width:92%;max-width:560px;background:#fff;color:#0f172a;border:1px solid #e2e8f0;box-shadow:0 20px 60px rgba(15,23,42,.35);}
    .policy-dialog header{padding:18px 20px;border-bottom:1px solid #e5e7eb;font-weight:800;font-size:18px;}
    .policy-dialog .body{padding:20px;font-size:14px;line-height:1.7;color:#1e293b;max-height:60vh;overflow:auto;}
    .policy-dialog footer{padding:18px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;}
    .policy-dialog .btn{border:none;border-radius:999px;padding:8px 18px;background:#111827;color:#fff;font-weight:600;cursor:pointer;}
    .auth-widget{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;box-shadow:0 8px 18px rgba(15,23,42,.08);min-height:52px;}
    .auth-widget .auth-status{font-size:13px;font-weight:700;color:#475569;}
    .auth-widget.is-authed .auth-status{color:#15803d;}
    .auth-btn{border:none;border-radius:999px;padding:8px 14px;font-weight:700;font-size:14px;background:linear-gradient(135deg,#18a168,#1095d6);color:#fff;cursor:pointer;box-shadow:0 10px 20px rgba(16,149,214,.25);transition:transform .2s ease,filter .2s ease;}
    .auth-btn:hover{transform:translateY(-1px);filter:brightness(1.05);}
    .auth-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;filter:none;}
    .member-menu{position:relative;display:none;}
    .member-menu.is-visible{display:block;}
    .member-menu button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 16px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,23,42,.08);
      display:flex;
      align-items:center;
      gap:8px;
      min-width:140px;
      justify-content:center;
    }
    .member-menu button:hover{border-color:rgba(24,161,104,.35);}
    .member-menu button .member-menu-badge{
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:11px;
      font-weight:800;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .member-menu button .member-menu-badge.show{display:inline-flex;}
    .member-menu-panel{
      position:absolute;
      right:0;
      top:calc(100% + 6px);
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 14px 40px rgba(15,23,42,.18);
      padding:8px;
      display:none;
      min-width:180px;
      z-index:20;
    }
    .member-menu-panel a,
    .member-menu-panel button{
      display:block;
      padding:12px 14px;
      border-radius:12px;
      color:#0f172a;
      text-decoration:none;
      font-weight:800;
      font-size:14px;
      width:100%;
      text-align:left;
      background:none;
      border:none;
      cursor:pointer;
    }
    .member-menu-panel a.qna-link{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .member-menu-panel .qna-badge{
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:11px;
      font-weight:800;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .member-menu-panel .qna-badge.show{display:inline-flex;}
    .member-menu-panel a:hover,
    .member-menu-panel button:hover{background:linear-gradient(135deg, rgba(24,161,104,.08), rgba(16,149,214,.08));}
    .member-menu-subpanel{
      margin-top:6px;
      padding:6px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      display:none;
      gap:6px;
    }
    .member-menu-subpanel button{
      padding:10px 12px;
      font-size:13px;
      border-radius:10px;
      font-weight:700;
    }
    .top-actions .member-menu button,
    .top-actions .auth-widget{
      min-height:52px;
      height:52px;
      padding:10px 16px;
      width:auto;
    }
    @media(max-width:720px){
      .top-actions{
        width:100%;
        align-items:stretch;
        gap:8px;
      }
      .top-actions .member-menu{flex:1 1 48%;}
      .top-actions .auth-widget{flex:1 1 48%;}
      .top-actions .member-menu button,
      .top-actions .auth-widget{
        width:100%;
        justify-content:center;
        min-height:50px;
        height:50px;
        border-radius:16px;
      }
      .top-actions .auth-widget{
        height:50px;
        padding:6px 12px;
      }
      .auth-widget{gap:8px;padding:10px 12px;}
      .auth-widget .auth-status{display:inline-flex;}
      .auth-widget .auth-btn{min-width:84px;height:32px;padding:6px 12px;}
      .auth-btn{font-size:13px;}
      .top-actions .btn,
      .top-actions .auth-btn,
      .member-menu button{
        height:44px;
        border-radius:14px;
        font-size:13px;
      }
      .action-group{
        display:grid;
        grid-template-columns:repeat(2, minmax(0,1fr));
        gap:8px;
        width:100%;
      }
      .action-group:first-child{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
      .action-group:last-child{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
      .topbar{
        align-items:flex-start;
      }
      .topbar-actions{
        width:100%;
        justify-content:flex-start;
      }
      .topbar-actions .btn{
        height:32px;
      }
      .top-actions{
        z-index:30;
      }
      .dropdown-content{
        z-index:1500;
      }
    }
    #btnBackToTop {
      position: fixed; bottom: 80px; right: 20px; width: 44px; height: 44px;
      border-radius: 50%; background: #fff; color: #0f172a; border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center;
      cursor: pointer; z-index: 900; font-size: 18px; transition: transform 0.2s;
    }
    #btnBackToTop:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .trip-result-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--line); }
    .trip-result-item:last-child { border-bottom: none; }
    .trip-result-order { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); color: #fff; display: grid; place-items: center; font-weight: 700; flex-shrink: 0; }
    .trip-result-name { font-weight: 700; }
    .trip-result-meta { font-size: 12px; color: var(--muted); }
    .trip-result-dist { font-size: 12px; color: var(--accent-2); font-weight: 700; margin-top: 4px; }
    .trip-result-actions { margin-left: auto; flex-shrink: 0; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <img src="https://i.ibb.co/7mtppQQ/logo.jpg" alt="">
          <div>
            <div class="brand-title">unalomecodes</div>
            <div class="brand-sub">Thailand Food Map</div>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="btn ghost pill" id="btnBack">è¿”å›é¦–é </button>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 16px; margin: 10px 0px 24px;">
        <div>
          <div style="display:flex; align-items:center; gap:10px;">
            <h1 style="font-size: 28px; font-weight: 800; margin: 0;">æ³°åœ‹ç¾é£Ÿåœ°åœ–</h1>
            <a class="title-ig" href="https://www.instagram.com/bkkaiwei/" target="_blank" rel="noopener" aria-label="Instagram bkkaiwei"><img src="/img/brand/logo-instagram.png" alt="Instagram"></a>
          </div>
          <div class="sub" style="font-size: 14px; margin-top: 4px;">
            <span id="pageSubtitle">ç²¾é¸ï¼©ï¼§ç¾é£ŸREELS ä¸€éµæ‰¾å‡ºä¾†é›¢ä½ æœ€è¿‘çš„é¤å»³</span>
            <button id="btnEditSubtitle" style="display:none;border:none;background:none;cursor:pointer;font-size:14px;color:#64748b;margin-left:4px;" title="ç·¨è¼¯å‰¯æ¨™é¡Œ">âœï¸</button>
          </div>
        </div>
        <div class="top-actions">
          <div class="action-group">
            <div class="dropdown" id="langDropdown">
              <button class="btn ghost pill" id="btnLang">åˆ‡æ›èªè¨€ â–¾</button>
              <div class="dropdown-content">
                <button type="button" data-lang="zh">ä¸­æ–‡</button>
                <button type="button" data-lang="en">è‹±æ–‡</button>
              </div>
            </div>
            <button class="btn ghost pill" id="btnFav">æ”¶è—æ¸…å–®</button>
          </div>
          <div class="action-group">
            <div class="member-menu" id="memberMenuContainer">
              <button type="button" id="memberMenuBtn">
                <span class="member-menu-label">æœƒå“¡ä¸­å¿ƒ</span>
                <span class="member-menu-arrow" id="memberMenuArrow">â–¾</span>
                <span class="member-menu-badge" id="memberMenuBadge" style="display:none;">0</span>
              </button>
              <div class="member-menu-panel" id="memberMenuPanel">
                <a href="#" data-profile>åŸºæœ¬è³‡æ–™</a>
                <a href="/account-coupons" id="userCouponsLink" class="qna-link">æˆ‘çš„å„ªæƒ åˆ¸ <span class="qna-badge" id="userCouponBadge">0</span></a>
                <a href="/account-orders" id="userOrdersLink" class="qna-link">æˆ‘çš„è¨‚å–® <span class="qna-badge" id="userQnaBadge">0</span></a>
                <a href="/account-store">é–€å¸‚é è¨­</a>
                <a href="/admin/orders" id="adminQnaLink" class="qna-link" data-admin-only data-admin-href="/admin/orders" style="display:none;">è¨‚å–®å•ç­” <span class="qna-badge" id="adminQnaBadge">0</span></a>
                <a href="/admin" data-admin-only data-admin-href="/admin" style="display:none;">å¾Œå°ç®¡ç†</a>
                <button type="button" id="adminToolsToggle" data-admin-only style="display:none;">ç¾é£Ÿåœ°åœ– â–¾</button>
                <div class="member-menu-subpanel" id="adminToolsPanel" data-admin-only style="display:none;">
                  <button type="button" id="btnAdd" style="display:none;">æ–°å¢é¤å»³</button>
                  <button type="button" id="btnExport" style="display:none;">åŒ¯å‡ºå‚™ä»½</button>
                  <button type="button" id="btnImport" style="display:none;">åŒ¯å…¥æ•‘æ´æª”</button>
                </div>
              </div>
            </div>
            <div class="auth-widget" data-auth-widget>
              <span class="auth-status" data-auth-status>ç™»å…¥ç‹€æ…‹è¼‰å…¥ä¸­â€¦</span>
              <button type="button" class="auth-btn" data-auth-btn>ç™»å…¥æœƒå“¡</button>
            </div>
          </div>
        </div>
      </div>
      <div class="hero">
        <div class="hero-panel">
          <div class="searchbox">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="kw" placeholder="æœå°‹åº—å / é—œéµå­—">
          </div>
          <div class="filter-row" style="grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));">
            <select id="fCat" class="filter-select">
              <option value="">å…¨éƒ¨åˆ†é¡</option>
            </select>
            <select id="fArea" class="filter-select">
              <option value="">å…¨éƒ¨åœ°å€</option>
            </select>
            <select id="fPrice" class="filter-select">
              <option value="">å…¨éƒ¨åƒ¹ä½</option>
              <option value="$">$ï¼ˆâ‰¤200ï¼‰</option>
              <option value="$$">$$ï¼ˆ200-1000ï¼‰</option>
              <option value="$$$">$$$ï¼ˆ1000+ï¼‰</option>
            </select>
            <select id="fStatus" class="filter-select">
              <option value="">ç‡Ÿæ¥­ç‹€æ…‹</option>
              <option value="open">ç¾åœ¨ç‡Ÿæ¥­ä¸­</option>
            </select>
            <select id="fSort" class="filter-select">
              <option value="">æ’åº</option>
              <option value="dist_asc">è·é›¢ è¿‘â†’é </option>
              <option value="rating_desc">è©•åˆ† é«˜â†’ä½</option>
              <option value="name_asc">åº—å Aâ†’Z</option>
              <option value="price_asc">åƒ¹ä½ ä½â†’é«˜</option>
              <option value="price_desc">åƒ¹ä½ é«˜â†’ä½</option>
            </select>
          </div>
        </div>
        <div class="hero-right">
          <div class="nearby-panel" id="nearbyPanel" style="border:none;padding:0;box-shadow:none;">
            <div class="nearby-head">
              <div class="nearby-title">ğŸ“ é™„è¿‘æ¨è–¦</div>
              <div class="nearby-head-actions">
                <button class="btn ghost pill" type="button" id="nearbyUse">ä½¿ç”¨æˆ‘çš„ä½ç½®</button>
                <button class="btn ghost pill" type="button" id="nearbyToggle" style="display:none;" aria-expanded="true">æ”¶åˆ</button>
              </div>
            </div>
            <div class="nearby-body" id="nearbyBody">
              <div class="nearby-input">
                <input type="text" id="nearbyInput" placeholder="è¼¸å…¥é£¯åº— / åœ°å€">
                <button class="btn pill" type="button" id="nearbySearch">æœå°‹é™„è¿‘</button>
              </div>
              <div class="nearby-map" id="nearbyMap">åœ°åœ–è¼‰å…¥ä¸­...</div>
              <div class="nearby-status" id="nearbyStatus">å°šæœªæœå°‹é™„è¿‘é¤å»³</div>
              <div class="nearby-list" id="nearbyList"></div>
            </div>
        </div>
      </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="count-bar">
      <div class="count-total" id="totalCount">å…± 0 é–“</div>
      <div class="count-sync" id="countSync">æ›´æ–°ä¸­...</div>
      <div class="count-tags" id="categoryCounts"></div>
      <button class="btn pill primary" id="modeToggle" style="margin-left:auto;">åœ°åœ–æ¨¡å¼</button>
    </div>
    <div class="cat-tabs" id="catTabs"></div>
    <div id="mainMap" class="main-map"></div>
    <div class="cards" id="cards"></div>
  </main>
  <footer class="page-footer">
    <div class="wrap footer-inner">
      <div>Â© 2025-2026 unalomecodes. All rights reserved.</div>
      <div>ç‡Ÿæ¥­æ™‚é–“èˆ‡è³‡è¨Šå¯èƒ½è®Šå‹•ï¼Œè«‹ä»¥åº—å®¶å…¬å‘Šç‚ºæº–ã€‚</div>
    </div>
  </footer>

  <dialog id="foodModal" style="border:none;border-radius:16px;padding:0;max-width:560px;width:92%;box-shadow:0 20px 40px rgba(0,0,0,.25);">
    <div id="foodModalBody" style="padding:0;overflow:hidden;border-radius:16px;"></div>
  </dialog>
  <div class="toast" id="saveToast">å·²å„²å­˜</div>
  <dialog id="tripResultModal" style="border:none;border-radius:16px;padding:0;max-width:560px;width:92%;box-shadow:0 20px 40px rgba(0,0,0,.25);">
    <div id="tripResultBody"></div>
  </dialog>
  <dialog id="statsModal" style="border:none;border-radius:16px;padding:0;max-width:640px;width:92%;box-shadow:0 20px 40px rgba(0,0,0,.25);">
    <div id="statsModalBody"></div>
  </dialog>
  <dialog id="profileDialog" class="policy-dialog">
    <header>åŸºæœ¬è³‡æ–™</header>
    <div class="body">
      <label>å§“å</label>
      <input id="profileName" type="text">
      <label>Email</label>
      <input id="profileEmail" type="email">
      <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
      <input id="profilePhone" type="tel" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
      <p class="muted" style="font-size:12px;margin-top:8px;">å„²å­˜å¾Œï¼Œå¯¦é«”å•†å“èˆ‡æœå‹™å•†å“çµå¸³æœƒè‡ªå‹•å¸¶å…¥é€™ä¸‰é …è³‡æ–™ã€‚</p>
      <div id="profileStatus" style="color:#ef4444;font-size:13px;min-height:18px;"></div>
    </div>
    <footer>
      <button type="button" class="btn" id="profileClose">å–æ¶ˆ</button>
      <button type="button" class="btn primary" id="profileSave">å„²å­˜</button>
    </footer>
  </dialog>
  <button id="btnBackToTop" title="å›åˆ°é ‚éƒ¨">â†‘</button>
  <script src="/js/auth.js?v=20240930"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = Array.from(document.querySelectorAll('.dropdown'));
  if (dropdowns.length) {
    dropdowns.forEach((dropdown) => {
      const dropdownButton = dropdown.querySelector('button');
      if (!dropdownButton) return;
      dropdownButton.addEventListener('click', function(event) {
        dropdowns.forEach(other => { if (other !== dropdown) other.classList.remove('active'); });
        dropdown.classList.toggle('active');
        event.stopPropagation();
      });
    });

    document.addEventListener('click', function() {
      dropdowns.forEach(d => d.classList.remove('active'));
    });
  }
  
  const btnBackToTop = document.getElementById('btnBackToTop');
  if (btnBackToTop) {
    window.addEventListener('scroll', () => {
      btnBackToTop.style.display = window.scrollY > 300 ? 'flex' : 'none';
    });
    btnBackToTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  const langDropdown = document.getElementById('langDropdown');
  if (langDropdown) {
    langDropdown.querySelectorAll('[data-lang]').forEach(btn => {
      btn.addEventListener('click', () => {
        const nextLang = btn.getAttribute('data-lang') || 'zh';
        setLanguage(nextLang);
        langDropdown.classList.remove('active');
      });
    });
  }

  // æœƒå“¡ä¸­å¿ƒä¸‹æ‹‰ (åŒæ­¥ shop)
  (function(){
    const toggle = document.getElementById('memberMenuBtn');
    const panel = document.getElementById('memberMenuPanel');
    const arrow = document.getElementById('memberMenuArrow');
    const memberMenu = document.getElementById('memberMenuContainer');
    const profileLink = panel ? panel.querySelector('a[data-profile]') : null;
    const dlg = document.getElementById('profileDialog');
    const nameInput = document.getElementById('profileName');
    const emailInput = document.getElementById('profileEmail');
    const phoneInput = document.getElementById('profilePhone');
    const saveBtn = document.getElementById('profileSave');
    const closeBtn = document.getElementById('profileClose');
    const statusEl = document.getElementById('profileStatus');

    async function openProfile(){
      if (!window.authState || !window.authState.isLoggedIn || !window.authState.isLoggedIn()){
        if (window.authState && typeof window.authState.promptLogin === 'function'){
          window.authState.promptLogin('è«‹å…ˆç™»å…¥å†ç·¨è¼¯åŸºæœ¬è³‡æ–™');
        }
        return;
      }
      try{
        const res = await fetch('/api/me/profile',{credentials:'include',cache:'no-store'});
        const data = await res.json().catch(()=>({}));
        const profile = data.profile || data || {};
        if (nameInput) nameInput.value = profile.name || profile.defaultContact?.name || '';
        if (emailInput) emailInput.value = profile.email || profile.defaultContact?.email || '';
        if (phoneInput) phoneInput.value = profile.defaultContact?.phone || profile.phone || '';
        if (statusEl) statusEl.textContent = '';
        if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
        else if (dlg) dlg.setAttribute('open','');
      }catch(e){
        if (statusEl) statusEl.textContent = 'è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      }
    }

    async function saveProfile(){
      if (!window.authState || !window.authState.isLoggedIn || !window.authState.isLoggedIn()){
        if (window.authState && typeof window.authState.promptLogin === 'function'){
          window.authState.promptLogin('è«‹å…ˆç™»å…¥å†å„²å­˜');
        }
        return;
      }
      if (statusEl) statusEl.style.color = '#ef4444';
      try{
        const body = {
          profile:{
            name: nameInput ? nameInput.value.trim() : '',
            email: emailInput ? emailInput.value.trim() : ''
          },
          defaultContact:{
            name: nameInput ? nameInput.value.trim() : '',
            email: emailInput ? emailInput.value.trim() : '',
            phone: phoneInput ? phoneInput.value.trim() : ''
          }
        };
        const res = await fetch('/api/me/profile',{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok){
          throw new Error(data.error || ('HTTP '+res.status));
        }
        if (statusEl){
          statusEl.style.color = '#16a34a';
          statusEl.textContent = 'å·²å„²å­˜ï¼Œä¸‹æ¬¡çµå¸³è‡ªå‹•å¸¶å…¥ã€‚';
        }
        if (window.authState && typeof window.authState.refreshProfile === 'function'){
          window.authState.refreshProfile();
        }
        setTimeout(()=>{ if (closeBtn) closeBtn.click(); }, 800);
      }catch(err){
        if (statusEl) statusEl.textContent = err.message || 'å„²å­˜å¤±æ•—';
      }
    }

    if (toggle && panel){
      const setArrow = (isOpen)=>{
        if (arrow){
          arrow.textContent = isOpen ? 'â–´' : 'â–¾';
        }
      };
      const close = ()=>{
        panel.style.display = 'none';
        setArrow(false);
      };
      const open = ()=>{
        panel.style.display = 'block';
        setArrow(true);
      };
      toggle.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const isOpen = panel.style.display === 'block';
        if (isOpen) close(); else open();
      });
      if (profileLink){
        profileLink.addEventListener('click', ev=>{
          ev.preventDefault();
          close();
          openProfile();
        });
      }
      document.addEventListener('click', (ev)=>{
        if (!panel.contains(ev.target) && ev.target !== toggle){
          close();
        }
      });
    }

    const adminToolsToggle = document.getElementById('adminToolsToggle');
    const adminToolsPanel = document.getElementById('adminToolsPanel');
    if (adminToolsToggle && adminToolsPanel){
      const setAdminArrow = (isOpen)=>{
        adminToolsToggle.textContent = `${t('adminTools')} ${isOpen ? 'â–´' : 'â–¾'}`;
      };
      const closeAdmin = ()=>{
        adminToolsPanel.style.display = 'none';
        setAdminArrow(false);
      };
      const openAdmin = ()=>{
        adminToolsPanel.style.display = 'grid';
        setAdminArrow(true);
      };
      setAdminArrow(false);
      adminToolsToggle.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const isOpen = adminToolsPanel.style.display === 'grid';
        if (isOpen) closeAdmin(); else openAdmin();
      });
    }

    if (closeBtn){
      closeBtn.addEventListener('click', ()=>{
        if (dlg && typeof dlg.close === 'function') dlg.close();
        else if (dlg) dlg.removeAttribute('open');
      });
    }
    if (saveBtn){
      saveBtn.addEventListener('click', saveProfile);
    }

    if (memberMenu){
      memberMenu.classList.remove('is-visible');
    }
    if (window.authState && typeof window.authState.subscribe === 'function'){
      window.authState.subscribe(user=>{
        if (!memberMenu) return;
        if (user){
          memberMenu.classList.add('is-visible');
        }else{
          memberMenu.classList.remove('is-visible');
          if (panel) panel.style.display = 'none';
          if (arrow) arrow.textContent = 'â–¾';
          if (adminToolsPanel) adminToolsPanel.style.display = 'none';
          if (adminToolsToggle) adminToolsToggle.textContent = `${t('adminTools')} â–¾`;
        }
      });
    }
  })();
});

// --- è£œä¸Šç¼ºå°‘çš„è®Šæ•¸å®£å‘Šï¼Œé¿å… ReferenceError ---
const FOOD_CACHE_KEY = 'food_map_data_v1';
const FOOD_CACHE_TTL = 24 * 60 * 60 * 1000;
const GOOGLE_MAPS_LANG = 'zh-TW';

let googleMapsKey = '';
let googleReady = false;
let googleMap = null;
let googleMarker = null;
let googleGeocoder = null;
let googleAutocomplete = null;
let googleLoadingPromise = null;
let isMapMode = false;
let mainMap = null;
let mainMarkers = [];
let mainInfoWindow = null;
const tripResultModal = document.getElementById('tripResultModal');
let currentLang = 'zh';
const TRANSLATIONS = {
  zh: {
    title: 'æ³°åœ‹ç¾é£Ÿåœ°åœ–',
    subtitle: 'ç²¾é¸ï¼©ï¼§ç¾é£ŸREELS ä¸€éµæ‰¾å‡ºä¾†é›¢ä½ æœ€è¿‘çš„é¤å»³',
    home: 'è¿”å›é¦–é ',
    fav: 'æ”¶è—æ¸…å–®',
    memberLabel: 'æœƒå“¡ä¸­å¿ƒ',
    langSwitch: 'åˆ‡æ›èªè¨€',
    langZh: 'ä¸­æ–‡',
    langEn: 'è‹±æ–‡',
    adminTools: 'ç¾é£Ÿåœ°åœ–',
    member: 'æœƒå“¡ä¸­å¿ƒ â–¾',
    login: 'ç™»å…¥æœƒå“¡',
    logout: 'ç™»å‡º',
    more: 'æ›´å¤š',
    add: 'æ–°å¢é¤å»³',
    export: 'åŒ¯å‡ºå‚™ä»½',
    import: 'åŒ¯å…¥æ•‘æ´æª”',
    stats: 'æµé‡çµ±è¨ˆ',
    searchPlaceholder: 'æœå°‹åº—å / é—œéµå­—',
    allCats: 'å…¨éƒ¨åˆ†é¡',
    allAreas: 'å…¨éƒ¨åœ°å€',
    allPrices: 'å…¨éƒ¨åƒ¹ä½',
    status: 'ç‡Ÿæ¥­ç‹€æ…‹',
    openNow: 'ç¾åœ¨ç‡Ÿæ¥­ä¸­',
    sort: 'æ’åº',
    distAsc: 'è·é›¢ è¿‘â†’é ',
    ratingDesc: 'è©•åˆ† é«˜â†’ä½',
    nameAsc: 'åº—å Aâ†’Z',
    priceAsc: 'åƒ¹ä½ ä½â†’é«˜',
    priceDesc: 'åƒ¹ä½ é«˜â†’ä½',
    nearbyTitle: 'ğŸ“ é™„è¿‘æ¨è–¦',
    useLoc: 'ä½¿ç”¨æˆ‘çš„ä½ç½®',
    collapse: 'æ”¶åˆ',
    expand: 'å±•é–‹',
    nearbyPlaceholder: 'è¼¸å…¥é£¯åº— / åœ°å€',
    searchNearby: 'æœå°‹é™„è¿‘',
    mapMode: 'åœ°åœ–æ¨¡å¼',
    listMode: 'åˆ—è¡¨æ¨¡å¼',
    totalCount: 'å…± {n} é–“',
    loadMore: 'è¼‰å…¥æ›´å¤š',
    details: 'æŸ¥çœ‹åº—å®¶è³‡è¨Š',
    nav: 'åœ°åœ–å°èˆª',
    openGmaps: 'é–‹å•Ÿ Google Maps',
    viewIg: 'åœ¨ IG ä¸ŠæŸ¥çœ‹',
    desc: 'åº—å®¶ä»‹ç´¹',
    addr: 'åœ°å€',
    reviews: 'Google è©•åˆ† & è©•è«–',
    tripTitle: 'åŠæ—¥åƒå–è·¯ç·š',
    planTrip: 'è¦åŠƒæ”¶è—è·¯ç·š',
    addFav: 'åŠ å…¥æ”¶è—',
    distFromHere: 'è·é›¢ç›®å‰ä½ç½®',
    distFromPrev: 'è·é›¢ä¸Šä¸€ç«™',
    openNav: 'åœ¨ Google Maps é–‹å•Ÿå°èˆª',
    detailShort: 'è©³æƒ…',
    locating: 'å®šä½ä¸­...',
    locFailed: 'å®šä½å¤±æ•—',
    searching: 'æœå°‹ä¸­...',
    noResult: 'æ‰¾ä¸åˆ°çµæœ',
    emptyFav: 'ç›®å‰æ²’æœ‰æ”¶è—ã€‚',
    emptyList: 'ç›®å‰æ²’æœ‰ç¬¦åˆçš„åº—å®¶',
    clearFilter: 'æ¸…é™¤ç¯©é¸',
    priceLabel: 'åƒ¹ä½',
    openLabel: 'ç‡Ÿæ¥­',
    igComment: 'IG ç•™è¨€',
    close: 'é—œé–‰',
    copy: 'è¤‡è£½',
    copied: 'å·²è¤‡è£½',
    save: 'å„²å­˜',
    cancel: 'å–æ¶ˆ',
    delete: 'åˆªé™¤',
    edit: 'ç·¨è¼¯',
    syncG: 'åŒæ­¥G',
    featured: 'ç²¾é¸',
    recommend: 'æ¨è–¦',
    newPlace: 'ï¼ˆæ–°é¤å»³ï¼‰',
    actionsHint: 'æ–°å¢å®Œæˆå¾Œæœƒé¡¯ç¤ºæ“ä½œæŒ‰éˆ•',
    unknownAddr: 'æš«ç„¡åœ°å€',
    noIntro: 'æš«ç„¡ä»‹ç´¹',
    noYt: 'å°šæœªæä¾› YouTube å½±ç‰‡',
    tripLimit: 'è¡Œç¨‹æœ€å¤šåªèƒ½åŠ å…¥ {n} å®¶åº—ã€‚',
    tripMin: 'è«‹è‡³å°‘é¸æ“‡ 2 å®¶åº—æ‰èƒ½è¦åŠƒè·¯ç·šã€‚',
    planning: 'è¦åŠƒä¸­...',
    cantLocate: 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä»¥ç¬¬ä¸€å®¶åº—ç‚ºèµ·é»ã€‚',
    tripFail: 'è·¯ç·šè¦åŠƒå¤±æ•—ï¼š',
    loginReq: 'è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚',
    loginConfirm: 'æ˜¯å¦ç¾åœ¨ç™»å…¥ï¼Ÿ',
    loginFav: 'è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½æŸ¥çœ‹æ”¶è—æ¸…å–®ã€‚',
    loginAddFav: 'è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½åŠ å…¥æ”¶è—ã€‚',
    loginRemoveFav: 'è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½ç§»é™¤æ”¶è—ã€‚',
    importing: 'åŒ¯å…¥ä¸­...',
    importSuccess: 'æ•‘æ´æˆåŠŸï¼è³‡æ–™å·²å¯«å›è³‡æ–™åº«ã€‚é é¢å°‡é‡æ–°æ•´ç†ã€‚',
    importFail: 'åŒ¯å…¥å¤±æ•—ï¼š',
    saveFail: 'å„²å­˜å¤±æ•—ï¼š',
    delConfirm: 'ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤å»³å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚',
    delSuccess: 'å·²åˆªé™¤',
    delFail: 'åˆªé™¤å¤±æ•—ï¼š',
    uploading: 'ä¸Šå‚³ä¸­â€¦',
    uploaded: 'å·²ä¸Šå‚³',
    uploadFail: 'ä¸Šå‚³å¤±æ•—',
    coverFail: 'å°é¢åœ–ä¸Šå‚³å¤±æ•—ï¼š',
    needAdmin: 'éœ€è¦ç®¡ç†å“¡æ¬Šé™ã€‚',
    syncing: 'æ›´æ–°ä¸­...',
    synced: 'å·²æ›´æ–°',
    syncFail: 'æ›´æ–°å¤±æ•—ï¼š',
    geoFail: 'è£œå®šä½å¤±æ•—ï¼š',
    ratingFail: 'ç„¡æ³•å–å¾— Google è©•åˆ†',
    gmapFail: 'Google Maps ä¸Šæ‰¾ä¸åˆ°æ­¤åœ°é»',
    mapLoad: 'æ­£åœ¨è¼‰å…¥åœ°åœ–å…ƒä»¶...',
    mapFail: 'åœ°åœ–è¼‰å…¥å¤±æ•—',
    noKey: 'æœªè¨­å®š Google Maps Key',
    browserNoLoc: 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½',
    locPerm: 'å®šä½å¤±æ•—ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™',
    inputHotel: 'è«‹å…ˆè¼¸å…¥é£¯åº—åç¨±æˆ–åœ°å€',
    searchLoc: 'æœå°‹ä½ç½®ä¸­â€¦',
    locNotFound: 'æ‰¾ä¸åˆ°æ­¤ä½ç½®ï¼Œè«‹æ›å€‹é—œéµå­—',
    nearbyEmpty: 'é™„è¿‘æ²’æœ‰å¯ç”¨çš„æ¨è–¦åº—å®¶',
    nearbyFound: 'å·²æ‰¾åˆ° {dist}km å…§é è¿‘ã€Œ{label}ã€çš„ {n} é–“åº—å®¶',
    nearbyNone: 'é™„è¿‘ {dist}km å…§æ²’æœ‰å¯ç”¨çš„åº—å®¶è³‡æ–™',
    nearbyFail: 'é™„è¿‘æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
    preparing: 'æ­£åœ¨æ•´ç† {dist}km å…§çš„é™„è¿‘é¤å»³â€¦',
    showing: 'å…ˆé¡¯ç¤º {n} é–“ï¼Œæ­£åœ¨è£œå……é™„è¿‘é¤å»³â€¦',
    locMy: 'æˆ‘çš„ä½ç½®',
    locBtn: 'ğŸ“ å®šä½æˆ‘çš„ä½ç½®',
    adminMode: 'ç®¡ç†æ¨¡å¼ï¼šå„²å­˜å¾Œæœƒç›´æ¥å¯«å…¥è³‡æ–™åº«ã€‚',
    dragHint: 'æ‹–æ›³åœ–ç‰‡å¯èª¿æ•´é¡¯ç¤ºä½ç½®',
    autoUpload: 'é¸æ“‡åœ–ç‰‡å¾Œæœƒè‡ªå‹•ä¸Šå‚³',
    placeIdHint: 'æŒ‡å®š Place ID ä»¥ä¿®æ­£è©•è«–',
    featuredLabel: 'ç½®é ‚æ¨è–¦ (Featured)',
    igVideo: 'IG å½±ç‰‡',
    ytVideo: 'YouTube å½±ç‰‡',
    gMap: 'Google Maps',
    hours: 'ç‡Ÿæ¥­æ™‚é–“',
    lat: 'ç·¯åº¦',
    lng: 'ç¶“åº¦',
    rating: 'è©•åˆ†',
    priceInput: 'åƒ¹ä½',
    areaInput: 'åœ°å€',
    catInput: 'åˆ†é¡',
    nameInput: 'åº—å',
    coverImg: 'å°é¢åœ–',
    saveBtn: 'å„²å­˜',
    cancelBtn: 'å–æ¶ˆ',
    delBtn: 'åˆªé™¤',
    editBtn: 'ç·¨è¼¯',
    favBtn: 'æ”¶è—',
    viewBtn: 'æŸ¥çœ‹',
    removeBtn: 'ç§»é™¤',
    navBtn: 'å°èˆª',
    seeMore: 'æŸ¥çœ‹æ›´å¤š Google Maps è©•è«– â†’',
    noReviews: 'æš«ç„¡è©•è«–å…§å®¹',
    loadingReviews: 'æ­£åœ¨è¼‰å…¥ Google è©•åƒ¹...',
    failReviews: 'ç„¡æ³•å–å¾—è©³ç´°è©•åƒ¹',
    failReviewsId: 'ç„¡æ³•å–å¾—è©³ç´°è©•åƒ¹ (ID ç„¡æ•ˆ)',
    gReviews: 'Google è©•åƒ¹',
    reviewsCount: '{n} å‰‡è©•è«–',
    trafficStats: 'æµé‡çµ±è¨ˆ',
    totalVisitors: 'ç¸½ç´¯ç©ä¸é‡è¤‡è¨ªå®¢',
    dailyVisitors: 'æ¯æ—¥ä¸é‡è¤‡è¨ªå®¢',
    past14Days: 'éå» 14 å¤©æ¯æ—¥æµé‡',
    reading: 'è®€å–ä¸­...',
    readFail: 'è®€å–å¤±æ•—: ',
    editSub: 'ç·¨è¼¯å‰¯æ¨™é¡Œ',
    editSubPrompt: 'ç·¨è¼¯å‰¯æ¨™é¡Œ',
    unknownError: 'unknown',
    ok: 'å®Œæˆ'
  },
  en: {
    title: 'Thailand Food Map',
    subtitle: 'Curated IG Reels & One-click to find nearest restaurants',
    home: 'Home',
    fav: 'Favorites',
    memberLabel: 'Member Center',
    langSwitch: 'Language',
    langZh: 'Chinese',
    langEn: 'English',
    adminTools: 'Food Map',
    member: 'Member â–¾',
    login: 'Login',
    logout: 'Logout',
    more: 'More',
    add: 'Add Place',
    export: 'Export',
    import: 'Import',
    stats: 'Stats',
    searchPlaceholder: 'Search name / keyword',
    allCats: 'All Categories',
    allAreas: 'All Areas',
    allPrices: 'All Prices',
    status: 'Status',
    openNow: 'Open Now',
    sort: 'Sort',
    distAsc: 'Distance (Near->Far)',
    ratingDesc: 'Rating (High->Low)',
    nameAsc: 'Name (A->Z)',
    priceAsc: 'Price (Low->High)',
    priceDesc: 'Price (High->Low)',
    nearbyTitle: 'ğŸ“ Nearby',
    useLoc: 'Use My Location',
    collapse: 'Collapse',
    expand: 'Expand',
    nearbyPlaceholder: 'Enter hotel / address',
    searchNearby: 'Search Nearby',
    mapMode: 'Map Mode',
    listMode: 'List Mode',
    totalCount: '{n} places',
    loadMore: 'Load More',
    details: 'Details',
    nav: 'Navigate',
    openGmaps: 'Open Google Maps',
    viewIg: 'View on IG',
    desc: 'Description',
    addr: 'Address',
    reviews: 'Google Ratings & Reviews',
    tripTitle: 'Half-day Trip',
    planTrip: 'Plan Trip',
    addFav: 'Add to Favorites',
    distFromHere: 'Dist from here',
    distFromPrev: 'Dist from prev',
    openNav: 'Open Navigation',
    detailShort: 'Details',
    locating: 'Locating...',
    locFailed: 'Locating Failed',
    searching: 'Searching...',
    noResult: 'No results',
    emptyFav: 'No favorites yet.',
    emptyList: 'No matching places found.',
    clearFilter: 'Clear Filters',
    priceLabel: 'Price',
    openLabel: 'Open',
    igComment: 'IG Comment',
    close: 'Close',
    copy: 'Copy',
    copied: 'Copied',
    save: 'Save',
    cancel: 'Cancel',
    delete: 'Delete',
    edit: 'Edit',
    syncG: 'Sync G',
    featured: 'Featured',
    recommend: 'Recommended',
    newPlace: '(New)',
    actionsHint: 'Actions are available after saving.',
    unknownAddr: 'No Address',
    noIntro: 'No Description',
    noYt: 'No YouTube Video',
    tripLimit: 'Max {n} places allowed.',
    tripMin: 'Select at least 2 places.',
    planning: 'Planning...',
    cantLocate: 'Cannot locate you, using first place as start.',
    tripFail: 'Planning failed: ',
    loginReq: 'Please login to use this feature.',
    loginConfirm: 'Login now?',
    loginFav: 'Please login to view favorites.',
    loginAddFav: 'Please login to add favorites.',
    loginRemoveFav: 'Please login to remove favorites.',
    importing: 'Importing...',
    importSuccess: 'Import success! Reloading...',
    importFail: 'Import failed: ',
    saveFail: 'Save failed: ',
    delConfirm: 'Delete this place? Cannot be undone.',
    delSuccess: 'Deleted',
    delFail: 'Delete failed: ',
    uploading: 'Uploading...',
    uploaded: 'Uploaded',
    uploadFail: 'Upload failed',
    coverFail: 'Cover upload failed: ',
    needAdmin: 'Admin permission required.',
    syncing: 'Updating...',
    synced: 'Updated',
    syncFail: 'Update failed: ',
    geoFail: 'Geocode failed: ',
    ratingFail: 'Cannot get Google rating',
    gmapFail: 'Place not found on Google Maps',
    mapLoad: 'Loading map...',
    mapFail: 'Map load failed',
    noKey: 'Google Maps Key missing',
    browserNoLoc: 'Browser does not support geolocation',
    locPerm: 'Geolocation failed, please allow permission',
    inputHotel: 'Please enter hotel or address',
    searchLoc: 'Searching location...',
    locNotFound: 'Location not found',
    nearbyEmpty: 'No nearby recommendations',
    nearbyFound: 'Found {n} places near "{label}" within {dist}km',
    nearbyNone: 'No data within {dist}km',
    nearbyFail: 'Nearby search failed',
    preparing: 'Preparing nearby places within {dist}km...',
    showing: 'Showing {n} places, loading more...',
    locMy: 'My Location',
    locBtn: 'ğŸ“ Locate Me',
    adminMode: 'Admin Mode: Saves directly to DB.',
    dragHint: 'Drag image to adjust position',
    autoUpload: 'Auto upload on select',
    placeIdHint: 'Place ID for reviews',
    featuredLabel: 'Featured',
    igVideo: 'IG Video',
    ytVideo: 'YouTube Video',
    gMap: 'Google Maps',
    hours: 'Hours',
    lat: 'Lat',
    lng: 'Lng',
    rating: 'Rating',
    priceInput: 'Price',
    areaInput: 'Area',
    catInput: 'Category',
    nameInput: 'Name',
    coverImg: 'Cover',
    saveBtn: 'Save',
    cancelBtn: 'Cancel',
    delBtn: 'Delete',
    editBtn: 'Edit',
    favBtn: 'Fav',
    viewBtn: 'View',
    removeBtn: 'Remove',
    navBtn: 'Nav',
    seeMore: 'See more Google Maps reviews â†’',
    noReviews: 'No reviews',
    loadingReviews: 'Loading Google reviews...',
    failReviews: 'Failed to load reviews',
    failReviewsId: 'Failed to load reviews (Invalid ID)',
    gReviews: 'Google Reviews',
    reviewsCount: '{n} reviews',
    trafficStats: 'Traffic Stats',
    totalVisitors: 'Total Unique Visitors',
    dailyVisitors: 'Daily Unique Visitors',
    past14Days: 'Past 14 Days Traffic',
    reading: 'Reading...',
    readFail: 'Read failed: ',
    editSub: 'Edit Subtitle',
    editSubPrompt: 'Edit Subtitle',
    unknownError: 'unknown',
    ok: 'Done'
  }
};
function t(key, params){
  let str = (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) || TRANSLATIONS['zh'][key] || key;
  if (params) {
    Object.keys(params).forEach(k => {
      str = str.replace(`{${k}}`, params[k]);
    });
  }
  return str;
}

let userLocation = null;
let dataLoading = false;
let dataReady = false;
let foodBooted = false;

// DOM Elements
const cardsEl = document.getElementById('cards');
const kwInput = document.getElementById('kw');
const fCat = document.getElementById('fCat');
const fArea = document.getElementById('fArea');
const fPrice = document.getElementById('fPrice');
const fStatus = document.getElementById('fStatus');
const fSort = document.getElementById('fSort');
const catTabs = document.getElementById('catTabs');
const totalCountEl = document.getElementById('totalCount');
const categoryCountsEl = document.getElementById('categoryCounts');
const countSyncEl = document.getElementById('countSync');
const modeToggle = document.getElementById('modeToggle');
const mainMapEl = document.getElementById('mainMap');

const nearbyPanel = document.getElementById('nearbyPanel');
const nearbyBody = document.getElementById('nearbyBody');
const nearbyToggle = document.getElementById('nearbyToggle');
const nearbyList = document.getElementById('nearbyList');
const nearbyMapEl = document.getElementById('nearbyMap');
const nearbyInput = document.getElementById('nearbyInput');
const nearbySearch = document.getElementById('nearbySearch');
const nearbyUse = document.getElementById('nearbyUse');
const nearbyStatus = document.getElementById('nearbyStatus');

// Buttons
const btnBack = document.getElementById('btnBack');
const btnFav = document.getElementById('btnFav');
const btnLang = document.getElementById('btnLang');
const btnAdd = document.getElementById('btnAdd');
let btnExport = document.getElementById('btnExport');
let btnImport = document.getElementById('btnImport');
let btnStats = document.getElementById('btnStats');
// ---------------------------

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}
function safeUrl(input){
  const raw = String(input || '').trim();
  if (!raw) return '';
  try{
    const u = new URL(raw, window.location.origin);
    if (u.protocol === 'http:' || u.protocol === 'https:') return u.href;
  }catch(_){}
  return '';
}
function buildThumbUrl(input, width=520){
  const raw = safeUrl(input);
  if (!raw) return '';
  const w = Math.max(120, Math.min(1200, Number(width)||520));
  return `/api/img?u=${encodeURIComponent(raw)}&w=${w}&q=65&fmt=webp`;
}
function isIgCoverUrl(input){
  const raw = safeUrl(input);
  if (!raw) return false;
  try{
    const u = new URL(raw);
    return /cdninstagram\.com$/.test(u.hostname || '');
  }catch(_){
    return false;
  }
}
function safeObjectPosition(input){
  const raw = String(input || '').trim();
  const m = raw.match(/^(\d{1,3}(?:\.\d+)?)%\s+(\d{1,3}(?:\.\d+)?)%$/);
  if (!m) return '50% 50%';
  const x = Math.max(0, Math.min(100, Number(m[1])));
  const y = Math.max(0, Math.min(100, Number(m[2])));
  if (Number.isNaN(x) || Number.isNaN(y)) return '50% 50%';
  return `${x}% ${y}%`;
}
function escapeSelectorValue(input){
  const raw = String(input ?? '');
  if (typeof CSS !== 'undefined' && CSS.escape) return CSS.escape(raw);
  return raw.replace(/["\\]/g, '\\$&').replace(/\s/g, '\\ ');
}
function buildInstagramEmbedUrl(input){
  const raw = safeUrl(input);
  if (!raw) return '';
  try{
    const u = new URL(raw);
    const host = (u.hostname || '').toLowerCase();
    if (!host.endsWith('instagram.com')) return '';
    if (!/^\/(p|reel|tv)\//.test(u.pathname)) return '';
    const cleanPath = u.pathname.replace(/\/?$/, '/');
    return `${u.origin}${cleanPath}embed`;
  }catch(_){ return ''; }
}
function buildYouTubeEmbedUrl(input){
  const rawInput = String(input || '').trim();
  if (!rawInput) return '';
  let raw = rawInput;
  const iframeMatch = raw.match(/src=["']([^"']+)["']/i);
  if (iframeMatch) raw = iframeMatch[1];
  const urlMatch = raw.match(/https?:\/\/[^\s<>"']+/i);
  if (urlMatch) raw = urlMatch[0];
  if (!/^https?:\/\//i.test(raw)){
    if (/^(www\.)?(youtube\.com|youtu\.be)\//i.test(raw)){
      raw = `https://${raw.replace(/^www\./i, '')}`;
    }else if (/^[a-zA-Z0-9_-]{11}$/.test(raw)){
      raw = `https://youtu.be/${raw}`;
    }else{
      return '';
    }
  }
  try{
    const u = new URL(raw);
    const host = (u.hostname || '').toLowerCase();
    if (host === 'youtu.be'){
      const id = u.pathname.split('/').filter(Boolean)[0] || '';
      return id ? `https://www.youtube.com/embed/${id}` : '';
    }
    if (!host.endsWith('youtube.com') && !host.endsWith('youtube-nocookie.com')) return '';
    const path = u.pathname || '';
    if (path.startsWith('/watch')){
      const id = u.searchParams.get('v') || '';
      return id ? `https://www.youtube.com/embed/${id}` : '';
    }
    if (path.startsWith('/shorts/')){
      const id = path.split('/shorts/')[1]?.split('/')[0] || '';
      return id ? `https://www.youtube.com/embed/${id}` : '';
    }
    if (path.startsWith('/embed/')){
      const id = path.split('/embed/')[1]?.split('/')[0] || '';
      return id ? `https://www.youtube.com/embed/${id}` : '';
    }
    if (path.startsWith('/live/')){
      const id = path.split('/live/')[1]?.split('/')[0] || '';
      return id ? `https://www.youtube.com/embed/${id}` : '';
    }
  }catch(_){}
  return '';
}
function buildIntroText(item){
  const intro = (item && item.intro) ? String(item.intro).trim() : '';
  if (intro) return intro;
  const parts = [];
  const highlights = Array.isArray(item && item.highlights) ? item.highlights.filter(Boolean) : [];
  if (highlights.length){
    parts.push(`${highlights.join('ã€')}`);
  }
  const dishes = Array.isArray(item && item.dishes) ? item.dishes.filter(d=>d && (d.name || d.price)) : [];
  if (dishes.length){
    const dishLine = dishes.map(d=>{
      const name = d.name ? String(d.name).trim() : '';
      const price = d.price ? `à¸¿${String(d.price).trim()}` : '';
      return [name, price].filter(Boolean).join(' ');
    }).filter(Boolean).join('ã€');
    if (dishLine) parts.push(`${dishLine}`);
  }
  return parts.join('ã€‚');
}
function buildCardSnippet(item){
  const text = (item && item.intro) ? String(item.intro) : buildIntroText(item);
  if (!text) return '';
  const lines = text.replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean);
  const cleaned = lines.filter(l=>{
    if (!l) return false;
    if (/^(#|@|ğŸ |ğŸ“|â°)/.test(l)) return false;
    if (/^https?:\/\//i.test(l)) return false;
    return true;
  }).join(' ');
  if (!cleaned) return '';
  const withBreaks = cleaned.replace(/([ã€‚ï¼ï¼Ÿ!?])\s*/g, '$1\n').replace(/(\.)\s+/g, '$1\n');
  const sentences = withBreaks.split('\n').map(s=>s.trim()).filter(Boolean);
  if (!sentences.length) return '';
  const keywords = ['å¿…é»','å¿…åƒ','å¿…è¨ª','å¿…ä¾†','æ¨è–¦','è¶…ç´š','è¶…å¥½åƒ','æœ€å¥½','æœ€æ„›','æ‹›ç‰Œ','ç‰¹è‰²','å€¼å¾—','äººæ°£','æ’éšŠ','é™å®š','åªæœ‰','é–‹åˆ°','ä¾¿å®œ','é«˜CP','æ°›åœ','æ‹ç…§','å¤œæ™¯','ç±³å…¶æ—','å¿…æ¯”ç™»'];
  const scored = sentences.map((s, idx)=>{
    let score = 0;
    keywords.forEach(k=>{ if (s.includes(k)) score += 3; });
    if (s.length >= 12 && s.length <= 60) score += 2;
    if (/[A-Za-z]/.test(s)) score -= 1;
    return { s, idx, score };
  }).sort((a,b)=> b.score - a.score);
  const picked = [];
  for (const it of scored){
    if (picked.length >= 2) break;
    if (!picked.find(p=>p.idx === it.idx)) picked.push(it);
  }
  const ordered = picked.sort((a,b)=> a.idx - b.idx).map(p=>p.s);
  const fallback = sentences.slice(0,2);
  const final = ordered.length ? ordered : fallback;
  let snippet = final.join(' ');
  snippet = snippet.replace(/\s+/g,' ').trim();
  if (!snippet) return '';
  if (snippet.length > 120) snippet = snippet.slice(0, 120) + 'â€¦';
  return snippet;
}
let toastTimer = null;
function showToast(text){
  const el = document.getElementById('saveToast');
  if (!el) return;
  el.textContent = text || 'å®Œæˆ';
  el.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.style.display = 'none'; }, 1600);
}

const nameCollator = (typeof Intl !== 'undefined' && Intl.Collator)
  ? new Intl.Collator('zh-Hant', { numeric:true, sensitivity:'base' })
  : null;
const priceRank = (val)=>{
  if (val === '$') return 1;
  if (val === '$$') return 2;
  if (val === '$$$') return 3;
  return 99;
};
const ALLOW_IG_COVER = false;
const coverCache = new Map();
const coverPending = new Set();
let coverRefreshTimer = null;

async function uploadCoverFile(file){
  const fd = new FormData();
  fd.append('file', file, file.name || 'cover.jpg');
  const res = await fetch('/api/upload', {
    method:'POST',
    body: fd,
    credentials:'include'
  });
  const data = await res.json().catch(()=>({}));
  if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
  const first = Array.isArray(data.files) ? data.files[0] : null;
  if (!first || !first.url) throw new Error('Upload failed');
  return first.url;
}

function initCoverPositionControls(scope){
  const getPreviews = (node)=>{
    if (!node) return Array.from(cardsEl.querySelectorAll('[data-admin-preview="cover"]'));
    if (node.matches && node.matches('[data-admin-preview="cover"]')) return [node];
    if (node.querySelectorAll) return Array.from(node.querySelectorAll('[data-admin-preview="cover"]'));
    return [];
  };
  const previews = getPreviews(scope);
  previews.forEach(previewEl=>{
    const img = previewEl.querySelector('img');
    if (!img) return;
    if (img.dataset.dragReady === '1') return;
    img.dataset.dragReady = '1';
    img.draggable = false;
    const wrap = previewEl.closest('[data-admin-id]');
    if (!wrap) return;
    const posInput = wrap.querySelector('[data-admin-field="coverPos"]');
    const setPos = (pos)=>{
      const safe = safeObjectPosition(pos);
      img.style.objectPosition = safe;
      if (posInput) posInput.value = safe;
    };
    setPos(posInput && posInput.value ? posInput.value : '50% 50%');
    let dragging = null;
    let dragMoved = false;
    const startDrag = (clientX, clientY)=>{
      const rect = previewEl.getBoundingClientRect();
      if (!rect.width || !rect.height) return;
      const pos = safeObjectPosition(img.style.objectPosition || '50% 50%');
      const [xStr,yStr] = pos.split(' ');
      dragging = {
        startX: clientX,
        startY: clientY,
        startPosX: parseFloat(xStr),
        startPosY: parseFloat(yStr),
        width: rect.width,
        height: rect.height
      };
      dragMoved = false;
      previewEl.dataset.dragging = '0';
      previewEl.style.cursor = 'grabbing';
    };
    const moveDrag = (clientX, clientY)=>{
      if (!dragging) return;
      const dx = clientX - dragging.startX;
      const dy = clientY - dragging.startY;
      if (!dragMoved && (Math.abs(dx) + Math.abs(dy) > 2)) dragMoved = true;
      const nx = Math.max(0, Math.min(100, dragging.startPosX + (dx / dragging.width) * 100));
      const ny = Math.max(0, Math.min(100, dragging.startPosY + (dy / dragging.height) * 100));
      setPos(`${nx.toFixed(1)}% ${ny.toFixed(1)}%`);
    };
    const endDrag = ()=>{
      if (!dragging) return;
      dragging = null;
      previewEl.style.cursor = 'grab';
      if (dragMoved) {
        previewEl.dataset.dragging = '1';
        setTimeout(()=>{ previewEl.dataset.dragging = '0'; }, 0);
      }
      dragMoved = false;
    };
    const onClick = (ev)=>{
      if (previewEl.dataset.dragging === '1') {
        ev.preventDefault();
        ev.stopPropagation();
        previewEl.dataset.dragging = '0';
      }
    };
    previewEl.addEventListener('click', onClick);
    if (typeof window !== 'undefined' && 'PointerEvent' in window){
      previewEl.addEventListener('pointerdown', (ev)=>{
        if (ev.button !== undefined && ev.button !== 0) return;
        ev.preventDefault();
        startDrag(ev.clientX, ev.clientY);
        previewEl.setPointerCapture && previewEl.setPointerCapture(ev.pointerId);
      });
      previewEl.addEventListener('pointermove', (ev)=>{ if (dragging) moveDrag(ev.clientX, ev.clientY); });
      previewEl.addEventListener('pointerup', endDrag);
      previewEl.addEventListener('pointercancel', endDrag);
      previewEl.addEventListener('pointerleave', endDrag);
    }else{
      const onMouseMove = (ev)=>{ if (dragging) moveDrag(ev.clientX, ev.clientY); };
      const onMouseUp = ()=>{
        endDrag();
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
      };
      previewEl.addEventListener('mousedown', (ev)=>{
        if (ev.button !== 0) return;
        ev.preventDefault();
        startDrag(ev.clientX, ev.clientY);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
      });
      const onTouchMove = (ev)=>{
        if (!dragging) return;
        const t = ev.touches && ev.touches[0];
        if (t) moveDrag(t.clientX, t.clientY);
      };
      const onTouchEnd = ()=>{
        endDrag();
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onTouchEnd);
        window.removeEventListener('touchcancel', onTouchEnd);
      };
      previewEl.addEventListener('touchstart', (ev)=>{
        const t = ev.touches && ev.touches[0];
        if (!t) return;
        ev.preventDefault();
        startDrag(t.clientX, t.clientY);
        window.addEventListener('touchmove', onTouchMove, { passive:false });
        window.addEventListener('touchend', onTouchEnd);
        window.addEventListener('touchcancel', onTouchEnd);
      }, { passive:false });
    }
    previewEl.addEventListener('dragstart', (ev)=> ev.preventDefault());
  });
}

function findCardById(id){
  if (!cardsEl || !id) return null;
  const safe = escapeSelectorValue(id);
  return cardsEl.querySelector(`[data-card-id="${safe}"]`);
}

function applyCoverToDom(item, url){
  if (!item) return;
  const cover = safeUrl(url);
  if (!cover) return;
  item.cover = cover;
  const pos = safeObjectPosition(item.coverPos || item.cover_pos || '50% 50%');
  const coverThumb = buildThumbUrl(cover, 520);
  const card = findCardById(item.id);
  if (!card) return;
  const coverBox = card.querySelector('.cover');
  if (coverBox){
    let img = coverBox.querySelector('img');
    if (!img){
      img = document.createElement('img');
      img.alt = item.name || '';
      coverBox.innerHTML = '';
      coverBox.appendChild(img);
    }
    img.src = coverThumb || cover;
    img.style.objectPosition = pos;
    img.loading = 'lazy';
    img.decoding = 'async';
  }
  const previewEl = card.querySelector('[data-admin-preview="cover"]');
  if (previewEl){
    const posInput = card.querySelector('[data-admin-field="coverPos"]');
    if (posInput && !posInput.value) posInput.value = pos;
    const hidden = card.querySelector('[data-admin-field="cover"]');
    if (hidden && !hidden.value) hidden.value = cover;
    previewEl.innerHTML = `<img src="${escapeHtml(cover)}" alt="" style="object-position:${escapeHtml(pos)};">`;
    initCoverPositionControls(previewEl);
  }
}

function ensureCover(item){
  if (!ALLOW_IG_COVER) return;
  if (!item || safeUrl(item.cover)) return;
  const igUrl = safeUrl(item.ig);
  if (!igUrl) return;
  let cacheKey = igUrl;
  try{
    const u = new URL(igUrl);
    u.search = '';
    u.hash = '';
    cacheKey = u.href;
  }catch(_){}
  if (coverCache.has(cacheKey)){
    const cached = coverCache.get(cacheKey);
    if (cached) applyCoverToDom(item, cached);
    return;
  }
  if (coverPending.has(cacheKey)) return;
  coverPending.add(cacheKey);
  fetch(`/api/ig/cover?url=${encodeURIComponent(cacheKey)}`, { cache:'no-store' })
    .then(async (res)=>{
      const data = await res.json().catch(()=>({}));
      const cover = data && data.cover ? safeUrl(data.cover) : '';
      if (res.ok && cover){
        coverCache.set(cacheKey, cover);
        applyCoverToDom(item, cover);
      }else{
        coverCache.set(cacheKey, '');
      }
    })
    .catch(()=>{ coverCache.set(cacheKey, ''); })
    .finally(()=>{ coverPending.delete(cacheKey); });
}

function loadCacheData(){
  try{
    const raw = localStorage.getItem(FOOD_CACHE_KEY);
    if (!raw) return false;
    const cached = JSON.parse(raw);
    if (!cached || !Array.isArray(cached.items) || !cached.ts) return false;
    if ((Date.now() - cached.ts) > FOOD_CACHE_TTL) return false;
    DATA = cached.items.filter(it=>it && !it.deleted);
    dataReady = true;
    safeRender();
    return true;
  }catch(_){
    return false;
  }
}

function saveCacheData(items){
  try{
    localStorage.setItem(FOOD_CACHE_KEY, JSON.stringify({
      ts: Date.now(),
      items
    }));
  }catch(_){}
}

function safeRender(){
  if (dataLoading && !dataReady){
    showLoadingState();
    return;
  }
  try{
    render();
  }catch(err){
    if (!cardsEl) return;
    cardsEl.innerHTML = '<div class="empty-state"><h3>è¼‰å…¥å¤±æ•—</h3><p>è«‹é‡æ–°æ•´ç†æˆ–ç¨å¾Œå†è©¦ã€‚</p></div>';
  }
}

function showLoadingState(){
  if (!cardsEl) return;
  cardsEl.innerHTML = '<div class="empty-state"><h3>è¼‰å…¥ä¸­...</h3><p>æ­£åœ¨æŠ“å–æœ€æ–°è³‡æ–™ã€‚</p></div>';
}

function setSyncIndicator(loading){
  if (!countSyncEl) return;
  countSyncEl.style.display = loading ? 'inline-flex' : 'none';
}

function setNearbyCollapsed(collapsed){
  if (!nearbyPanel) return;
  nearbyPanel.classList.toggle('collapsed', collapsed);
  if (nearbyBody) nearbyBody.setAttribute('aria-hidden', collapsed ? 'true' : 'false');
  if (nearbyToggle){
    nearbyToggle.textContent = collapsed ? 'å±•é–‹' : 'æ”¶åˆ';
    nearbyToggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
  }
}
function showNearbyToggle(show){
  if (!nearbyToggle) return;
  nearbyToggle.style.display = show ? 'inline-flex' : 'none';
}
function isNearbyCollapsed(){
  return !!(nearbyPanel && nearbyPanel.classList.contains('collapsed'));
}

function updateMapPreview(coords, label){
  if (!coords || !Number.isFinite(coords.lat) || !Number.isFinite(coords.lng)) return;
  if (googleReady && googleMap && googleMarker){
    googleMap.setCenter(coords);
    googleMap.setZoom(14);
    googleMarker.setPosition(coords);
  }else if (nearbyMapEl){
    nearbyMapEl.textContent = label ? `${t('locating')} ${label}` : t('locating');
  }
}
function initGoogleMaps(){
  if (!window.google || !window.google.maps) return;
  googleReady = true;
  if (!nearbyMapEl) return;
  nearbyMapEl.textContent = '';
  googleMap = new google.maps.Map(nearbyMapEl, {
    center: { lat: 13.7563, lng: 100.5018 },
    zoom: 12,
    disableDefaultUI: true,
    zoomControl: true,
    gestureHandling: 'greedy'
  });
  googleMarker = new google.maps.Marker({ map: googleMap });
  googleGeocoder = new google.maps.Geocoder();
  if (nearbyInput){
    googleAutocomplete = new google.maps.places.Autocomplete(nearbyInput, {
      types: ['geocode', 'establishment'],
      componentRestrictions: { country: 'th' }
    });
    googleAutocomplete.addListener('place_changed', ()=>{
      const place = googleAutocomplete.getPlace();
      const loc = place && place.geometry && place.geometry.location;
      if (!loc) return;
      const coords = { lat: loc.lat(), lng: loc.lng() };
      const label = place.formatted_address || place.name || nearbyInput.value.trim();
      updateMapPreview(coords, label);
      runNearby(coords, label);
    });
  }
}
async function getGoogleMapsKey(){
  if (googleMapsKey) return googleMapsKey;
  try{
    const res = await fetch('/api/maps-key', { cache:'no-store' });
    const data = await res.json().catch(()=>({}));
    if (res.ok && data && data.ok && data.key){
      googleMapsKey = data.key;
      return googleMapsKey;
    }
    if (nearbyMapEl){
      const msg = res.status ? `ç„¡æ³•è®€å– Google Maps Keyï¼ˆHTTP ${res.status}ï¼‰` : 'ç„¡æ³•è®€å– Google Maps Key';
      nearbyMapEl.textContent = msg;
    }
  }catch(_){}
  return '';
}
async function ensureGoogleMaps(){
  if (googleReady && window.google && window.google.maps) return true;
  if (googleLoadingPromise) return googleLoadingPromise;
  
  googleLoadingPromise = new Promise(async (resolve) => {
    if (nearbyMapEl) nearbyMapEl.textContent = 'æ­£åœ¨è¼‰å…¥åœ°åœ–å…ƒä»¶...';
    const key = await getGoogleMapsKey();
    if (!key){
      if (nearbyMapEl) nearbyMapEl.textContent = t('noKey');
      resolve(false);
      return;
    }
    if (window.google && window.google.maps) {
      initGoogleMaps();
      resolve(true);
      return;
    }
    
    const script = document.createElement('script');
    script.id = 'googleMapsScript';
    script.async = true;
    script.defer = true;
    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&callback=initGoogleMaps&language=${encodeURIComponent(GOOGLE_MAPS_LANG)}`;
    
    // Hook callback
    const originalInit = window.initGoogleMaps;
    window.initGoogleMaps = () => {
      if (typeof originalInit === 'function') originalInit();
      resolve(true);
    };
    script.onerror = () => {
      if (nearbyMapEl) nearbyMapEl.textContent = t('mapFail');
      resolve(false);
    };
    document.head.appendChild(script);
  });
  return googleLoadingPromise;
}
window.initGoogleMaps = initGoogleMaps;

function geocodeWithGoogle(query){
  if (!googleReady || !googleGeocoder) return Promise.resolve(null);
  return new Promise(resolve=>{
    googleGeocoder.geocode({ address: query }, (results, status)=>{
      if (status !== 'OK' || !results || !results[0]) return resolve(null);
      const loc = results[0].geometry.location;
      if (!loc) return resolve(null);
      resolve({ lat: loc.lat(), lng: loc.lng(), label: results[0].formatted_address || query });
    });
  });
}

let DATA = [];
let favs = [];
let isAdmin = false;
let editingId = '';
let newItem = null;
let currentLimit = 20;
const PAGE_SIZE = 20;
const CATEGORY_ORDER = ['æ—¥å¼æ–™ç†','æ³°å¼æ–™ç†','ç¾©å¼æ–™ç†','ä¸­å¼æ–™ç†','æ¸¯é»','é¤é…’é¤¨','é…’å§','å’–å•¡å»³','æ—©åˆé¤','ç”œé»','å°åƒ','ç´ é£Ÿ','buffet','å…¶ä»–'];
const CATEGORY_MAP_EN = {'æ—¥å¼æ–™ç†':'Japanese','æ³°å¼æ–™ç†':'Thai','ç¾©å¼æ–™ç†':'Italian','ä¸­å¼æ–™ç†':'Chinese','æ¸¯é»':'Dim Sum','é¤é…’é¤¨':'Bistro','é…’å§':'Bar','å’–å•¡å»³':'Cafe','æ—©åˆé¤':'Brunch','ç”œé»':'Dessert','å°åƒ':'Street Food','ç´ é£Ÿ':'Vegetarian','buffet':'Buffet','å…¶ä»–':'Other'};

function resetFilters(){
  currentLimit = PAGE_SIZE;
  if (kwInput) kwInput.value = '';
  if (fCat) fCat.value = '';
  if (fArea) fArea.value = '';
  if (fPrice) fPrice.value = '';
  if (fSort) fSort.value = '';
  if (fStatus) fStatus.value = '';
}

async function checkAdmin(){
  try{
    const res = await fetch('/api/admin/status', { credentials:'include', cache:'no-store' });
    const data = await res.json().catch(()=>({}));
    isAdmin = !!(data && data.admin);
  }catch(_){
    isAdmin = false;
  }
  if (btnAdd) btnAdd.style.display = isAdmin ? 'inline-flex' : 'none';
  
  if (btnExport) btnExport.style.display = isAdmin ? 'inline-flex' : 'none';
  if (btnImport) btnImport.style.display = isAdmin ? 'inline-flex' : 'none';
  if (btnStats) btnStats.style.display = isAdmin ? 'inline-flex' : 'none';

  if (isAdmin) {
    // åŒ¯å‡ºæŒ‰éˆ• (å‚™ä»½ç”¨)
    if (btnExport) {
      btnExport.onclick = () => {
        const json = JSON.stringify({ items: DATA, ts: Date.now() }, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `food-map-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    }

    // åŒ¯å…¥æŒ‰éˆ• (æ•‘æ´ç”¨)
    if (btnImport) {
      btnImport.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async ev => {
            try {
              let obj = JSON.parse(ev.target.result);
              // è™•ç†å¾ console è¤‡è£½æ™‚å¯èƒ½ç”¢ç”Ÿçš„é›™é‡ç·¨ç¢¼å­—ä¸² (ä¾‹å¦‚ "{\"items\":...}")
              if (typeof obj === 'string') {
                try { obj = JSON.parse(obj); } catch(_) {}
              }
              const items = Array.isArray(obj) ? obj : (obj && obj.items || []);
              if (!items.length) return alert('æª”æ¡ˆå…§ç„¡è³‡æ–™');
              if (!confirm(`æº–å‚™åŒ¯å…¥ ${items.length} ç­†è³‡æ–™ï¼Œé€™å°‡æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ã€‚ç¢ºå®šå—ï¼Ÿ`)) return;
              
              btnImport.textContent = 'åŒ¯å…¥ä¸­...';
              btnImport.disabled = true;
              
              // ä½¿ç”¨æ‰¹æ¬¡åŒæ­¥æ¥å£å¯«å…¥è³‡æ–™åº«
              await fetch('/api/foods/sync', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ items })
              });
              
              alert('æ•‘æ´æˆåŠŸï¼è³‡æ–™å·²å¯«å›è³‡æ–™åº«ã€‚é é¢å°‡é‡æ–°æ•´ç†ã€‚');
              location.reload();
            } catch (err) {
              alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
              btnImport.textContent = 'åŒ¯å…¥æ•‘æ´æª”';
              btnImport.disabled = false;
            }
          };
          reader.readAsText(file);
        };
        input.click();
      };
    }

    // å‰¯æ¨™é¡Œç·¨è¼¯æŒ‰éˆ•
    const btnSub = document.getElementById('btnEditSubtitle');
    if (btnSub) {
      btnSub.style.display = 'inline-block';
      btnSub.onclick = async () => {
        const el = document.getElementById('pageSubtitle');
        const oldVal = el.textContent;
        const newVal = prompt('ç·¨è¼¯å‰¯æ¨™é¡Œ', oldVal);
        if (newVal && newVal !== oldVal) {
          try {
            const res = await fetch('/api/foods/meta', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'include',
              body: JSON.stringify({ subtitle: newVal })
            });
            const data = await res.json();
            if (data.ok) {
              el.textContent = newVal;
            } else {
              alert('å„²å­˜å¤±æ•—: ' + (data.error || 'unknown'));
            }
          } catch(e) {
            alert('å„²å­˜å¤±æ•—: ' + e.message);
          }
        }
      };
    }

    // æµé‡çµ±è¨ˆæŒ‰éˆ•
    if (btnStats) {
      btnStats.onclick = async () => {
        const statsModal = document.getElementById('statsModal');
        if (!statsModal) return;

        btnStats.disabled = true;
        btnStats.textContent = 'è®€å–ä¸­...';
        try {
          // Ensure Chart.js is loaded
          if (typeof Chart === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            await new Promise((resolve, reject) => {
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
          }

          const res = await fetch('/api/admin/food-stats?days=14', { credentials: 'include' });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'è®€å–å¤±æ•—');
          
          const statsModalBody = document.getElementById('statsModalBody');
          if (!statsModalBody) return;

          const labels = data.stats.map(s => s.date.slice(5));
          const counts = data.stats.map(s => s.count);
          const totalUsers = data.total || 0;

          statsModalBody.innerHTML = `
            <div style="padding:16px; display:grid; gap:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:18px; font-weight:800;">æµé‡çµ±è¨ˆ</div>
                <button class="modal-close" onclick="document.getElementById('statsModal').close()">é—œé–‰</button>
              </div>
              <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px;">
                <div style="font-size:12px; color:#64748b;">ç¸½ç´¯ç©ä¸é‡è¤‡è¨ªå®¢</div>
                <div style="font-size:24px; font-weight:800; color:#0f172a;">${totalUsers.toLocaleString()} äºº</div>
              </div>
              <div><canvas id="statsChartCanvas"></canvas></div>
            </div>
          `;
          
          statsModal.showModal();

          const ctx = document.getElementById('statsChartCanvas').getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'æ¯æ—¥ä¸é‡è¤‡è¨ªå®¢', data: counts, backgroundColor: 'rgba(255, 90, 60, 0.6)', borderColor: 'rgba(255, 90, 60, 1)', borderWidth: 1 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false }, title: { display: true, text: 'éå» 14 å¤©æ¯æ—¥æµé‡' } } }
          });
        } catch (e) {
          alert('è®€å–å¤±æ•—: ' + e.message);
        } finally {
          btnStats.disabled = false;
          btnStats.textContent = 'æµé‡çµ±è¨ˆ';
        }
      };
    }
  }
}

function setLanguage(lang) {
  currentLang = lang;
  if (btnLang) btnLang.textContent = `${t('langSwitch')} â–¾`;
  const langDropdown = document.getElementById('langDropdown');
  if (langDropdown) {
    const zhBtn = langDropdown.querySelector('[data-lang="zh"]');
    const enBtn = langDropdown.querySelector('[data-lang="en"]');
    if (zhBtn) zhBtn.textContent = t('langZh');
    if (enBtn) enBtn.textContent = t('langEn');
  }
  
  // Update static text
  document.querySelector('h1').textContent = t('title');
  const sub = document.getElementById('pageSubtitle');
  if (sub && (sub.textContent === TRANSLATIONS['zh']['subtitle'] || sub.textContent === TRANSLATIONS['en']['subtitle'])) {
    sub.textContent = t('subtitle');
  }
  if (btnBack) btnBack.textContent = t('home');
  if (btnFav) btnFav.textContent = t('fav');
  const memLabel = document.querySelector('.member-menu-label');
  if (memLabel) memLabel.textContent = t('memberLabel');
  const authBtn = document.querySelector('[data-auth-btn]');
  if (authBtn) {
    const loggedIn = window.authState && typeof window.authState.isLoggedIn === 'function' && window.authState.isLoggedIn();
    authBtn.textContent = loggedIn ? t('logout') : t('login');
  }
  const adminToolsToggle = document.getElementById('adminToolsToggle');
  if (adminToolsToggle) {
    const adminPanel = document.getElementById('adminToolsPanel');
    const isOpen = adminPanel && adminPanel.style.display === 'block';
    adminToolsToggle.textContent = `${t('adminTools')} ${isOpen ? 'â–´' : 'â–¾'}`;
  }
  
  // Dropdown
  const dropBtn = document.querySelector('#adminDropdown > button');
  if (dropBtn) dropBtn.textContent = t('more');
  if (btnAdd) btnAdd.textContent = t('add');
  if (btnExport) btnExport.textContent = t('export');
  if (btnImport) btnImport.textContent = t('import');
  if (btnStats) btnStats.textContent = t('stats');

  // Filters
  if (kwInput) kwInput.placeholder = t('searchPlaceholder');
  
  // Re-init filters to update options text
  initFilters();
  
  // Update select options text (hardcoded ones)
  if (fPrice && fPrice.options[0]) fPrice.options[0].textContent = t('allPrices');
  if (fStatus) {
    if (fStatus.options[0]) fStatus.options[0].textContent = t('status');
    if (fStatus.options[1]) fStatus.options[1].textContent = t('openNow');
  }
  if (fSort) {
    if (fSort.options[0]) fSort.options[0].textContent = t('sort');
    if (fSort.options[1]) fSort.options[1].textContent = t('distAsc');
    if (fSort.options[2]) fSort.options[2].textContent = t('ratingDesc');
    if (fSort.options[3]) fSort.options[3].textContent = t('nameAsc');
    if (fSort.options[4]) fSort.options[4].textContent = t('priceAsc');
    if (fSort.options[5]) fSort.options[5].textContent = t('priceDesc');
  }

  // Nearby
  const nearbyTitleEl = document.querySelector('.nearby-title');
  if (nearbyTitleEl) nearbyTitleEl.textContent = t('nearbyTitle');
  if (nearbyUse) nearbyUse.textContent = t('useLoc');
  if (nearbyToggle) nearbyToggle.textContent = isNearbyCollapsed() ? t('expand') : t('collapse');
  if (nearbyInput) nearbyInput.placeholder = t('nearbyPlaceholder');
  if (nearbySearch) nearbySearch.textContent = t('searchNearby');
  if (modeToggle) modeToggle.textContent = isMapMode ? t('listMode') : t('mapMode');

  safeRender();
}

function initFilters(){
  const source = Array.isArray(DATA) ? DATA.filter(item=>item && typeof item === 'object' && !item.deleted) : [];
  fCat.innerHTML = '<option value=\"\">å…¨éƒ¨åˆ†é¡</option>';
  fArea.innerHTML= '<option value=\"\">å…¨éƒ¨åœ°å€</option>';
  const cats = Array.from(new Set(source.map(d=>mapCategory(d.category)).filter(Boolean)))
    .sort((a,b)=>{
      const ai = CATEGORY_ORDER.indexOf(a);
      const bi = CATEGORY_ORDER.indexOf(b);
      if (ai === -1 && bi === -1) return a.localeCompare(b);
      if (ai === -1) return 1;
      if (bi === -1) return -1;
      return ai - bi;
    });
  if (catTabs){
    catTabs.innerHTML = '';
    const tabAll = document.createElement('button');
    tabAll.type = 'button';
    tabAll.className = 'cat-tab';
    tabAll.textContent = t('allCats');
    tabAll.dataset.value = '';
    catTabs.appendChild(tabAll);
    cats.forEach(c=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'cat-tab';
      // Translate category if possible
      const displayC = currentLang === 'en' ? (CATEGORY_MAP_EN[c] || c) : c;
      btn.textContent = displayC;
      btn.dataset.value = c;
      catTabs.appendChild(btn);
    });
    catTabs.querySelectorAll('.cat-tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        fCat.value = btn.dataset.value || '';
        currentLimit = PAGE_SIZE;
        safeRender();
      });
    });
  }
  fCat.options[0].textContent = t('allCats');
  cats.forEach(c=>{ 
    const opt=document.createElement('option');opt.value=c;
    opt.textContent= currentLang === 'en' ? (CATEGORY_MAP_EN[c] || c) : c;
    fCat.appendChild(opt); 
  });
  fArea.options[0].textContent = t('allAreas');
  const areas = Array.from(new Set(source.map(d=>d.area).filter(Boolean))).sort();
  areas.forEach(a=>{ const opt=document.createElement('option');opt.value=a;opt.textContent=a;fArea.appendChild(opt); });
}

function mapCategory(value){
  const v = String(value || '');
  if (!v) return '';
  if (v.toLowerCase().includes('buffet')) return 'buffet';
  if (v.includes('ç´ é£Ÿ') || v.includes('è”¬é£Ÿ')) return 'ç´ é£Ÿ';
  if (v.includes('æ—¥å¼')) return 'æ—¥å¼æ–™ç†';
  if (v.includes('æ³°å¼')) return 'æ³°å¼æ–™ç†';
  if (v.includes('ç¾©å¼')) return 'ç¾©å¼æ–™ç†';
  if (v.includes('ä¸­å¼')) return 'ä¸­å¼æ–™ç†';
  if (v.includes('æ¸¯é»')) return 'æ¸¯é»';
  if (v.includes('é¤é…’')) return 'é¤é…’é¤¨';
  if (v.includes('å’–å•¡')) return 'å’–å•¡å»³';
  if (v.includes('é…’å§') || v.includes('ç²¾é‡€')) return 'é…’å§';
  if (v.includes('æ—©åˆé¤') || v.includes('å…¨æ—¥')) return 'æ—©åˆé¤';
  if (v.includes('ç”œé»') || v.includes('æœæ±') || v.includes('çƒ˜ç„™')) return 'ç”œé»';
  if (v.includes('å°åƒ') || v.includes('åœ¨åœ°') || v.includes('éºµåº—') || v.includes('å®µå¤œ')) return 'å°åƒ';
  if (v.includes('ç«é‹')) return 'ä¸­å¼æ–™ç†';
  if (v.includes('ç‡’è‡˜') || v.includes('çƒ¤é´¨')) return 'ä¸­å¼æ–™ç†';
  if (v.includes('ç‰›æ’')) return 'é¤é…’é¤¨';
  return 'å…¶ä»–';
}

function renderSummary(currentList){
  if (!totalCountEl || !categoryCountsEl) return;
  const allItems = Array.isArray(DATA) ? DATA.filter(item=>item && !item.deleted) : [];
  const totalAll = allItems.length;
  const shown = Array.isArray(currentList) ? currentList.length : totalAll;
  totalCountEl.textContent = (shown !== totalAll && totalAll)
    ? `${t('totalCount', {n: shown})} / ${totalAll}`
    : t('totalCount', {n: totalAll});

  const counts = new Map();
  allItems.forEach(item=>{
    const cat = mapCategory(item.category) || item.category || 'å…¶ä»–';
    counts.set(cat, (counts.get(cat) || 0) + 1);
  });
  const cats = Array.from(counts.keys()).sort((a,b)=>{
    const ai = CATEGORY_ORDER.indexOf(a);
    const bi = CATEGORY_ORDER.indexOf(b);
    if (ai === -1 && bi === -1) return a.localeCompare(b);
    if (ai === -1) return 1;
    if (bi === -1) return -1;
    return ai - bi;
  });
  categoryCountsEl.innerHTML = cats.map(cat=>{
    const count = counts.get(cat) || 0;
    const displayCat = currentLang === 'en' ? (CATEGORY_MAP_EN[cat] || cat) : cat;
    return `<span class="count-pill">${escapeHtml(displayCat)} ${count}/${totalAll}</span>`;
  }).join('');
}

const GEO_CACHE_KEY = 'food_map_geo_cache_v1';
const NEARBY_MAX_KM = 20;
const NEARBY_LOOKUP_LIMIT = 10;
const NEARBY_LOOKUP_MAX = 40;
const GEO_CACHE_TTL = 1000 * 60 * 60 * 24 * 45;
const geoCache = (()=>{ try{ return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}') || {}; }catch(_){ return {}; } })();
let geoSaveTimer = null;
const geoQueryCache = new Map();
const geoQueryPending = new Map();

function markGeoCacheDirty(){
  if (geoSaveTimer) return;
  geoSaveTimer = setTimeout(()=>{
    try{ localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache)); }catch(_){}
    geoSaveTimer = null;
  }, 1200);
}
function parseLatLngPair(lat, lng){
  const latNum = Number(lat);
  const lngNum = Number(lng);
  if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return null;
  if (latNum < -90 || latNum > 90 || lngNum < -180 || lngNum > 180) return null;
  return { lat: latNum, lng: lngNum };
}
function extractLatLngFromText(text){
  const m = String(text || '').match(/(-?\d{1,3}\.\d+)\s*,\s*(-?\d{1,3}\.\d+)/);
  return m ? parseLatLngPair(m[1], m[2]) : null;
}
function extractLatLngFromMaps(url){
  const raw = safeUrl(url);
  if (!raw) return null;
  try{
    const u = new URL(raw);
    const atMatch = u.pathname.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
    if (atMatch) return parseLatLngPair(atMatch[1], atMatch[2]);
    const dataMatch = raw.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
    if (dataMatch) return parseLatLngPair(dataMatch[1], dataMatch[2]);
    const q = u.searchParams.get('q') || u.searchParams.get('query') || u.searchParams.get('ll') || '';
    const pair = extractLatLngFromText(q);
    if (pair) return pair;
    return null;
  }catch(_){
    return extractLatLngFromText(raw);
  }
}
function extractMapsQuery(url){
  const raw = safeUrl(url);
  if (!raw) return '';
  try{
    const u = new URL(raw);
    const q = u.searchParams.get('q') || u.searchParams.get('query') || '';
    return q || '';
  }catch(_){
    return '';
  }
}
function extractPlaceNameFromMapsUrl(url){
  const raw = safeUrl(url);
  if (!raw) return '';
  try{
    const u = new URL(raw);
    const parts = u.pathname.split('/').filter(Boolean);
    const idx = parts.indexOf('place');
    if (idx !== -1 && parts[idx + 1]){
      return decodeURIComponent(parts[idx + 1]).replace(/\+/g, ' ');
    }
  }catch(_){}
  return '';
}
function storeCoords(item, coords){
  if (!coords || !item) return null;
  if (item.id){
    geoCache[item.id] = { lat: coords.lat, lng: coords.lng, ts: Date.now() };
    markGeoCacheDirty();
  }
  item.lat = coords.lat;
  item.lng = coords.lng;
  return coords;
}
function getCachedCoords(item){
  if (!item) return null;
  const own = parseLatLngPair(item.lat, item.lng);
  if (own) return own;
  const cached = item.id ? geoCache[item.id] : null;
  if (cached && Number.isFinite(cached.lat) && Number.isFinite(cached.lng)){
    if (!cached.ts || (Date.now() - cached.ts) < GEO_CACHE_TTL){
      return parseLatLngPair(cached.lat, cached.lng);
    }
  }
  const fromMaps = extractLatLngFromMaps(item.maps);
  if (fromMaps) return storeCoords(item, fromMaps);
  return null;
}
async function geocodeQuery(query){
  const q = String(query || '').trim();
  if (!q) return null;
  const key = q.toLowerCase();
  if (geoQueryCache.has(key)) return geoQueryCache.get(key);
  if (geoQueryPending.has(key)) return geoQueryPending.get(key);
  const controller = new AbortController();
  const timeout = setTimeout(()=> controller.abort(), 3500);
  const task = fetch(`/api/geo?q=${encodeURIComponent(q)}`, { cache:'no-store', signal: controller.signal })
    .then(res=>res.json().catch(()=>({ ok:false })))
    .then(data=>{
      clearTimeout(timeout);
      if (data && data.ok && Number.isFinite(data.lat) && Number.isFinite(data.lng)){
        const coords = { lat: Number(data.lat), lng: Number(data.lng) };
        geoQueryCache.set(key, coords);
        return coords;
      }
      return null;
    })
    .catch(()=>null)
    .finally(()=>{ geoQueryPending.delete(key); });
  geoQueryPending.set(key, task);
  return task;
}
function buildGeocodeQuery(item){
  const fromMap = extractMapsQuery(item.maps);
  if (fromMap) return fromMap;
  const place = extractPlaceNameFromMapsUrl(item.maps);
  if (place) return place;
  const addr = String(item.address || '').trim();
  if (addr) return addr;
  const name = String(item.name || '').trim();
  if (!name) return '';
  const area = String(item.area || '').trim();
  const suffix = area ? ` ${area} Thailand` : ' Thailand';
  return name + suffix;
}
async function resolveItemCoords(item){
  const cached = getCachedCoords(item);
  if (cached) return cached;
  const query = buildGeocodeQuery(item);
  if (!query) return null;
  const coords = await geocodeQuery(query);
  return coords ? storeCoords(item, coords) : null;
}
function haversineKm(a, b){
  const r = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const h = Math.sin(dLat/2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng/2) ** 2;
  return 2 * r * Math.asin(Math.sqrt(h));
}
function formatDistance(km){
  if (!Number.isFinite(km)) return '';
  if (km < 1) return `${Math.round(km * 1000)} m`;
  return `${km.toFixed(km < 10 ? 1 : 0)} km`;
}
function filterRankByDistance(origin, entries){
  return entries
    .map(entry=>({
      item: entry.item,
      distance: haversineKm(origin, entry.coords)
    }))
    .filter(entry=>Number.isFinite(entry.distance) && entry.distance <= NEARBY_MAX_KM)
    .sort((a,b)=>a.distance - b.distance);
}
function getNearbyFromCached(origin, limit=5){
  const items = getActiveItems();
  const resolved = [];
  items.forEach(item=>{
    const coords = getCachedCoords(item);
    if (coords) resolved.push({ item, coords });
  });
  const ranked = filterRankByDistance(origin, resolved);
  return ranked.slice(0, limit);
}
function getActiveItems(){
  const source = Array.isArray(DATA) ? DATA : [];
  return source.filter(item=>item && !item.deleted);
}
async function getNearbyRestaurants(origin, limit=5){
  const items = getActiveItems();
  const resolved = [];
  const pending = [];
  items.forEach(item=>{
    const coords = getCachedCoords(item);
    if (coords) resolved.push({ item, coords });
    else pending.push(item);
  });
  let ranked = filterRankByDistance(origin, resolved);
  if (!pending.length) return ranked.slice(0, limit);

  let offset = 0;
  let looked = 0;
  const maxLookups = Math.max(NEARBY_LOOKUP_MAX, limit * 6);
  while (offset < pending.length && looked < maxLookups){
    const batch = pending.slice(offset, offset + NEARBY_LOOKUP_LIMIT);
    offset += NEARBY_LOOKUP_LIMIT;
    looked += batch.length;
    const coordsList = await Promise.all(batch.map(item=> resolveItemCoords(item)));
    coordsList.forEach((coords, idx)=>{
      if (coords) resolved.push({ item: batch[idx], coords });
    });
    ranked = filterRankByDistance(origin, resolved);
  }
  return ranked.slice(0, limit);
}
function renderNearbyList(list){
  if (!nearbyList) return 0;
  const source = Array.isArray(list) ? list.filter(entry=> entry && entry.item) : [];
  const deduped = [];
  const seen = new Set();
  source.forEach((entry)=>{
    const item = entry.item;
    const key = item && (item.id || item.name);
    if (key){
      if (seen.has(key)) return;
      seen.add(key);
    }
    deduped.push(entry);
  });
  if (!deduped.length){
    nearbyList.innerHTML = `<div class="nearby-empty">${t('nearbyEmpty')}</div>`;
    return 0;
  }
  nearbyList.innerHTML = deduped.map(entry=>{
    const item = entry.item;
    const mapsUrl = safeUrl(item.maps);
    let displayCat = mapCategory(item.category) || item.category || '';
    if (currentLang === 'en') displayCat = CATEGORY_MAP_EN[displayCat] || displayCat;
    const distance = formatDistance(entry.distance);
    return `
      <div class="nearby-item">
        <div>
          <div class="nearby-name">${escapeHtml(item.name || '')}</div>
          <div class="nearby-meta">${escapeHtml(distance)} Â· ${escapeHtml(displayCat)} Â· ${escapeHtml(item.area || '')}</div>
        </div>
        <div class="nearby-actions">
          <button class="nearby-btn primary" type="button" data-nearby-open="${escapeHtml(item.id || '')}">${t('viewBtn')}</button>
          ${mapsUrl ? `<a class="nearby-btn" href="${escapeHtml(mapsUrl)}" target="_blank" rel="noopener">${t('navBtn')}</a>` : ''}
        </div>
      </div>
    `;
  }).join('');
  nearbyList.querySelectorAll('[data-nearby-open]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-nearby-open');
      if (id) openModal(id);
    });
  });
  return deduped.length;
}

function isOpenNow(hoursStr) {
  if (!hoursStr) return false;
  const s = String(hoursStr).trim();
  if (s.includes('24 å°æ™‚') || s.includes('24 hours')) return true;
  if (s.includes('ä¼‘æ¯') || s.includes('Closed')) return false;
  
  const now = new Date();
  const current = now.getHours() * 60 + now.getMinutes();

  if (s.includes('é–‹å§‹') || s.includes('Starts')) {
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) {
      const start = parseInt(m[1])*60 + parseInt(m[2]);
      return current >= start;
    }
  }
  const ranges = s.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/g);
  if (ranges) {
    for (const range of ranges) {
      const m = range.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
      if (m) {
        const start = parseInt(m[1])*60 + parseInt(m[2]);
        let end = parseInt(m[3])*60 + parseInt(m[4]);
        if (end < start) end += 24 * 60;
        let c = current;
        if (c < start && (end > 24*60)) c += 24*60;
        if (c >= start && c <= end) return true;
      }
    }
    return false;
  }
  return true; 
}

function render(){
  const kw = (kwInput.value||'').trim().toLowerCase();
  const cat = fCat.value;
  const area= fArea.value;
  const price= fPrice.value;
  const status = fStatus ? fStatus.value : '';
  const sort = fSort ? fSort.value : '';
  const hasFilters = !!(kw || cat || area || price);
  const source = Array.isArray(DATA) ? DATA.filter(item=>item && typeof item === 'object') : [];
  let list = source.filter(item=>{
    const hay = [
      item.name,
      item.category,
      item.area,
      item.address,
      item.intro,
      item.ig,
      item.igComment,
      item.hours
    ].filter(Boolean).join(' ').toLowerCase();
    if (kw && !hay.includes(kw)) return false;
    if (cat && mapCategory(item.category) !== cat) return false;
    if (area && item.area !== area) return false;
    if (price && item.price !== price) return false;
    if (status === 'open' && !isOpenNow(item.hours)) return false;
    return true;
  });
  
  // æ’åºé‚è¼¯
  list = list.slice().sort((a,b)=>{
    // å„ªå…ˆç½®é ‚
    const af = !!(a.featured || a.featured_);
    const bf = !!(b.featured || b.featured_);
    if (af !== bf) return af ? -1 : 1;

    if (sort === 'name_asc'){
      const an = a.name || '';
      const bn = b.name || '';
      return nameCollator ? nameCollator.compare(an, bn) : an.localeCompare(bn);
    }
    if (sort === 'price_asc' || sort === 'price_desc'){
      const diff = priceRank(a.price) - priceRank(b.price);
      return sort === 'price_desc' ? -diff : diff;
    }
    if (sort === 'rating_desc'){
      return (Number(b.rating)||0) - (Number(a.rating)||0);
    }
    if (sort === 'dist_asc'){
      if (!userLocation) return 0;
      const da = haversineKm(userLocation, {lat:a.lat||0, lng:a.lng||0});
      const db = haversineKm(userLocation, {lat:b.lat||0, lng:b.lng||0});
      return da - db;
    }
    return 0;
  });

  // è‹¥è™•æ–¼åœ°åœ–æ¨¡å¼ï¼ŒåŒæ­¥æ›´æ–°åœ°åœ–æ¨™è¨˜
  if (isMapMode) {
    updateMapMarkers(list);
  }

  if (catTabs){
    catTabs.querySelectorAll('.cat-tab').forEach(btn=>{
      const val = btn.dataset.value || '';
      btn.classList.toggle('active', val === (fCat.value || ''));
    });
  }
  const canEdit = isAdmin;
  const renderList = (canEdit && newItem) ? [newItem, ...list] : list;
  const totalLen = renderList.length;
  const displayList = renderList.slice(0, currentLimit);
  if (!displayList.length){
    cardsEl.innerHTML = `
      <div class="empty-state">
        <h3>${t('emptyList')}</h3>
        <button class="btn ghost pill" type="button" id="clearFiltersBtn">${t('clearFilter')}</button>
      </div>
    `;
    const clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn){
      clearBtn.onclick = ()=>{ resetFilters(); safeRender(); };
    }
    return;
  }
  cardsEl.innerHTML = displayList.map((item, idx)=>{
    let displayCat = mapCategory(item.category) || item.category;
    if (currentLang === 'en') displayCat = CATEGORY_MAP_EN[displayCat] || displayCat;
    const ratingTag = item.rating ? `<span class="tag" style="background:#fffbeb;color:#b45309;border-color:#fcd34d">â˜… ${item.rating}</span>` : '';
    const isFeatured = !!(item.featured || item.featured_);
    const featuredTag = isFeatured ? `<span class="tag" style="background:#fff1f2;color:#be123c;border-color:#fda4af">ğŸ”¥ ${t('featured')}</span>` : '';
    const tags = [displayCat, item.area, item.price ? `${t('priceLabel')} ${item.price}` : '']
      .filter(Boolean)
      .map(t=>`<span class="tag">${escapeHtml(t)}</span>`)
      .join('');
    const liked = item.id ? favs.includes(item.id) : false;
    const safeId = escapeHtml(item.id || '');
    const isNew = !!item.__tempId;
    const editKey = item.__tempId || item.id || '';
    const safeName = escapeHtml(item.name || (isNew ? t('newPlace') : ''));
    let coverUrl = safeUrl(item.cover);
    const isIgCover = isIgCoverUrl(coverUrl);
    if (isIgCover && !ALLOW_IG_COVER) coverUrl = '';
    const coverThumb = coverUrl && !isIgCover ? buildThumbUrl(coverUrl, 520) : '';
    const coverPos = safeObjectPosition(item.coverPos || item.cover_pos);
    const coverStyle = coverPos ? ` style="object-position:${escapeHtml(coverPos)};"` : '';
    const eager = idx < 2;
    const coverImg = coverThumb
      ? `<img src="${escapeHtml(coverThumb)}" alt="${safeName}"${coverStyle} loading="${eager ? 'eager' : 'lazy'}" decoding="async"${eager ? ' fetchpriority="high"' : ''}>`
      : '';
    const coverPreview = coverUrl ? `<img src="${escapeHtml(coverUrl)}" alt="${safeName}"${coverStyle}>` : '<div class="admin-preview-empty">å°šæœªä¸Šå‚³</div>';
    const mapsUrl = safeUrl(item.maps);
    const introText = buildIntroText(item);
    const snippet = buildCardSnippet(item);
    const isEditing = canEdit && editingId === editKey;
    
    const cardStyle = isFeatured ? 'style="border:2px solid #fda4af;background:#fff1f2;box-shadow:0 12px 32px rgba(251,113,133,0.12);"' : '';

    const adminPanel = isEditing ? `
      <div class="admin-panel" data-admin-id="${safeId}">
        <div class="admin-grid">
          <label>åº—å<input class="admin-input" data-admin-field="name" value="${escapeHtml(item.name || '')}"></label>
          <label>åˆ†é¡<input class="admin-input" data-admin-field="category" value="${escapeHtml(item.category || '')}"></label>
          <label>åœ°å€<input class="admin-input" data-admin-field="area" value="${escapeHtml(item.area || '')}"></label>
          <label>åƒ¹ä½<input class="admin-input" data-admin-field="price" value="${escapeHtml(item.price || '')}"></label>
          <label>è©•åˆ†
            <div style="display:flex;gap:4px">
              <input class="admin-input" data-admin-field="rating" value="${escapeHtml(item.rating || '')}" placeholder="0-5">
              <button class="btn pill" type="button" data-fetch-rating="${safeId}" style="padding:0 8px;font-size:11px;white-space:nowrap">åŒæ­¥G</button>
            </div>
          </label>
          <label style="display:flex;align-items:center;gap:6px;grid-column:1/-1;background:#fff7ed;padding:8px;border-radius:8px;border:1px dashed #fdba74;">
            <input type="checkbox" data-admin-field="featured" ${(item.featured || item.featured_) ? 'checked' : ''}>
            <span style="font-weight:700;color:#c2410c;font-size:12px;">ç½®é ‚æ¨è–¦ (Featured)</span>
          </label>
          <label>åœ°å€<input class="admin-input" data-admin-field="address" value="${escapeHtml(item.address || '')}"></label>
          <label>ç·¯åº¦<input class="admin-input" data-admin-field="lat" value="${escapeHtml(item.lat ?? '')}"></label>
          <label>ç¶“åº¦<input class="admin-input" data-admin-field="lng" value="${escapeHtml(item.lng ?? '')}"></label>
          <label>ç‡Ÿæ¥­æ™‚é–“<input class="admin-input" data-admin-field="hours" value="${escapeHtml(item.hours || '')}"></label>
          <label>Google Maps<input class="admin-input" data-admin-field="maps" value="${escapeHtml(item.maps || '')}"></label>
          <label>Google Place ID<input class="admin-input" data-admin-field="googlePlaceId" value="${escapeHtml(item.googlePlaceId || item.google_place_id || '')}" placeholder="æŒ‡å®š Place ID ä»¥ä¿®æ­£è©•è«–"></label>
          <label>IG å½±ç‰‡<input class="admin-input" data-admin-field="ig" value="${escapeHtml(item.ig || '')}"></label>
          <label>YouTube å½±ç‰‡<input class="admin-input" data-admin-field="youtube" value="${escapeHtml(item.youtube || '')}"></label>
          <label class="admin-field">IG ç•™è¨€
            <textarea class="admin-textarea" data-admin-field="igComment">${escapeHtml(item.igComment || '')}</textarea>
          </label>
          <label class="admin-cover">å°é¢åœ–
            <div class="admin-upload">
              <div class="admin-preview" data-admin-preview="cover">${coverPreview}</div>
              <div>
                <input class="admin-file" data-admin-file="cover" type="file" accept="image/*">
                <input type="hidden" class="admin-input" data-admin-field="cover" value="${escapeHtml(item.cover || '')}">
                <input type="hidden" class="admin-input" data-admin-field="coverPos" value="${escapeHtml(coverPos)}">
                <div class="admin-upload-hint">é¸æ“‡åœ–ç‰‡å¾Œæœƒè‡ªå‹•ä¸Šå‚³</div>
                <div class="admin-upload-hint">æ‹–æ›³åœ–ç‰‡å¯èª¿æ•´é¡¯ç¤ºä½ç½®</div>
                <div class="admin-upload-status" data-admin-status="cover"></div>
              </div>
            </div>
          </label>
        </div>
        <label class="admin-field">åº—å®¶ä»‹ç´¹
          <textarea class="admin-textarea" data-admin-field="intro">${escapeHtml(introText)}</textarea>
        </label>
        <div class="admin-actions">
          <button class="btn ghost" data-admin-save="${safeId}">å„²å­˜</button>
          <button class="btn ghost" data-admin-cancel>å–æ¶ˆ</button>
          ${item.id ? '<button class="btn ghost" data-admin-delete>åˆªé™¤</button>' : ''}
          <span class="admin-msg" data-admin-msg></span>
        </div>
        <div class="admin-hint">ç®¡ç†æ¨¡å¼ï¼šå„²å­˜å¾Œæœƒç›´æ¥å¯«å…¥è³‡æ–™åº«ã€‚</div>
      </div>
    ` : '';
    return `<article class="card" ${cardStyle} data-card-id="${String(item.__tempId || item.id || '').replace(/"/g,'&quot;')}">
      <div class="cover">${coverImg}</div>
      <div class="card-body">
        <div class="card-head">
          <div>
            <div class="card-title">${safeName}</div>
            <div class="card-sub">${escapeHtml(displayCat || '')} Â· ${escapeHtml(item.area || '')}${item.price ? ` Â· ${escapeHtml(t('priceLabel'))} ${escapeHtml(item.price)}` : ''}</div>
          </div>
          <div class="card-head-actions">
            ${canEdit ? `<button class="edit-btn" data-edit="${escapeHtml(editKey)}">${escapeHtml(t('edit'))}</button>` : ''}
            ${item.id ? `<button class="fav-btn" data-fav="${safeId}" title="${escapeHtml(t('favBtn'))}">${liked?'â˜…':'â˜†'}</button>` : ''}
          </div>
        </div>
        <div class="card-tags">${featuredTag}${tags}${ratingTag}<span class="badge-hot">${escapeHtml(t('recommend'))}</span></div>
        <div class="card-addr">${escapeHtml(item.address || '')}</div>
        ${snippet ? `<div class="card-desc">${escapeHtml(snippet)}</div>` : ''}
        <div class="card-actions">
          ${item.id ? `<button class="btn primary" data-open="${safeId}">${escapeHtml(t('details'))}</button>` : `<span class="mini">${escapeHtml(t('actionsHint'))}</span>`}
          ${item.id ? `<a class="btn ghost" href="${escapeHtml(mapsUrl || '#')}" target="_blank" rel="noopener">${escapeHtml(t('nav'))}</a>` : ''}
        </div>
        ${adminPanel}
      </div>
    </article>`;
  }).join('') + (totalLen > currentLimit ? `
    <div style="grid-column:1/-1;text-align:center;padding:20px 0;">
      <button id="btnLoadMore" class="btn pill" style="background:#fff;border:1px solid #cbd5e1;padding:10px 24px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin:0 auto;">
        ${escapeHtml(t('loadMore'))} (${totalLen - currentLimit})
      </button>
    </div>` : '');

  if (totalLen > currentLimit) {
    document.getElementById('btnLoadMore').onclick = () => {
      currentLimit += PAGE_SIZE;
      safeRender();
    };
  }

  displayList.forEach(item=> ensureCover(item));
  renderSummary(displayList);
  // ç¶å®šå¡ç‰‡æŒ‰éˆ•
  cardsEl.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = (ev)=>{
      const id = btn.getAttribute('data-open');
      openModal(id);
    };
  });
  cardsEl.querySelectorAll('button[data-fav]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-fav');
      try{
        const action = favs.includes(id) ? 'remove' : 'add';
        const res = await fetch('/api/me/food-favs', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ id, action })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        favs = data.favorites || [];
        safeRender();
      }catch(err){
        alert('æ”¶è—å¤±æ•—ï¼š'+ (err.message||err));
      }
    };
  });
  cardsEl.querySelectorAll('[data-fetch-rating]').forEach(btn=>{
    btn.onclick = (e)=>{
      e.preventDefault();
      const id = btn.getAttribute('data-fetch-rating');
      const item = DATA.find(x=>x.id===id);
      if(!item) return;
      const wrap = btn.closest('[data-admin-id]');
      const input = wrap.querySelector('[data-admin-field="rating"]');
      
      if(!window.google || !window.google.maps || !window.google.maps.places){
        alert('åœ°åœ–æœå‹™å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™');
        ensureGoogleMaps();
        return;
      }
      
      btn.textContent = '...';
      btn.disabled = true;
      
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      
      const onResult = (place, status) => {
        btn.textContent = 'åŒæ­¥G';
        btn.disabled = false;
        if(status === google.maps.places.PlacesServiceStatus.OK && place && place.rating){
          input.value = place.rating;
        } else {
          alert('ç„¡æ³•å–å¾— Google è©•åˆ†');
        }
      };

      const placeId = item.googlePlaceId || item.google_place_id;
      if(placeId){
        service.getDetails({ placeId, fields:['rating'] }, onResult);
        return;
      }
      
      let query = '';
      if (item.maps) {
        try {
          const u = new URL(item.maps);
          const qVal = u.searchParams.get('q') || u.searchParams.get('query');
          if (qVal) query = qVal;
          else if (u.pathname.includes('/place/')) {
            const parts = u.pathname.split('/');
            const idx = parts.indexOf('place');
            if (idx >= 0 && parts[idx + 1]) query = decodeURIComponent(parts[idx + 1]).replace(/\+/g, ' ');
          }
        } catch (e) {}
      }
      if (!query) query = (item.name || '') + ' ' + (item.area || '') + ' Thailand';
      
      service.findPlaceFromQuery({ query, fields:['place_id'] }, (res, stat)=>{
        if(stat === google.maps.places.PlacesServiceStatus.OK && res && res[0]){
          service.getDetails({ placeId: res[0].place_id, fields:['rating'] }, onResult);
        } else {
          btn.textContent = 'åŒæ­¥G';
          btn.disabled = false;
          alert('Google Maps ä¸Šæ‰¾ä¸åˆ°æ­¤åœ°é»');
        }
      });
    };
  });
  if (isAdmin){
    cardsEl.querySelectorAll('button[data-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-edit') || '';
        editingId = (editingId === id) ? '' : id;
        safeRender();
        const card = cardsEl.querySelector(`[data-card-id="${escapeSelectorValue(id)}"]`);
        if (card) card.scrollIntoView({ behavior:'smooth', block:'start' });
      };
    });
    cardsEl.querySelectorAll('[data-admin-save]').forEach(btn=>{
      btn.onclick = async ()=>{
        const wrap = btn.closest('[data-admin-id]');
        if (!wrap) return;
        const id = wrap.getAttribute('data-admin-id');
        const original = DATA.find(x => x.id === id) || {};

        const read = (field)=>{
          const el = wrap.querySelector(`[data-admin-field="${field}"]`);
          if (!el) return undefined;
          if (el.type === 'checkbox') return el.checked;
          return el.value.trim();
        };
        
        const getVal = (f) => { const v = read(f); return v !== undefined ? v : original[f]; };
        
        const introRaw = getVal('intro') || '';
        const introLines = introRaw ? introRaw.split(/\n+/).filter(Boolean) : (original.highlights || []);

        const payload = {
          ...original,
          id: id || original.id,
          name: getVal('name'),
          category: getVal('category'),
          area: getVal('area'),
          price: getVal('price'),
          featured: read('featured') ?? original.featured,
          featured_: read('featured') ?? original.featured_,
          rating: getVal('rating'),
          address: getVal('address'),
          lat: getVal('lat'),
          lng: getVal('lng'),
          maps: getVal('maps'),
          googlePlaceId: getVal('googlePlaceId'),
          google_place_id: getVal('googlePlaceId'),
          hours: getVal('hours'),
          ig: getVal('ig'),
          youtube: getVal('youtube'),
          igComment: getVal('igComment'),
          cover: getVal('cover'),
          coverPos: getVal('coverPos'),
          intro: introRaw,
          highlights: introLines,
          dishes: original.dishes || []
        };
        const msgEl = wrap.querySelector('[data-admin-msg]');
        const setMsg = (text)=>{
          if (!msgEl) return;
          msgEl.textContent = text || '';
          if (text) setTimeout(()=>{ if (msgEl) msgEl.textContent = ''; }, 2000);
        };
        try{
          btn.disabled = true;
          const res = await fetch('/api/foods', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=>({}));
          if (res.status === 401){
            alert('éœ€è¦ç®¡ç†å“¡æ¬Šé™æ‰èƒ½ç·¨è¼¯ã€‚');
            return;
          }
          if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
          setMsg('å·²å„²å­˜');
          showToast('å·²å„²å­˜');
          editingId = '';
          newItem = null;
          await loadRemote();
        }catch(err){
          alert('å„²å­˜å¤±æ•—ï¼š' + (err.message||err));
        }finally{
          btn.disabled = false;
        }
      };
    });
    cardsEl.querySelectorAll('[data-admin-delete]').forEach(btn=>{
      btn.onclick = async ()=>{
        const wrap = btn.closest('[data-admin-id]');
        if (!wrap) return;
        const id = wrap.getAttribute('data-admin-id');
        if (!id) return;
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é¤å»³å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚')) return;
        const msgEl = wrap.querySelector('[data-admin-msg]');
        const setMsg = (text)=>{
          if (!msgEl) return;
          msgEl.textContent = text || '';
          if (text) setTimeout(()=>{ if (msgEl) msgEl.textContent = ''; }, 2000);
        };
        try{
          btn.disabled = true;
          const res = await fetch(`/api/foods?id=${encodeURIComponent(id)}`, {
            method:'DELETE',
            credentials:'include'
          });
          const data = await res.json().catch(()=>({}));
          if (res.status === 401){
            alert('éœ€è¦ç®¡ç†å“¡æ¬Šé™æ‰èƒ½åˆªé™¤ã€‚');
            return;
          }
          if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
          setMsg('å·²åˆªé™¤');
          showToast('å·²åˆªé™¤');
          editingId = '';
          await loadRemote();
        }catch(err){
          alert('åˆªé™¤å¤±æ•—ï¼š' + (err.message||err));
        }finally{
          btn.disabled = false;
        }
      };
    });
    cardsEl.querySelectorAll('[data-admin-cancel]').forEach(btn=>{
      btn.onclick = ()=>{
        editingId = '';
        if (newItem) newItem = null;
        safeRender();
      };
    });
    cardsEl.querySelectorAll('[data-admin-file="cover"]').forEach(input=>{
      input.onchange = async ()=>{
        const file = input.files && input.files[0];
        if (!file) return;
        const wrap = input.closest('[data-admin-id]');
        if (!wrap) return;
        const previewEl = wrap.querySelector('[data-admin-preview="cover"]');
        const hidden = wrap.querySelector('[data-admin-field="cover"]');
        const posInput = wrap.querySelector('[data-admin-field="coverPos"]');
        const statusEl = wrap.querySelector('[data-admin-status="cover"]');
        const setStatus = (text)=>{ if (statusEl) statusEl.textContent = text || ''; };
        setStatus('ä¸Šå‚³ä¸­â€¦');
        try{
          const url = await uploadCoverFile(file);
          if (hidden) hidden.value = url;
          if (posInput && !posInput.value) posInput.value = '50% 50%';
          const posVal = posInput ? posInput.value : '50% 50%';
          if (previewEl) previewEl.innerHTML = `<img src="${escapeHtml(url)}" alt="" style="object-position:${escapeHtml(posVal)};">`;
          setStatus('å·²ä¸Šå‚³');
          const card = wrap.closest('.card');
          if (card){
            const coverImg = card.querySelector('.cover img');
            if (coverImg){
              coverImg.src = url;
              coverImg.style.objectPosition = posVal;
            }else{
              const coverBox = card.querySelector('.cover');
              if (coverBox) coverBox.innerHTML = `<img src="${escapeHtml(url)}" alt="" style="object-position:${escapeHtml(posVal)};">`;
            }
          }
          const id = wrap.getAttribute('data-admin-id');
          const target = DATA.find(it=>it.id === id);
          if (target){
            target.cover = url;
            target.coverPos = posVal;
          }
          initCoverPositionControls(previewEl);
        }catch(err){
          setStatus('ä¸Šå‚³å¤±æ•—');
          alert('å°é¢åœ–ä¸Šå‚³å¤±æ•—ï¼š' + (err.message||err));
        }
      };
    });
    initCoverPositionControls();
  }
}

// --- åœ°åœ–æ¨¡å¼ç›¸é—œé‚è¼¯ ---
if (modeToggle) {
  modeToggle.onclick = () => {
    isMapMode = !isMapMode;
    if (isMapMode) {
      modeToggle.textContent = 'åˆ—è¡¨æ¨¡å¼';
      cardsEl.style.display = 'none';
      mainMapEl.style.display = 'block';
      // åˆ‡æ›åˆ°åœ°åœ–æ¨¡å¼æ™‚ï¼Œè‹¥åœ°åœ–å°šæœªåˆå§‹åŒ–å‰‡åˆå§‹åŒ–ï¼Œå¦å‰‡è§¸ç™¼ resize ä¸¦æ›´æ–°æ¨™è¨˜
      if (!mainMap) {
        initMainMap();
      } else {
        google.maps.event.trigger(mainMap, 'resize');
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ¨™è¨˜
        safeRender();
      }
    } else {
    modeToggle.textContent = t('mapMode');
      cardsEl.style.display = 'grid';
      mainMapEl.style.display = 'none';
    }
  };
}

function initMainMap() {
  if (!window.google || !window.google.maps) {
    ensureGoogleMaps().then(ok => { if(ok) initMainMap(); });
    return;
  }
  if (mainMap) return;

  mainMap = new google.maps.Map(mainMapEl, {
    center: { lat: 13.7563, lng: 100.5018 },
    zoom: 12,
    gestureHandling: 'greedy',
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false
  });
  mainInfoWindow = new google.maps.InfoWindow({ maxWidth: 280 });
  
  // æ–°å¢å®šä½æŒ‰éˆ•
  const locBtn = document.createElement("button");
  locBtn.className = "btn pill";
  locBtn.style.cssText = "background:#fff; color:#0f172a; border:1px solid #cbd5e1; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-top:10px; font-weight:700; cursor:pointer; z-index: 5;";
  locBtn.innerHTML = t('locBtn');
  
  locBtn.addEventListener("click", () => {
    if (navigator.geolocation) {
      locBtn.textContent = t('locating');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };
          userLocation = pos; // æ›´æ–°å…¨åŸŸä½ç½®è®Šæ•¸
          mainMap.setCenter(pos);
          mainMap.setZoom(15);
          
          // æ¨™ç¤ºä½¿ç”¨è€…ä½ç½®
          new google.maps.Marker({
            position: pos,
            map: mainMap,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: "#2563eb",
              fillOpacity: 1,
              strokeColor: "white",
              strokeWeight: 2,
            },
            title: "æ‚¨çš„ä½ç½®"
          });
          locBtn.innerHTML = t('locBtn');
        },
        () => {
          alert(t('locPerm'));
          locBtn.innerHTML = t('locBtn');
        }
      );
    } else {
      alert(t('browserNoLoc'));
    }
  });
  
  mainMap.controls[google.maps.ControlPosition.TOP_CENTER].push(locBtn);
  
  // åˆå§‹åŒ–å¾Œç«‹å³æ›´æ–°æ¨™è¨˜
  safeRender();
}

function updateMapMarkers(list) {
  if (!mainMap) return;
  
  // æ¸…é™¤èˆŠæ¨™è¨˜
  mainMarkers.forEach(m => m.setMap(null));
  mainMarkers = [];
  
  const bounds = new google.maps.LatLngBounds();
  let hasLoc = false;
  
  list.forEach(item => {
    const coords = getCachedCoords(item);
    if (coords) {
      hasLoc = true;
      const marker = new google.maps.Marker({
        position: coords,
        map: mainMap,
        title: item.name
      });
      
      marker.addListener('click', () => {
        const thumb = item.cover && !isIgCoverUrl(item.cover) ? buildThumbUrl(item.cover, 120) : '';
        const content = `
          <div style="display:flex; gap:10px; align-items:flex-start; padding:2px;">
            ${thumb ? `<img src="${escapeHtml(thumb)}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;flex-shrink:0;">` : ''}
            <div style="min-width:0;">
              <div style="font-weight:700; font-size:14px; margin-bottom:4px; line-height:1.3;">${escapeHtml(item.name)}</div>
              <div style="font-size:12px; color:#64748b; margin-bottom:8px;">
                ${item.rating ? `<span style="color:#b45309;">â˜… ${item.rating}</span>` : ''} 
                ${item.price ? `Â· ${t('priceLabel')} ${escapeHtml(item.price)}` : ''}
              </div>
              <button onclick="openModal('${escapeHtml(item.id)}')" style="background:#0f172a; color:#fff; border:none; padding:5px 12px; border-radius:999px; font-size:12px; cursor:pointer; font-weight:600;">${t('detailShort')}</button>
            </div>
          </div>
        `;
        mainInfoWindow.setContent(content);
        mainInfoWindow.open(mainMap, marker);
      });
      
      mainMarkers.push(marker);
      bounds.extend(coords);
    }
  });
  
  if (hasLoc) {
    mainMap.fitBounds(bounds);
    // é¿å…åªæœ‰ä¸€å€‹é»æ™‚ç¸®æ”¾å¤ªå¤§
    const listener = google.maps.event.addListener(mainMap, "idle", function() { 
      if (mainMap.getZoom() > 16) mainMap.setZoom(16); 
      google.maps.event.removeListener(listener); 
    });
  }
}

function sortTripItems(origin, items) {
  let remaining = items.map(it => ({ item: it, coords: getCachedCoords(it) })).filter(it => it.coords);
  let sorted = [];
  let currentPos = origin;

  while (remaining.length > 0) {
    remaining.sort((a, b) => haversineKm(currentPos, a.coords) - haversineKm(currentPos, b.coords));
    const next = remaining.shift();
    sorted.push(next);
    currentPos = next.coords;
  }
  return sorted;
}

function buildMultiStopUrl(origin, sortedItems) {
  if (!origin || !sortedItems.length) return '';
  const base = 'https://www.google.com/maps/dir/?api=1';
  const params = new URLSearchParams();
  params.set('origin', `${origin.lat},${origin.lng}`);
  
  const getLoc = (entry) => {
    const it = entry.item;
    const pid = it.googlePlaceId || it.google_place_id;
    if (pid) return `place_id:${pid}`;
    if (it.name) {
      let q = it.name.replace(/[|]/g, ' ');
      if (it.area) q += ` ${it.area}`;
      return q;
    }
    return `${entry.coords.lat},${entry.coords.lng}`;
  };

  params.set('destination', getLoc(sortedItems[sortedItems.length - 1]));
  if (sortedItems.length > 1) {
    const waypoints = sortedItems.slice(0, -1).map(it => getLoc(it)).join('|');
    params.set('waypoints', waypoints);
  }
  params.set('travelmode', 'driving');
  return `${base}&${params.toString()}`;
}

function renderTripResult(sortedItems, gmapsUrl, startCoords) {
  const body = tripResultModal.querySelector('#tripResultBody');
  if (!body) return;
  let lastCoords = startCoords;
  const itemsHtml = sortedItems.map((entry, index) => {
    const dist = haversineKm(lastCoords, entry.coords);
    lastCoords = entry.coords;
    const distLabel = index === 0 ? t('distFromHere') : t('distFromPrev');
    return `
      <div class="trip-result-item">
        <div class="trip-result-order">${index + 1}</div>
        <div>
          <div class="trip-result-name">${escapeHtml(entry.item.name)}</div>
          <div class="trip-result-meta">${escapeHtml(entry.item.area)} Â· ${escapeHtml(currentLang==='en'?(CATEGORY_MAP_EN[mapCategory(entry.item.category)]||mapCategory(entry.item.category)):mapCategory(entry.item.category))}</div>
          <div class="trip-result-dist">${distLabel}ï¼š${formatDistance(dist)}</div>
        </div>
        <div class="trip-result-actions">
          <button class="btn pill ghost" onclick="openModal('${escapeHtml(entry.item.id)}')">${t('detailShort')}</button>
        </div>
      </div>
    `;
  }).join('');

  body.innerHTML = `
    <div style="padding:16px; display:grid; gap:12px;">
      <div class="modal-head">
        <div class="modal-title">${t('tripTitle')}</div>
        <button class="modal-close" onclick="tripResultModal.close()">${t('close')}</button>
      </div>
      <div>${itemsHtml}</div>
      <a href="${escapeHtml(gmapsUrl)}" target="_blank" rel="noopener" class="btn primary">${t('openNav')}</a>
    </div>
  `;
}

// æŒ‰éˆ•äº‹ä»¶
[btnBack, btnFav, btnAdd].forEach(btn=>{
  if (!btn) return;
  if (btn.id === 'btnBack') btn.onclick = ()=> { window.location.href = '/shop'; };
});

function checkLoginOrRedirect(msg){
  if (window.authState && typeof window.authState.isLoggedIn === 'function' && window.authState.isLoggedIn()) {
    return true;
  }
  if (confirm((msg || t('loginReq')) + '\n\n' + t('loginConfirm'))) {
    // ä¿®æ­£ï¼šè‹¥åº—å®¶è³‡è¨Šå½ˆçª—é–‹å•Ÿä¸­ï¼Œéœ€å…ˆé—œé–‰ï¼Œå¦å‰‡ç™»å…¥ç•«é¢æœƒè¢«è“‹ä½ (å› ç‚º dialog åœ¨ top-layer)
    const dlg = document.getElementById('foodModal');
    if (dlg && dlg.open) {
      dlg.close();
    }
    if (window.authState && typeof window.authState.login === 'function') {
      window.authState.login();
    } else {
      window.location.href = '/shop'; 
    }
  }
  return false;
}

if (btnFav) btnFav.onclick = ()=> {
  if (checkLoginOrRedirect(t('loginFav'))) {
    openFavList();
  }
};

if (btnAdd) btnAdd.onclick = ()=>{
  if (!isAdmin) return;
      if (!newItem){
        newItem = {
          __tempId: `new-${Date.now()}`,
          id: '',
          name: '',
          category: '',
          area: '',
          price: '',
          featured_: false,
          featured: false,
          rating: '',
          address: '',
          hours: '',
          maps: '',
          googlePlaceId: '',
          ig: '',
          youtube: '',
          igComment: '',
          cover: '',
          coverPos: '50% 50%',
          intro: ''
        };
      }
  editingId = newItem.__tempId;
        safeRender();
  if (cardsEl) cardsEl.scrollIntoView({ behavior:'smooth', block:'start' });
};

function bootFoodMap(){
  if (foodBooted) return;
  foodBooted = true;

  // å„ªåŒ–ï¼šå„ªå…ˆè®€å–å¿«å–æˆ–é è¨­è³‡æ–™ï¼Œå¯¦ç¾ç§’é–‹
  if (loadCacheData()) {
    // loadCacheData å…§éƒ¨æœƒè¨­å®š dataReady = true ä¸¦æ¸²æŸ“
  } else if (DATA && DATA.length > 0) {
    dataReady = true;
    safeRender();
  } else {
    dataLoading = true;
    dataReady = false;
    showLoadingState();
  }

  setSyncIndicator(true);
  showNearbyToggle(false);
  setNearbyCollapsed(false);
  checkAdmin().then(()=>{ safeRender(); });
  initFilters();
  resetFilters();
  [kwInput, fCat, fArea, fPrice, fStatus].filter(Boolean).forEach(el=> el.addEventListener('input', () => {
    currentLimit = PAGE_SIZE;
    safeRender();
  }));
  if (fSort) {
    fSort.addEventListener('change', ()=>{
      currentLimit = PAGE_SIZE;
      if (fSort.value === 'dist_asc' && !userLocation) {
        if (nearbyStatus) nearbyStatus.textContent = t('locating');
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            updateMapPreview(userLocation, t('locMy'));
            safeRender();
          },
          ()=>{ alert(t('locPerm')); fSort.value = ''; safeRender(); }
        );
      } else {
        safeRender();
      }
    });
  }
  ensureGoogleMaps(); // ç§»é™¤å»¶é²ï¼Œç›´æ¥è¼‰å…¥åœ°åœ–
  loadRemote();
  loadMeta();
  fetch('/api/foods/track', { method:'POST' }).catch(()=>{});
}

async function runNearby(origin, label){
  if (!origin || !Number.isFinite(origin.lat) || !Number.isFinite(origin.lng)) return;
  showNearbyToggle(true);
  setNearbyCollapsed(false);
  if (nearbyStatus) nearbyStatus.textContent = t('preparing', {dist: NEARBY_MAX_KM});
  if (nearbyList) nearbyList.innerHTML = '';
  const cachedList = getNearbyFromCached(origin, 5);
  if (cachedList.length){
    const shown = renderNearbyList(cachedList);
    if (nearbyStatus) nearbyStatus.textContent = t('showing', {n: shown});
  }
  try{
    const list = await getNearbyRestaurants(origin, 5);
    const shown = renderNearbyList(list);
    if (!shown && nearbyStatus){
      nearbyStatus.textContent = t('nearbyNone', {dist: NEARBY_MAX_KM});
    }else if (nearbyStatus && label){
      nearbyStatus.textContent = t('nearbyFound', {dist: NEARBY_MAX_KM, label, n: shown});
    }
  }catch(_){
    if (nearbyStatus) nearbyStatus.textContent = t('nearbyFail');
  }
}
if (nearbyUse){
  nearbyUse.addEventListener('click', ()=>{
    ensureGoogleMaps();
    if (!navigator.geolocation){
      if (nearbyStatus) nearbyStatus.textContent = t('browserNoLoc');
      return;
    }
    if (nearbyStatus) nearbyStatus.textContent = t('locating');
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        userLocation = coords;
        updateMapPreview(coords, t('locMy'));
        runNearby(coords, t('locMy'));
      },
      ()=>{
        if (nearbyStatus) nearbyStatus.textContent = t('locPerm');
      },
      { enableHighAccuracy:true, timeout: 8000, maximumAge: 60000 }
    );
  });
}
if (nearbySearch){
  const runSearch = async ()=>{
    await ensureGoogleMaps();
    const query = nearbyInput ? nearbyInput.value.trim() : '';
    if (!query){
      if (nearbyStatus) nearbyStatus.textContent = t('inputHotel');
      return;
    }
    if (nearbyStatus) nearbyStatus.textContent = t('searchLoc');
    let coords = null;
    let label = query;
    if (googleReady){
      const result = await geocodeWithGoogle(query);
      coords = result ? { lat: result.lat, lng: result.lng } : null;
      label = result && result.label ? result.label : query;
    }else{
      coords = await geocodeQuery(query);
    }
    if (!coords){
      if (nearbyStatus) nearbyStatus.textContent = t('locNotFound');
      return;
    }
    updateMapPreview(coords, label);
    runNearby(coords, label);
  };
  nearbySearch.addEventListener('click', runSearch);
  if (nearbyInput){
    nearbyInput.addEventListener('keydown', (ev)=>{
      ensureGoogleMaps();
      if (ev.key === 'Enter'){
        ev.preventDefault();
        runSearch();
      }
    });
  }
}
if (nearbyToggle){
  nearbyToggle.addEventListener('click', ()=>{
    ensureGoogleMaps();
    setNearbyCollapsed(!isNearbyCollapsed());
  });
}

async function loadMeta(){
  try{
    const res = await fetch('/api/foods/meta');
    const data = await res.json().catch(()=>({}));
    if(data && data.ok && data.meta && data.meta.subtitle){
      const el = document.getElementById('pageSubtitle');
      if(el) el.textContent = data.meta.subtitle;
    }
  }catch(_){}
}

// è®€å–é ç«¯è³‡æ–™èˆ‡æ”¶è—
async function loadRemote(){
  dataLoading = true;
  setSyncIndicator(true);
  if (!dataReady) showLoadingState();
  try{
    const res = await fetch('/api/foods'); // ç§»é™¤ no-storeï¼Œå…è¨±ç€è¦½å™¨å¿«å– (éœ€é…åˆå¾Œç«¯ Cache-Control)
    const data = await res.json().catch(()=>({}));
    if (res.ok && Array.isArray(data.items)){
      DATA = data.items.filter(it=>it && !it.deleted);
      saveCacheData(DATA);
    }
  }catch(err){
    console.error("Failed to load remote food data, using fallback.", err);
    if (loadCacheData()) {
      console.log("Loaded from local cache");
    }
  }
  dataReady = true;
  dataLoading = false;
  setSyncIndicator(false);
  await refreshFavorites();
  initFilters();
  safeRender();
}

function loadGooglePlaceDetails(item, container) {
  if (!window.google || !window.google.maps || !window.google.maps.places) {
    container.innerHTML = `
      <div style="background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:24px; text-align:center;">
        <div style="color:#94a3b8; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px;">
          <span style="display:inline-block; width:14px; height:14px; border:2px solid #cbd5e1; border-top-color:#64748b; border-radius:50%; animation:spin 1s linear infinite;"></span>
          æ­£åœ¨è¼‰å…¥ Google è©•åƒ¹...
        </div>
      </div>`;
    return;
  }
  const service = new google.maps.places.PlacesService(document.createElement('div'));
  
  const placeId = item.googlePlaceId || item.google_place_id;
  if (placeId) {
    service.getDetails({
      placeId: placeId,
      fields: ['rating', 'user_ratings_total', 'reviews', 'url']
    }, (place, statusDet) => {
      if (statusDet === google.maps.places.PlacesServiceStatus.OK && place) {
        renderGoogleReviews(place, container);
      } else {
        container.innerHTML = '<div style="padding:15px;color:#94a3b8;font-size:13px;text-align:center;background:#f8fafc;border-radius:12px;">ç„¡æ³•å–å¾—è©³ç´°è©•åƒ¹ (ID ç„¡æ•ˆ)</div>';
      }
    });
    return;
  }

  // å„ªå…ˆå˜—è©¦å¾ Google Maps é€£çµä¸­æå–æœå°‹é—œéµå­—ï¼Œæ¯”å–®ç´”ç”¨åº—åæ›´æº–ç¢º
  let query = '';
  if (item.maps) {
    try {
      const u = new URL(item.maps);
      const qVal = u.searchParams.get('q') || u.searchParams.get('query');
      if (qVal) {
        query = qVal;
      } else if (u.pathname.includes('/place/')) {
        const parts = u.pathname.split('/');
        const idx = parts.indexOf('place');
        if (idx >= 0 && parts[idx + 1]) {
          query = decodeURIComponent(parts[idx + 1]).replace(/\+/g, ' ');
        }
      }
    } catch (e) {}
  }
  
  if (!query) {
    query = (item.name || '') + ' ' + (item.area || '') + ' Thailand';
  }
  
  service.findPlaceFromQuery({
    query: query,
    fields: ['place_id']
  }, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
      service.getDetails({
        placeId: results[0].place_id,
        fields: ['rating', 'user_ratings_total', 'reviews', 'url']
      }, (place, statusDet) => {
        if (statusDet === google.maps.places.PlacesServiceStatus.OK && place) {
          renderGoogleReviews(place, container);
        } else {
          container.innerHTML = '<div style="padding:15px;color:#94a3b8;font-size:13px;text-align:center;background:#f8fafc;border-radius:12px;">ç„¡æ³•å–å¾—è©³ç´°è©•åƒ¹</div>';
        }
      });
    } else {
      container.innerHTML = '<div style="padding:15px;color:#94a3b8;font-size:13px;text-align:center;background:#f8fafc;border-radius:12px;">Google Maps ä¸Šæ‰¾ä¸åˆ°æ­¤åœ°é»</div>';
    }
  });
}

function renderGoogleReviews(place, container) {
  const rating = place.rating || 0;
  const total = place.user_ratings_total || 0;
  const reviews = place.reviews || [];
  
  // ç”¢ç”Ÿæ˜Ÿæ˜Ÿ HTML
  const starHtml = (r) => {
    const full = Math.floor(r);
    const hasHalf = (r % 1) >= 0.5;
    let html = '';
    for (let i = 0; i < 5; i++) {
      if (i < full) html += '<span style="color:#fbbc04;">â˜…</span>';
      else if (i === full && hasHalf) html += '<span style="background:linear-gradient(90deg, #fbbc04 50%, #e2e8f0 50%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">â˜…</span>';
      else html += '<span style="color:#e2e8f0;">â˜…</span>';
    }
    return html;
  };

  let html = `
    <div style="background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.03);">
      <div style="padding:14px 16px; background:#f8fafc; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10px;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" style="width:20px; height:20px;">
          <div>
            <div style="font-weight:700; font-size:13px; color:#0f172a; line-height:1.2;">Google è©•åƒ¹</div>
            <div style="font-size:11px; color:#64748b;">${total.toLocaleString()} å‰‡è©•è«–</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:22px; font-weight:800; color:#0f172a; line-height:1;">${rating}</div>
          <div style="font-size:12px; letter-spacing:1px; margin-top:2px;">${starHtml(rating)}</div>
        </div>
      </div>
  `;
  
  if (reviews.length) {
    html += `<div style="display:flex; flex-direction:column;">`;
    reviews.slice(0, 3).forEach((r, idx) => {
      const txt = r.text || '';
      const isLong = txt.length > 85;
      const displayTxt = isLong ? txt.slice(0, 85) + '...' : txt;
      const border = idx === reviews.slice(0,3).length - 1 ? '' : 'border-bottom:1px solid #f1f5f9;';
      
      html += `
        <div style="padding:14px 16px; ${border}">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <img src="${r.profile_photo_url}" style="width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid #e2e8f0;">
            <div style="flex:1; min-width:0;">
              <div style="font-size:13px; font-weight:700; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(r.author_name)}</div>
              <div style="display:flex; align-items:center; gap:6px; font-size:10px; color:#94a3b8;">
                <span style="display:flex; color:#fbbc04; font-size:10px;">${'â˜…'.repeat(Math.floor(r.rating))}</span>
                <span>${r.relative_time_description}</span>
              </div>
            </div>
          </div>
          ${txt ? `<div style="font-size:13px; color:#475569; line-height:1.6;">${escapeHtml(displayTxt)}</div>` : ''}
        </div>
      `;
    });
    html += `</div>`;
  } else {
    html += `<div style="padding:20px; text-align:center; color:#94a3b8; font-size:13px;">æš«ç„¡è©•è«–å…§å®¹</div>`;
  }

  html += `
      <a href="${place.url}" target="_blank" rel="noopener" style="display:block; text-align:center; padding:12px; background:#f8fafc; border-top:1px solid #e2e8f0; font-size:13px; font-weight:600; color:#2563eb; text-decoration:none; transition:background 0.2s;">
        æŸ¥çœ‹æ›´å¤š Google Maps è©•è«– â†’
      </a>
    </div>
  `;
  
  container.innerHTML = html;
}

// Modalï¼šåº—å®¶è³‡è¨Š
function openModal(id){
  const item = DATA.find(x=>x.id===id);
  if (!item) return;
  const body = document.getElementById('foodModalBody');
  const dlg = document.getElementById('foodModal');
  const introText = buildIntroText(item);
  const ytEmbed = buildYouTubeEmbedUrl(item.youtube || item.ig);
  const iframe = ytEmbed ? `<iframe src="${escapeHtml(ytEmbed)}" allowfullscreen></iframe>` : '';
  const embedClass = ytEmbed ? 'modal-embed yt' : 'modal-embed';
  const igComment = String(item.igComment || '').trim();
  const hoursText = String(item.hours || '').trim();
  const mapsUrl = safeUrl(item.maps);
  const igUrl = safeUrl(item.ig);
  const safeId = escapeHtml(item.id || '');
  const displayCat = mapCategory(item.category) || item.category;
  const tags = [
    displayCat,
    item.area,
    item.price ? `${t('priceLabel')} ${item.price}` : ''
  ]
    .filter(Boolean)
    .map(t=>`<span class="modal-chip">${escapeHtml(t)}</span>`)
    .join('');
  const metaTags = [
    hoursText ? `${t('hours')} ${hoursText}` : ''
  ]
    .filter(Boolean)
    .map(t=>`<span class="modal-chip">${escapeHtml(t)}</span>`)
    .join('');
  body.innerHTML = `
    <div class="modal-body">
      <div class="modal-head">
        <div class="modal-title">${escapeHtml(item.name || '')}</div>
        <button id="foodClose" class="modal-close">${escapeHtml(t('close'))}</button>
      </div>
      <div class="modal-tags">${tags}</div>
      <div class="${embedClass}">
        <div class="modal-embed-inner">
          ${iframe || `<div style="padding:20px;color:#94a3b8;text-align:center;">${escapeHtml(t('noYt'))}</div>`}
        </div>
      </div>
      ${igComment ? `
        <div class="modal-section">
          <strong>${escapeHtml(t('igComment'))}</strong>
          <div style="white-space:pre-wrap;color:#475569;line-height:1.8;">${escapeHtml(igComment)}</div>
        </div>` : ''}
      <div class="modal-section">
        <strong>${escapeHtml(t('desc'))}</strong>
        <div style="white-space:pre-wrap;line-height:1.8;color:#475569;">${escapeHtml(introText || t('noIntro'))}</div>
      </div>
      <div class="modal-section">
        <div><strong>${escapeHtml(t('addr'))}ï¼š</strong>${escapeHtml(item.address || '') || escapeHtml(t('unknownAddr'))}</div>
        ${metaTags ? `<div class="modal-tags" style="margin-top:8px;">${metaTags}</div>` : ''}
      </div>
      <div class="modal-section">
        <strong>${escapeHtml(t('reviews'))}</strong>
        <div id="googleReviewsBox" style="margin-top:4px;"></div>
      </div>
      <div class="modal-actions">
        <a class="btn primary" href="${escapeHtml(mapsUrl || '#')}" target="_blank" rel="noopener">${escapeHtml(t('openGmaps'))}</a>
        ${igUrl ? `<a class="btn ghost" href="${escapeHtml(igUrl)}" target="_blank" rel="noopener" style="color:#d62976;border-color:#d62976;">${escapeHtml(t('viewIg'))}</a>` : ''}
        <button class="btn ghost" data-fav="${safeId}">${escapeHtml(t('addFav'))}</button>
      </div>
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  ensureGoogleMaps().then(() => {
    loadGooglePlaceDetails(item, document.getElementById('googleReviewsBox'));
  });
  const favBtn = body.querySelector('button[data-fav]');
  if (favBtn){ favBtn.onclick = ()=> toggleFav(item.id); }
}

// æ”¶è—æ¸…å–®èˆ‡æ”¶è— API
async function refreshFavorites(){
  try{
    const r = await fetch('/api/me/food-favs',{credentials:'include',cache:'no-store'});
    const j = await r.json().catch(()=>({}));
    if (r.ok && Array.isArray(j.favorites)){
      favs = j.favorites;
        safeRender();
    }
    return r.ok;
  }catch(_){ return false; }
}
async function toggleFav(id){
  if (!checkLoginOrRedirect('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½åŠ å…¥æ”¶è—ã€‚')) return;
  try{
    const action = favs.includes(id) ? 'remove' : 'add';
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action })
    });
    const data = await res.json().catch(()=>({}));
    if (res.status === 401){ alert('è«‹å…ˆç™»å…¥å¾Œå†æ”¶è—'); return; }
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    safeRender();
  }catch(err){
    alert('æ”¶è—å¤±æ•—ï¼š' + (err.message||err));
  }
}
function openFavList(){
  const dlg = document.getElementById('foodModal');
  const body = document.getElementById('foodModalBody');
  const list = DATA.filter(it=> favs.includes(it.id));
  
  const planButtonHtml = list.length >= 3 ? `
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e2e8f0;">
      <button class="btn primary" id="planTripFromFavs" style="width:100%;">${escapeHtml(t('planTrip'))}</button>
    </div>
  ` : '';

  body.innerHTML = `
    <div style="padding:16px;display:grid;gap:12px;background:#fff;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:18px;font-weight:800;">${escapeHtml(t('fav'))}</div>
        <button id="foodClose" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer;">${escapeHtml(t('close'))}</button>
      </div>
      ${!list.length ? `<div style="color:#94a3b8; text-align:center; padding:20px 0;">${escapeHtml(t('emptyFav'))}</div>` : `
        <div style="display:grid;gap:8px;">
          ${list.map(it=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;">
            <div>
              <div style="font-weight:700;">${escapeHtml(it.name || '')}</div>
              <div style="color:#64748b;font-size:12px;">${escapeHtml(mapCategory(it.category) || it.category || '')}ï½œ${escapeHtml(it.area || '')}</div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn ghost" style="padding:6px 10px;font-size:12px;" data-open="${escapeHtml(it.id || '')}">${escapeHtml(t('viewBtn'))}</button>
              <button class="btn" style="padding:6px 10px;font-size:12px;" data-remove="${escapeHtml(it.id || '')}">${escapeHtml(t('removeBtn'))}</button>
            </div>
          </div>`).join('')}
        </div>
      `}
      ${planButtonHtml}
    </div>
  `;
  dlg.showModal();
  document.getElementById('foodClose').onclick = ()=> dlg.close();
  body.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.onclick = ()=> openModal(btn.getAttribute('data-open'));
  });
  body.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.onclick = ()=> removeFav(btn.getAttribute('data-remove'));
  });

  const planBtn = document.getElementById('planTripFromFavs');
  if (planBtn) {
    planBtn.onclick = async () => {
      planBtn.textContent = t('planning');
      planBtn.disabled = true;
      try {
        const startCoords = await new Promise((resolve, reject) => {
          if (userLocation) return resolve(userLocation);
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            () => {
              alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä»¥ç¬¬ä¸€å®¶åº—ç‚ºèµ·é»ã€‚');
              const firstItem = DATA.find(it => it.id === favs[0]);
              const coords = getCachedCoords(firstItem);
              if (coords) resolve(coords);
              else reject(new Error('ç„¡æ³•å–å¾—èµ·é»ä½ç½®'));
            }
          );
        });

        const selected = favs.map(id => DATA.find(it => it.id === id)).filter(Boolean);
        const sorted = sortTripItems(startCoords, selected);
        const gmapsUrl = buildMultiStopUrl(startCoords, sorted);

        renderTripResult(sorted, gmapsUrl, startCoords);
        tripResultModal.showModal();
      } catch (err) {
        alert('è·¯ç·šè¦åŠƒå¤±æ•—ï¼š' + err.message);
      } finally {
        planBtn.textContent = t('planTrip');
        planBtn.disabled = false;
      }
    };
  }
}
async function removeFav(id){
  if (!checkLoginOrRedirect('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½ç§»é™¤æ”¶è—ã€‚')) return;
  try{
    const res = await fetch('/api/me/food-favs',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, action:'remove' })
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    favs = data.favorites || [];
    safeRender();
    const dlg = document.getElementById('foodModal');
    if (dlg.open) openFavList();
  }catch(err){
    alert('ç§»é™¤å¤±æ•—ï¼š' + (err.message||err));
  }
}
document.addEventListener('DOMContentLoaded', bootFoodMap);
</script>
</body>
</html>
